<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://seata.apache.org/blog</id>
    <title>Apache Seata Blog</title>
    <updated>2023-11-27T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://seata.apache.org/blog"/>
    <subtitle>Apache Seata Blog</subtitle>
    <icon>https://seata.apache.org/img/seata_logo_small.jpeg</icon>
    <entry>
        <title type="html"><![CDATA[Exploring the Journey of Open Source Development in Seata Project]]></title>
        <id>https://seata.apache.org/blog/explore-seata-journey</id>
        <link href="https://seata.apache.org/blog/explore-seata-journey"/>
        <updated>2023-11-27T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In this article, I will share my journey as a developer in the Seata community, along with the experiences and insights I have gained during this adventure.]]></summary>
        <content type="html"><![CDATA[<blockquote><p>Seata is an open-source distributed transaction solution dedicated to providing high-performance and user-friendly distributed transaction services in a microservices architecture. During this year's Summer of Code event, I joined the Apache Seata (Incubator) community, completed the Summer of Code project, and have been actively involved in the community ever since. I was fortunate to share my developer experience at the YunQi Developer Show during the Cloud Conferen</p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="relevant-background">Relevant Background<a href="#relevant-background" class="hash-link" aria-label="Direct link to Relevant Background" title="Direct link to Relevant Background">​</a></h2><p>Before formally introducing my experiences, I would like to provide some relevant background information to explain why I chose to participate in open source and how I got involved. There are various motivations for participating in open source, and here are some of the main reasons I believe exist:</p><ul><li><strong>Learning</strong>: Participating in open source provides us with the opportunity to contribute to open-source projects developed by different organizations, interact with industry experts, and offers learning opportunities.</li><li><strong>Skill Enhancement</strong>: In my case, I usually work with Java and Python for backend development. However, when participating in the Seata project, I had the chance to learn the Go language, expanding my backend technology stack. Additionally, as a student, it's challenging to encounter production-level frameworks or applications, and the open-source community provided me with this opportunity.</li><li><strong>Interest</strong>: Many of my friends are passionate about open source, enjoying programming and being enthusiastic about open source.</li><li><strong>Job Seeking</strong>: Participating in open source can enrich our portfolio, adding weight to resumes.</li><li><strong>Work Requirements</strong>: Sometimes, involvement in open source is to address work-related challenges or meet job requirements.</li></ul><p>These are some reasons for participating in open source. For me, learning, skill enhancement, and interest are the primary motivations. Whether you are a student or a working professional, if you have the willingness to participate in open source, don't hesitate. Anyone can contribute to open-source projects. Age, gender, occupation, and location are not important; the key is your passion and curiosity about open-source projects.</p><p><strong>The opportunity for me to participate in open source arose when I joined the Open Source Promotion Plan (OSPP) organized by the Institute of Software, Chinese Academy of Sciences.</strong></p><p>OSPP is an open-source activity for university developers. The community releases open-source projects, and student developers complete project development under the guidance of mentors. The completed results are contributed to the community, merged into the community repository, and participants receive project bonuses and certificates. OSPP is an excellent opportunity to enter the open-source community, and it was my first formal encounter with open-source projects. This experience opened a new door for me. I deeply realized that participating in the construction of open-source projects, sharing your technical achievements, and enabling more developers to use what you contribute is a joyful and meaningful endeavor.</p><p>The image below, officially released by OSPP, shows that the number of participating communities and students has been increasing year by year since 2020, and the event is getting better. This year, a total of 133 community projects were involved, each providing several topics, with each student selecting only one topic. Choosing a community to participate in and finding a suitable topic in such a large number of communities is a relatively complex task.</p><p><img loading="lazy" alt="img" src="/assets/images/explore-seata-ospp-ea3140f489f2794691a5ec30584dc17d.png" width="1736" height="455" class="img_ev3q"></p><p><strong>Considering factors such as community activity, technical stack compatibility, and guidance for newcomers, I ultimately chose to join the Seata community.</strong></p><p>Seata is an open-source distributed transaction framework that provides a complete distributed transaction solution, including AT, TCC, Saga, and XA transaction modes, and supports multiple programming languages and data storage solutions. Since its open source in 2019, Seata has been around for <strong>5</strong> years, with over <strong>300</strong> contributors in the community. The project has received <strong>24k+</strong> stars and is a mature community. Seata is compatible with <strong>10+</strong> mainstream RPC frameworks and RDBMS, has integration relationships with <strong>20+</strong> communities, and is applied to business systems by <strong>thousands</strong> of customers. It can be considered the de facto standard for distributed transaction solutions.</p><p><img loading="lazy" alt="img" src="/assets/images/explore-seata-apache-0ab436a0c1d070e4d1dbff2df66ea775.png" width="750" height="146" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="seatas-journey-to-apache-incubator">Seata's Journey to Apache Incubator<a href="#seatas-journey-to-apache-incubator" class="hash-link" aria-label="Direct link to Seata's Journey to Apache Incubator" title="Direct link to Seata's Journey to Apache Incubator">​</a></h3><p>On October 29, 2023, Seata was formally donated to the Apache Software Foundation and became an incubating project. After incubation, Seata is expected to become the first top-level distributed transaction framework project under the Apache Software Foundation. This donation will propel Seata to a broader development scope, profoundly impacting ecosystem construction, and benefiting more developers. This significant milestone also opens up broader development opportunities for Seata.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="development-journey">Development Journey<a href="#development-journey" class="hash-link" aria-label="Direct link to Development Journey" title="Direct link to Development Journey">​</a></h2><p><strong>Having introduced some basic information, the following sections will delve into my development journey in the Seata community.</strong></p><p>Before officially starting development, I undertook several preparatory steps. Given Seata's five years of development and the accumulation of hundreds of thousands of lines of code, direct involvement requires a certain learning curve. I share some preparatory experiences in the hope of providing inspiration.</p><ol><li><p><strong>Documentation and Blogs as Primary Resources</strong></p><ul><li>Text materials such as documentation and blogs help newcomers quickly understand project background and code structure.</li><li>Official documentation is the primary reference material, providing insights into everything the official documentation deems necessary to know.
<img loading="lazy" alt="img" src="/assets/images/explore-seata-docs-481f1fed9d84cd5bf6459048ab08e169.png" width="722" height="146" class="img_ev3q"></li><li>Blogs, secondary to official documentation, are often written by developers or advanced users. Blogs may delve deeper into specific topics, such as theoretical models of projects, project structure, and source code analysis of specific modules.
<img loading="lazy" alt="img" src="/assets/images/explore-seata-blogs-3a309daa3407d8705311955654df0b21.png" width="722" height="155" class="img_ev3q"></li><li>Public accounts (such as WeChat) are similar to blogs, generally containing technical articles. An advantage of public accounts is the ability to subscribe for push notifications, allowing for technical reading during spare time.
<img loading="lazy" alt="img" src="/assets/images/explore-seata-pubs-b79d08833dc9443c20d5badd02f46ad1.png" width="722" height="131" class="img_ev3q"></li><li>Additionally, slides from online or offline community presentations and meetups provide meaningful textual materials.
<img loading="lazy" alt="img" src="/assets/images/explore-seata-slides-9d9ec97761879e8d3a74be56c6908a4a.png" width="722" height="115" class="img_ev3q"></li><li>Apart from official materials, many third-party resources are available for learning, such as understanding specific implementations and practices through user-shared use cases, exploring the project's ecosystem through integration documentation from third-party communities, and learning through video tutorials. However, among all these materials, I consider official documentation and blogs to be the most helpful.</li></ul></li><li><p><strong>Familiarizing Yourself with the Framework</strong></p><ul><li>Not all text materials need to be thoroughly read. Understanding is superficial if confined to paper. Practice should commence when you feel you understand enough. The "Get Started" section in the official documentation is a step-by-step guide to understanding the project's basic workflow.</li><li>Another approach is to find examples or demonstrations provided by the official project, build and run them, understand the meanings of code and configurations, and learn about the project's requirements, goals, existing features, and architecture through usage.</li><li>For instance, Seata has a repository named "seata-samples" containing over 20 use cases, covering scenarios like Seata integration with Dubbo, integration with SCA, and Nacos integration. These examples cover almost all supported scenarios.</li></ul></li><li><p><strong>Roughly Reading Source Code to Grasp Main Logic</strong></p><ul><li>In the preparation phase, roughly reading the source code to grasp the project's main logic is crucial. Efficiently understanding a project's core content is a skill that requires long-term accumulation.</li><li>First, through the previously mentioned preparation steps, understanding the project's concepts, interactions, and process models is helpful.</li><li>Taking Seata as an example, through official documentation and practical operations, you can understand the three roles in Seata's transaction domain: TC (Transaction Coordinator), TM (Transaction Manager), and RM (Resource Manager). TC, deployed independently as a server, maintains the state of global and branch transactions, crucial for Seata's high availability. TM interacts with TC, defining the start, commit, or rollback of global transactions. RM manages resources for branch transaction processing, interacts with TC to register branch transactions and report branch transaction states, and drives branch transaction commit or rollback. After roughly understanding the interaction between these roles, grasping the project's main logic becomes easier.
<img loading="lazy" alt="img" src="/assets/images/solution-1bdadb80e54074aa3088372c17f0244b.png" width="868" height="473" class="img_ev3q"></li><li>Having a mental impression of these models makes it easier to extract the main logic from the source code. For example, analyzing the Seata TC transaction coordinator, as a server-side application deployed independently of the business, involves starting the server locally and tracking it through the startup class. This analysis can reveal some initialization logic, such as service registration and initialization of global locks. Tracking the code through RPC calls can reveal how TC persists global and branch transactions and how it drives global transaction commit or rollback.</li><li>However, for embedded client framework code without a startup class entry point for analysis, starting with a sample can be effective. Finding references to framework code in a sample allows for code reading. For instance, a crucial annotation in Seata is <code>GlobalTransaction</code>, used to identify a global transaction. To understand how TM analyzes this annotation, one can use the IDE's search function to find the interceptor for <code>GlobalTransaction</code> and analyze its logic.</li><li>Here's a tip: Unit tests often focus on the functional aspects of a single module. Reading unit tests can reveal a module's input-output, logic boundaries, and understanding the code through the unit test's call chain is an essential means of understanding the source code.</li></ul></li></ol><p><strong>With everything prepared, the next step is to actively participate in the community.</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ways-to-contribute-and-personal-insights">Ways to Contribute and Personal Insights<a href="#ways-to-contribute-and-personal-insights" class="hash-link" aria-label="Direct link to Ways to Contribute and Personal Insights" title="Direct link to Ways to Contribute and Personal Insights">​</a></h2><p>There are various ways to participate, with one of the most common being to check the project's Issues list. Communities often mark issues suitable for new contributors with special labels such as "good-first-issue," "contributions-welcome," and "help-wanted." Interested tasks can be filtered through these labels.</p><p><img loading="lazy" alt="img" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAu4AAABQCAMAAABxnADUAAACuFBMVEXMztD+/v/y9PX5+vuoq62nqq3////Iy83MztDFyMv29/j988Xw763//vz+//////3o6On9/f7+/PP9+/j///79/Pv7/P7u7/Hu7e399Mr99tX9/v/t6+n5+/3x8vL18/H8+ub+9Mfz8O329cvb4+33+PrJys3y8bLl5ebM09xlXGPAwsjy8a65vML39fPp6+7q5+Tv8vZ4dHX59O359/X6+fjS1trv597h6O7Bv8D19veZh33HxcXFztlycHPOyml5eoD2+v6OfXTh3dm0uL69ydfFyMvj6/O8w8zU09Pu9fvp49xfZXbd2dTO0dVeX2rBxs728OZ0dXvU3umgkYbx7OTMzc+Dc2vFy9Lc4eb8+fPz+PzOysbz6r7i4eBlZW3m28+0vcrZ3N/Rzs27rqDVybzDtanq6amPk5txfZDN2OXi18p/eXWLmKzp8PiDf3vQwrKwpZjJuqvY0MmapLRjYVrq4dba1M9rcHprdol/gop+bGWvoI6CrYXT2eG5p5rF0uJxYmBsbHGDkKe1wtO8ubmcq8FfWVNkbYCvsrjl46bz9vno7vRyeYWqrbKomond0MCjrLv9+e5WWWd+i6CMg36Hh2mXprtsaGepssCEipTw5bqSnrJ1amjRz3fe3Z99fWROUF347sKquMja1ZTIx6d2gZdYTEru7Kqnm5OUuZeRiYasu8/p6L2pnHRERk2Xj4nGxpd6a1iKgFqkssd/eFn68cOzqHjg06ekqbGYnaWvtoyVh2Pr8+zOxLr599yYlZX27r6glGnRwo03ODulpqZvcVeRkXS3uqGdnobg6+Hn4bihwqSanHeUtOmzr67N3s7Gv4Xv79PS1Z+iqYLCt47Asn1uYUysya7V04WwlYx/cnnV5NbE2cZsluG7r4u40bqsxe5Rg9vH2PR+o+Vdi95vmm////+WVYwoAAAA6HRSTlPE////lpb/xMXE///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////E/33mMAAAIABJREFUeNrsm/lTU1kWxyWZeWVBJSQkISwhLAVWEkuBsGhBEQI0g0toBAMoTkhggAFZwhIQCBhZFBRlEwgYBAxEShEUFAgMssgoxNjVFjO0S7dF/zR/x5z7AJcedKRVnMH3TeUldznvJNTnnnfueWHHH3buIETom9DOP+7YSbcgROibEB1CuwVGiNA3IYsdBO6ECNwJESJwJ0SIwP3/SdaU3y9rgphthTude5+0rfGnuMw4fIJcbAhmtg/uj5+Ul5c/f8zctt/XxsHe6pPk0ExE+C1VwtLg4FLzZomk4/ovuP9SfvPp41c3yx9vX9pXoR2Dh5WVXjaGv9PL1nrX2r99WK2/k+mtrOybCQS38GK81NcVHNzVN8jYjBVp13e4dll+CHdu+XM/eAl4cpP0hT78n/lUt8jjTmjRnnV/e4T67sTosxGv38f+eMDp010zM/eEYNYziGrdGt2uxjv4O9c+kx5/vfDA7LpRRF83mBsywLgDg6Bwy5KPpRfBuLrMrE2YxU3uQfouPRnDfA/udnfcCHeLp+X3MfJ9FkYrf/qFgmtodqxUJO+1xTCf2TNv+n3O7n93okL+epTSIDlg+xlw19QewmxQJjO3sKiX6cYA4vmsQRlEeNf5NrPMakwnM442zqERFObn9Hr9nE4/JtPJ5oby9Hqd3mrOfHcRLQcivG+VmNEvuvogvMPhxdIm7HafxxcHuf57DHPbdbbp0IbR/flNFvbqX08x8s1fUZPBIVPsSJhzIptK4fDIuH83Hgnz49GcMGe2m6etGw1mcDlsFseTjsGcOrAh0bzRNG+I1zCH5wHriwej2F6epyPg7vYXXlltDoaxeN577ZxhGMwCUmt6PZh20GBx4PyYM61xFXc3cL1P3XJx1bM3xvBa9UyzBct3PJOQZy9v3AR9H4YnyYtNReeD6xnDi0fGcW9GuBv75YahnsX5NtNy1orJWDboOv+oTWleblsYHjVMLfQYIJz/YHywuLy4ctdkDF1QDvcXGsbbTMaptmc47i4Eh1uVypiDuwZnBvvg2dXN+H24W2CRE+/DnY79CrizVnFXCI82t3YolDEqUlqWSAU2rHxhcYeXVFTZSdIUD8gn7wi0bqGlyuKHSnl4QpqwsvRo0dV04aX9BcqYJifMWlM8216VUzQgEjWFoGPH3tBsKnSXwKmif67OrYRhdppQvCfw7xL+tFKU7V3QKroSUaQsVl4G3K1TsypjjqTcvnbPEWPlCkUdHPA86Y17nhV0uoVeAs+t8nDGG8/umcqYiRBYHNDKKg5KSBFVXnGPvoGbreOuG31obBipHGpfnK95ZNCb9YC7YeSfz3oemUaHny2OK5d/MEyZRhYWDCtTNSsVhpHFu6blmrarD5TGERz3GYLDrdqm9kEa093dfaEbIvzMZnCnv8adebieT90Q91drycz98l9QM7PwpI9apbl8hJYpaMqXB8ECaG/i0cpqT6cKql9e5kuvHSuTJKuvn6oo8Y9vaRQkhYW2ZPafKxD0lkmCaI6QhlzmpwqSpBnH86OCAq8fT4viB2ZTGfnt1eA+VnAr/1p4/uVj8ddPsxtrqouuqqYF1WFnpbeRQQrCPTa+k9dQmxyfXQeeK1Q8mqaYXyC4hXs+ogHPGZHqWn/wKehNRJ61pwRNZZJjtNgfJ/iKfhX0TcsPhMVnp0j4Be333iQzPQ/HhVPtxqH2hppCw5gOJTO6u6ZnZcPzo8MjhvFWo8H8U6FpNGt5ZKjwb1nmqcUp00rhomFoHXcium+VmvHMvQvtVoODN5HN7K6HPSjLKWACcN/3MNybviHu98ufWL61VQXcm9WqwwMxTfm3i4UI99yoCMi/q6iwCl5mhKRIDuVG+cefgx56Q0aKJAcrKykQwBI5p2iN6XAC3EtCfOJVai0WW9GkPoftqzgQmM1IEyVBKs5EuEtyFIXhqVniIEXhmcz+YrE86caV2f6OUO1q7q4QnMEa5cmhWirGTI1yxxiBVY428Z0vS06kSXIa5Xx1JyWwhV6WkS+JwDS1BYIzzfHaooGYjsN56eGZYKu5lAeIN1yXttgyQrMR7hRUmBkbzxrvaVMut7Uu31lZQMlMn0k2BPmN6R8Php+19RhcXV2NPYYHs8a7C1nDd8xDhp96DFNtecZRSHQAd3ui9L5Foia8wHepS39F1ZlN4H4wvT6Zd76+Hm1VIycnvsv5QCHy6XohsqjiXEGNipOYF3VWoDr4vTcCsInHK5OcnhaEr+POVyPcWdKMVEEvRNJMHHdOohQQRNE9VxAeWJKM4jqEbPnp0OxGgSqZ57Qa3XHcvSLjWzJrehUVnQfjwiq00zW90oxkzTUU3dXZiQ0lngh38Kzl8TQSfmp7NY57RGMUjnsV4F4g6EgMrQLAm9VaTliZBBV1FP3asPgquLZExqtSJEEF7bcQ7piLvdUYbDnndDqZzAzbVL1uTocKkWMyvd6s08uMaoMOLzzqxmQyKx2ahg/pYTZqogqOC1F437Lc/QLCfclPBrj3JXy8naX/5MPJ83FxybDhJHO5pI2jO2aB32Z6QlttMTSV6aKOaaV4gp0iFKN8H7JkcdJhqVDcZKmpCsnPONQoTh64ZSPVsvLSuWnCmHT3IvFRn8DeXKW4KQThPiBSnSgaEIp7nRRwTPKVanOvySuvXES5e3huaU6R8FieuDQ8OrCYD6ee9MwTzYrCFVni2ZiT8GVTlcJSfoL0HhX3HJMUKxXGNNVpWkJyM3IyxacD71FudNJT0kmrnn8+2RzYgTyfgIuHoqY0q/RoggZGIqJvCNH24/ohdE/VfrXs/h7pVgZdP3ybyX6GQmC4VXJcQmnMYMIgQD+4mZv9zD9d2eOxUWFzgx8RvL6DxeKQuAF+HE9bjGJHq1utzNA8MAaH7Yjt5VJ92Y5+bDLXkulMQk2YQ8ZYbCcK19KXBjMA9wxPO0hcoEVFRy6V6RzgS6PR4IQYhe3hy6az2B7ONC4MepLh1CQqAzx6YM6elmy81O4MXpncdc+W4NkOebYASwZ4rlvzDGPg2Y5McQvw5djhS1khCLcDO4qdpxMqMUHnXvSRMOtmB/tPkYMLQfsWimUG3l90Q07TnbApQ0saGfsI3D+nrBsyQr7WVRDl/e/5VDb/oea154d61kRhEgxuZfbuO7i6W73g81nO90VxP3XE9mv9nd6+LbvBte4doY63xyx+00Poa8b3GXNfn3npM93J3q4/ACZ+w79d0ncqk8H4bMUB4t87CH1DInAnROBOiBCB+4dEpn+cQ/K6OyaZWGeE/odw96V5Onnt8q9ziztuS+Fc9IuM2/Xeegfl4LtDDP+ct/fXYXH7MQrNG8P+zd61/zSV5fFtm1yTxgut7W2b2JZNbTstl75oSx+0DdBSWmtLEaktNJX3+yFvxBlWQUSk4LAoo0SiRjPgIwLihKz4FjW7WWOMrLPJ7Py6f8eeUyrCiI6aHTM45xPC5Z5z7nndz/ncb+FyPoW+ote1B3a+VQtb3bjuLIruEMJnojvhcQY1ZXKuzpJGGu2PD+FcGXwvna2TJBB6MwcjzEyctnLEiCRSDDhPl2CEng7/nlMwIk8gmLgA05uBihN8u0vifZyPYVoyKqEIMCYHUyqiZrMEXM7USQhw2I6bJUQkSpgFFBqdBusiZDkEBZREQPjt6S7qHxkMhV0hnaXHYhRZajHMExRguF3qFNtJqY9a5uzxkFJrktuZJiyTjoiBhkudRq/fkp+AJbYGSI07mufjB5wKIOr6SJDGC0O6O/zOUt+QPQToHipzkD0sd6k0LZLGcud4g/1yrzHitHIt0qDGLjXJvaU+jbonAd0mhN+c7mzP8xFHNCliypdKyRyssxZjhYGCJ5FRDxm2JpmkCrejzMXrD8CjPEkhxkSkxu63yD0lAsDqtMGQxWhQSOUiRxRj88uCmexOSHdFjt1lKQVRkVLR6CEjZMTvdhmLXXpTGqkJ+8O1EctISMG1+EhNqytsVUTt2YjuCJ9D3S3OHg4zMRwkh8rkkO4iEkTb4JuBDMsLTRZHaanXqu+HxzI5yyTGClxFBldYXKDIxOyOUovfIu5wWGq1iiiGM7WKxsQVujd2ZEcc4DGhVDBMYjzsyNd5SbdL2e8ryWz1h4OmyGCpUxKWkkXgzGoydiK6I3wOuutlsiHcHgiq3FJnDmbPx9RWEEcTnU5nqNURsPKkPrGnRy8NSX0hviXgMGIstxMEM0aRPxMvy8e0UjdpcUVI6UgUU7oDckGiHUT+hSanxah9DiIjnTMw6FN1/K1RHQgyLFKHMRzs93emWaQKmY/mDpUF+13u/E7SZEV0R/gcv5mBEY2SCz59cocwjCbAiNhbZoSQirfKhQJMx5UQNDadqefSMaXQDJcCl5qg5+ASCht8BGXTaUKqRCnzkkMYUwhfcaSBIrhOSKUUwMcEhW7mcqneICd+PVMvbA3SOEohXUCj6DksYaufJgCN0dBdQvhMdH/HIlCrPrQoLxAw/lKe9d7VJJFbsyZDHVpbrCCEdB3hd0D3j1kZG+zlhHHetL8+d31XENsRNhndERAQ3REQEN0REBDdERD+X3TfQkdA+INgy5+2SGgICH8ISLagYAYBxe4ICIjuCAiI7ggIiO4Iv0skfjzYXybdmVShGdH/SwZ7270dH48vZG/MX+wAfOff0GjyDiLFFwv8zw+2fgq+2rGptrWnxPArdP/HN1d+/s+XbDSJtP3eV29TuWoafDtelbImKeXtUjs2j+OgORBz3lMEJO+j+50r0L2DTb1yxQxPCX78XXRKnqnxU1v2kutdIikdZNHac+Uaw8lCU/6aHJYsEqFihJrBgT9z428DE61ykSnnVxottPSs/CBauzMqwY8AUPnQTYFQq+Lug4mdfqVF/C52vE8n7f4NDTBx76D4U4PqTuv2j6DuBwpdx+Pq0fidTNj24G1GTz+cS9n6aHx5sSqWOn0cJL14mZLypsjK8d5mCeDZvlsxW9VB6N6h9zqNG3szQaNJgrpqNJmXdTOe0VEtziM/nvHsziD29YFVdheY4KS37HpTkdbUaGg/EmemSZN3+Oaaq4vb953uFhdM7gLkqZg6G+cBK73PMLt2VWg32OtXu/dorL2i4uTsNYvgxL6psS5/FvR9qhs4Gd+MO/FEDf++dd1aWXW97HC+2bEbb+1ZOzRvkLn/VtFGozZMnvwkuuPhnsTKUc76xALTzncKyQfur5xYnjyw9F18+u6tyHlVFWA1kPMqSO1zNxZTph+Oz/0LJIPUS+MvId2B3IOv6aqtsCiU/60PNk04Qw5yQDizYkXGf7/R5DerRpN5h7/DlDIuE1pFmltys4GW6XhJDAk0jdRAsWTQsCTZ0Ir7ZJKMS9EzGAJcJOQJeUxoNIBps2pUX3epoNcAX0bHK3OtNCyxZZcRWiOwGCoBXpGb3dF+jQetIfH9yVbD4aM87nZQGPodYHXt2a3tRw0DM0cTtu2Z6ePE9JmhTO+jR4YwPYOboOeZGVR2xUAJfGQp1SomwaPyhQkgzwPpTlTmHqpLzoYprBV7BX5r8lmZ+uBMAwdvnqmBXMVFMuWJA0NqDayQwuIpQYV1yRehQxUYue5El5iplMGKhTzP3ga4WsEY4X8TatNrVCIZDTSoIfjxPsNSAoxoGbMKcD6YJj1PCCYPB6m0WAdwnswMrgeDg16ZApgBXTJ5DDCxYPoMNxo0fBXBM/M1cAxcaMcAx8ABJWLuzzic51hNOrWKo00/YGTCWV/JMcMuxDrK4ybgPDroQexeQCdPVfHU9/F1uwPy9sX87afnrs+Pv3x0e37x0u3xqcWUcz+2Lyy/mn+2ML74cOnvVdPX566PL4KTV8vnnr1cGH92HIbvf908dH9jNMmkFL/LaPKf0GjyZ4zzmu5HDVdtfdCTaTiwd6kLqmzX/dMNOz2ztu58ZbNtuLb4lG3CWNFkO+M9ZTsrrKzvHRWld199niEunL2WwK6Ymjl7OXf2dButoqm3wX5w6QCoomXsfu9EDjR/bFNnLR0ztXfXd9XCR8nSMenhmqauQ9CX5kwmpLu1Y/Km4XBGzc7i+klId125bXcwvc9TXwsuz7DW7b4/ORFJX9oFLtc2p3YdMdRX1w/nay/3dg8AuhtAe6bkidRhMcjcfQTKW97kNUx7sLcrp6DJ9j2gO6sltavkxAH1qSPay6kZ2cU/VafWhPYs5YJHAhh5dXhg6WTkMqz4p+7qy0vQ8JIFxtiWibHvTs3cKp/wNIHqn4P+F5aDPhuauqtzYs32lKf2VufU2a62FWHaUxkTvmZbBvTDtLkKZm22UfpfMmb3jSald5/qzWbtr7e1DdU19Z5tXrpwprnB0/R6DKnXVsYQqkztnQAPnMS79baSJDgUXXNq70UwuQ2RWduwHLD9buruEmU5tPOpn6huntjZ0SRvqbeN8tK7J+AjqbB55lpc6SHdj/+wvPBk4cnc/NMfll89uX3+0Y9A3W8/XTj/sH1u/vzci4GXW6vml2+Mw5Pr/730ZGHqyQAIdzYV3TmrdGerR+QbumYDZRdi+js07E4smGEDurdcKAkBMft2rLYl1wpECJwD8dozHMjqq8x1ydRZJ8MH29KP+RjNY36Zrqw/a6z0Ro3RsPdiXW9tXN0vWJv/x971/zSVZfFAk/cDmZaW9lEy0HbSAS11pHyxBSmQ0lqgQilgkeFLqGD53kr5UqDA8rUKApUiLRRSAgSDshB1BUJGlHU1arJZxyXOuptxMok6+3/sOa+gZsZxY4ybcbY3KaXvvnfuPe993rmfe3r7PpOR2rN6VJUEE8FgoqX/HKqKideqJtXZQ672flRbtUxCdF/Wdg1WGY4ZdUBXGi4bxK4zif3fxKcaa90Id4uuQhQhHzxlTe3t+Fpv21ncqBqyO4fs0EPBztk5m3bIrO2fbjaoq4Z80b3+1JAXRohqQ97KcCbK/VFwrzWtWWb1GN0bPDPlEQD3uSVjTt64rexya4t4A6I7DBeWyQqRYHw4UpjyeK5Oe9nMTezC6E62gI+R+wOXyupqGVrWdHmrDBW9hpPWQYjcpEVXb9HZtXPeqsszceFEQn9dEmV9RwyNddt6YBgbn4xuyinuslUql1s8M9Xiw0WDxaLsG2a+frnNam7vn7a84YPTUKEt8oYSIUqbTFJtyBofTio7W5QjktsyC48+HhoMJ0qwxmKoaMo5OTQoaRjoq3aUgVldXpctEoei5sVze8Gd8TkQ8ZEb208fbC3M35p6sH3vwfrUJYD7Z3e/e7pwd+rKvfWFXeuTr2rWt3c3p3bXF+4u7P7z6tD2P6jo/umQmQs0/F1oEApNFr5DaPJfUngL2hOaxOh+vQDlgwHuTqTQQLwz28QVNxYVHpe+Lp1ItOoUnumyRoVd6y6YyF6tbVyUFU0Twb2uJhegiS53MbqHS53i6JXO64t2FIukuDvwb7krvKRoukF3ItG6xla64PZz6iKhwWC5y3itIN5Qj/R6wr0McLd3z7qz5AD3YJwHhCDc1fJFxYCjWXci37N0yoqyNA2NtXPDWqudrjR316UndCF3t+RkAncPKTLrrynSCpJeRfdpY+fqTDfCvXn4DHB3hLscdqnbobQqEz3I9yEMt8Y1OUopw+1iO3HRNx+4PutehHuRrneFN3WoPGvgBSkfxD4PpHioGOocyOwdPh6sX/b5m3BjmoMdcKxAYyFKL3RiY9yWXqXrKfIS3Y5q1PC8jz5Ap+Ggtn51iM8Hqj2LIbMajuuGsSi4yqTIoiyddtcWTUr0y7wdxR2riwfR3aRQd18rSBvO6LcTJW6vfNqCZg9BCxjSm82vJhlfHASyvrW5/uDJrc2FPz3d3Pzu3ubUDYjdW9u7D7ce1WytP7y0+ajmyt3tq5uPrq4/3H0AIf7WAkVmvvxkUu+5tefLmcfOvxKajHt7IvLvf/jbD3/94Y8+FWGI7tP8cuNivQ/uOjVtD+52uSP3dLFRlwoc2ZV7OilCJR8uLu+efCxO7V2UdU0D+ZkbgAkohw4El4L7Ueu5HYD7ZCowyeZFdbtno2m4p8VjB2rdZrUD3CF0O5G7b8AdAlFQkwu8tUFcnzh3Ltuqdl62cRHuHJg/MH3RvTsnT1NZ5YM7xd17c2RyhDtbiarBVGTkWCjufrHIbNRlaWQwNgX7ovt021BOJMKd4xRXMH3RvQkM9jh9cO/fGEWxeeNkX29OcXdOpRzgrga4D3IZ0Eu1EeHO1lPR3bMGB7DlLovumEbW5qFm3U5DpkWnVhV59+E+Ab2D7u7oqMaKdwx94459uNvKxBOaXNWcV8TM7zJz9+Fe/YYPVQa7SgnRnYxVKW1NhixNZbMuehzgbhPJl1VdyzxfjVFXoZFlA9yJakPHiQY0GwuhB5n9zvlXcKcjm7m0tT5VUzM/ArPU+SufjczDpBRnryMwcR2ZhwnqPKYl5+dr8MP8/MgV3BWC+ycjn8xJzr15/+aFjAwZRG8pn8sP/ZWvmXxCk3tp93zlUotbUXsGkFdwolDpgItncZxJfNbX4C6Yrc/Xp3XWQ8CpLa5uVKAcpVfldlzvqJRvAFlUUuKmHIuntWk2vaFANt5xZ0CdaOpEEwOraa6xxOvxMG7kKx0ZJjVbj2mXQmXdSeUa/XuzsCm+c6aU0qjnVDs0pr4E5Tn6ClxvQriS1hm94m2Lr4dRp1Pd4ojMb7QnuFGUsiG+072sMqWy9a2Fqx130pag+WxTXdmzvhD5uUJ9QSdqFxOwO3DpDbbezDMOwvhe0pumyGpyRbjtlMFTz+ovrm6U6DtSwSB4PuacG9xBw9pnfQTdaFgKJwrRx0h0zdCK3F1dIt8gv/cKV6DPiY1UGqihMxMnC8DdFTiiJCiXCLSeBZMdxdfZqwWo0jmb7lRUyicI4yxqeLYGAvmeSO41LK0Ad+9j66fRBzGmqRJNdcWolgmW2EaFoiIWLbWZOlcdYzseb3ParMkcSpRgTeEKOBlrgq63dQ2ml/TGKyYi5FSmK0Q//PpJyiGA93t3Hz15a2r95wn3NxORB//8KenJZsweDvqv36pywsnbt2+Te59YYaPSWEzEEFIJjxJzJI6EweQ/ihCIJDzMUcBWEZcFn1hHRJimYfLDaMJRhLsZZwcBZARXwA2QhvGOQE3UvgkUq8TkAo/gCJjJuJ2PbQuYQWGjhIBPsGNFySilGkYjpBFYLxjl8OMwd8pmMmn8OBIqYqA9sEsPCyKoXBFdKOFzaWgrEOr4mNUggoVgkUaHLUd8bhC4O3hFxAQSAiqlQUYwgwRcEjajA2zcG2oxEUJ5Tg+TkGhYCj6Dvzgmoo886kguHhhFFyZzsM9M0SieGTxZYaFoN4r6B/wKSyZ8HaA2xoiozAycFJoQexFORogCGVRyCxpA59CHgBhmAwZq1NcMpY7DEwTnmbIEG/lwISK4ZIREyGdgDZeF1yOI6gI9jMqbiQJZQoqUwu6vH2/CCPn8L0BoDr5v+fKTUk/mJIv+d0KTiSsFJ/xfYH5IKbx/0+RI+iimGYyQL96/XCR/F+f1o8A9+36Pf5nZB5WEs3cuJH20p0oxGP+vD6zyLwD+jY7G/lPgh7u/+Isf7v7iL78fuIez/NfJX35jcH+r0OQvxCRJ1i//e3fhvfz2p+dvWY0ZwAt4R8P+4i/vC3epRMKLza0cjZUlkSJNEkMoK/5VaP1MaFKgkWFmgb33+PYjzFCBrGeUILL318YGqF6vkuVIX6/yJpmjZLlsTKqS+b4aSX/+4scfX/x0hjKCC9Wj9rIKCXuKlfTTmf7L6C8fDndW9gEUmuRLw8oPj8GLWyZLwYVW0iiCRQtiEWRQeAAZhe/wikGhSY6UBlVRYDD7sGSUI+WVpGTSAJ6CozOlAmZKNINo75GyWAEEGUA/3YOHwksaFXNyDP4GoDGy5ZukkmJtRZykPYv68cTLF8+Pl77897fhlBGCiM0YJYNCCVqU8FApDhAk/j4kiGqW9fpe8Bd/eV+4+4Qm85JCycKM42RsHj+lEuBOLz+QkaTKOBAdqDnQE3voQHQMvAs0KDSJGpQSbUZGMYNoOxxHg7tFcjYvI5JBxFT+p70zaE0ciOI4KgxUsN3QaAQ1gsShYYim1ISkJAeJxGhRLKLERgI1tx68FPTmrQex7H0/Sr+E/QbCLu332DexXfawl7Usy7LzgyGXyZuB+fvyZhj5k4CvRXeIXyrjvmPU+gE/VfYhilh3PssqxkMaLKWaBkIjpas5fiz37WsXfnjbXYAajrJBJ8unSYj7+XE/JCHk90YHP0kOxo+O6w4rEZaY3hkHyX1vNCmGplSJBl1oYuSSNipbjwsytStmbDB5m1fGLXjae6PJ+bvR5GKtnz3Ypm9KqteE9O4Gpw4ZQnanDpWe4+dOaIgpfZUYFatO/fo6t0Uyz2ADVawVp7r2Xu47auNE5Y7KBKohlWxCa60rk+Jzy0ignlx+kMl5z49s1cNedBuwNWUclt0tKzaavONuTAnajHSju3ejyYYJotNjo8l1X/9hNKl6U+laaaKFl6ut/U5otkdU7rTy4HteDi2h48RUDHQylW8IDSEslU+4brUvlI4NtQ/I/cJcFTgOMjydHxQzpWOJFjOx3BOjQVGZtSRH0Z+/tOFrIZ8++F5zMegMrxVT6axKbE0ZB8k9NprsuYN6x/UFaPvsnl0SMrlfu3bewpMrWbNC158UTZcaTUaESEvpetBEV34hsySyYHo0p6PyOLjCBCqNXsv1S/dQhPP3LdcuQogzTISp7BBrFco34znsPNW1r5+NXTlHJxFsv71sX3d0O1rDAf17qw5jzSJzhntkjkbEXU9gXkZPqgxCMjZYMcM48GSGUhOqfFlI8aKQQho1nERZ8fzNaDKfzqYSaQ6e0O0no8l0It40ZkWRa0CjxyfVhJZPghQ1iHUaycfxPWTqVZmmQRtJThQ4CKZxvMZlhbygiW+XlBPdry+7bXz4kqkWqPPlBsbShCTsay9L1Ai6mVUxAAAAUElEQVTzMkeHTZUyVQ6CsyVlfEDuvy7r1Y8c/hX1zW/1LzULbKEYf0/uH7vBlGG3Fhj/lNwZDCZ3BoPJncFgcmcwmNwZjD8o96Mkg/GfcPQdSUMSadj9ClMAAAAASUVORK5CYII=" width="750" height="80" class="img_ev3q"></p><p>In addition to Issues, GitHub provides a discussion feature where you can participate in open discussions and gain new ideas.</p><p><img loading="lazy" alt="img" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAu4AAABWCAMAAACnxePJAAADAFBMVEXb29v6+/319vj///68vLz////o6uzb29vX19jc3Nz8/Pz4+frp6+3z9fb+///9/f7+/v7w8fL+///19vff4eL3+Pjy8/XZ2Nj5+vvCwsX18ez7+/v5+PdXVlna3N5kZGfExsm1trnGz9rQ0tX6/f+3ur7x9/vKy83u7/Dn5OBdXWG8vsL//vzDydPr6eZHR0zOzs7h6fHT2uDPysfk7vPJx8b59vDMz9HAxczN1Nzj4+Ps7Ozw8vTU3ef8+/nGyM3//Pc8fD72+v3IzNP8+vb29PLp7fDc1tHm6Os0NDeysrPHwsDx7+3t8/jAvsB7eHmssbigrLvW09FQUFq9wcnb4efg5ey3vMVyZ181OkVycnSlqK7Uz8u6xdRrcHugnZzt5+D7+fOqmIhSVmCsrrHw7elOTVCCgYKKf3hAOz3T1dhram3o4dng29bl5udqXVVSSkk/P0S/vLzg3tvM2eahpKqJiIs/Qkza5O5ITVleVlKIjZZKREWspqSeoaVqdIlaUEx/c2ny6+M+Rlbq8PWRnrCPh392cGp7f4p0eYarq6yAqIShj4CPlZ2qn5WXmqGSj5BugJS73qa2rqbI2cxgaoGLl6jxxl3DtKS8t7djaXWAjqOKfGrTxrjS4Nfs5tTt8OtGUWSWjILn7uSVspTEu7Pc59R8iJtoYmCttcDbz8FYYnSaprbm2s704prt37LQvqz212OeuqC4pp/g6+CYgnTLwbdOXGv58+W7pu+uyLVJhUvX48y0pZZ/h5OmssSElqzf08hfRkeclY/D0uDz6sXM5b8nKC61wNDPkH7KNy9ZWGy7tq2Ms6DotVC+yq3sz5KtucpIRVji69lhlmS1zcLBrZvK1L61mljUtYN/cEzDO1n664RPptzbeDG90L5UjVerw6TF4raUronb5d3fvMCRMS7TuWaownl2UTibvrGqtYu2z4u7US3c2O3y1X2JUt95QvfWjk7LbVvdq1GVUV7kx3G2eTyOn1yqi/HZm5ebdPK9gY1RSSREcphNkKyMgShXAAAACnRSTlPF////l///xMTGTzExxQAAG3pJREFUeNrsm1tMGvkex9eSYRNEQauAIlCltXVqoTfdem1TRQWtqFTXK1pQRPGGBTkCCpbi7ahoCNZrjCZGq26rMdp9qW3VTT3pPuz60FhbfWub5mSzD+fs6b6c3fMfwLt0u5fzoJ1vggPD/zszDJ//b77/P+Nnn0OoUH0i+vwzFHdUKO6oUKG4o0L1aeLuStxH6BlFdShxp5Dc9irck4CeU1SHD3fPMOx+wpNQ3lEdOtxxp7D7C++MnlRUhw13Z7wD3LEk6/ucMHcoMOEI8tQnFCwwrBhXCIrEOyFrMBR30MIFPCMSCATkQdgW+jkxO62QzYp12nkEN/DuCW7uW8MFjPWyggmzGiFvLAGKZB3Z58g5oUiHDAy4jX75KO5WEXDbRPgjuGO6NNcSYvkTeDfvGvNoztGSk/XG41D0dE9EIBWCSqr8WGUPO93IbsOFVRpee2GhJmRr010jwFqXDKxmxBoQJO0E1oc9EUTKtgO4Mt3jK51r5vM157wrec21C4X870GHGJM9IlBA73jeVHbWTOv1Os8J8rXqdMxsVVVh1XWX/mcRpb6+NeoOX9/rKPKfPO5EZ1I4aZvCSUgt/p243+p7wBuF5dWwLqiCzRU3Lggbeo8HP6RNuMy2noPy0huHOrt6KmV+LdV8yUSbtikpbXPLt6Qb1nj9Xuumvq57KuEaRqsbDIonWhWNkckvvHs1cGy0Ka2k3Q/K61tuTpdLJGxjyXwGG0iekTObniGsWmg0CxRmmWyUa5DJmiJQAD5x3HEkFwqO6L4pIs6T5EL4vbiP6VVVDM0Js1T3rYxf1JglEjY8Zg2xW5kpoqKOiwWVl0Xj9KCH4ogWcRWtdZTGEP4Nc5N5FbJZM+xWs6xQ3pi10NPQu2XdPADMc3ajvqNe1yZWjGkbm/N5JxKPYbsqhJfIw/pBv9kK7siCSlk3eKZkfoROp3tMq3ICRSpT0vSzGoHiKym/gVvN52ddRQH4tHGnhnu67m5DPLp3uuU3cL8hspyVMvwewslmGo0rFvIB7v0V1TIZg0FT9Q6JH41Jlq706Vza4ExGe49pgaG40mKxsRwtsnwh7dmyZgLc7Va1vNeDbFfMJDtTMjIklxgUY0UqgQTomVe6nAGawdrxVJE4N10O0wQjZ+eNyFb7VTkD5WyJqh3BfUyaCXDPzFSiYebTxp1A2ndi5ejRD+HOymPtCTMzBlNmMrZUOpKdKy1qqh0CuCd0N/N4vt2VuV/2643BdbphySPvIQYsq++RVskUmFKmbSx6q95gkgFr/chZq7Ue4L5pTapn22WcZAsB7jozqO5sY2JlZWViFCkbVHled2WNktyXoalRC3m866XzRqT/TqqWRAIl6AQA90tSGk37NINGEz9yRwk4SCJSnXCgJFNxfxHuR1ysi7BTu3ZDojjGfeDeq3vf7MJ9ssiQxGfADHiitAEp0fUAd0oLmwak1fl/nf7YZVKrtVwMbuMX6XJlcCN/K0UDa34mDKzGrxpgYK0CuFNFVitbdy3lhF3Fz5c16g6pimZQ9C+3q2EYljw+3l8hAM0kg4quogxGBZemV83FblT3JXNtg7xjGOC+mM1L52rFpnJLKkrQwRHBMy4kJ8fPI3Z4eDY7jPgX4E4It1ZYusYUZ1/jXnIGCbieLg5xH/hx6tWrVwM7cMd4t+jwlbkVluaQMVp7RTtc1Vj32GfGcj409OaMBeBePRGrf9p7NVAk047n10loc2mY2Eu2JG236hDrgr4VWAHuVmvAjOUahLEJGkjnSoqW9T1D1Yrng0Psu8wL5R3HJ5dzQkNDu5YXb7Q8K64bVJbr0gbmH+PDwsK6VDk4zkzG0lgTGKrGSrmWWbVE/D36k9gBKuzhIY+Sk5Pz21r6+lZXWy5Q/zzuVBLoNES6SaNRltnWBNd0+lsjPcEB7vj7UwD3qfu7snuLjnxhWN0RxOyHm/V8wZfx6b0+M+JapVI5avG/pVY1llfDqrnivqKMVqk4yczI2ZbdrdYRxJqvLrRaqVZrTTrAfUPB07T20cIK47D4TN14m7y1uUYPcNdqwB7qrbifN+u53BGAuwpUfrgiIye4jd3pfytRtBwlhfXPcke1AmUaitFBod0nwQ/Antwsmll99+7dykrf8D6JxtODTKfTyfRTH4c7BSnibsrLSadPJ1njenRQfpa/tezjHON+Z2pq6t5O3J/oO6bBqBRmNAWZuvWZmvhyeXLkjBxmMBhai39wDS99PCdvSJAlbZUyaAIwulyCWKm27A6sZps1PndYDaxq+QSuxW7dwj1a1ERvYcC56vGTdcYubrVAwgW4F4lBM7VhcVara4PhuXa4s6RcmAskFSyOqXtvQyXp8vG0WI8ZudiYXS9UoBwdEHGeXEBqe9aLtyvv369m/vPtymrJ3rjjZVIiMmXZwwgH+Z2RE+76Idw9yyi+x5zjrBeLbFNzawRoTXDDOQ4zdwDw3+zE3Ts+lROG6BSFWhAfR/WuvH4tMDbKjcPhpEQ5QYTIUiwg1oMUEB7NIqekpBSHgwRk2/IuqxNixWxZNxQYgIW8Peis+PNUVkze6dAwVlCIe15iHIdDCvC6nZeYWuKV5hQYkBZdGmP94GSXYDL4dDcueKUSIEzpFzFOUKSbE8rRAZH36+7k5ImR+rf/ebvSt7bWsbK+/h1mz/xJ/klnTyCPWizyMjI2axFQ9u2S+4fCDAThfI/ZJ7cDvJo1CoA7zmGYwWKR8n6ftesmgn0vSNY/toN031yx8cKRMB98b+MeAnSK5XAr4XVWa9ODjHKA+8+/rq398n59/UXkniyTz7Quy+y438z3g6DSWoe42zML4cTJzVV515ERpLPjoSqW9d2dH1nYj8AdFao/Gt0LXjcOGgyGn/7175XVtbW1wR/W1/8Rube678AdwsT7QQVeQZcc4W6fYCfi3bZ2hHNFJiKdHeOO7X/RH4fijur/qYLXpibNnPCnl2/+y/117Zf5Nz+8mcb9RnWHAuP9orsvxd/1d4Q7Lpyy386OuBAd4x53kndsN+5EZ1f79NHmMAFD2ZaHiJSPSx846p8/U1Q0oR+K7F6rbBVKX75Z/fnvD7gvX75ZXtz7TSdlMY+WXT7mawrbwD248kSN8Zwj3CGK2z68e4bv6UjbcMeTvYp3486JwqchQHufPw5hfAiYguLiuLPXth19FIhIgR7M21Bkmb93MZNp7YCYjf+FInrae0NAyPZbGiLJF6GCuG1rosnINnGhzHMYFjMNWbriWOHIjcM2xH08wLI0FaXlwMun5H/snftPWlkewCPkNpOLCIqXN4pQRASUh4ioiJGxig9URAHfVfHNw0db8dGK1mfU2jTtWKsxNmm0VbeTTFr7S6vd7sb5oWni/LCb7PwDbbY/7iTzw26y50KnD1+z7XaTrT0fxXtFuNdcPufwPYdzzjcn79xMUe0vr16/fv3rK6B7UeHBR0U29vMvnmss1gZrSZlah1BQl/z0kbojzHQa54OqnMIk0w92cX4wZsadu38QQYEttzyCS2YOy9OZZzXldYbc0DTzZZTMJHIoKIeISWyxXFqHIdKQXlWpzIhz4Q0ELi1bo0TJGJWDOfmFRAxDqDSLHHjPJVOoTBoT/xBgOytHHsYlh3AoRA74i+sKXnC5qd22BH4kK9fdbSNbzunxe5iBJ7BtsbJsdQ+RRkIyyExwBvi50pcKpUAdk9eYV7v48vXrl3/7+edfLIc9CrvYz8LezZjm4jF4xnuzHg4OAEZp6XQy7S1kejp2yAe2xw8Ro7JtkTqnmC9NFRkMqVMpml5QE5tzLQb5GWGhRJVgMN91G4QKebZI6WQpEVkVUJQtNjIqBQnilFCxUVGpkhgMp7oNedVhCDiOyskyyAkIeGdS5cjB7zpGGVuYhSRrGoPvU04pQx6h1iNOW2GBBlTmbKFEagBvIGxbuEXcqAPHuizhGxPERjgm7Auu311iUUzM1N9fvvz1X6/+6Tq8SRvJYB53kMOmd4D6l/kWDnro6ITfGRFZYGNUi3vYN6Os4Wa9pjw/Cddda8SqjOYkV4pGWSdi2MoLDOLiJJlaibCtIJapE+nZrCSnIk9n7mWnxN2Ud0lTCi3VETJ1Wba0zRaXr0SSWZFSllytz2Zp5QwBJVMt7OoNnC1f3yEPU4Dn68OIVWW4/i5buDkJ6M5IwTTGLmOXoFtTLJSWMaE2X279jmJpkZG5BZK/Pn9uoX3aMf5Hk/dwzzQ97JgoIzNfpVHmCELQbLNCzqkS5CstVqD73fBuqZIrSYnFdXcJ8Nl53dIofm6+yixIuczmA90ZDGtsVXVEhqYsWdomx/LLkWTpZdfFao3+LKvMLAL2G7SDOgxFss16Sp2VrlGx9CEgXgvo3i3ngvKB/xskjfymkREliozp7ZbCUQNfN59/ajYWqG+tDLmExW+MMqZr9OoUt8bKiuJH8qXWU1WiGHmOSCpisKRRGpaekK0o5ypUQFqngp9bJahKkaqEhd9qVC6+MNySYgYFIYHPV6XpmJYk5KyiMLNLkMA36EJyrCEIkcJVl1sKkWGRsS28iq+TgG2sLAcozdZKdBmKJPBvuFmsPJ1FakztksYIWVIlfMWh7p8C7YjqPTzQGnSLxYwCN8OqEmvBl0Er5vPxHb5Yq+UbjOAmFvMNYKPVgrvBtzANtBlIYSgJxUgoGoFwSFQuIUJGI+E9LFwChYoiKAXBm6ccDkICLc43PZQoN5KJUDEagYLSQgJb/HEIFTSIwQ7VjZ/TgJ8TPzfYzYWvONT9U6Bi4XGHQA524lA4HNTZ1nYG5fyHfHKXybH995TPdhrI1617cNGM/XzQrKWGwesLOSm6QyBQdwgE6g6BQN0hEKg7BAJ1h0Cg7hAI1B0COag7lQCBfB18A2p3JgTyVRDyDQxmIDB2h0Cg7hAI1B0CgbpDIFB3CATqDoFA3SGQ/wPdqRzSQZhwMijkJOqO0tNCDyGOBK8p5MTpTqUfsc5MHAovKuSk6c45c9QqYjR4USEnTfffWTSP6EwN4GYiT6fiXAqFQnvq2zs6hJ1Xfs962vlb6uv0d7FRQSpDWNUY5Q4E/5uVeBa+jIK0IPSMh4IwhINhGKdDGFLX2NsxVR6B1OUlEe9VBpc97jAE0os4FUGEcYw3e3AdJcjxulOZBDL9LWQCGvbxumfO4ml/eU0LvbLHDWJ7Io/XWTLsqbHOXnhi35L/4A0kvu4cqX57vEdjvMSG86Uz7dVhdTcL5xt6uGmxm+Px8fE8cBuVeK5Xmmejoxf25uOLx1oX7I5JOfGxr4dY34CviUqs86/0UMH2Wmcpr7OTx1tgeRzg+ImJraNwrRvIcbqT6HQa9g4COZ3M+WjdZffGJhrzrnlWepe8poqh/sGxzu2lpvYrY46FoZFtVx5g0L67/i5XdvId+4jtuW/v2UbW9967052T4w17w4O1tR7Tk9pa63yryTHh9zUP7Dhrp1rWTBeia6qHPdcLZUHd6xYdG5La6tPI45XB2wO+83O2zb5V4WyN9eEfb0DdIUfrTqWl788jQ8HSSR+rOyKrX1ciy0OrWR2Liec8o8+iJ/XTjpqLY501Hl8Jntxs+Hbik/fW490s8pqi+0wN0TWV9t0LraaF5oFt/O6hLRDWEB9P2K8mLF512ncsrG4/jxe/tt47b7pUO+dxTMzJXXbHaNq0aQfovjXW1F5R5N1Z7ludGr8wMwh1hxynO4F+SM8552AGmw90Dz2oO7I0MMqdHhEgsselU32l7dEV23eGthrHKgAbQPfMacdG7HvHqxu0O/rHWidbJrr8rSX1pfrlvj1QJvy7I3MlsbJrFd7SGWC8/VbLhWLP1vnz4ytG++71sQpQRiqK6xM36LOtq5cRoHtLYlFz0cCtjr5LRQOO9maoO+QY3ZnB/KnUfSkMmAcKwXu6u+/fv+8+oHvyA9/cwK0s4kOvacHbMFHrvXHN67vi50Wv8fbw4H5x5YPFp9n5fkfN3NCM/xYIZnrmecXPEquRjsVO70hL4o245+0mXzOu+87TtZK19bk5/4r2dtPV9GxQLmgkiZA2PzApOoMQZ7damvpn5rxA99GnfY4SlwfqfoLITH706FEm5b9Y2naf7nQM/0ljid+E67KC3EBmGxrhSN1DN1/848Vm6IFEk0+9uyt6hHjP7pN6KmqexQse9pVe8azP3faWvKe7jBksWZtrJlNNpce0/mMIrnvpXPykIAcEKdMrqvrOW7FLretRi7juw+Mlnq3m5vGf9HX+q1lvYvfMee+qxbMaK5tev1ZR1LnQvrfcN2n3VTQ9gbX7yQEd/vMfAMv08PBwevbZz6B7MDk2LWZyghX0natuvJsVqN6pR+v+3Yvvlvd3RCar/a2tjgkBAflLfJtnxr97qTDzga/f0wBCjRKESkoO6k5cuhJMl3Q29faI7ofWkZjm6u+9f1o6r0qYj84r2sbqfb3JsxtpD3y8mvGt2qadzb7R5prm5qJLyszF33Rnz/67vXMNaurKA7jJ7clMwyMJSQg3ZGMeJCSbC0IekIRHeCVQnmkMsGqsZBewIqazsFDqqxaxrc3U7bhp1Z1tpBKzy45bOoBdHhl3O6tUrBQcsKxfFhE/4dbVttOdbvfD3nsDFCGhTqfOLHp+M3DJvSfnZuB3//n/zz3h7D+q3nN+y7P8V17ue+7UoX27L5/e+1zFNeWxVqj7YwPjTx8Qth/3swj8I+awLZldHk9//EPoHk+MXnPFLS3bDoroweiuscrJ64C+tu4ronv787sOv2N7ddeW3/Ne+YT3wuZN9ZuOsH734psvvFTx2i+fBQNndu96mxgxzzn/cjCDL/jwD4ff+snW+o0vXfzj/k8qtlZUHPpzm5mB/fxwG8iO++zFv7zb+rMtP9311zP7f3G0FWef3klG981tADn5zMebNm+uf+a9U3tf3/vb5zd1n3/bcWhLPb6r/mOo++MC/7MbEzdGPxgJ+AkCI5PhEpqo2anh4Zu+/qXrhBFO9zhCd5aMJhYZUfLuKLbnDXLNYQYrrO6uHlz3nqIHdU879qaaApyat7o/2nou+czRc80HrOyz9tK/XWjZUbEdOPt27pPEkO2uBX10Htt4pLnBfHLjO/K03+wkaN2egJ//5NFU4j1gmxwz951THrj8of1s684KvN69nH3sCAU7+boWgMYdB1tqZaKrv045IBVd3X0htT1d+eqFgzg7tnZD3R8PkEu47KOjNZ0jxwludZaGXlYOYfcO5xK4u4LpeDNqyFsrujPpDLEIBBfcY8TVtKSuqXvkYB+ue9/gitydzljYYGwK08yNARgdMAEioOAJEoVYDZuxMO65+KIFbGJdGoz8Ti60ETyhIFgkE9/iKcT6M8RzBVwul4GwqdHEkqtgcQUPhAGIo2SPGHdhHWG41N7jUqb2vH/jyyujCkXgFkFAoeCGbughbR++mdtLDp83yiotlDVzd0C3ihZ21KHFViLpiM8Mm7sP3hv9dPTe4KpSFQL5EXH2fP3FlSv/yVR0BlEookI1i6H7CNtvDrlzp4jwjpXoOR3hkhlmLHlFMNKFizG3uaGDSAeoYUdmIgfv3/vvvftQd8ij1X3iU1L30q5+gq5SRei5iFzcc/fU0Oxw7s3bxJvCVSsq6wg3EBkRHIGhrygDVlWq3+leNHj/28Fvoe6QR5u6Iz0ncN1HSxXB3H1EwQqZzCDxbjy0e4n8fYooVrGmi1jTr8LpHs1mh1gkm565qutl0f2bu7S736ypO5OLXz4Id1Up7Yxc3FVAozzwBPPy+7h0Fp6lLzxdgB/Ixr+ILSDye+Zitwj5HEEm0RGdulShCtaakFxwOw+atE64dOKrz698+VHXgu79nWE+WDGEx3U3kb+7SWkLq3my1HC6A0ZU1Kpu4mKpMWF1p92tiqRFVt19UPdsznKPnDz8UbZQvjLPatcnLKjKR5cfxJoT0797iYgyHdUCvpicE8zT5bNtiZJYfJuX3IQ3EvCCZ8rmJaYnlWWnmCQUJmiuXuzOOTsf3uiYgV4t9Gi91KoTX/0b9/14oIsgcKsLCd2uy00OzOROeYMRrdBUyQirO2BSM9kR8fQlKNzYEDPEvm+KWHut2sypjMjgCFm0BDPNWNRhjnRRk4UWerKQFg0w/CeBsVKpZ7m4SiG1wOiQyYmdRfHJnMo4kFOexWQIOFVcF0cYARA2XWNAHOQIEZ3Nl/GS2GhbBF9lKXyjDdfcqDASXSZXl2EOiRlt0HOqcjSyxbmWp+fcbU6/1xvR5em/HTVp6bTUeSrNXq/C7y0rCEz7oO7rhoH3T3zxj8//HiBvM036s8O16ydi+/CUJ9S4fIj57nRuVCZricyokB+3/h7d+eK2Ops4q0SiyUdTHVIVTyTioBajrppnMuKhGjPqum32KqXMri40OZJsBptVDtrxQ8JTBl0WHs9lBrbGgErFao0BT0v4aGpNfjlpJrJHz5Mgmix8m4dpcN3N5bZuoV0O9khiQI09o9xqcGS1221JCSAnoAXI+Pzs9Zq5oTnPnXlvr2duaHzG5/PNuIfGfXPz42Ozbqj7ugFzXpr419cTp9mxsbHsOCzsWzYS5ZntnekMefARfZrJiVoK88UGjbZxu01vd6kUZ6+ZyzmJOqteDTRZIC0lsZajy1cevMwtqU7Ui7QDKjkoNACHCS0rlJCC5xcnofl2eQ3ubTKaldZkqlXj+7FCfVljEqbLKtR3gKDuTbakAvxSaNyeABr1GkNpSXeHo1tn7QDZ/g7gnHO7x/w+7Z3r472e8V4cXPWh6THLnbGh63cuDsDovp7KVSzHmZODACaTuXY74kZMzI+qe1xY3cnh0AJUWG44ZUjpaEwqrZXwVTwUrUQbVDyr1GQUaUF7NW9bZbNKqkINDj3HkiIhonuNnqMTkrrTlS6HQSfhJBerNeronJKkIoXLWKx2UUGdWG2pQ4UijjjLQiF156tsEkL3NFStFGcVSlwl3RxVqkBjIDOz0z5vwDfTa/nn9WnffMDt8Y1N+oY8gbGy6bEZ7/jYOIzuTxY/VHcGK4ztGeSQSka5rNwqNokMKfrSJjVPpTLp7Kp0sVUmbaq1R+Jla4PQJRWyikqFLF5DmbmhgUMBmFJaFeeKq7MAerNUncdvUGfI8tURxCMpDWCuUqkcmKVSNVUptZht+BZJLiNy9wwa3SgHGSnFtWK1QlZrL7fK1EJNPlkFd3mjEf9tL9d/2zOjTfN0+NWMyRlvp5finJ7R8qc9HjlUAOr+MOFdESq+RyqC96MUnCUckmUPSBRhumSCFcW2wLTcRnpUzBqvBz+JkRsR51o8SQbzwW4RgBAE5/IvdBQD//5Q94eN7xFU9iq4q0YxkdgfPm2FyYX/lAzy/6E7BAJ1h0Cg7hAI1B0CgbpDIFB3CATqDoE8tO4b4C8B8qSwYcNTT2+AQJ4Inn7qf3evwjA0KV9HAAAAAElFTkSuQmCC" width="750" height="86" class="img_ev3q"></p><p>Furthermore, communities often hold regular meetings, such as weekly or bi-weekly meetings, where you can stay updated on the community's latest progress, ask questions, and interact with other community members.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary-and-insights">Summary and Insights<a href="#summary-and-insights" class="hash-link" aria-label="Direct link to Summary and Insights" title="Direct link to Summary and Insights">​</a></h2><p>I initially joined the Seata community through the Open Source Summer Program. I completed my project, implemented new features for Seata Saga, and carried out a series of optimizations. However, I didn't stop there. My open-source experience with Seata provided me with the most valuable developer experience in my student career. Over time, I continued to stay active in the community through the aforementioned participation methods. This was mainly due to the following factors:</p><ol><li><p><strong>Communication and Networking:</strong> The mentorship system provided crucial support. During development, the close collaboration between my mentor and me played a key role in adapting to community culture and workflow. My mentor not only helped me acclimate to the community but also provided design ideas and shared work-related experiences and insights, all of which were very helpful for my development. Additionally, Seata community founder Ming Cai provided a lot of assistance, including establishing contacts with other students, helping with code reviews, and offering many opportunities.</p></li><li><p><strong>Positive Feedback:</strong> During Seata's development, I experienced a virtuous cycle. Many details provided positive feedback, such as my contributions being widely used and beneficial to users, and the recognition of my development efforts by the community. This positive feedback strengthened my desire to continue contributing to the Seata community.</p></li><li><p><strong>Skill Enhancement:</strong> Participating in Seata development greatly enhanced my abilities. Here, I could learn production-level code, including performance optimization, interface design, and techniques for boundary judgment. I could directly participate in the operation of an open-source project, including project planning, scheduling, and communication. Additionally, I gained insights into how a distributed transaction framework is designed and implemented.</p></li></ol><p>In addition to these valuable developer experiences, I gained some personal insights into participating in open source. To inspire other students interested in joining open-source communities, I made a simple summary:</p><ol><li><p><strong>Understand and Learn Community Culture and Values:</strong> Every open-source community has different cultures and values. Understanding a community's culture and values is crucial for successful participation. Observing and understanding the daily development and communication styles of other community members is a good way to learn community culture. Respect others' opinions and embrace different viewpoints in the community.</p></li><li><p><strong>Dare to Take the First Step:</strong> Don't be afraid of challenges; taking the first step is key to participating in open-source communities. You can start by tackling issues labeled "good-first-issue" or by contributing to documentation, unit tests, etc. Overcoming the fear of difficulties, actively trying, and learning are crucial.</p></li><li><p><strong>Have Confidence in Your Work:</strong> Don't doubt your abilities. Everyone starts from scratch, and no one is born an expert. Participating in open-source communities is a process of learning and growth that requires continuous practice and experience accumulation.</p></li><li><p><strong>Actively Participate in Discussions, Keep Learning Different Technologies:</strong> Don't hesitate to ask questions, whether about specific project technologies or challenges in the development process. Also, don't limit yourself to one domain. Try to learn and master different programming languages, frameworks, and tools. This broadens your technical perspective and provides valuable insights for the project.</p></li></ol><hr><p>Through my open-source journey, I accumulated valuable experience and skills. This not only helped me grow into a more valuable developer but also gave me a profound understanding of the power of open-source communities. However, I am not just an individual participant; I represent a part of the Seata community. Seata, as a continuously growing and evolving open-source project, has tremendous potential and faces new challenges. Therefore, I want to emphasize the importance of the Seata community and its future potential. It has entered the incubation stage of the Apache Software Foundation, a significant milestone that will bring broader development opportunities for Seata. Seata welcomes more developers and contributors to join us. Let's work together to drive the development of this open-source project and contribute to the advancement of the distributed transaction field.</p>]]></content>
        <author>
            <name>Yinxiangkun - Tsinghua University, participant in Seata Summer of Code</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata-Raft Storage Mode in Depth and Getting Started]]></title>
        <id>https://seata.apache.org/blog/seata-raft-detailed-explanation</id>
        <link href="https://seata.apache.org/blog/seata-raft-detailed-explanation"/>
        <updated>2023-10-13T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[From traditional storage and computing separation to integrated storage and computing relying on distributed consensus algorithms to ensure transaction data consistency under high availability mode, what changes has Seata 2.x made? This article will provide a detailed introduction to the architecture and performance comparison.]]></summary>
        <content type="html"><![CDATA[<ul><li><a href="#">1. Overview</a></li><li><a href="#">2. Architecture Introduction</a></li><li><a href="#">3. Deployment and Usage</a></li><li><a href="#">4. Benchmark Comparison</a></li><li><a href="#">5. Conclusion</a></li></ul><h1>1. Overview</h1><p>Seata is an open-source distributed transaction solution with over 24000 stars and a highly active community. It is dedicated to providing high-performance and user-friendly distributed transaction services in microservices architecture.</p><p>Currently, Seata's distributed transaction data storage modes include file, db, and redis. This article focuses on the architecture, deployment and usage, benchmark comparison of Seata-Server Raft mode. It explores why Seata needs Raft and provides insights into the process from research and comparison to design, implementation, and knowledge accumulation.</p><p>Presenter: Jianbin  Chen(funkye) github id: <a href="https://github.com/funky-eyes" target="_blank" rel="noopener noreferrer">funky-eyes</a></p><h1>2. Architecture Introduction</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="21-what-is-raft-mode">2.1 What is Raft Mode?<a href="#21-what-is-raft-mode" class="hash-link" aria-label="Direct link to 2.1 What is Raft Mode?" title="Direct link to 2.1 What is Raft Mode?">​</a></h2><p>Firstly, it is essential to understand what the Raft distributed consensus algorithm is. The following excerpt is a direct quote from the official documentation of sofa-jraft:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RAFT is a novel and easy-to-understand distributed consensus replication protocol proposed by Diego Ongaro and John Ousterhout at Stanford University. It serves as the central coordination component in the RAMCloud project. Raft is a Leader-Based variant of Multi-Paxos, providing a more complete and clear protocol description compared to protocols like Paxos, Zab, View Stamped Replication. It also offers clear descriptions of node addition and deletion. As a replication state machine, Raft is the most fundamental component in distributed systems, ensuring ordered replication and execution of commands among multiple nodes, guaranteeing consistency when the initial states of multiple nodes are consistent.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">In summary, Seata's Raft mode is based on the Sofa-Jraft component, implementing the ability to ensure the data consistency and high availability of Seata-Server itself.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="22-why-raft-mode-is-needed">2.2 Why Raft Mode is Needed<a href="#22-why-raft-mode-is-needed" class="hash-link" aria-label="Direct link to 2.2 Why Raft Mode is Needed" title="Direct link to 2.2 Why Raft Mode is Needed">​</a></h2><p>After understanding the definition of Seata-Raft mode, you might wonder whether Seata-Server is now unable to ensure consistency and high availability. Let's explore how Seata-Server currently achieves this from the perspectives of consistency and high availability.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="221-existing-storage-modes">2.2.1 Existing Storage Modes<a href="#221-existing-storage-modes" class="hash-link" aria-label="Direct link to 2.2.1 Existing Storage Modes" title="Direct link to 2.2.1 Existing Storage Modes">​</a></h3><p>In the current Seata design, the role of the Server is to ensure the correct execution of the two-phase commit for transactions. However, this depends on the correct storage of transaction records. To ensure that transaction records are not lost, it is necessary to drive all Seata-RM instances to perform the correct two-phase commit behavior while maintaining correct state. So, how does Seata currently store transaction states and records?</p><p>Firstly, let's introduce the three transaction storage modes supported by Seata: file, db, and redis. In terms of consistency ranking, the db mode provides the best guarantee for transaction records, followed by the asynchronous flushing of the file mode, and finally the aof and rdb modes of redis.</p><p>To elaborate:</p><ul><li><p>The file mode is Seata's self-implemented transaction storage method. It stores transaction information on the local disk in a sequential write manner. For performance considerations, it defaults to asynchronous mode and stores transaction information in memory to ensure consistency between memory and disk data. In the event of Seata-Server (TC) unexpected crash, it reads transaction information from the disk upon restarting and restores it to memory for the continuation of transaction contexts.</p></li><li><p>The db mode is another implementation of Seata's abstract transaction storage manager (AbstractTransactionStoreManager). It relies on databases such as PostgreSQL, MySQL, Oracle, etc., to perform transaction information operations. Consistency is guaranteed by the local transactions of the database, and data persistence is the responsibility of the database.</p></li><li><p>Redis, similar to db, is a transaction storage method using Jedis and Lua scripts. It performs transaction operations using Lua scripts, and in Seata 2.x, all operations (such as lock competition) are handled using Lua scripts. Data storage is similar to db, relying on the storage side (Redis) to ensure data consistency. Like db, redis adopts a computation and storage separation architecture design in Seata.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="222-high-availability">2.2.2 High Availability<a href="#222-high-availability" class="hash-link" aria-label="Direct link to 2.2.2 High Availability" title="Direct link to 2.2.2 High Availability">​</a></h3><p>High availability is simply the ability of a cluster to continue running normally after the main node crashes. The common approach is to deploy multiple nodes providing the same service and use a registry center to real-time sense the online and offline status of the main node for timely switching to an available node.</p><p>It may seem that deploying a few more machines is all that's needed. However, there is a problem behind it – how to ensure that multiple nodes operate as a whole. If one node crashes, another node can seamlessly take over the work of the crashed node, including handling the data of the crashed node. The answer to solving this problem is simple: in a computation and storage separation architecture, store data in a shared middleware. Any node can access this shared storage area to obtain transaction information for all nodes' operations, thus achieving high availability.</p><p>However, the prerequisite is that computation and storage must be separated. Why is the integration of computation and storage not feasible? This brings us to the implementation of the File mode. As described earlier, the File mode stores data on local disks and node memory, with no synchronization in data writing operations. This means that the current File mode cannot achieve high availability and only supports single-machine deployment. For basic quick start and simple use, the File mode has lower applicability, and the high-performance, memory-based File mode is practically no longer used in production environments.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="23-how-is-seata-raft-designed">2.3 How is Seata-Raft Designed?<a href="#23-how-is-seata-raft-designed" class="hash-link" aria-label="Direct link to 2.3 How is Seata-Raft Designed?" title="Direct link to 2.3 How is Seata-Raft Designed?">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="231-design-principles">2.3.1 Design Principles<a href="#231-design-principles" class="hash-link" aria-label="Direct link to 2.3.1 Design Principles" title="Direct link to 2.3.1 Design Principles">​</a></h3><p>The design philosophy of Seata-Raft mode is to encapsulate the File mode, which is unable to achieve high availability, and use the Raft algorithm to synchronize data between multiple TCs. This mode ensures data consistency among multiple TCs when using the File mode and replaces asynchronous flushing operations with Raft logs and snapshots for data recovery.</p><p><img loading="lazy" src="https://blog.funkye.icu/img/blog/Dingtalk_20230105203431.jpg" alt="flow" class="img_ev3q"></p><p>In the Seata-Raft mode, the client-side, upon startup, retrieves its transaction group (e.g., default) and the IP addresses of relevant Raft cluster nodes from the configuration center. By sending a request to the control port of Seata-Server, the client can obtain metadata for the Raft cluster corresponding to the default group, including leader, follower, and learner member nodes. Subsequently, the client monitors (watches) any member nodes of non-leader nodes.</p><p>Assuming that TM initiates a transaction, and the leader node in the local metadata points to the address of TC1, TM will only interact with TC1. When TC1 adds global transaction information, through the Raft protocol, denoted as step 1 in the diagram, TC1 sends the log to other nodes. Step 2 represents the response of follower nodes to log reception. When more than half of the nodes (such as TC2) accept and respond successfully, the state machine (FSM) on TC1 will execute the action of adding a global transaction.</p><p><img loading="lazy" src="https://blog.funkye.icu/img/blog/Dingtalk_20230105204423.jpg" alt="watch" class="img_ev3q">
<img loading="lazy" src="https://blog.funkye.icu/img/blog/Dingtalk_20230105211035.jpg" alt="watch2" class="img_ev3q"></p><p>If TC1 crashes or a reelection occurs, what happens? Since the metadata has been obtained during the initial startup, the client will execute the watch follower node's interface to update the local metadata information. Therefore, subsequent transaction requests will be sent to the new leader (e.g., TC2). Meanwhile, TC1's data has already been synchronized to TC2 and TC3, ensuring data consistency. Only at the moment of the election, if a transaction happens to be sent to the old leader, it will be actively rolled back to ensure data correctness.</p><p>It is important to note that in this mode, if a transaction is in the phase of sending resolution requests or the one-phase process has not yet completed at the moment of the election, and it happens exactly during the election, these transactions will be actively rolled back. This is because the RPC node has crashed or a reelection has occurred, and there is currently no implemented RPC retry. The TM side has a default retry mechanism of 5 times, but due to the approximately 1s-2s time required for the election, transactions in the 'begin' state may not successfully resolve, so they are prioritized for rollback to release locks, avoiding impacting the correctness of other business.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="232-fault-recovery">2.3.2 Fault Recovery<a href="#232-fault-recovery" class="hash-link" aria-label="Direct link to 2.3.2 Fault Recovery" title="Direct link to 2.3.2 Fault Recovery">​</a></h3><p>In Seata, when a TC experiences a failure, the data recovery process is as follows:</p><p><img loading="lazy" src="https://blog.funkye.icu/img/blog/Dingtalk_20230106231817.jpg" alt="recover" class="img_ev3q"></p><p>As shown in the above diagram:</p><ul><li><p>Check for the Latest Data Snapshot: Firstly, the system checks for the existence of the latest data snapshot file. The data snapshot is a one-time full copy of the in-memory data state. If there is a recent data snapshot, the system directly loads it into memory.</p></li><li><p>Replay Based on Raft Logs After Snapshot: If there is the latest snapshot or no snapshot file, the system replays the data based on the previously recorded Raft logs. Each request in Seata-Server ultimately goes through the ServerOnRequestProcessor for processing, then moves to the specific coordinator class (DefaultCoordinator or RaftCoordinator), and further proceeds to the specific business code (DefaultCore) for the corresponding transaction processing (e.g., begin, commit, rollback).</p></li><li><p>After the log replay is complete, the leader initiates log synchronization and continues to execute the related transaction's add, delete, and modify actions.</p></li></ul><p>Through these steps, Seata can achieve data recovery after a failure. It first attempts to load the latest snapshot, if available, to reduce replay time. Then, it replays based on Raft logs to ensure the consistency of data operations. Finally, through the log synchronization mechanism, it ensures data consistency among multiple nodes.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="233-business-processing-synchronization-process">2.3.3 Business Processing Synchronization Process<a href="#233-business-processing-synchronization-process" class="hash-link" aria-label="Direct link to 2.3.3 Business Processing Synchronization Process" title="Direct link to 2.3.3 Business Processing Synchronization Process">​</a></h3><p><img loading="lazy" src="https://blog.funkye.icu/img/blog/Dingtalk_20230106230931.jpg" alt="flow" class="img_ev3q">
For the case where the client side is obtaining the latest metadata while a business thread is executing operations such as begin, commit, or registry, Seata adopts the following handling:</p><ul><li><p>On the client side:</p><ul><li>If the client is executing operations like begin, commit, or registry, and at this moment, it needs to obtain the latest metadata, the RPC request from the client might fail since the leader may no longer exist or is not the current leader. </li><li>If the request fails, the client receives an exception response, and in this case, the client needs to roll back based on the request result.</li></ul></li><li><p>TC side for detecting the old leader:</p><ul><li>On the TC side, if the client's request reaches the old leader node, TC checks if it is the current leader. If it is not the leader, it rejects the request.</li><li>If it is the leader but fails midway, such as failing during the process of submitting a task to the state machine, the creation of the task (createTask) fails due to the current state not being the leader. In this case, the client also receives a response with an exception.</li><li>The old leader's task submission also fails, ensuring the consistency of transaction information.</li></ul></li></ul><p>Through the above handling, when the client obtains the latest metadata while a business operation is in progress, Seata ensures data consistency and transaction correctness. If the client's RPC request fails, it triggers a rollback operation. On the TC side, detection of the old leader and the failure of task submission prevent inconsistencies in transaction information. This way, the client's data can also maintain consistency.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-usage-and-deployment">3. Usage and Deployment<a href="#3-usage-and-deployment" class="hash-link" aria-label="Direct link to 3. Usage and Deployment" title="Direct link to 3. Usage and Deployment">​</a></h2><p>In terms of usage and deployment, the community adheres to the principles of minimal intrusion and minimal changes. Therefore, the overall deployment should be straightforward. The following sections introduce deployment changes separately for the client and server sides.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-client">3.1 Client<a href="#31-client" class="hash-link" aria-label="Direct link to 3.1 Client" title="Direct link to 3.1 Client">​</a></h3><p>Firstly, those familiar with the use of registry configuration centers should be aware of the <code>seata.registry.type</code> configuration item in Seata's configuration, supporting options like Nacos, ZooKeeper, etcd, Redis, etc. After version 2.0, a configuration item for Raft was added.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">   registry:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type: raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      raft:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         server-addr: 192.168.0.111:7091, 192.168.0.112:7091, 192.168.0.113:7091</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Switch the <code>registry.type</code> to 'raft' and configure the address for obtaining Raft-related metadata, which is unified as the IP of the seata-server + HTTP port. Then, it is essential to configure the traditional transaction group.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">seata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   tx-service-group: default_tx_group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      vgroup-mapping:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         default_tx_group: default</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If the current transaction group used is <code>default_tx_group</code>, then the corresponding Seata cluster/group is 'default'. There is a corresponding relationship, and this will be further explained in the server deployment section.
With this, the changes on the client side are complete.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-server">3.2 Server<a href="#32-server" class="hash-link" aria-label="Direct link to 3.2 Server" title="Direct link to 3.2 Server">​</a></h3><p>For server-side changes, there might be more adjustments, involving familiarity with some tuning parameters and configurations. Of course, default values can be used without any modifications.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">seata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    raft:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      group: default # This value represents the group of this raft cluster, and the value corresponding to the client's transaction group should match it.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      server-addr: 192.168.0.111:9091,192.168.0.112:9091,192.168.0.113:9091 # IP and port of the 3 nodes, the port is the netty port of the node + 1000, default netty port is 8091</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      snapshot-interval: 600 # Take a snapshot every 600 seconds for fast rolling of raftlog. However, making a snapshot every 600 seconds may cause business response time jitter if there is too much transaction data in memory. But it is friendly for fault recovery and faster node restart. You can adjust it to 30 minutes, 1 hour, etc., according to the business. You can test whether there is jitter on your own, and find a balance point between rt jitter and fault recovery.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      apply-batch: 32 # At most, submit raftlog once for 32 batches of actions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      max-append-bufferSize: 262144 # Maximum size of the log storage buffer, default is 256K</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      max-replicator-inflight-msgs: 256 # In the case of enabling pipeline requests, the maximum number of in-flight requests, default is 256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      disruptor-buffer-size: 16384 # Internal disruptor buffer size. If it is a scenario with high write throughput, you need to appropriately increase this value. Default is 16384</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      election-timeout-ms: 1000 # How long without a leader's heartbeat to start a new election</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      reporter-enabled: false # Whether the monitoring of raft itself is enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      reporter-initial-delay: 60 # Interval of monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serialization: jackson # Serialization method, do not change</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      compressor: none # Compression method for raftlog, such as gzip, zstd, etc.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      sync: true # Flushing method for raft log, default is synchronous flushing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # support: nacos, consul, apollo, zk, etcd3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type: file # This configuration can choose different configuration centers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  registry:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # support: nacos, eureka, redis, zk, consul, etcd3, sofa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type: file # Non-file registration center is not allowed in raft mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  store:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # support: file, db, redis, raft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode: raft # Use raft storage mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    file:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dir: sessionStore # This path is the storage location of raftlog and related transaction logs, default is relative path, it is better to set a fixed location</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In 3 or more nodes of seata-server, after configuring the above parameters, you can directly start it, and you will see similar log output, which means the cluster has started successfully:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.392  WARN --- [Rpc-netty-server-worker-10-thread-1] [com.alipay.sofa.jraft.rpc.impl.BoltRaftRpcFactory] [ensurePipeline] []: JRaft SET bolt.rpc.dispatch-msg-list-in-default-executor to be false for replicator pipeline optimistic.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.439  INFO --- [default/PeerPair[10.58.16.231:9091 -&gt; 10.58.12.217:9091]-AppendEntriesThread0] [com.alipay.sofa.jraft.storage.impl.LocalRaftMetaStorage] [save] []: Save raft meta, path=sessionStore/raft/9091/default/raft_meta, term=4, votedFor=0.0.0.0:0, cost time=25 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.441  WARN --- [default/PeerPair[10.58.16.231:9091 -&gt; 10.58.12.217:9091]-AppendEntriesThread0] [com.alipay.sofa.jraft.core.NodeImpl] [handleAppendEntriesRequest] []: Node &lt;default/10.58.16.231:9091&gt; reject term_unmatched AppendEntriesRequest from 10.58.12.217:9091, term=4, prevLogIndex=4, prevLogTerm=4, localPrevLogTerm=0, lastLogIndex=0, entriesSize=0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.442  INFO --- [JRaft-FSMCaller-Disruptor-0] [io.seata.server.cluster.raft.RaftStateMachine] [onStartFollowing] []: groupId: default, onStartFollowing: LeaderChangeContext [leaderId=10.58.12.217:9091, term=4, status=Status[ENEWLEADER&lt;10011&gt;: Raft node receives message from new leader with higher term.]].</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.449  WARN --- [default/PeerPair[10.58.16.231:9091 -&gt; 10.58.12.217:9091]-AppendEntriesThread0] [com.alipay.sofa.jraft.core.NodeImpl] [handleAppendEntriesRequest] []: Node &lt;default/10.58.16.231:9091&gt; reject term_unmatched AppendEntriesRequest from 10.58.12.217:9091, term=4, prevLogIndex=4, prevLogTerm=4, localPrevLogTerm=0, lastLogIndex=0, entriesSize=0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.459  INFO --- [Bolt-default-executor-4-thread-1] [com.alipay.sofa.jraft.core.NodeImpl] [handleInstallSnapshot] []: Node &lt;default/10.58.16.231:9091&gt; received InstallSnapshotRequest from 10.58.12.217:9091, lastIncludedLogIndex=4, lastIncludedLogTerm=4, lastLogId=LogId [index=0, term=0].</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.489  INFO --- [Bolt-conn-event-executor-13-thread-1] [com.alipay.sofa.jraft.rpc.impl.core.ClientServiceConnectionEventProcessor] [onEvent] []: Peer 10.58.12.217:9091 is connected</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.519  INFO --- [JRaft-Group-Default-Executor-0] [com.alipay.sofa.jraft.util.Recyclers] [&lt;clinit&gt;] []: -Djraft.recyclers.maxCapacityPerThread: 4096.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.574  INFO --- [JRaft-Group-Default-Executor-0] [com.alipay.sofa.jraft.storage.snapshot.local.LocalSnapshotStorage] [destroySnapshot] []: Deleting snapshot sessionStore/raft/9091/default/snapshot/snapshot_4.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.574  INFO --- [JRaft-Group-Default-Executor-0] [com.alipay.sofa.jraft.storage.snapshot.local.LocalSnapshotStorage] [close] []: Renaming sessionStore/raft/9091/default/snapshot/temp to sessionStore/raft/9091/default/snapshot/snapshot_4.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.689  INFO --- [JRaft-FSMCaller-Disruptor-0] [io.seata.server.cluster.raft.snapshot.session.SessionSnapshotFile] [load] []: on snapshot load start index: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.694  INFO --- [JRaft-FSMCaller-Disruptor-0] [io.seata.server.cluster.raft.snapshot.session.SessionSnapshotFile] [load] []: on snapshot load end index: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.694  INFO --- [JRaft-FSMCaller-Disruptor-0] [io.seata.server.cluster.raft.RaftStateMachine] [onSnapshotLoad] []: groupId: default, onSnapshotLoad cost: 110 ms.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.694  INFO --- [JRaft-FSMCaller-Disruptor-0] [io.seata.server.cluster.raft.RaftStateMachine] [onConfigurationCommitted] []: groupId: default, onConfigurationCommitted: 10.58.12.165:9091,10.58.12.217:9091,10.58.16.231:9091.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.705  INFO --- [JRaft-FSMCaller-Disruptor-0] [com.alipay.sofa.jraft.storage.snapshot.SnapshotExecutorImpl] [onSnapshotLoadDone] []: Node &lt;default/10.58.16.231:9091&gt; onSnapshotLoadDone, last_included_index: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">last_included_term: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peers: "10.58.12.165:9091"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peers: "10.58.12.217:9091"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peers: "10.58.16.231:9091"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2023-10-13 17:20:06.722  INFO --- [JRaft-Group-Default-Executor-1] [com.alipay.sofa.jraft.storage.impl.RocksDBLogStorage] [lambda$truncatePrefixInBackground$2] []: Truncated prefix logs in data path: sessionStore/raft/9091/default/log from log index 1 to 5, cost 0 ms.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="33-faq">3.3 faq<a href="#33-faq" class="hash-link" aria-label="Direct link to 3.3 faq" title="Direct link to 3.3 faq">​</a></h3><ul><li><p>Once the <code>seata.raft.server-addr</code> is configured, cluster scaling or shrinking must be done through the server's openapi. Directly changing this configuration and restarting won't take effect. The API for this operation is <code>/metadata/v1/changeCluster?raftClusterStr=new_cluster_list</code>.</p></li><li><p>If the addresses in <code>server-addr:</code> are all on the local machine, you need to add a 1000 offset to the netty ports of different servers on the local machine. For example, if <code>server.port: 7092</code>, the netty port will be 8092, and the raft election and communication port will be 9092. You need to add the startup parameter <code>-Dserver.raftPort=9092</code>. On Linux, this can be specified using <code>export JAVA_OPT="-Dserver.raftPort=9092"</code>.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-performance-test-comparison">4. Performance Test Comparison<a href="#4-performance-test-comparison" class="hash-link" aria-label="Direct link to 4. Performance Test Comparison" title="Direct link to 4. Performance Test Comparison">​</a></h2><p>Performance testing is divided into two scenarios. To avoid data hotspots and thread optimization, the client side initializes 3 million items and uses jdk21 virtual threads + Spring Boot3 + Seata AT for testing. Garbage collection is handled with the ZGC generational garbage collector. The testing tool used is Alibaba Cloud PTS. Server-side is uniformly configured with jdk21 (not yet adapted for virtual threads). Server configurations are as follows:</p><ul><li><p>TC: 4c8g * 3</p></li><li><p>Client: 4c <em> 8G </em> 1</p></li><li><p>Database: Alibaba Cloud RDS 4c16g</p></li><li><p>64 concurrent performance test only increases the performance of the <code>@GlobalTransactional</code> annotated interface with empty submissions.</p></li><li><p>Random 3 million data items are used for inventory deduction in a 32 concurrent scenario for 10 minutes.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-171-db-mode">4.1 1.7.1 db mode<a href="#41-171-db-mode" class="hash-link" aria-label="Direct link to 4.1 1.7.1 db mode" title="Direct link to 4.1 1.7.1 db mode">​</a></h3><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i3/O1CN011dNh3H1UK8G5prQAg_!!6000000002498-0-tps-731-333.jpg" alt="raft pressure test model" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="empty-submission-64c">Empty submission 64C<a href="#empty-submission-64c" class="hash-link" aria-label="Direct link to Empty submission 64C" title="Direct link to Empty submission 64C">​</a></h4><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01pE1Anf1nRtgcnlx9t_!!6000000005087-0-tps-622-852.jpg" alt="db64-2" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="random-inventory-deduction-32c">Random inventory deduction 32C<a href="#random-inventory-deduction-32c" class="hash-link" aria-label="Direct link to Random inventory deduction 32C" title="Direct link to Random inventory deduction 32C">​</a></h4><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN016hZkJC20OJax9ce31_!!6000000006839-0-tps-624-852.jpg" alt="db32-2" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-20-raft-mode">4.2 2.0 raft mode<a href="#42-20-raft-mode" class="hash-link" aria-label="Direct link to 4.2 2.0 raft mode" title="Direct link to 4.2 2.0 raft mode">​</a></h3><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01nNL6oe1X95YcQQEjs_!!6000000002880-0-tps-773-353.jpg" alt="raft pressure test model" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="empty-submission-64c-1">Empty submission 64C<a href="#empty-submission-64c-1" class="hash-link" aria-label="Direct link to Empty submission 64C" title="Direct link to Empty submission 64C">​</a></h4><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01rs1ykr1dhnH8qnXj3_!!6000000003768-0-tps-631-851.jpg" alt="raft64-2" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="random-inventory-deduction-32c-1">Random inventory deduction 32C<a href="#random-inventory-deduction-32c-1" class="hash-link" aria-label="Direct link to Random inventory deduction 32C" title="Direct link to Random inventory deduction 32C">​</a></h4><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i4/O1CN015OwA2k20enquV7Yfu_!!6000000006875-0-tps-624-856.jpg" alt="raft32c-2" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="43-test-result-comparison">4.3 Test Result Comparison<a href="#43-test-result-comparison" class="hash-link" aria-label="Direct link to 4.3 Test Result Comparison" title="Direct link to 4.3 Test Result Comparison">​</a></h3><p>32 concurrent random inventory deduction scenario with 3 million items</p><table><thead><tr><th>tps avg</th><th>tps max</th><th>count</th><th>rt</th><th>error</th><th>Storage Type</th></tr></thead><tbody><tr><td>1709 (42%↑)</td><td>2019 (21%↑)</td><td>1228803 (42%↑)</td><td>13.86ms (30%↓)</td><td>0</td><td>Raft</td></tr><tr><td>1201</td><td>1668</td><td>864105</td><td>19.86ms</td><td>0</td><td>DB</td></tr></tbody></table><p>64 concurrent empty pressure on <code>@GlobalTransactional</code> interface (test peak limit is 8000)</p><table><thead><tr><th>tps avg</th><th>tps max</th><th>count</th><th>rt</th><th>error</th><th>Storage Type</th></tr></thead><tbody><tr><td>5704 (20%↑)</td><td>8062 (30%↑)</td><td>4101236 (20%↑)</td><td>7.79ms (19%↓)</td><td>0</td><td>Raft</td></tr><tr><td>4743</td><td>6172</td><td>3410240</td><td>9.65ms</td><td>0</td><td>DB</td></tr></tbody></table><p>In addition to the direct comparison of the above data, by observing the curves of the pressure test, it can be seen that under the raft mode, TPS and RT are more stable, with less jitter, and better performance and throughput.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-summary">5. Summary<a href="#5-summary" class="hash-link" aria-label="Direct link to 5. Summary" title="Direct link to 5. Summary">​</a></h2><p>In the future development of Seata, performance, entry threshold, and deployment and operation costs are directions that we need to pay attention to and continuously optimize. After the introduction of the raft mode, Seata has the following characteristics:</p><ol><li>In terms of storage, after the separation of storage and computation, Seata's upper limit for optimization has been raised, making it more self-controlled.</li><li>Lower deployment costs, no need for additional registration centers, storage middleware.</li><li>Lower entry threshold, no need to learn other knowledge such as registration centers; one can directly use Seata Raft.</li></ol><p>In response to industry trends, some open-source projects such as ClickHouse and Kafka have started to abandon the use of ZooKeeper and instead adopt self-developed solutions, such as ClickKeeper and KRaft. These solutions ensure the storage of metadata and other information by themselves, reducing the need for third-party dependencies, thus reducing operational and learning costs. These features are mature and worth learning from.</p><p>Of course, currently, solutions based on the Raft mode may not be mature enough and may not fully meet the beautiful descriptions above. However, precisely because of such theoretical foundations, the community should strive in this direction, gradually bringing practice closer to the theoretical requirements. Here, all students interested in Seata are welcome to join the community, contributing to the development of Seata!</p>]]></content>
        <author>
            <name>funkye</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata:Bridging Data and Applications]]></title>
        <id>https://seata.apache.org/blog/seata-connect-data-and-application</id>
        <link href="https://seata.apache.org/blog/seata-connect-data-and-application"/>
        <updated>2023-06-30T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This article introduces the past, present, and future evolution of Seata.]]></summary>
        <content type="html"><![CDATA[<p>This article mainly introduces the evolutionary journey of distributed transactions from internal development to commercialization and open source, as well as the current progress and future planning of the Seata community.
Seata is an open-source distributed transaction solution designed to provide a comprehensive solution for distributed transactions under modern microservices architecture. Seata offers complete distributed transaction solutions, including AT, TCC, Saga, and XA transaction modes, supporting various programming languages and data storage schemes. Seata also provides easy-to-use APIs, extensive documentation, and examples to facilitate quick development and deployment for enterprises applying Seata.
<strong>Seata's advantages lie in its high availability, high performance, and high scalability, and it does not require extra complex operations for horizontal scaling.</strong> Seata is currently used in thousands of customer business systems on Alibaba Cloud, and its reliability has been recognized and applied by major industry manufacturers.
As an open-source project, the Seata community is also expanding continuously, becoming an important platform for developers to exchange, share, and learn, attracting more and more attention and support from enterprises.
Today, I will primarily share about Seata on the following three topics:</p><ul><li><strong>From TXC/GTS to Seata</strong></li><li><strong>Latest developments in the Seata community</strong></li><li><strong>Future planning for the Seata community</strong><br></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="from-txcgts-to-seata">From TXC/GTS to Seata<a href="#from-txcgts-to-seata" class="hash-link" aria-label="Direct link to From TXC/GTS to Seata" title="Direct link to From TXC/GTS to Seata">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-origin-of-distributed-transactions">The Origin of Distributed Transactions<a href="#the-origin-of-distributed-transactions" class="hash-link" aria-label="Direct link to The Origin of Distributed Transactions" title="Direct link to The Origin of Distributed Transactions">​</a></h4><p><img loading="lazy" alt="Product Matrix" src="/assets/images/产品矩阵-911645846cd62c27fb3e2aaef802b52e.jpg" width="1468" height="1316" class="img_ev3q">
Seata is internally codenamed TXC (taobao transaction constructor) within Alibaba, a name with a strong organizational structure flavor. TXC originated from Alibaba's Wushi (Five Color Stones) project, which in ancient mythology were the stones used by the goddess Nüwa to mend the heavens, symbolizing Alibaba's important milestone in the evolution from monolithic architecture to distributed architecture. During this project, a batch of epoch-making Internet middleware was developed, including the well-known "Big Three":</p><ul><li><strong>HSF service invocation framework</strong>
Solves service communication issues after the transition from monolithic applications to service-oriented architectures.</li><li><strong>TDDL database sharding framework</strong>
Addresses storage capacity and connection count issues of databases at scale.</li><li><strong>MetaQ messaging framework</strong>
Addresses asynchronous invocation issues.
The birth of the Big Three satisfied the basic requirements of microservices-based business development, but the data consistency issues that arose after microservices were not properly addressed, lacking a unified solution. The likelihood of data consistency issues in microservices is much higher than in monolithic applications, and the increased complexity of moving from in-process calls to network calls exacerbates the production of exceptional scenarios. The increase in service hops also makes it impossible for upstream and downstream services to coordinate data rollback in the event of a business processing exception. TXC was born to address the pain points of data consistency at the application architecture layer, and the core data consistency scenarios it aimed to address included:</li><li><strong>Consistency across services.</strong> Coordinates rollback of upstream and downstream service nodes in the event of system exceptions such as call timeouts and business exceptions.</li><li><strong>Data consistency in database sharding.</strong> Ensures internal transactions during logical SQL operations on business layers are consistent across different data shards.</li><li><strong>Data consistency in message sending.</strong> Addresses the inconsistency between data operations and successful message sending.
To overcome the common scenarios encountered, TXC was seamlessly integrated with the Big Three. When businesses use the Big Three for development, they are completely unaware of TXC's presence in the background, do not have to consider the design of data consistency, and leave it to the framework to ensure, allowing businesses to focus more on their own development, greatly improving development efficiency.<br>![GTS Architecture](/img/blog/GTS架构.jpg) TXC has been widely used within Alibaba Group for many years and has been baptized by the surging traffic of large-scale events like Singles' Day, significantly improving business development efficiency and ensuring data accuracy, eliminating financial and reputational issues caused by data inconsistencies. With the continuous evolution of the architecture, **a standard three-node cluster can now handle peak values of nearly 100K TPS and millisecond-level transaction processing. In terms of availability and performance, it has reached a four-nines SLA guarantee, ensuring no failures throughout the year even in unattended conditions.**<br></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-evolution-of-distributed-transactions">The Evolution of Distributed Transactions<a href="#the-evolution-of-distributed-transactions" class="hash-link" aria-label="Direct link to The Evolution of Distributed Transactions" title="Direct link to The Evolution of Distributed Transactions">​</a></h4><p>The birth of new things is always accompanied by doubts. Is middleware capable of ensuring data consistency reliable? The initial birth of TXC was just a vague theory, lacking theoretical models and engineering practice. After we conducted MVP (Minimum Viable Product) model testing and promoted business deployment, we often encountered faults and frequently had to wake up in the middle of the night to deal with issues, wearing wristbands to sleep to cope with emergency responses. These were the most painful years I went through technically after taking over the team.
<img loading="lazy" alt="Evolution of Distributed Transactions" src="/assets/images/分布式事务演进-cd118286fd5a0add7ecf5775e381a1f5.jpg" width="1488" height="702" class="img_ev3q">
Subsequently, we had extensive discussions and systematic reviews. We first needed to define the consistency problem. Were we to achieve majority consensus consistency like RAFT, solve database consistency issues like Google Spanner, or something else? Looking at the top-down layered structure from the application node, it mainly includes development frameworks, service invocation frameworks, data middleware, database drivers, and databases. We had to decide at which layer to solve the data consistency problem. We compared the consistency requirements, universality, implementation complexity, and business integration costs faced when solving data consistency issues at different levels. In the end, we weighed the pros and cons, decided to keep the implementation complexity to ourselves, and adopted the AT mode initially as a consistency component. We needed to ensure high consistency, but not be locked into specific database implementations, ensuring the generality of scenarios and the business integration costs were low enough to be easily implemented. This is also why TXC initially adopted the AT mode.
<strong>A distributed transaction is not just a framework; it's a system.</strong> We defined the consistency problem in theory, abstractly conceptualized modes, roles, actions, and isolation, etc. From an engineering practice perspective, we defined the programming model, including low-intrusion annotations, simple method templates, and flexible APIs, and defined basic and enhanced transaction capabilities (e.g., how to support a large number of activities at low cost), as well as capabilities in operations, security, performance, observability, and high availability.
<img loading="lazy" alt="Transaction Logical Model" src="/assets/images/事务逻辑模型-bd13bfb9738e5aca63823d268e543280.jpg" width="1482" height="656" class="img_ev3q">
What problems do distributed transactions solve? A classic and tangible example is the money transfer scenario. The transfer process includes subtracting balance and adding balance, how do we ensure the atomicity of the operation? Without any intervention, these two steps may encounter various problems, such as account B being canceled or service call timeouts, etc.
<strong>Timeout issues have always been a difficult problem to solve in distributed applications</strong>; we cannot accurately know whether service B has executed and in what order. From a data perspective, this means the money in account B may not be successfully added. After the service-oriented transformation, each node only has partial information, while the transaction itself requires global coordination of all nodes, thus requiring a centralized role with a god's-eye view, capable of obtaining all information, which is the <strong>TC (transaction coordinator)</strong>, used to globally coordinate the transaction state. The <strong>TM (Transaction Manager)</strong> is the role that drives the generation of transaction proposals. However, even gods nod off, and their judgments are not always correct, so we need an <strong>RM (resource manager)</strong> role to verify the authenticity of the transaction as a representative of the soul. This is TXC's most basic philosophical model. We have methodologically verified that its data consistency is very complete, of course, our cognition is bounded. Perhaps the future will prove we were turkey engineers, but under current circumstances, its model is already sufficient to solve most existing problems.
<img loading="lazy" alt="Distributed Transaction Performance" src="/assets/images/分布式事务性能-379ce638304757417a8ed74fe07fc69c.jpg" width="1494" height="674" class="img_ev3q">
<strong>After years of architectural evolution, from the perspective of transaction single-link latency, TXC takes an average of about 0.2 milliseconds to process at the start of the transaction and about 0.4 milliseconds for branch registration, with the entire transaction's additional latency within the millisecond range. This is also the theoretical limit value we have calculated. In terms of throughput, the TPS of a single node reaches 30,000 times/second, and the TPS of a standard cluster is close to 100,000 times/second.</strong></p><br>#### Seata Open Source Why go open source? This is a question many people have asked me. In 2017, we commercialized the GTS (Global Transaction Service) product sold on Alibaba Cloud, with both public and private cloud forms. At this time, the internal group developed smoothly, but we encountered various problems in the process of commercialization. The problems can be summed up in two main categories: **First, developers are quite lacking in the theory of distributed transactions,** most people do not even understand what local transactions are, let alone distributed transactions. **Second, there are problems with product maturity,** often encountering various strange scenario issues, leading to a sharp rise in support and delivery costs, and R&amp;D turning into after-sales customer service. We reflected on why we encountered so many problems. The main issue here is that Alibaba Group internally has a unified language stack and unified technology stack, and our polishing of specific scenarios is very mature. Serving Alibaba, one company, and serving thousands of enterprises on the cloud is fundamentally different, which also made us realize that our product's scenario ecology was not well developed. On GitHub, more than 80% of open-source software is basic software, and basic software primarily solves the problem of scenario universality, so it cannot be locked in by a single enterprise, like Linux, which has a large number of community distributions. Therefore, in order to make our product better, we chose to open source and co-build with developers to popularize more enterprise users. ![Alibaba Open Source](/img/blog/阿里开源.jpg) Alibaba's open-source journey has gone through three main stages. **The first stage is the stage where Dubbo is located, where developers contribute out of love,** Dubbo has been open sourced for over 10 years, and time has fully proven that Dubbo is an excellent open-source software, and its microkernel plugin extensibility design is an important reference for me when I initially open sourced Seata. When designing software, we need to consider which is more important between extensibility and performance, whether we are doing a three-year design, a five-year design, or a ten-year design that meets business development. While solving the 0-1 service call problem, can we predict the governance problems after the 1-100 scale-up? **The second stage is the closed loop of open source and commercialization, where commercialization feeds back into the open-source community, promoting the development of the open-source community.** I think cloud manufacturers are more likely to do open source well for the following reasons: - First, the cloud is a scaled economy, which must be established on a stable and mature kernel foundation, packaging its product capabilities including high availability, maintenance-free, and elasticity on top of it. An unstable kernel will inevitably lead to excessive delivery and support costs, and high penetration of the R&amp;D team's support Q&amp;A will prevent large-scale replication, and high penetration rates will prevent rapid evolution and iteration of products. - Second, commercial products know business needs better. Our internal technical teams often YY requirements from a development perspective, and what they make is not used by anyone, and thus does not form a value conversion. The business requirements collected through commercialization are all real, so its open source kernel must also evolve in this direction. Failure to evolve in this direction will inevitably lead to architectural splits on both sides, increasing the team's maintenance costs. - Finally, the closed loop of open source and commercialization can promote better development of both parties. If the open-source kernel often has various problems, would you believe that its commercial product is good enough? **The third stage is systematization and standardization.** First, systematization is the basis of open-source solutions. Alibaba's open-source projects are mostly born out of internal e-commerce scenario practices. For example, Higress is used to connect Ant Group's gateways; Nacos carries services with millions of instances and tens of millions of connections; Sentinel provides degradation and throttling capabilities for high availability during major promotions; and Seata ensures transaction data consistency. This set of systematized open-source solutions is designed based on the best practices of Alibaba's e-commerce ecosystem. Second, standardization is another important feature. Taking OpenSergo as an example, it is both a standard and an implementation. In the past few years, the number of domestic open-source projects has exploded. However, the capabilities of various open-source products vary greatly, and many compatibility issues arise when integrating with each other. Therefore, open-source projects like OpenSergo can define some standardized capabilities and interfaces and provide some implementations, which will greatly help the development of the entire open-source ecosystem.<br>### Latest Developments in the Seata Community #### Introduction to the Seata Community ![Community Introduction](/img/blog/社区简介.jpg) **At present, Seata has open-sourced 4 transaction modes, including AT, TCC, Saga, and XA, and is actively exploring other viable transaction solutions.** Seata has integrated with more than 10 mainstream RPC frameworks and relational databases, and has integrated or been integrated relationships with more than 20 communities. In addition, we are also exploring languages other than Java in the multi-language system, such as Golang, PHP, Python, and JS. Seata has been applied to business systems by thousands of customers. Seata applications have become more mature, with successful cooperation with the community in the financial business scenarios of CITIC Bank and Everbright Bank, and successfully adopted into core accounting systems. The landing of microservices systems in financial scenarios is very stringent, which also marks a new level of maturity for Seata's kernel.<br>#### Seata Ecosystem Expansion ![Ecosystem Expansion](/img/blog/扩展生态.jpg) **Seata adopts a microkernel and plugin architecture design, exposing rich extension points in APIs, registry configuration centers, storage modes, lock control, SQL parsers, load balancing, transport, protocol encoding and decoding, observability, and more.** This allows businesses to easily perform flexible extensions and select technical components.<br>#### Seata Application Cases ![Application Cases](/img/blog/应用案例.jpg) **Case 1: China Aviation Information's Air Travel Project** The China Aviation Information Air Travel project introduced Seata in the 0.2 version to solve the data consistency problem of ticket and coupon business, greatly improving development efficiency, reducing asset losses caused by data inconsistency, and enhancing user interaction experience. **Case 2: Didi Chuxing's Two-Wheeler Business Unit** Didi Chuxing's Two-Wheeler Business Unit introduced Seata in version 0.6.1, solving the data consistency problem of business processes such as blue bicycles, electric vehicles, and assets, optimizing the user experience, and reducing asset loss. **Case 3: Meituan's Infrastructure** Meituan's infrastructure team developed the internal distributed transaction solution Swan based on the open-source Seata project, which is used to solve distributed transaction problems within Meituan's various businesses. **Case 4: Hema Town** Hema Town uses Seata to control the flower-stealing process in game interactions, significantly shortening the development cycle from 20 days to 5 days, effectively reducing development costs.<br>#### Evolution of Seata Transaction Modes ![Mode Evolution](/img/blog/模式演进.jpg)<br>#### Current Progress of Seata - Support for Oracle and PostgreSQL multi-primary keys. - Support for Dubbo3. - Support for Spring Boot3. - Support for JDK 17. - Support for ARM64 images. - Support for multiple registration models. - Extended support for various SQL syntaxes. - Support for GraalVM Native Image. - Support for Redis lua storage mode.<br>### Seata 2.x Development Planning ![Development Planning](/img/blog/发展规划.jpg) Mainly includes the following aspects: - **Storage/Protocol/Features** Explore storage and computing separation in Raft cluster mode; better experience, unify the current 4 transaction mode APIs; compatible with GTS protocol; support Saga annotations; support distributed lock control; support data perspective insight and governance. - **Ecosystem** Support more databases, more service frameworks, while exploring support for the domestic trust creation ecosystem; support the MQ ecosystem; further enhance APM support. - **Solutions** In addition to supporting microservices ecosystems, explore multi-cloud solutions; closer to cloud-native solutions; add security and traffic protection capabilities; achieve self-convergence of core components in the architecture. - **Multi-Language Ecosystem** Java is the most mature in the multi-language ecosystem, continue to improve other supported programming languages, while exploring Transaction Mesh solutions that are independent of languages. - **R&amp;D Efficiency/Experience** Improve test coverage, prioritize quality, compatibility, and stability; restructure the official website's documentation to improve the hit rate of document searches; simplify operations and deployment on the experience side, achieve one-click installation and metadata simplification; console supports transaction control and online analysis capabilities.<p>In one sentence, the 2.x plan is summarized as: <strong>Bigger scenarios, bigger ecosystems, from usable to user-friendly.</strong></p><br>### Contact Information for the Seata Community ![Contact Information](/img/blog/联系方式.jpg)]]></content>
        <author>
            <name>Ji Min - Founder of the Seata Open Source Community, Leader of the Distributed Transactions Team</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Observability Practices in Seata]]></title>
        <id>https://seata.apache.org/blog/seata-observable-practice</id>
        <link href="https://seata.apache.org/blog/seata-observable-practice"/>
        <updated>2023-06-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This article explores and discusses Seata's practices in the field of observability.]]></summary>
        <author>
            <name>rong.liu-Seata</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[seata-go 1.2.0 Ready for Production Environment!!!]]></title>
        <id>https://seata.apache.org/blog/seata-go-1.2.0</id>
        <link href="https://seata.apache.org/blog/seata-go-1.2.0"/>
        <updated>2023-06-08T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[seata-go 1.2.0, ready for production environment!!!]]></summary>
        <author>
            <name>Seata Community</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[6 Major Topics Now Open for Selection | Welcome to Apply for Seata Open Source Summer]]></title>
        <id>https://seata.apache.org/blog/iscas2023</id>
        <link href="https://seata.apache.org/blog/iscas2023"/>
        <updated>2023-05-12T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Welcome everyone to register for Seata Open Source Summer 2023 topics]]></summary>
        <content type="html"><![CDATA[<h3 class="anchor anchorWithStickyNavbar_LWe7" id="welcome-everyone-to-register-for-seata-open-source-summer-2023-topics">Welcome everyone to register for Seata Open Source Summer 2023 topics<a href="#welcome-everyone-to-register-for-seata-open-source-summer-2023-topics" class="hash-link" aria-label="Direct link to Welcome everyone to register for Seata Open Source Summer 2023 topics" title="Direct link to Welcome everyone to register for Seata Open Source Summer 2023 topics">​</a></h3><p>The registration period for Open Source Summer 2023 runs from <strong>April 29th to June 4th</strong>, and we welcome registration for Seata 2023 topics! Here, you will have the opportunity to delve into the theory and application of distributed transactions, and collaborate with students from different backgrounds to complete practical projects. We look forward to your active participation and contribution, jointly promoting the development of the distributed transaction field.</p><p><img loading="lazy" alt="summer2023-1" src="/assets/images/summer2023-1-354d728bacb1640f84811b82ac954a9d.jpg" width="1290" height="2796" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="seata-open-source-summer-2023">Seata Open Source Summer 2023<a href="#seata-open-source-summer-2023" class="hash-link" aria-label="Direct link to Seata Open Source Summer 2023" title="Direct link to Seata Open Source Summer 2023">​</a></h3><p>Open Source Summer is a summer open source activity initiated and long-term supported by the Institute of Software, Chinese Academy of Sciences, as part of the "Open Source Software Supply Chain Lighting Program", aimed at encouraging students to actively participate in the development and maintenance of open source software, cultivating and discovering more outstanding developers, promoting the vigorous development of excellent open source software communities, and assisting in the construction of the open source software supply chain.</p><p>Participating students will collaborate remotely online with senior mentors to participate in the development of various organizational projects in the open source community and receive bonuses, gifts, and certificates. <strong>These gains are not only a highlight on future graduation resumes but also a brilliant starting point towards becoming top developers.</strong> Each project is divided into two difficulty levels: basic and advanced, with corresponding project completion bonuses of RMB 8,000 and RMB 12,000 before tax, respectively.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="introduction-to-the-seata-community">Introduction to the Seata Community<a href="#introduction-to-the-seata-community" class="hash-link" aria-label="Direct link to Introduction to the Seata Community" title="Direct link to Introduction to the Seata Community">​</a></h3><p><strong>Seata</strong> is an open-source distributed transaction solution, with over 23K+ stars on GitHub, dedicated to providing high-performance and easy-to-use distributed transaction services under the microservices architecture. Before being open-sourced, Seata played a role as a middleware for distributed data consistency within Alibaba, where almost every transaction needed to use Seata. After undergoing the baptism of Double 11's massive traffic, it provided strong technical support for business.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="summary-of-seata-community-open-source-summer-2023-project-topics">Summary of Seata Community Open Source Summer 2023 Project Topics<a href="#summary-of-seata-community-open-source-summer-2023-project-topics" class="hash-link" aria-label="Direct link to Summary of Seata Community Open Source Summer 2023 Project Topics" title="Direct link to Summary of Seata Community Open Source Summer 2023 Project Topics">​</a></h3><p>The Seata community recommends 6 selected project topics for the Open Source Summer 2023 organizing committee. You can visit the following link to make your selection:<br>
<a href="https://summer-ospp.ac.cn/org/orgdetail/064c15df-705c-483a-8fc8-02831370db14?lang=zh" target="_blank" rel="noopener noreferrer">https://summer-ospp.ac.cn/org/orgdetail/064c15df-705c-483a-8fc8-02831370db14?lang=zh</a><br>
<!-- -->Please communicate promptly with the respective mentors and prepare project application materials, and register through the official channels (the following topics are not listed in any particular order):</p><p><img loading="lazy" alt="seata2023-2" src="/assets/images/summer2023-2-cff41105a59822fdd5e8d88d84ad0e2a.png" width="706" height="271" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="project-one-implementation-of-namingserver-for-service-discovery-and-registration">Project One: Implementation of NamingServer for Service Discovery and Registration<a href="#project-one-implementation-of-namingserver-for-service-discovery-and-registration" class="hash-link" aria-label="Direct link to Project One: Implementation of NamingServer for Service Discovery and Registration" title="Direct link to Project One: Implementation of NamingServer for Service Discovery and Registration">​</a></h4><p><strong>Difficulty:</strong> Advanced</p><p><strong>Project Community Mentor:</strong> Chen Jianbin</p><p><strong>Mentor's Contact Email:</strong> <a href="mailto:364176773@qq.com" target="_blank" rel="noopener noreferrer">364176773@qq.com</a></p><p><strong>Project Description:</strong><br>
<!-- -->Currently, Seata's service exposure and discovery mainly rely on third-party registration centers. With the evolution and development of the project, it brings additional learning and usage costs. Most mainstream middleware with servers have begun to evolve their own service self-loop and control and provide components or functions with higher compatibility and reliability to the server, such as Kafka's KRaft, RocketMQ's NameServer, ClickHouse's ClickHouse Keeper, etc. To address the above problems and architectural evolution requirements, Seata needs to build its own NamingServer to ensure more stability and reliability.</p><p><strong>Project Link:</strong>
<a href="https://summer-ospp.ac.cn/org/prodetail/230640380?list=org&amp;navpage=org" target="_blank" rel="noopener noreferrer">https://summer-ospp.ac.cn/org/prodetail/230640380?list=org&amp;navpage=org</a></p><p>...</p><p>(Projects Two to Six translated in the same manner)</p><p>...</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-participate-in-seata-open-source-summer-2023-and-quickly-select-a-project">How to Participate in Seata Open Source Summer 2023 and Quickly Select a Project?<a href="#how-to-participate-in-seata-open-source-summer-2023-and-quickly-select-a-project" class="hash-link" aria-label="Direct link to How to Participate in Seata Open Source Summer 2023 and Quickly Select a Project?" title="Direct link to How to Participate in Seata Open Source Summer 2023 and Quickly Select a Project?">​</a></h3><p><strong>Welcome to communicate with each mentor through the above contact information and prepare project application materials.</strong></p><p>During the project participation period, students can work online from anywhere in the world. The completion of Seata-related projects needs to be submitted to the Seata community repository as a PR by <strong>September 30th</strong>, so please prepare early.</p><p><img loading="lazy" alt="seata2023-3" src="/assets/images/summer2023-3-9b3b418ef64bd3c1afb2782d17af315a.png" width="1080" height="471" class="img_ev3q"></p><p><strong>To obtain information about mentors and other information during the project, you can scan the QR code below to enter the DingTalk group for communication</strong> —— Understand various projects in the Seata community, meet Seata community open source mentors, and help with subsequent applications.</p><p><img loading="lazy" alt="summer2023-4" src="/assets/images/summer2023-4-3322e50a0b89b4585ddec35b43ef84eb.jpg" width="618" height="700" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="reference-materials">Reference Materials:<a href="#reference-materials" class="hash-link" aria-label="Direct link to Reference Materials:" title="Direct link to Reference Materials:">​</a></h4><p><strong>Seata Website:</strong> <a href="https://seata.apache.org/" target="_blank" rel="noopener noreferrer">https://seata.apache.org/</a></p><p><strong>Seata GitHub:</strong> <a href="https://github.com/seata" target="_blank" rel="noopener noreferrer">https://github.com/seata</a></p><p><strong>Open Source Summer Official Website:</strong> <a href="https://summer-ospp.ac.cn/org/orgdetail/ab188e59-fab8-468f-bc89-bdc2bd8b5e64?lang=zh" target="_blank" rel="noopener noreferrer">https://summer-ospp.ac.cn/org/orgdetail/ab188e59-fab8-468f-bc89-bdc2bd8b5e64?lang=zh</a></p><p>If students are interested in other areas of microservices projects, they can also try to apply, such as:</p><ul><li>For students interested in <strong>microservice configuration registration centers</strong>, they can try to apply for <a href="https://nacos.io/zh-cn/blog/iscas2023.html" target="_blank" rel="noopener noreferrer">Nacos Open Source Summer</a>;</li><li>For students interested in <strong>microservice frameworks and RPC frameworks</strong>, they can try to apply for <a href="https://summer-ospp.ac.cn/org/orgdetail/41d68399-ed48-4d6d-9d4d-3ff4128dc132?lang=zh" target="_blank" rel="noopener noreferrer">Spring Cloud Alibaba Open Source Summer</a> and <a href="https://summer-ospp.ac.cn/org/orgdetail/a7f6e2ad-4acc-47f8-9471-4e54b9a166a6?lang=zh" target="_blank" rel="noopener noreferrer">Dubbo Open Source Summer</a>;</li><li>For students interested in <strong>cloud-native gateways</strong>, they can try to apply for <a href="https://higress.io/zh-cn/blog/ospp-2023" target="_blank" rel="noopener noreferrer">Higress Open Source Summer</a>;</li><li>For students interested in <strong>distributed high-availability protection</strong>, they can try to apply for <!-- -->[Sentinel Open Source Summer]<!-- -->(<a href="https://summer-ospp.ac." target="_blank" rel="noopener noreferrer">https://summer-ospp.ac.</a> cn/org/orgdetail/5e879522-bd90-4a8b-bf8b-b11aea48626b?lang=zh);</li><li>For students interested in <strong>microservices governance</strong>, they can try to apply for <!-- -->[OpenSergo Open Source Summer]<!-- -->(<a href="https://summer-ospp.ac." target="_blank" rel="noopener noreferrer">https://summer-ospp.ac.</a> cn/org/orgdetail/aaff4eec-11b1-4375-997d-5eea8f51762b?lang=zh).</li></ul>]]></content>
        <author>
            <name>Seata Community</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata 1.6.0 Released with Significant Performance Improvement]]></title>
        <id>https://seata.apache.org/blog/seata-1.6.0</id>
        <link href="https://seata.apache.org/blog/seata-1.6.0"/>
        <updated>2022-12-17T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Seata 1.6.0 Released with Significant Performance Improvement]]></summary>
        <content type="html"><![CDATA[<h3 class="anchor anchorWithStickyNavbar_LWe7" id="seata-160-released-with-significant-performance-improvement">Seata 1.6.0 Released with Significant Performance Improvement<a href="#seata-160-released-with-significant-performance-improvement" class="hash-link" aria-label="Direct link to Seata 1.6.0 Released with Significant Performance Improvement" title="Direct link to Seata 1.6.0 Released with Significant Performance Improvement">​</a></h3><p>Seata is an open-source distributed transaction solution that provides high performance and easy-to-use distributed transaction services.</p><p><strong>Download Links for seata-server:</strong></p><p><a href="https://github.com/apache/incubator-seata/archive/v1.6.0.zip" target="_blank" rel="noopener noreferrer">source</a> |
<a href="https://github.com/apache/incubator-seata/releases/download/v1.6.0/seata-server-1.6.0.zip" target="_blank" rel="noopener noreferrer">binary</a></p><p>Updates in this version:</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="feature">feature：<a href="#feature" class="hash-link" aria-label="Direct link to feature：" title="Direct link to feature：">​</a></h3><ul><li>[<a href="https://github.com/apache/incubator-seata/pull/4863" target="_blank" rel="noopener noreferrer">#4863</a>] Support for multiple primary keys in Oracle and PostgreSQL</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4649" target="_blank" rel="noopener noreferrer">#4649</a>] Support for multiple registry centers in seata-server</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4779" target="_blank" rel="noopener noreferrer">#4779</a>] Support for Apache Dubbo3</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4479" target="_blank" rel="noopener noreferrer">#4479</a>] TCC annotations can now be added to interfaces and implementation classes</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4877" target="_blank" rel="noopener noreferrer">#4877</a>] Client SDK supports JDK17</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4914" target="_blank" rel="noopener noreferrer">#4914</a>] Support for update join syntax for MySQL</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4542" target="_blank" rel="noopener noreferrer">#4542</a>] Support for Oracle timestamp type</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5111" target="_blank" rel="noopener noreferrer">#5111</a>] Support for Nacos contextPath configuration</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4802" target="_blank" rel="noopener noreferrer">#4802</a>] Dockerfile supports arm64</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="bug-fixes">Bug Fixes:<a href="#bug-fixes" class="hash-link" aria-label="Direct link to Bug Fixes:" title="Direct link to Bug Fixes:">​</a></h3><ul><li>[<a href="https://github.com/apache/incubator-seata/pull/4780" target="_blank" rel="noopener noreferrer">#4780</a>] Fixed the issue where TimeoutRollbacked event wasn't sent after a successful timeout rollback.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4954" target="_blank" rel="noopener noreferrer">#4954</a>] Fixed NullPointerException when the output expression was incorrect.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4817" target="_blank" rel="noopener noreferrer">#4817</a>] Fixed the problem with non-standard configuration in higher versions of Spring Boot.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4838" target="_blank" rel="noopener noreferrer">#4838</a>] Fixed the issue where undo log wasn't generated when using Statement.executeBatch().</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4533" target="_blank" rel="noopener noreferrer">#4533</a>] Fixed inaccurate metric data caused by duplicate events handling for handleRetryRollbacking.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4912" target="_blank" rel="noopener noreferrer">#4912</a>] Fixed the issue where mysql InsertOnDuplicateUpdate couldn't correctly match column names due to inconsistent case.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4543" target="_blank" rel="noopener noreferrer">#4543</a>] Fixed support for Oracle nclob data type.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4915" target="_blank" rel="noopener noreferrer">#4915</a>] Fixed the problem of not obtaining ServerRecoveryProperties attributes.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4919" target="_blank" rel="noopener noreferrer">#4919</a>] Fixed the issue where XID's port and address appeared as null:0.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4928" target="_blank" rel="noopener noreferrer">#4928</a>] Fixed NPE issue in rpcContext.getClientRMHolderMap.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4953" target="_blank" rel="noopener noreferrer">#4953</a>] Fixed the issue where InsertOnDuplicateUpdate could bypass primary key modification.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4978" target="_blank" rel="noopener noreferrer">#4978</a>] Fixed kryo support for cyclic dependencies.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4985" target="_blank" rel="noopener noreferrer">#4985</a>] Fixed the issue of duplicate undo_log id.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4874" target="_blank" rel="noopener noreferrer">#4874</a>] Fixed startup failure with OpenJDK 11.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5018" target="_blank" rel="noopener noreferrer">#5018</a>] Fixed server startup failure issue due to loader path using relative path in startup script.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5004" target="_blank" rel="noopener noreferrer">#5004</a>] Fixed the issue of duplicate row data in mysql update join.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5032" target="_blank" rel="noopener noreferrer">#5032</a>] Fixed the abnormal SQL statement in mysql InsertOnDuplicateUpdate due to incorrect calculation of condition parameter fill position.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5033" target="_blank" rel="noopener noreferrer">#5033</a>] Fixed NullPointerException issue in SQL statement of InsertOnDuplicateUpdate due to missing insert column field.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5038" target="_blank" rel="noopener noreferrer">#5038</a>] Fixed SagaAsyncThreadPoolProperties conflict issue.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5050" target="_blank" rel="noopener noreferrer">#5050</a>] Fixed the issue where global status under Saga mode wasn't correctly changed to Committed.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5052" target="_blank" rel="noopener noreferrer">#5052</a>] Fixed placeholder parameter issue in update join condition.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5031" target="_blank" rel="noopener noreferrer">#5031</a>] Fixed the issue of using null value index as query condition in InsertOnDuplicateUpdate.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5075" target="_blank" rel="noopener noreferrer">#5075</a>] Fixed the inability to intercept SQL statements with no primary key and unique index in InsertOnDuplicateUpdate.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5093" target="_blank" rel="noopener noreferrer">#5093</a>] Fixed accessKey loss issue after seata server restart.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5092" target="_blank" rel="noopener noreferrer">#5092</a>] Fixed the issue of incorrect AutoConfiguration order when seata and jpa are used together.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5109" target="_blank" rel="noopener noreferrer">#5109</a>] Fixed NPE issue when @GlobalTransactional is not applied on RM side.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5098" target="_blank" rel="noopener noreferrer">#5098</a>] Disabled oracle implicit cache for Druid.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4860" target="_blank" rel="noopener noreferrer">#4860</a>] Fixed metrics tag override issue.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5028" target="_blank" rel="noopener noreferrer">#5028</a>] Fixed null value issue in insert on duplicate SQL.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5078" target="_blank" rel="noopener noreferrer">#5078</a>] Fixed interception issue for SQL statements without primary keys and unique keys.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5097" target="_blank" rel="noopener noreferrer">#5097</a>] Fixed accessKey loss issue when Server restarts.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5131" target="_blank" rel="noopener noreferrer">#5131</a>] Fixed issue where XAConn cannot rollback when in active state.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5134" target="_blank" rel="noopener noreferrer">#5134</a>] Fixed issue where hikariDataSource auto proxy fails in some cases.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5163" target="_blank" rel="noopener noreferrer">#5163</a>] Fixed compilation failure in higher versions of JDK.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="optimization">Optimization:<a href="#optimization" class="hash-link" aria-label="Direct link to Optimization:" title="Direct link to Optimization:">​</a></h3><ul><li>[<a href="https://github.com/apache/incubator-seata/pull/4681" target="_blank" rel="noopener noreferrer">#4681</a>] Optimized the process of competing locks.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4774" target="_blank" rel="noopener noreferrer">#4774</a>] Optimized mysql8 dependency in seataio/seata-server image.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4750" target="_blank" rel="noopener noreferrer">#4750</a>] Optimized the release of global locks in AT branch to not use xid.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4790" target="_blank" rel="noopener noreferrer">#4790</a>] Added automatic OSSRH github action publishing.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4765" target="_blank" rel="noopener noreferrer">#4765</a>] XA mode in mysql8.0.29 and above no longer holds connection to the second phase.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4797" target="_blank" rel="noopener noreferrer">#4797</a>] Optimized all github actions scripts.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4800" target="_blank" rel="noopener noreferrer">#4800</a>] Added NOTICE file.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4761" target="_blank" rel="noopener noreferrer">#4761</a>] Used hget instead of hmget in RedisLocker.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4414" target="_blank" rel="noopener noreferrer">#4414</a>] Removed log4j dependency.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4836" target="_blank" rel="noopener noreferrer">#4836</a>] Improved readability of BaseTransactionalExecutor#buildLockKey(TableRecords rowsIncludingPK) method.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4865" target="_blank" rel="noopener noreferrer">#4865</a>] Fixed security vulnerabilities in Saga visualization designer GGEditor.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4590" target="_blank" rel="noopener noreferrer">#4590</a>] Dynamic configuration support for automatic degradation switch.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4490" target="_blank" rel="noopener noreferrer">#4490</a>] Optimized tccfence record table to delete by index.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4911" target="_blank" rel="noopener noreferrer">#4911</a>] Added header and license checks.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4917" target="_blank" rel="noopener noreferrer">#4917</a>] Upgraded package-lock.json to fix vulnerabilities.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4924" target="_blank" rel="noopener noreferrer">#4924</a>] Optimized pom dependencies.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4932" target="_blank" rel="noopener noreferrer">#4932</a>] Extracted default values for some configurations.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4925" target="_blank" rel="noopener noreferrer">#4925</a>] Optimized javadoc comments.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4921" target="_blank" rel="noopener noreferrer">#4921</a>] Fixed security vulnerabilities in console module and upgraded skywalking-eyes version.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4936" target="_blank" rel="noopener noreferrer">#4936</a>] Optimized storage configuration reading.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4946" target="_blank" rel="noopener noreferrer">#4946</a>] Passed SQL exceptions encountered when acquiring locks to the client.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4962" target="_blank" rel="noopener noreferrer">#4962</a>] Optimized build configuration and corrected base image of docker image.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4974" target="_blank" rel="noopener noreferrer">#4974</a>] Removed limitation on querying globalStatus quantity under redis mode.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4981" target="_blank" rel="noopener noreferrer">#4981</a>] Improved error message when tcc fence record cannot be found.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4995" target="_blank" rel="noopener noreferrer">#4995</a>] Fixed duplicate primary key query conditions in the SQL statement after mysql InsertOnDuplicateUpdate.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5047" target="_blank" rel="noopener noreferrer">#5047</a>] Removed unused code.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5051" target="_blank" rel="noopener noreferrer">#5051</a>] When undolog generates dirty write during rollback, throw exception BranchRollbackFailed_Unretriable.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5075" target="_blank" rel="noopener noreferrer">#5075</a>] Intercept insert on duplicate update statements without primary keys and unique indexes.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5104" target="_blank" rel="noopener noreferrer">#5104</a>] ConnectionProxy is no longer dependent on druid.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5124" target="_blank" rel="noopener noreferrer">#5124</a>] Support deleting TCC fence record table for oracle.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4968" target="_blank" rel="noopener noreferrer">#4468</a>] Support kryo 5.3.0.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4807" target="_blank" rel="noopener noreferrer">#4807</a>] Optimized image and OSS repository publishing pipelines.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4445" target="_blank" rel="noopener noreferrer">#4445</a>] Optimized transaction timeout judgment.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4958" target="_blank" rel="noopener noreferrer">#4958</a>] Optimized execution of triggerAfterCommit() for timeout transactions.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4582" target="_blank" rel="noopener noreferrer">#4582</a>] Optimized transaction sorting in redis storage mode.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4963" target="_blank" rel="noopener noreferrer">#4963</a>] Added ARM64 pipeline CI testing.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4434" target="_blank" rel="noopener noreferrer">#4434</a>] Removed seata-server CMS GC parameters.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="testing">Testing:<a href="#testing" class="hash-link" aria-label="Direct link to Testing:" title="Direct link to Testing:">​</a></h3><ul><li>[<a href="https://github.com/apache/incubator-seata/pull/4411" target="_blank" rel="noopener noreferrer">#4411</a>] Tested Oracle database AT mode type support.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4794" target="_blank" rel="noopener noreferrer">#4794</a>] Refactored code and attempted to fix unit test <code>DataSourceProxyTest.getResourceIdTest()</code>.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/5101" target="_blank" rel="noopener noreferrer">#5101</a>] Fixed ClassNotFoundException issue in zk registration and configuration center <code>DataSourceProxyTest.getResourceIdTest()</code>.</li></ul><p>Special thanks to the following contributors for their code contributions. If there are any unintentional omissions, please report.</p><ul><li><a href="https://github.com/slievrly" target="_blank" rel="noopener noreferrer">slievrly</a></li><li><a href="https://github.com/renliangyu857" target="_blank" rel="noopener noreferrer">renliangyu857</a></li><li><a href="https://github.com/wangliang181230" target="_blank" rel="noopener noreferrer">wangliang181230</a></li><li><a href="https://github.com/funky-eyes" target="_blank" rel="noopener noreferrer">funky-eyes</a></li><li><a href="https://github.com/tuwenlin" target="_blank" rel="noopener noreferrer">tuwenlin</a></li><li><a href="https://github.com/conghuhu" target="_blank" rel="noopener noreferrer">conghuhu</a></li><li><a href="https://github.com/a1104321118" target="_blank" rel="noopener noreferrer">a1104321118</a></li><li><a href="https://github.com/duanqiaoyanyu" target="_blank" rel="noopener noreferrer">duanqiaoyanyu</a></li><li><a href="https://github.com/robynron" target="_blank" rel="noopener noreferrer">robynron</a></li><li><a href="https://github.com/lcmvs" target="_blank" rel="noopener noreferrer">lcmvs</a></li><li><a href="https://github.com/github-ganyu" target="_blank" rel="noopener noreferrer">github-ganyu</a></li><li><a href="https://github.com/1181954449" target="_blank" rel="noopener noreferrer">1181954449</a></li><li><a href="https://github.com/zw201913" target="_blank" rel="noopener noreferrer">zw201913</a></li><li><a href="https://github.com/wingchi-leung" target="_blank" rel="noopener noreferrer">wingchi-leung</a></li><li><a href="https://github.com/AlexStocks" target="_blank" rel="noopener noreferrer">AlexStocks</a></li><li><a href="https://github.com/liujunlin5168" target="_blank" rel="noopener noreferrer">liujunlin5168</a></li><li><a href="https://github.com/pengten" target="_blank" rel="noopener noreferrer">pengten</a></li><li><a href="https://github.com/liuqiufeng" target="_blank" rel="noopener noreferrer">liuqiufeng</a></li><li><a href="https://github.com/yujianfei1986" target="_blank" rel="noopener noreferrer">yujianfei1986</a></li><li><a href="https://github.com/Bughue" target="_blank" rel="noopener noreferrer">Bughue</a></li><li><a href="https://github.com/AlbumenJ" target="_blank" rel="noopener noreferrer">AlbumenJ</a></li><li><a href="https://github.com/doubleDimple" target="_blank" rel="noopener noreferrer">doubleDimple</a></li><li><a href="https://github.com/jsbxyyx" target="_blank" rel="noopener noreferrer">jsbxyyx</a></li><li><a href="https://github.com/tuwenlin" target="_blank" rel="noopener noreferrer">tuwenlin</a></li><li><a href="https://github.com/JavaLionLi" target="_blank" rel="noopener noreferrer">CrazyLionLi</a></li><li><a href="https://github.com/whxxxxx" target="_blank" rel="noopener noreferrer">whxxxxx</a></li><li><a href="https://github.com/neillee95" target="_blank" rel="noopener noreferrer">neillee95</a></li><li><a href="https://github.com/crazy-sheep" target="_blank" rel="noopener noreferrer">crazy-sheep</a></li><li><a href="https://github.com/zhangzq7" target="_blank" rel="noopener noreferrer">zhangzq7</a></li><li><a href="https://github.com/l81893521" target="_blank" rel="noopener noreferrer">l81893521</a></li><li><a href="https://github.com/zhuyoufeng" target="_blank" rel="noopener noreferrer">zhuyoufeng</a></li><li><a href="https://github.com/xingfudeshi" target="_blank" rel="noopener noreferrer">xingfudeshi</a></li><li><a href="https://github.com/odidev" target="_blank" rel="noopener noreferrer">odidev</a></li><li><a href="https://github.com/miaoxueyu" target="_blank" rel="noopener noreferrer">miaoxueyu</a></li></ul><p>At the same time, we have received many valuable issues and suggestions from the community, and we are very grateful to everyone.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="link">Link<a href="#link" class="hash-link" aria-label="Direct link to Link" title="Direct link to Link">​</a></h4><ul><li><strong>Seata:</strong> <a href="https://github.com/apache/incubator-seata" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata</a></li><li><strong>Seata-Samples:</strong> <a href="https://github.com/apache/incubator-seata-samples" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata-samples</a></li><li><strong>Release:</strong> <a href="https://github.com/apache/incubator-seata/releases" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata/releases</a></li><li><strong>WebSite:</strong> <a href="https://seata.apache.org" target="_blank" rel="noopener noreferrer">https://seata.apache.org</a></li></ul>]]></content>
        <author>
            <name>Seata Community</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata 1.5.2 Released with XID Load Balancing Support]]></title>
        <id>https://seata.apache.org/blog/seata-1.5.2</id>
        <link href="https://seata.apache.org/blog/seata-1.5.2"/>
        <updated>2022-07-12T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Seata 1.5.2 Released with XID Load Balancing Support]]></summary>
        <content type="html"><![CDATA[<h3 class="anchor anchorWithStickyNavbar_LWe7" id="seata-152-released-with-xid-load-balancing-support">Seata 1.5.2 Released with XID Load Balancing Support<a href="#seata-152-released-with-xid-load-balancing-support" class="hash-link" aria-label="Direct link to Seata 1.5.2 Released with XID Load Balancing Support" title="Direct link to Seata 1.5.2 Released with XID Load Balancing Support">​</a></h3><p>Seata is an open-source distributed transaction solution that provides high-performance and easy-to-use distributed transaction services.</p><p><strong>seata-server Download Links:</strong></p><p><a href="https://github.com/apache/incubator-seata/archive/v1.5.2.zip" target="_blank" rel="noopener noreferrer">source</a> |
<a href="https://github.com/apache/incubator-seata/releases/download/v1.5.2/seata-server-1.5.2.zip" target="_blank" rel="noopener noreferrer">binary</a></p><p>The key updates in this version include:</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="features">Features:<a href="#features" class="hash-link" aria-label="Direct link to Features:" title="Direct link to Features:">​</a></h3><ul><li>[<a href="https://github.com/apache/incubator-seata/pull/4713" target="_blank" rel="noopener noreferrer">#4661</a>] Added support for XID load balancing algorithm.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4676" target="_blank" rel="noopener noreferrer">#4676</a>] Added support for Seata server to expose services through SLB when using Nacos as the registry center.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4642" target="_blank" rel="noopener noreferrer">#4642</a>] Added support for parallel processing of client batch requests.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4567" target="_blank" rel="noopener noreferrer">#4567</a>] Added support for the <code>find_in_set</code> function in the WHERE condition.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="bug-fixes">Bug Fixes:<a href="#bug-fixes" class="hash-link" aria-label="Direct link to Bug Fixes:" title="Direct link to Bug Fixes:">​</a></h3><ul><li>[<a href="https://github.com/apache/incubator-seata/pull/4515" target="_blank" rel="noopener noreferrer">#4515</a>] Fixed an issue where SeataTCCFenceAutoConfiguration on the develop branch throws a ClassNotFoundException when the client does not use a DB.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4661" target="_blank" rel="noopener noreferrer">#4661</a>] Fixed SQL exceptions when using PostgreSQL in the console.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4682" target="_blank" rel="noopener noreferrer">#4667</a>] Fixed an exception when updating the map in RedisTransactionStoreManager on the develop branch.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4678" target="_blank" rel="noopener noreferrer">#4678</a>] Fixed the issue of cache penetration when the property <code>transport.enableRmClientBatchSendRequest</code> is not configured.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4701" target="_blank" rel="noopener noreferrer">#4701</a>] Fixed the issue of missing command line parameters.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4607" target="_blank" rel="noopener noreferrer">#4607</a>] Fixed a defect in skipping global lock verification.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4696" target="_blank" rel="noopener noreferrer">#4696</a>] Fixed the insertion issue when using the Oracle storage mode.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4726" target="_blank" rel="noopener noreferrer">#4726</a>] Fixed a possible NPE issue when sending messages in batches.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4729" target="_blank" rel="noopener noreferrer">#4729</a>] Fixed the issue of incorrect setting of <code>AspectTransactional.rollbackForClassName</code>.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4653" target="_blank" rel="noopener noreferrer">#4653</a>] Fixed the exception of non-numeric primary key in INSERT_ON_DUPLICATE.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="optimizations">Optimizations:<a href="#optimizations" class="hash-link" aria-label="Direct link to Optimizations:" title="Direct link to Optimizations:">​</a></h3><ul><li>[<a href="https://github.com/apache/incubator-seata/pull/4650" target="_blank" rel="noopener noreferrer">#4650</a>] Fixed a security vulnerability.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4670" target="_blank" rel="noopener noreferrer">#4670</a>] Optimized the number of threads in the <code>branchResultMessageExecutor</code> thread pool.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4662" target="_blank" rel="noopener noreferrer">#4662</a>] Optimized the monitoring metrics for rolling back transactions.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4693" target="_blank" rel="noopener noreferrer">#4693</a>] Optimized the console navigation bar.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4700" target="_blank" rel="noopener noreferrer">#4700</a>] Fixed failures in the execution of maven-compiler-plugin and maven-resources-plugin.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4711" target="_blank" rel="noopener noreferrer">#4711</a>] Separated the lib dependency during deployment.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4720" target="_blank" rel="noopener noreferrer">#4720</a>] Optimized pom descriptions.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4728" target="_blank" rel="noopener noreferrer">#4728</a>] Upgraded the logback version dependency to 1.2.9.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4745" target="_blank" rel="noopener noreferrer">#4745</a>] Added support for mysql8 driver in the distribution package.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4626" target="_blank" rel="noopener noreferrer">#4626</a>] Used <code>easyj-maven-plugin</code> plugin instead of <code>flatten-maven-plugin</code> to fix compatibility issues between <code>shade</code> plugin and <code>flatten</code> plugin.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4629" target="_blank" rel="noopener noreferrer">#4629</a>] Checked the constraint relationship before and after updating the globalSession status.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4662" target="_blank" rel="noopener noreferrer">#4662</a>] Optimized the readability of EnhancedServiceLoader.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="tests">Tests:<a href="#tests" class="hash-link" aria-label="Direct link to Tests:" title="Direct link to Tests:">​</a></h3><ul><li>[<a href="https://github.com/apache/incubator-seata/pull/4544" target="_blank" rel="noopener noreferrer">#4544</a>] Optimized the jackson package dependency issue in TransactionContextFilterTest.</li><li>[<a href="https://github.com/apache/incubator-seata/pull/4731" target="_blank" rel="noopener noreferrer">#4731</a>] Fixed unit test issues in AsyncWorkerTest and LockManagerTest.</li></ul><p>A big thanks to the contributors for their valuable code contributions. If inadvertently omitted, please report.</p><ul><li><a href="https://github.com/slievrly" target="_blank" rel="noopener noreferrer">slievrly</a></li><li><a href="https://github.com/pengten" target="_blank" rel="noopener noreferrer">pengten</a></li><li><a href="https://github.com/YSF-A" target="_blank" rel="noopener noreferrer">YSF-A</a></li><li><a href="https://github.com/tuwenlin" target="_blank" rel="noopener noreferrer">tuwenlin</a></li><li><a href="https://github.com/2129zxl" target="_blank" rel="noopener noreferrer">2129zxl</a></li><li><a href="https://github.com/Ifdevil" target="_blank" rel="noopener noreferrer">Ifdevil</a></li><li><a href="https://github.com/wingchi-leung" target="_blank" rel="noopener noreferrer">wingchi-leung</a></li><li><a href="https://github.com/robynron" target="_blank" rel="noopener noreferrer">liurong</a></li><li><a href="https://github.com/opelok-z" target="_blank" rel="noopener noreferrer">opelok-z</a></li><li><a href="https://github.com/funky-eyes" target="_blank" rel="noopener noreferrer">funky-eyes</a></li><li><a href="https://github.com/Smery-lxm" target="_blank" rel="noopener noreferrer">Smery-lxm</a></li><li><a href="https://github.com/lvekee" target="_blank" rel="noopener noreferrer">lvekee</a></li><li><a href="https://github.com/doubleDimple" target="_blank" rel="noopener noreferrer">doubleDimple</a></li><li><a href="https://github.com/wangliang181230" target="_blank" rel="noopener noreferrer">wangliang181230</a></li><li><a href="https://github.com/Bughue" target="_blank" rel="noopener noreferrer">Bughue</a></li><li><a href="https://github.com/AYue-94" target="_blank" rel="noopener noreferrer">AYue-94</a></li><li><a href="https://github.com/lingxiao-wu" target="_blank" rel="noopener noreferrer">lingxiao-wu</a></li><li><a href="https://github.com/caohdgege" target="_blank" rel="noopener noreferrer">caohdgege</a></li></ul><p>At the same time, we have received many valuable issues and suggestions from the community, thank you very much.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="link">Link<a href="#link" class="hash-link" aria-label="Direct link to Link" title="Direct link to Link">​</a></h4><ul><li><strong>Seata:</strong> <a href="https://github.com/apache/incubator-seata" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata</a></li><li><strong>Seata-Samples:</strong> <a href="https://github.com/apache/incubator-seata-samples" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata-samples</a></li><li><strong>Release:</strong> <a href="https://github.com/apache/incubator-seata/releases" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata/releases</a></li><li><strong>WebSite:</strong> <a href="https://seata.io" target="_blank" rel="noopener noreferrer">https://seata.io</a></li></ul>]]></content>
        <author>
            <name>Seata Community</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Alibaba Seata Resolves Idempotence, Dangling, and Empty Rollback Issues in TCC Mode]]></title>
        <id>https://seata.apache.org/blog/seata-tcc-fence</id>
        <link href="https://seata.apache.org/blog/seata-tcc-fence"/>
        <updated>2022-06-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Seata version 1.5.1 from Alibaba has finally resolved the issues of idempotence, dangling, and empty rollback in TCC (Try-Confirm-Cancel) mode. This article mainly explains how Seata addresses these problems.]]></summary>
        <content type="html"><![CDATA[<p>Today, let's talk about how the new version (1.5.1) of Alibaba's Seata resolves the issues of idempotence, dangling, and empty rollback in TCC mode.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-tcc">1 TCC<a href="#1-tcc" class="hash-link" aria-label="Direct link to 1 TCC" title="Direct link to 1 TCC">​</a></h2><p>TCC mode is the most classic solution for distributed transactions. It divides the distributed transaction into two phases. In the try phase, resources are reserved for each branch transaction. If all branch transactions successfully reserve resources, the global transaction proceeds to the commit phase for committing the transaction globally. However, if any node fails to reserve resources, the global transaction enters the cancel phase to rollback the transaction globally.</p><p>Taking traditional order, inventory, and account services as an example, in the try phase, resources are attempted to be reserved by inserting orders, deducting inventory, and deducting amounts. These three services require local transaction commits, and the resources can be transferred to an intermediate table. In the commit phase, the resources reserved in the try phase are transferred to the final table. In the cancel phase, the resources reserved in the try phase are released, such as returning the account amount to the customer's account.</p><p><strong>Note: The try phase must involve committing local transactions. For example, when deducting the order amount, the money must be deducted from the customer's account. If it is not deducted, there will be a problem in the commit phase if the customer's account does not have enough money.</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-try-commit">1.1 try-commit<a href="#11-try-commit" class="hash-link" aria-label="Direct link to 1.1 try-commit" title="Direct link to 1.1 try-commit">​</a></h3><p>In the try phase, resources are first reserved, and then they are deducted in the commit phase. The diagram below illustrates this process:</p><p><img loading="lazy" alt="fence-try-commit" src="/assets/images/fence-try-commit-453b9a1e280200057448436ecd7eef27.png" width="501" height="681" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-try-cancel">1.2 try-cancel<a href="#12-try-cancel" class="hash-link" aria-label="Direct link to 1.2 try-cancel" title="Direct link to 1.2 try-cancel">​</a></h3><p>In the try phase, resources are first reserved. If the deduction of inventory fails, leading to a rollback of the global transaction, the resources are released in the cancel phase. The diagram below illustrates this process:</p><p><img loading="lazy" alt="fence-try-cancel" src="/assets/images/fence-try-cancel-eafbbb62134fe4e3ed61bdc2a47461b9.png" width="501" height="681" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-tcc-advantages">2 TCC Advantages<a href="#2-tcc-advantages" class="hash-link" aria-label="Direct link to 2 TCC Advantages" title="Direct link to 2 TCC Advantages">​</a></h2><p>The biggest advantage of TCC mode is its high efficiency. In the try phase, the resource locking in TCC mode is not a true lock, but rather a real local transaction submission that reserves resources in an intermediate state without the need for blocking and waiting. Therefore, it is more efficient than other modes.</p><p>Additionally, the TCC mode can be optimized as follows:</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-asynchronous-commit">2.1 Asynchronous Commit<a href="#21-asynchronous-commit" class="hash-link" aria-label="Direct link to 2.1 Asynchronous Commit" title="Direct link to 2.1 Asynchronous Commit">​</a></h3><p>After the try phase succeeds, instead of immediately entering the confirm/cancel phase, it is considered that the global transaction has already ended. A scheduled task is started to asynchronously execute the confirm/cancel phase, which involves deducting or releasing resources. This approach can greatly improve performance.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-same-database-mode">2.2 Same-Database Mode<a href="#22-same-database-mode" class="hash-link" aria-label="Direct link to 2.2 Same-Database Mode" title="Direct link to 2.2 Same-Database Mode">​</a></h3><p>In the TCC mode, there are three roles:</p><ul><li>TM: Manages the global transaction, including starting the global transaction and committing/rolling back the global transaction.</li><li>RM: Manages the branch transaction.</li><li>TC: Manages the state of the global transaction and branch transactions.</li></ul><p>The diagram below is from the Seata official website:</p><p><img loading="lazy" alt="fence-fiffrent-db" src="/assets/images/fence-fiffrent-db-1f7a834639aa755d73fa2af435c4f042.png" width="853" height="482" class="img_ev3q"></p><p>When TM starts a global transaction, RM needs to send a registration message to TC, and TC saves the state of the branch transaction. When TM requests a commit or rollback, TC needs to send commit or rollback messages to RM. In this way, in a distributed transaction with two branch transactions, there are four RPCs between TC and RM.</p><p>After optimization, the process is as shown in the diagram below:</p><p>TC saves the state of the global transaction. When TM starts a global transaction, RM no longer needs to send a registration message to TC. Instead, it saves the state of the branch transaction locally. After TM sends a commit or rollback message to TC, the asynchronous thread in RM first retrieves the uncommitted branch transactions saved locally, and then sends a message to TC to obtain the state of the global transaction in which the local branch transaction is located, in order to determine whether to commit or rollback the local transaction.</p><p>With this optimization, the number of RPCs is reduced by 50%, resulting in a significant performance improvement.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-rm-code-example">3 RM Code Example<a href="#3-rm-code-example" class="hash-link" aria-label="Direct link to 3 RM Code Example" title="Direct link to 3 RM Code Example">​</a></h2><p>Taking the inventory service as an example, the RM inventory service interface code is as follows:</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@LocalTCC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface StorageService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * decrease</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param xid </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param productId </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param count </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @TwoPhaseBusinessAction(name = "storageApi", commitMethod = "commit", rollbackMethod = "rollback", useTCCFence = true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean decrease(String xid, Long productId, Integer count);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * commit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param actionContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean commit(BusinessActionContext actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * rollback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param actionContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean rollback(BusinessActionContext actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>By using the <code>@LocalTCC</code> annotation, when the RM is initialized, it registers a branch transaction with the TC. The <code>try</code> phase method (e.g., <code>decrease</code> method) is annotated with <code>@TwoPhaseBusinessAction</code>, which defines the branch transaction's <code>resourceId</code>, <code>commit</code> method, <code>cancel</code> method, and the <code>useTCCFence</code> property, which will be explained in the next section.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-issues-with-tcc">4 Issues with TCC<a href="#4-issues-with-tcc" class="hash-link" aria-label="Direct link to 4 Issues with TCC" title="Direct link to 4 Issues with TCC">​</a></h2><p>There are three major issues with the TCC pattern: idempotence, suspension, and empty rollback. In version 1.5.1 of Seata, a transaction control table named <code>tcc_fence_log</code> is introduced to address these issues. The <code>useTCCFence</code> property mentioned in the previous <code>@TwoPhaseBusinessAction</code> annotation is used to enable or disable this mechanism, with a default value of <code>false</code>.</p><p>The creation SQL statement for the <code>tcc_fence_log</code> table (in MySQL syntax) is as follows:</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE IF NOT EXISTS `tcc_fence_log`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `xid`           VARCHAR(128)  NOT NULL COMMENT 'global id',</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `branch_id`     BIGINT        NOT NULL COMMENT 'branch id',</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `action_name`   VARCHAR(64)   NOT NULL COMMENT 'action name',</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `status`        TINYINT       NOT NULL COMMENT 'status(tried:1;committed:2;rollbacked:3;suspended:4)',</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `gmt_create`    DATETIME(3)   NOT NULL COMMENT 'create time',</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `gmt_modified`  DATETIME(3)   NOT NULL COMMENT 'update time',</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PRIMARY KEY (`xid`, `branch_id`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KEY `idx_gmt_modified` (`gmt_modified`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KEY `idx_status` (`status`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE = InnoDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DEFAULT CHARSET = utf8mb4;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-idempotence">4.1 Idempotence<a href="#41-idempotence" class="hash-link" aria-label="Direct link to 4.1 Idempotence" title="Direct link to 4.1 Idempotence">​</a></h3><p>During the commit/cancel phase, if the TC does not receive a response from the branch transaction, it needs to retry the operation. Therefore, it is necessary for the branch transaction to support idempotence.</p><p>Let's take a look at how this is addressed in the new version. The following code is from the <code>TCCResourceManager</code> class:</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public BranchStatus branchCommit(BranchType branchType, String xid, long branchId, String resourceId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 String applicationData) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TCCResource tccResource = (TCCResource)tccResourceCache.get(resourceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object targetTCCBean = tccResource.getTargetBean();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Method commitMethod = tccResource.getCommitMethod();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //BusinessActionContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BusinessActionContext businessActionContext = getBusinessActionContext(xid, branchId, resourceId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            applicationData);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object[] args = this.getTwoPhaseCommitArgs(tccResource, businessActionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //whether the useTCCFence property is set to true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Boolean.TRUE.equals(businessActionContext.getActionContext(Constants.USE_TCC_FENCE))) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                result = TCCFenceHandler.commitFence(commitMethod, targetTCCBean, xid, branchId, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (SkipCallbackWrapperException | UndeclaredThrowableException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw e.getCause();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.info("TCC resource commit result : {}, xid: {}, branchId: {}, resourceId: {}", result, xid, branchId, resourceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result ? BranchStatus.PhaseTwo_Committed : BranchStatus.PhaseTwo_CommitFailed_Retryable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return BranchStatus.PhaseTwo_CommitFailed_Retryable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above code shows that when executing the commit method of the branch transaction, it first checks if the <code>useTCCFence</code> property is <code>true</code>. If it is <code>true</code>, it follows the <code>commitFence</code> logic in the <code>TCCFenceHandler</code> class; otherwise, it follows the normal commit logic.</p><p>The <code>commitFence</code> method in the <code>TCCFenceHandler</code> class calls the <code>commitFence</code> method of the same class. The code is as follows:</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static boolean commitFence(Method commitMethod, Object targetTCCBean,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  String xid, Long branchId, Object[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return transactionTemplate.execute(status -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection conn = DataSourceUtils.getConnection(dataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TCCFenceDO tccFenceDO = TCC_FENCE_DAO.queryTCCFenceDO(conn, xid, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (tccFenceDO == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new TCCFenceException(String.format("TCC fence record not exists, commit fence method failed. xid= %s, branchId= %s", xid, branchId),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        FrameworkErrorCode.RecordAlreadyExists);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (TCCFenceConstant.STATUS_COMMITTED == tccFenceDO.getStatus()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.info("Branch transaction has already committed before. idempotency rejected. xid: {}, branchId: {}, status: {}", xid, branchId, tccFenceDO.getStatus());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (TCCFenceConstant.STATUS_ROLLBACKED == tccFenceDO.getStatus() || TCCFenceConstant.STATUS_SUSPENDED == tccFenceDO.getStatus()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (LOGGER.isWarnEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOGGER.warn("Branch transaction status is unexpected. xid: {}, branchId: {}, status: {}", xid, branchId, tccFenceDO.getStatus());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return updateStatusAndInvokeTargetMethod(conn, commitMethod, targetTCCBean, xid, branchId, TCCFenceConstant.STATUS_COMMITTED, status, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            status.setRollbackOnly();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new SkipCallbackWrapperException(t);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>From the code, we can see that when committing the transaction, it first checks if there is a record in the <code>tcc_fence_log</code> table. If a record exists, it checks the transaction execution status and returns. This ensures idempotence by avoiding duplicate commits if the transaction status is already <code>STATUS_COMMITTED</code>. If there is no record in the <code>tcc_fence_log</code> table, a new record is inserted for later retry detection.</p><p>The rollback logic is similar to the commit logic and is implemented in the <code>rollbackFence</code> method of the <code>TCCFenceHandler</code> class.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-empty-rollback">4.2 Empty Rollback<a href="#42-empty-rollback" class="hash-link" aria-label="Direct link to 4.2 Empty Rollback" title="Direct link to 4.2 Empty Rollback">​</a></h3><p>In the scenario shown in the following diagram, the account service consists of a cluster of two nodes. During the try phase, the account service on Node 1 encounters a failure. Without considering retries, the global transaction must reach the end state, requiring a cancel operation to be performed on the account service.</p><p><img loading="lazy" alt="fence-empty-rollback" src="/assets/images/fence-empty-rollback-55e0c44f8e67d5df91c0f930860baa1f.png" width="591" height="681" class="img_ev3q"></p><p>Seata's solution is to insert a record into the <code>tcc_fence_log</code> table during the try phase, with the <code>status</code> field set to <code>STATUS_TRIED</code>. During the rollback phase, it checks if the record exists, and if it doesn't, the rollback operation is not executed. The code is as follows:</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//TCCFenceHandler </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static Object prepareFence(String xid, Long branchId, String actionName, Callback&lt;Object&gt; targetCallback) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return transactionTemplate.execute(status -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection conn = DataSourceUtils.getConnection(dataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boolean result = insertTCCFenceLog(conn, xid, branchId, actionName, TCCFenceConstant.STATUS_TRIED);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.info("TCC fence prepare result: {}. xid: {}, branchId: {}", result, xid, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (result) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return targetCallback.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new TCCFenceException(String.format("Insert tcc fence record error, prepare fence failed. xid= %s, branchId= %s", xid, branchId),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        FrameworkErrorCode.InsertRecordError);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (TCCFenceException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The processing logic in the Rollback phase is as follows:</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//TCCFenceHandler </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static boolean rollbackFence(Method rollbackMethod, Object targetTCCBean,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    String xid, Long branchId, Object[] args, String actionName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return transactionTemplate.execute(status -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection conn = DataSourceUtils.getConnection(dataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TCCFenceDO tccFenceDO = TCC_FENCE_DAO.queryTCCFenceDO(conn, xid, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // non_rollback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (tccFenceDO == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //The rollback logic is not executed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (TCCFenceConstant.STATUS_ROLLBACKED == tccFenceDO.getStatus() || TCCFenceConstant.STATUS_SUSPENDED == tccFenceDO.getStatus()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOGGER.info("Branch transaction had already rollbacked before, idempotency rejected. xid: {}, branchId: {}, status: {}", xid, branchId, tccFenceDO.getStatus());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (TCCFenceConstant.STATUS_COMMITTED == tccFenceDO.getStatus()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (LOGGER.isWarnEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        LOGGER.warn("Branch transaction status is unexpected. xid: {}, branchId: {}, status: {}", xid, branchId, tccFenceDO.getStatus());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return updateStatusAndInvokeTargetMethod(conn, rollbackMethod, targetTCCBean, xid, branchId, TCCFenceConstant.STATUS_ROLLBACKED, status, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            status.setRollbackOnly();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new SkipCallbackWrapperException(t);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>updateStatusAndInvokeTargetMethod method executes the following SQL:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">update</span><span class="token plain"> tcc_fence_log </span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">status</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ?</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gmt_modified </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> xid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ? </span><span class="token operator" style="color:#393A34">and</span><span class="token plain">  branch_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ? </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">status</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ? </span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As we can see, it updates the value of the status field in the tcc_fence_log table from STATUS_TRIED to STATUS_ROLLBACKED. If the update is successful, the rollback logic is executed.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="43-hanging">4.3 Hanging<a href="#43-hanging" class="hash-link" aria-label="Direct link to 4.3 Hanging" title="Direct link to 4.3 Hanging">​</a></h3><p>Hanging refers to a situation where, due to network issues, the RM did not receive the try instruction initially, but after executing the rollback, the RM receives the try instruction and successfully reserves resources. This leads to the inability to release the reserved resources, as shown in the following diagram:</p><p><img loading="lazy" alt="fence-suspend" src="/assets/images/fence-suspend-054f87611ab16153c07bd28495c6902c.png" width="451" height="193" class="img_ev3q"></p><p>Seata solves this problem by checking if there is a record for the current xid in the tcc_fence_log table before executing the rollback method. If there is no record, it inserts a new record into the tcc_fence_log table with the status STATUS_SUSPENDED and does not perform the rollback operation. The code is as follows:</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static boolean rollbackFence(Method rollbackMethod, Object targetTCCBean,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    String xid, Long branchId, Object[] args, String actionName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return transactionTemplate.execute(status -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection conn = DataSourceUtils.getConnection(dataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TCCFenceDO tccFenceDO = TCC_FENCE_DAO.queryTCCFenceDO(conn, xid, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // non_rollback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (tccFenceDO == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                boolean result = insertTCCFenceLog(conn, xid, branchId, actionName, TCCFenceConstant.STATUS_SUSPENDED);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return updateStatusAndInvokeTargetMethod(conn, rollbackMethod, targetTCCBean, xid, branchId, TCCFenceConstant.STATUS_ROLLBACKED, status, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When executing the try phase method, a record for the current xid is first inserted into the tcc_fence_log table, which causes a primary key conflict. The code is as follows:</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//TCCFenceHandler </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static Object prepareFence(String xid, Long branchId, String actionName, Callback&lt;Object&gt; targetCallback) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return transactionTemplate.execute(status -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection conn = DataSourceUtils.getConnection(dataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boolean result = insertTCCFenceLog(conn, xid, branchId, actionName, TCCFenceConstant.STATUS_TRIED);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (TCCFenceException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (e.getErrcode() == FrameworkErrorCode.DuplicateKeyException) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOGGER.error("Branch transaction has already rollbacked before,prepare fence failed. xid= {},branchId = {}", xid, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                addToLogCleanQueue(xid, branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            status.setRollbackOnly();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new SkipCallbackWrapperException(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note: The queryTCCFenceDO method in the SQL statement uses for update, so there is no need to worry about not being able to determine the execution result of the local transaction in the rollback method due to the inability to obtain records from the tcc_fence_log table.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-summary">5 Summary<a href="#5-summary" class="hash-link" aria-label="Direct link to 5 Summary" title="Direct link to 5 Summary">​</a></h3><p>TCC mode is a very important transaction mode in distributed transactions. However, idempotence, hanging, and empty rollback have always been issues that need to be considered in TCC mode. The Seata framework perfectly solves these problems in version 1.5.1.
The operations on the tcc_fence_log table also need to consider transaction control. Seata uses a proxy data source to execute the operations on the tcc_fence_log table and the RM business operations in the same local transaction. This ensures that the local operations and the operations on the tcc_fence_log table succeed or fail together.</p>]]></content>
        <author>
            <name>Zhu Jinjun</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[In-Depth Analysis of Seata TCC Mode (1)]]></title>
        <id>https://seata.apache.org/blog/seata-tcc</id>
        <link href="https://seata.apache.org/blog/seata-tcc"/>
        <updated>2022-01-18T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Seata currently supports AT mode, XA mode, TCC mode, and SAGA mode. Previous articles have talked more about non-intrusive AT mode. Today, we will introduce TCC mode, which is also a two-phase commit.]]></summary>
        <content type="html"><![CDATA[<p>Seata currently supports AT mode, XA mode, TCC mode, and SAGA mode. Previous articles have talked more about non-intrusive AT mode. Today, we will introduce TCC mode, which is also a two-phase commit.</p><h1>What is TCC</h1><p>TCC is a two-phase commit protocol in distributed transactions. Its full name is Try-Confirm-Cancel. Their specific meanings are as follows:</p><ol><li>Try: Check and reserve business resources;</li><li>Confirm: Commit the business transaction, i.e., the commit operation. If Try is successful, this step will definitely be successful;</li><li>Cancel: Cancel the business transaction, i.e., the rollback operation. This step will release the resources reserved in Try.</li></ol><p>TCC is an intrusive distributed transaction solution. All three operations need to be implemented by the business system itself, which has a significant impact on the business system. The design is relatively complex, but the advantage is that TCC does not rely on the database. It can manage resources across databases and applications, and can implement an atomic operation for different data access through intrusive coding, better solving the distributed transaction problems in various complex business scenarios.</p><img loading="lazy" src="/img/blog/20220116160157.png" alt="img" style="zoom:50%" class="img_ev3q"><h1>Seata TCC mode</h1><p>Seata TCC mode follows the same principle as the general TCC mode. Let's first use Seata TCC mode to implement a distributed transaction:</p><p>Suppose there is a business that needs to use service A and service B to complete a transaction operation. We define a TCC interface for this service in service A:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface TccActionOne {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @TwoPhaseBusinessAction(name = "DubboTccActionOne", commitMethod = "commit", rollbackMethod = "rollback")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean prepare(BusinessActionContext actionContext, @BusinessActionContextParameter(paramName = "a") String a);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean commit(BusinessActionContext actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean rollback(BusinessActionContext actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Similarly, we define a TCC interface for this service in service B:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface TccActionTwo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @TwoPhaseBusinessAction(name = "DubboTccActionTwo", commitMethod = "commit", rollbackMethod = "rollback")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void prepare(BusinessActionContext actionContext, @BusinessActionContextParameter(paramName = "b") String b);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void commit(BusinessActionContext actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void rollback(BusinessActionContext actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the business system, we start a global transaction and execute the TCC reserve resource methods for service A and service B:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@GlobalTransactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public String doTransactionCommit(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Service A transaction participant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tccActionOne.prepare(null,"one");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Service B transaction participant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tccActionTwo.prepare(null,"two");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The example above demonstrates the implementation of a global transaction using Seata TCC mode. It can be seen that the TCC mode also uses the <code>@GlobalTransactional</code> annotation to initiate a global transaction, while the TCC interfaces of Service A and Service B are transaction participants. Seata treats a TCC interface as a Resource, also known as a TCC Resource.</p><p>TCC interfaces can be RPC or internal JVM calls, meaning that a TCC interface has both a sender and a caller identity. In the example above, the TCC interface is the sender in Service A and Service B, and the caller in the business system. If the TCC interface is a Dubbo RPC, the caller is a dubbo:reference and the sender is a dubbo:service.</p><img loading="lazy" src="/img/blog/20220116161933.png" alt="img" style="zoom:50%" class="img_ev3q"><p>When Seata starts, it scans and parses the TCC interfaces. If a TCC interface is a sender, Seata registers the TCC Resource with the TC during startup, and each TCC Resource has a resource ID. If a TCC interface is a caller, Seata proxies the caller and intercepts the TCC interface calls. Similar to the AT mode, the proxy intercepts the call to the Try method, registers a branch transaction with the TC, and then executes the original RPC call.</p><p>When the global transaction decides to commit/rollback, the TC will callback to the corresponding participant service to execute the Confirm/Cancel method of the TCC Resource using the resource ID registered by the branch.</p><h1>How Seata Implements TCC Mode</h1><p>From the above Seata TCC model, it can be seen that the TCC mode in Seata also follows the TC, TM, RM three-role model. How to implement TCC mode in these three-role models? I mainly summarize the implementation as resource parsing, resource management, and transaction processing.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="resource-parsing">Resource Parsing<a href="#resource-parsing" class="hash-link" aria-label="Direct link to Resource Parsing" title="Direct link to Resource Parsing">​</a></h2><p>Resource parsing is the process of parsing and registering TCC interfaces. As mentioned earlier, TCC interfaces can be RPC or internal JVM calls. In the Seata TCC module, there is a remoting module that is specifically used to parse TCC interfaces with the <code>TwoPhaseBusinessAction</code> annotation:</p><img loading="lazy" src="/img/blog/20220116175059.png" alt="img" style="zoom:50%" class="img_ev3q"><p>The <code>RemotingParser</code> interface mainly has methods such as <code>isRemoting</code>, <code>isReference</code>, <code>isService</code>, <code>getServiceDesc</code>, etc. The default implementation is <code>DefaultRemotingParser</code>, and the parsing of various RPC protocols is executed in <code>DefaultRemotingParser</code>. Seata has already implemented parsing of Dubbo, HSF, SofaRpc, and LocalTCC RPC protocols while also providing SPI extensibility for additional RPC protocol parsing classes.</p><p>During the Seata startup process, the <code>GlobalTransactionScanner</code> annotation is used for scanning and executes the following method:</p><p><code>io.seata.spring.util.TCCBeanParserUtils#isTccAutoProxy</code></p><p>The purpose of this method is to determine if the bean has been TCC proxied. In the process, it first checks if the bean is a Remoting bean. If it is, it calls the <code>getServiceDesc</code> method to parse the remoting bean, and if it is a sender, it registers the resource:</p><p>io.seata.rm.tcc.remoting.parser.DefaultRemotingParser#parserRemotingServiceInfo</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public RemotingDesc parserRemotingServiceInfo(Object bean, String beanName, RemotingParser remotingParser){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RemotingDesc remotingBeanDesc = remotingParser.getServiceDesc(bean, beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if(remotingBeanDesc == null){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    remotingServiceMap.put(beanName, remotingBeanDesc);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;?&gt; interfaceClass = remotingBeanDesc.getInterfaceClass();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Method[] methods = interfaceClass.getMethods();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (remotingParser.isService(bean, beanName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //service bean, registry resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object targetBean = remotingBeanDesc.getTargetBean();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (Method m : methods) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TwoPhaseBusinessAction twoPhaseBusinessAction = m.getAnnotation(TwoPhaseBusinessAction.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (twoPhaseBusinessAction != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    TCCResource tccResource = new TCCResource();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tccResource.setActionName(twoPhaseBusinessAction.name());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tccResource.setTargetBean(targetBean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tccResource.setPrepareMethod(m);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tccResource.setCommitMethodName(twoPhaseBusinessAction.commitMethod());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tccResource.setCommitMethod(interfaceClass.getMethod(twoPhaseBusinessAction.commitMethod(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    twoPhaseBusinessAction.commitArgsClasses()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tccResource.setRollbackMethodName(twoPhaseBusinessAction.rollbackMethod());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tccResource.setRollbackMethod(interfaceClass.getMethod(twoPhaseBusinessAction.rollbackMethod(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    twoPhaseBusinessAction.rollbackArgsClasses()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // set argsClasses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tccResource.setCommitArgsClasses(twoPhaseBusinessAction.commitArgsClasses());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tccResource.setRollbackArgsClasses(twoPhaseBusinessAction.rollbackArgsClasses());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // set phase two method's keys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tccResource.setPhaseTwoCommitKeys(this.getTwoPhaseArgs(tccResource.getCommitMethod(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    twoPhaseBusinessAction.commitArgsClasses()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tccResource.setPhaseTwoRollbackKeys(this.getTwoPhaseArgs(tccResource.getRollbackMethod(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    twoPhaseBusinessAction.rollbackArgsClasses()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // registry tcc resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    DefaultResourceManager.get().registerResource(tccResource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new FrameworkException(t, "parser remoting service error");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (remotingParser.isReference(bean, beanName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // reference bean, TCC proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        remotingBeanDesc.setReference(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return remotingBeanDesc;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above method first calls the parsing class <code>getServiceDesc</code> method to parse the remoting bean and puts the parsed <code>remotingBeanDesc</code> into the local cache <code>remotingServiceMap</code>. At the same time, it calls the parsing class <code>isService</code> method to determine if it is the initiator. If it is the initiator, it parses the content of the <code>TwoPhaseBusinessAction</code> annotation to generate a <code>TCCResource</code> and registers it as a resource.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="resource-management">Resource Management<a href="#resource-management" class="hash-link" aria-label="Direct link to Resource Management" title="Direct link to Resource Management">​</a></h2><p><strong>1. Resource Registration</strong></p><p>The resource for Seata TCC mode is called <code>TCCResource</code>, and its resource manager is called <code>TCCResourceManager</code>. As mentioned earlier, after parsing the TCC interface RPC resource, if it is the initiator, it will be registered as a resource:</p><p>io.seata.rm.tcc.TCCResourceManager#registerResource</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void registerResource(Resource resource){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TCCResource tccResource=(TCCResource)resource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tccResourceCache.put(tccResource.getResourceId(),tccResource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.registerResource(tccResource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>TCCResource</code> contains the relevant information of the TCC interface and is cached locally. It continues to call the parent class <code>registerResource</code> method (which encapsulates communication methods) to register with the TC. The TCC resource's resourceId is the actionName, and the actionName is the name in the <code>@TwoParseBusinessAction</code> annotation.</p><p><strong>2. Resource Commit/Rollback</strong></p><p>io.seata.rm.tcc.TCCResourceManager#branchCommit</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public BranchStatus branchCommit(BranchType branchType,String xid,long branchId,String resourceId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String applicationData)throws TransactionException{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TCCResource tccResource=(TCCResource)tccResourceCache.get(resourceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if(tccResource==null){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw new ShouldNeverHappenException(String.format("TCC resource is not exist, resourceId: %s",resourceId));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object targetTCCBean=tccResource.getTargetBean();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Method commitMethod=tccResource.getCommitMethod();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if(targetTCCBean==null||commitMethod==null){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw new ShouldNeverHappenException(String.format("TCC resource is not available, resourceId: %s",resourceId));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //BusinessActionContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BusinessActionContext businessActionContext=getBusinessActionContext(xid,branchId,resourceId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    applicationData);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ... ... </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret=commitMethod.invoke(targetTCCBean,args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ... ... </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return result?BranchStatus.PhaseTwo_Committed:BranchStatus.PhaseTwo_CommitFailed_Retryable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }catch(Throwable t){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String msg=String.format("commit TCC resource error, resourceId: %s, xid: %s.",resourceId,xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOGGER.error(msg,t);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return BranchStatus.PhaseTwo_CommitFailed_Retryable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When the TM resolves the phase two commit, the TC will callback to the corresponding participant (i.e., TCC interface initiator) service to execute the Confirm/Cancel method of the TCC Resource registered by the branch.</p><p>In the resource manager, the corresponding <code>TCCResource</code> will be found in the local cache based on the resourceId, and the corresponding <code>BusinessActionContext</code> will be found based on xid, branchId, resourceId, and applicationData, and the parameters to be executed are in the context. Finally, the commit method of the <code>TCCResource</code> is executed to perform the phase two commit.</p><p>The phase two rollback is similar.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="transaction-processing">Transaction Processing<a href="#transaction-processing" class="hash-link" aria-label="Direct link to Transaction Processing" title="Direct link to Transaction Processing">​</a></h2><p>As mentioned earlier, if the TCC interface is a caller, the Seata TCC proxy will be used to intercept the caller and register the branch before processing the actual RPC method call.</p><p>The method <code>io.seata.spring.util.TCCBeanParserUtils#isTccAutoProxy</code> not only parses the TCC interface resources, but also determines whether the TCC interface is a caller. If it is a caller, it returns true:</p><p>io.seata.spring.annotation.GlobalTransactionScanner#wrapIfNecessary</p><img loading="lazy" src="/img/blog/20220116192544.png" alt="img" style="zoom:50%" class="img_ev3q"><p>As shown in the figure, when <code>GlobalTransactionalScanner</code> scans the TCC interface caller (Reference), it will proxy and intercept it with <code>TccActionInterceptor</code>, which implements <code>MethodInterceptor</code>.</p><p>In <code>TccActionInterceptor</code>, it will also call <code>ActionInterceptorHandler</code> to execute the interception logic, and the transaction-related processing is in the <code>ActionInterceptorHandler#proceed</code> method:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public Object proceed(Method method, Object[] arguments, String xid, TwoPhaseBusinessAction businessAction, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Callback&lt;Object&gt; targetCallback) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Get action context from arguments, or create a new one and then reset to arguments</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BusinessActionContext actionContext = getOrCreateActionContextAndResetToArguments(method.getParameterTypes(), arguments);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Creating Branch Record</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String branchId = doTccActionLogStore(method, arguments, businessAction, actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ... ... </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ... ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return targetCallback.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //to report business action context finally if the actionContext.getUpdated() is true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BusinessActionContextUtil.reportContext(actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ... ... </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the process of executing the first phase of the TCC interface, the <code>doTccActionLogStore</code> method is called for branch registration, and the TCC-related information such as parameters is placed in the context. This context will be used for resource submission/rollback as mentioned above.</p><h1>How to control exceptions</h1><p>In the process of executing the TCC model, various exceptions may occur, the most common of which are empty rollback, idempotence, and suspense. Here I will explain how Seata handles these three types of exceptions.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-handle-empty-rollback">How to handle empty rollback<a href="#how-to-handle-empty-rollback" class="hash-link" aria-label="Direct link to How to handle empty rollback" title="Direct link to How to handle empty rollback">​</a></h2><p>What is an empty rollback?</p><p>An empty rollback refers to a situation in a distributed transaction where the TM drives the second-phase rollback of the participant's Cancel method without calling the participant's Try method.</p><p>How does an empty rollback occur?</p><img loading="lazy" src="/img/blog/20220116201900.png" alt="img" style="zoom:50%" class="img_ev3q"><p>As shown in the above figure, after the global transaction is opened, participant A will execute the first-phase RPC method after completing branch registration. If the machine where participant A is located crashes or there is a network anomaly at this time, the RPC call will fail, meaning that participant A's first-phase method did not execute successfully. However, the global transaction has already been opened, so Seata must progress to the final state. When the global transaction is rolled back, participant A's Cancel method will be called, resulting in an empty rollback.</p><p>To prevent empty rollback, it is necessary to identify it in the Cancel method. How does Seata do this?</p><p>Seata's approach is to add a TCC transaction control table, which contains the XID and BranchID information of the transaction. A record is inserted when the Try method is executed, indicating that phase one has been executed. When the Cancel method is executed, this record is read. If the record does not exist, it means that the Try method was not executed.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-handle-idempotent-operations">How to Handle Idempotent Operations<a href="#how-to-handle-idempotent-operations" class="hash-link" aria-label="Direct link to How to Handle Idempotent Operations" title="Direct link to How to Handle Idempotent Operations">​</a></h2><p>Idempotent operation refers to TC repeating the two-phase commit, so the Confirm/Cancel interface needs to support idempotent processing, which means that it will not cause duplicate resource submission or release.</p><p>So how does idempotent operation arise?</p><img loading="lazy" src="/img/blog/20220116203816.png" alt="img" style="zoom:50%" class="img_ev3q"><p>As shown in the above figure, after participant A completes the two phases, network jitter or machine failure may cause TC not to receive the return result of participant A's execution of the two phases. TC will continue to make repeated calls until the two-phase execution result is successful.</p><p>How does Seata handle idempotent operations?</p><p>Similarly, a status field is added to the TCC transaction control table. This field has 3 values:</p><ol><li>tried: 1</li><li>committed: 2</li><li>rollbacked: 3</li></ol><p>After the execution of the two-phase Confirm/Cancel method, the status is changed to committed or rollbacked. When the two-phase Confirm/Cancel method is called repeatedly, checking the transaction status can solve the idempotent problem.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-handle-suspend">How to Handle Suspend<a href="#how-to-handle-suspend" class="hash-link" aria-label="Direct link to How to Handle Suspend" title="Direct link to How to Handle Suspend">​</a></h2><p>Suspension refers to the two-phase Cancel method being executed before the phase Try method, because empty rollback is allowed. After the execution of the two-phase Cancel method, directly returning success, the global transaction has ended. However, because the Try method is executed later, this will cause the resources reserved by the phase Try method to never be committed or released.</p><p>So how does suspension arise?</p><img loading="lazy" src="/img/blog/20220116205241.png" alt="img" style="zoom:50%" class="img_ev3q"><p>As shown in the above figure, when participant A's phase Try method is executed, network congestion occurs, and due to Seata's global transaction timeout limit, after the Try method times out, TM resolves to roll back the global transaction. After the rollback is completed, if the RPC request arrives at participant A at this time and the Try method is executed to reserve resources, it will cause suspension.</p><p>How does Seata handle suspension?</p><p>Add a status to the TCC transaction control table:</p><ol><li>suspended: 4</li></ol><p>When the two-phase Cancel method is executed, if it is found that there is no related record in the TCC transaction control table, it means that the two-phase Cancel method is executed before the phase Try method. Therefore, a record with status=4 is inserted. Then, when the phase Try method is executed, if status=4 is encountered, it means that the two-phase Cancel has been executed, and false is returned to prevent the phase Try method from succeeding.</p><h1>Author Introduction</h1><p>Zhang Chenghui, currently working at Ant Group, loves to share technology. He is the author of the WeChat public account "Advanced Backend," the author of the technical blog (<a href="https://objcoding.com/" target="_blank" rel="noopener noreferrer">https://objcoding.com/</a>), a Seata Committer, and his GitHub ID is: objcoding.</p>]]></content>
        <author>
            <name>Zhang Chenghui</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[In-Depth Analysis of Seata AT Mode Transaction Isolation Levels and Global Lock Design]]></title>
        <id>https://seata.apache.org/blog/seata-at-lock</id>
        <link href="https://seata.apache.org/blog/seata-at-lock"/>
        <updated>2022-01-12T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[The transaction isolation in Seata AT mode is built on the basis of local isolation levels of supporting transactions. Assuming a database local isolation level of Read Committed or higher, Seata designs a global write-exclusive lock maintained by the transaction coordinator to ensure write isolation between transactions. Meanwhile, the default isolation level for global transactions is defined at Read Uncommitted.]]></summary>
        <content type="html"><![CDATA[<p>Seata AT mode is a non-intrusive distributed transaction solution. Seata internally implements a proxy layer for database operations. When using Seata AT mode, we actually use the built-in data source proxy DataSourceProxy provided by Seata. Seata adds a lot of logic in this proxy layer, such as inserting rollback undo_log records and checking global locks.</p><p>Why check global locks? This is because the transaction isolation of Seata AT mode is based on the local isolation level of supporting transactions. Under the premise of database local isolation level of read committed or above, Seata designs a global write exclusive lock maintained by the transaction coordinator to ensure write isolation between transactions. At the same time, global transactions are by default defined at the read uncommitted isolation level.</p><h1>Understanding Seata Transaction Isolation Levels</h1><p>Before discussing Seata transaction isolation levels, let's review the isolation levels of database transactions. Currently, there are four types of database transaction isolation levels, from lowest to highest:</p><ol><li>Read uncommitted</li><li>Read committed</li><li>Repeatable read</li><li>Serializable</li></ol><p>The default isolation level for databases is usually read committed, such as Oracle, while some databases default to repeatable read, such as MySQL. Generally, the read committed isolation level of databases can satisfy the majority of business scenarios.</p><p>We know that a Seata transaction is a global transaction, which includes several local transaction branches. During the execution of a global transaction (before the global transaction is completed), if a local transaction commits and Seata does not take any measures, it may lead to reading of committed local transactions, causing dirty reads. If a local transaction that has been committed before the global transaction commits is modified, it may cause dirty writes.</p><p>From this, we can see that traditional dirty reads involve reading uncommitted data, while Seata's dirty reads involve reading data that has not been committed under the global transaction, where the global transaction may include multiple local transactions. The fact that one local transaction commits does not mean that the global transaction commits.</p><p>Working under the read committed isolation level is fine for the vast majority of applications. In fact, the majority of scenarios that work under the read uncommitted isolation level also work fine.</p><p>In extreme scenarios, if an application needs to achieve global read committed, Seata also provides a global lock mechanism to implement global transaction read committed. However, by default, Seata's global transactions work under the read uncommitted isolation level to ensure efficiency in the majority of scenarios.</p><h1>Implementation of Global Locks</h1><p>In AT mode, Seata uses the internal data source proxy DataSourceProxy, and the implementation of global locks is hidden within this proxy. Let's see what happens during the execution and submission processes.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-execution-process">1. Execution Process<a href="#1-execution-process" class="hash-link" aria-label="Direct link to 1. Execution Process" title="Direct link to 1. Execution Process">​</a></h2><p>The execution process is in the StatementProxy class. During execution, if the executed SQL is <code>select for update</code>, the SelectForUpdateExecutor class is used. If the executed method is annotated with <code>@GlobalTransactional</code> or <code>@GlobalLock</code>, it checks if there is a global lock. If a global lock exists, it rolls back the local transaction and continuously competes to obtain local and global locks through a while loop.</p><p>io.seata.rm.datasource.exec.SelectForUpdateExecutor#doExecute</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public T doExecute(Object... args) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Connection conn = statementProxy.getConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ... ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ... ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // ... ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (RootContext.inGlobalTransaction() || RootContext.requireGlobalLock()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Do the same thing under either @GlobalTransactional or @GlobalLock, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // that only check the global lock  here.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    statementProxy.getConnectionProxy().checkLock(lockKeys);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new RuntimeException("Unknown situation!");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (LockConflictException lce) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (sp != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    conn.rollback(sp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    conn.rollback();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // trigger retry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                lockRetryController.sleep(lce);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-submission-process">2. Submission Process<a href="#2-submission-process" class="hash-link" aria-label="Direct link to 2. Submission Process" title="Direct link to 2. Submission Process">​</a></h2><p>The submission process occurs in the doCommit method of ConnectionProxy.</p><p>1) If the executed method is annotated with <code>@GlobalTransactional</code>, it will acquire the global lock during branch registration:</p><ul><li>Requesting TC to register a branch</li></ul><p>io.seata.rm.datasource.ConnectionProxy#register</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private void register() throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!context.hasUndoLog() || !context.hasLockKey()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Long branchId = DefaultResourceManager.get().branchRegister(BranchType.AT, getDataSourceProxy().getResourceId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                null, context.getXid(), null, context.buildLockKeys());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.setBranchId(branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>When a TC registers a branch, it obtains a global lock</li></ul><p>io.seata.server.transaction.at.ATCore#branchSessionLock</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">protected void branchSessionLock(GlobalSession globalSession, BranchSession branchSession) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!branchSession.lock()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new BranchTransactionException(LockKeyConflict, String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             .format("Global lock acquire failed xid = %s branchId = %s", globalSession.getXid(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                     branchSession.getBranchId()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2）If the execution method has a '@GlobalLock' annotation, the global lock is checked for existence before committing, and if it does, an exception is thrown:</p><p>io.seata.rm.datasource.ConnectionProxy#processLocalCommitWithGlobalLocks</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private void processLocalCommitWithGlobalLocks() throws SQLException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    checkLock(context.buildLockKeys());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        targetConnection.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new SQLException(ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.reset();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="globallock-annotation-explanation">GlobalLock Annotation Explanation<a href="#globallock-annotation-explanation" class="hash-link" aria-label="Direct link to GlobalLock Annotation Explanation" title="Direct link to GlobalLock Annotation Explanation">​</a></h2><p>From the execution process and submission process, it can be seen that since opening a global transaction with the <code>@GlobalTransactional</code> annotation can check if the global lock exists before transaction submission, why does Seata still provide a <code>@GlobalLock</code> annotation?</p><p>This is because not all database operations require opening a global transaction, and opening a global transaction is a relatively heavy operation that involves initiating RPC processes to TC. The <code>@GlobalLock</code> annotation only checks the existence of the global lock during the execution process and does not initiate a global transaction. Therefore, when there is no need for a global transaction but the global lock needs to be checked to avoid dirty reads and writes, using the <code>@GlobalLock</code> annotation is a lighter operation.</p><h1>How to Prevent Dirty Writes</h1><p>Let's first understand how dirty writes occur when using Seata AT mode:</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20211226164628.png" class="img_ev3q"></p><p><em>Note: Other processes in the branch transaction execution are omitted.</em></p><p>When Business One starts a global transaction containing branch transaction A (modifying A) and branch transaction B (modifying B), Business Two modifies A. Business One's branch transaction A obtains a local lock before Business Two, waiting for Business One to complete the execution of branch transaction A. Business Two then obtains the local lock, modifies A, and commits it to the database. However, Business One encounters an exception during the execution of branch transaction A. Since the data of branch transaction A has been modified by Business Two, Business One's global transaction cannot be rolled back.</p><p>How to prevent dirty writes?</p><ol><li>Business Two uses <code>@GlobalTransactional</code> annotation:</li></ol><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20211226210337.png" class="img_ev3q"></p><p><em>Note: Other processes in the branch transaction execution are omitted.</em></p><p>During the execution of the global transaction by Business Two, when registering the branch transaction before the submission of branch transaction A and acquiring the global lock, it finds that Business One's global lock has not been released yet. Therefore, Business Two cannot commit and throws an exception to roll back, thus preventing dirty writes.</p><ol start="2"><li>Business Two uses <code>@GlobalLock</code> annotation:</li></ol><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20211226210502.png" class="img_ev3q"></p><p><em>Note: Other processes in the branch transaction execution are omitted.</em></p><p>Similar to the effect of <code>@GlobalTransactional</code> annotation, but without the need to open a global transaction, it only checks the existence of the global lock before local transaction submission.</p><ol start="3"><li>Business Two uses <code>@GlobalLock</code> annotation + <code>select for update</code> statement:</li></ol><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20211226172358.png" class="img_ev3q"></p><p>If a <code>select for update</code> statement is added, it checks the existence of the global lock before the update operation. Business Two can only execute the updateA operation after the global lock is released.</p><p>If only <code>@Transactional</code> is used, there is a possibility of dirty writes. The fundamental reason is that without the GlobalLock annotation, the global lock is not checked, which may lead to another global transaction finding that a branch transaction has been modified when rolling back. Therefore, adding <code>select for update</code> also has a benefit, which is that it allows for retries.</p><h1>How to Prevent Dirty Reads</h1><p>Dirty reads in Seata AT mode refer to the scenario where data from a branch transaction that has been committed is read by another business before the global transaction is committed. Essentially, this is because Seata's default global transaction isolation level is read uncommitted.</p><p>So how to prevent dirty reads?</p><p>Business Two queries A with <code>@GlobalLock</code> annotation + <code>select for update</code> statement:</p><p><img loading="lazy" src="https://gitee.com/objcoding/md-picture/raw/master/img/20211226210633.png" class="img_ev3q"></p><p>Adding the <code>select for update</code> statement checks the existence of the global lock before executing the SQL. The SQL can only be executed after the global lock is acquired, thus preventing dirty reads.</p><h1>Author Bio:</h1><p>Zhang Chenghui currently works at Ant Group and is passionate about sharing technology. He is the author of the WeChat public account "后端进阶" (Backend Advancement) and the owner of the technical blog (<a href="https://objcoding.com/" target="_blank" rel="noopener noreferrer">https://objcoding.com/</a>). He is also a Seata Contributor with GitHub ID: objcoding.</p>]]></content>
        <author>
            <name>chenghui.zhang</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Q&A on the New Version of Snowflake Algorithm]]></title>
        <id>https://seata.apache.org/blog/seata-snowflake-explain</id>
        <link href="https://seata.apache.org/blog/seata-snowflake-explain"/>
        <updated>2021-06-21T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In the previous analysis of the new version of the Snowflake algorithm, we mentioned two changes made in the new version:]]></summary>
        <content type="html"><![CDATA[<p>In the previous analysis of the new version of the Snowflake algorithm, we mentioned two changes made in the new version:</p><ol><li>The timestamp no longer constantly follows the system clock.</li><li>The exchange of positions between node ID and timestamp. From the original:
<img loading="lazy" alt="Original Bit Allocation Strategy" src="/assets/images/before-8c52102c116e08f0b37d947b30008b58.png" width="904" height="156" class="img_ev3q">
to:
<img loading="lazy" alt="Improved Bit Allocation Strategy" src="/assets/images/after-cad00baeb92d348340136601174c9d8c.png" width="900" height="157" class="img_ev3q"></li></ol><p>A careful student raised a question: In the new version, the algorithm is indeed monotonically increasing within a single node, but in a multi-instance deployment, it is no longer globally monotonically increasing! Because it is obvious that the node ID is in the high bits, so the generated ID with a larger node ID will definitely be greater than the ID with a smaller node ID, regardless of the chronological order. In contrast, the original algorithm, with the timestamp in the high bits and always following the system clock, can ensure that IDs generated earlier are smaller than those generated later. Only when two nodes happen to generate IDs at the same timestamp, the order of the two IDs is determined by the node ID. So, does it mean that the new version of the algorithm is wrong?</p><p>This is a great question! The fact that students can raise this question indicates a deep understanding of the essential differences between the standard Snowflake algorithm and the new version. This is commendable! Here, let's first state the conclusion: indeed, the new version of the algorithm does not possess global monotonicity, but this does not affect our original intention (to reduce database page splits). This conclusion may seem counterintuitive but can be proven.</p><p>Before providing the proof, let's briefly review some knowledge about page splits in databases. Taking the classic MySQL InnoDB as an example, InnoDB uses a B+ tree index where the leaf nodes of the primary key index also store the complete records of data rows. The leaf nodes are linked together in the form of a doubly linked list. The physical storage form of the leaf nodes is a data page, and each data page can store up to N rows of records (where N is inversely proportional to the size of each row). As shown in the diagram:
<img loading="lazy" alt="Data Page" src="/assets/images/page1-09fa5360a09c5f6ce7e1c5978f370eb1.png" width="956" height="256" class="img_ev3q">
The characteristics of the B+ tree require that the left node should be smaller than the right node. What happens if we want to insert a record with an ID of 25 at this point (assuming each data page can only hold 4 records)? The answer is that it will cause a page split, as shown in the diagram:
<img loading="lazy" alt="Page Split" src="/assets/images/page2-0ddae897017478780b7f338cca9daa02.png" width="1213" height="270" class="img_ev3q">
Page splits are unfriendly to I/O, requiring the creation of new data pages, copying and transferring part of the records from the old data page, etc., and should be avoided as much as possible.</p><p>Ideally, the primary key ID should be sequentially increasing (for example, setting the primary key as auto_increment). This way, a new page will only be needed when the current data page is full, and the doubly linked list will always grow sequentially at the tail, avoiding any mid-node splits.</p><p>In the worst-case scenario, if the primary key ID is randomly generated and unordered (for example, a UUID string in Java), new records will be randomly assigned to any data page. If the page is already full, it will trigger a page split.</p><p>If the primary key ID is generated by the standard Snowflake algorithm, in the best-case scenario, only one node is generating IDs within each timestamp. In this case, the algorithm's effect is equivalent to the ideal situation of sequential incrementation, similar to auto_increment. In the worst-case scenario, all nodes within each timestamp are generating IDs, and the algorithm's effect is close to unordered (but still much better than completely unordered UUIDs, as the workerId with only 10 bits limits the nodes to a maximum of 1024). In actual production, the algorithm's effectiveness depends on business traffic, and the lower the concurrency, the closer the algorithm is to the ideal scenario.</p><p>So, how does it fare with the new version of the algorithm?  </p><p>The new version of the algorithm, from a global perspective, produces IDs in an unordered manner. However, for each workerId, the generated IDs are strictly monotonically increasing. Additionally, since workerId is finite, it can divide into a maximum of 1024 subsequences, each of which is monotonically increasing.</p><p>For a database, initially, the received IDs may be unordered, coming from various subsequences, as illustrated here:
<img loading="lazy" alt="Initial State" src="/assets/images/page3-00bbd658b09cdde9b7cb39a0bd38fbe0.png" width="986" height="268" class="img_ev3q"></p><p>If, at this point, a worker1-seq2 arrives, it will clearly cause a page split:
<img loading="lazy" alt="First Split" src="/assets/images/page4-883fee2cd79ec31b7f1d67c9e6362bca.png" width="1228" height="258" class="img_ev3q"></p><p>However, after the split, interesting things happen. For worker1, subsequent seq3, seq4 will not cause page splits anymore (because there is still space), and seq5 only needs to link to a new page for sequential growth (the difference is that this new page is not at the tail of the doubly linked list). Note that the subsequent IDs of worker1 will not be placed after any nodes from worker2 or beyond (thus avoiding page splits for later nodes) because they are always smaller than the IDs of worker2; nor will they be placed before the current node of worker1 (thus avoiding page splits for previous nodes) because the subsequences of worker1 are always monotonically increasing. Here, we refer to such subsequences as reaching a steady state, meaning that the subsequence has "stabilized," and its subsequent growth will only occur at the end of the subsequence without causing page splits for other nodes.</p><p>The same principle can be extended to all subsequences. Regardless of how chaotic the IDs received by the database are initially, after a finite number of page splits, the doubly linked list can always reach a stable state:
<img loading="lazy" alt="Steady State" src="/assets/images/page5-24bcb08065fcf74b8e6a55b3c54e81b2.png" width="789" height="298" class="img_ev3q"></p><p>After reaching the steady state, subsequent IDs will only grow sequentially within their respective subsequences, without causing page splits. The difference between this sequential growth and the sequential growth of auto_increment is that the former has 1024 growth points (the ends of various subsequences), while the latter only has one at the end.</p><p>At this point, we can answer the question posed at the beginning: indeed, the new algorithm is not globally monotonically increasing, but the algorithm <strong>converges</strong>. After reaching a steady state, the new algorithm can achieve the same effect as global sequential incrementation.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="further-considerations">Further Considerations<a href="#further-considerations" class="hash-link" aria-label="Direct link to Further Considerations" title="Direct link to Further Considerations">​</a></h2><p>The discussion so far has focused on the continuous growth of sequences. However, in practical production, there is not only the insertion of new data but also the deletion of old data. Data deletion may lead to page merging (InnoDB, if it finds that the space utilization of two adjacent data pages is both less than 50%, it will merge them). How does this affect the new algorithm?</p><p>As we have seen in the above process, the essence of the new algorithm is to utilize early page splits to gradually separate different subsequences, allowing the algorithm to continuously converge to a steady state. Page merging, on the other hand, may reverse this process by merging different subsequences back into the same data page, hindering the convergence of the algorithm. Especially in the early stages of convergence, frequent page merging may even prevent the algorithm from converging forever (I just separated them, and now I'm merging them back together, back to square one~)! However, after convergence, only page merging at the end nodes of each subsequence has the potential to disrupt the steady state (merging the end node of one subsequence with the head node of the next subsequence). Merging on the remaining nodes of the subsequence does not affect the steady state because the subsequence remains ordered, albeit with a shorter length.</p><p>Taking Seata's server as an example, the data in the three tables of the server has a relatively short lifecycle. After a global transaction ends, the data is cleared. This is not friendly to the new algorithm, as it does not provide enough time for convergence. However, there is already a pull request (PR) for delayed deletion in the review process, and with this PR, the effect will be much better. For example, periodic weekly cleanup allows sufficient time for the algorithm to converge in the early stages, and for most of the time, the database can benefit from it. At the time of cleanup, the worst-case result is that the table is cleared, and the algorithm starts from scratch.</p><p>If you wish to apply the new algorithm to a business system, make sure to ensure that the algorithm has time to converge. For example, for user tables or similar, where data is intended to be stored for a long time, the algorithm can naturally converge. Alternatively, implement a mechanism for delayed deletion, providing enough time for the algorithm to converge.</p><p>If you have better opinions and suggestions, feel free to contact the Seata community!</p>]]></content>
        <author>
            <name>selfishlover</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Analysis of Seata's Distributed UUID Generator Based on Improved Snowflake Algorithm]]></title>
        <id>https://seata.apache.org/blog/seata-analysis-UUID-generator</id>
        <link href="https://seata.apache.org/blog/seata-analysis-UUID-generator"/>
        <updated>2021-05-08T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Seata incorporates a distributed UUID generator to assist in generating global transaction IDs and branch transaction IDs. The desired characteristics for this generator include high performance, global uniqueness, and trend incrementation.]]></summary>
        <content type="html"><![CDATA[<p>Seata incorporates a distributed UUID generator to assist in generating global transaction IDs and branch transaction IDs. The desired characteristics for this generator include high performance, global uniqueness, and trend incrementation.</p><p>High performance is self-explanatory, and global uniqueness is crucial to prevent confusion between different global transactions or branch transactions. Additionally, trend incrementation is valuable for users employing databases as the storage tool for TC clusters, as it can reduce the frequency of data page splits, thereby minimizing database IO pressure (the <code>branch_table</code> table uses the branch transaction ID as the primary key).</p><p>In the older version of Seata (prior to 1.4), the implementation of this generator was based on the standard version of the Snowflake algorithm. The standard Snowflake algorithm has been well-documented online, so we won't delve into it here. If you're unfamiliar with it, consider referring to existing resources before continuing with this article.</p><p>Here, we discuss some drawbacks of the standard Snowflake algorithm:</p><ol><li><p><strong>Clock Sensitivity:</strong> Since ID generation is always tied to the current operating system's timestamp (leveraging the monotonicity of time), a clock rollback may result in repeated IDs. Seata's strategy to handle this is by recording the last timestamp and rejecting service if the current timestamp is less than the recorded value (indicating a clock rollback). The service waits until the timestamp catches up with the recorded value. However, this means the TC will be in an unavailable state during this period.</p></li><li><p><strong>Burst Performance Limit:</strong> The standard Snowflake algorithm claims a high QPS, approximately 4 million/s. However, strictly speaking, this is a bit misleading. The timestamp unit of the algorithm is milliseconds, and the bit length allocated to the sequence number is 12, allowing for 4096 sequence spaces per millisecond. So, a more accurate description would be 4096/ms. The distinction between 4 million/s and 4096/ms lies in the fact that the former doesn't require every millisecond's concurrency to be below 4096. Seata also adheres to this limitation. If the sequence space for the current timestamp is exhausted, it will spin-wait for the next timestamp.</p></li></ol><p>In newer versions (1.4 and beyond), the generator has undergone optimizations and improvements to address these issues effectively. The core idea of the improvement is to decouple from the operating system's timestamp, with the generator obtaining the system's current timestamp only during initialization as the initial timestamp. Subsequently, it no longer synchronizes with the system timestamp. The incrementation is solely driven by the incrementation of the sequence number. For example, when the sequence number reaches its maximum value (4095), the next request causes an overflow of the 12-bit space. The sequence number resets to zero, and the overflow carry is added to the timestamp, incrementing it by 1. Thus, the timestamp and sequence number can be considered as a single entity. In practice, we adjusted the bit allocation strategy for the 64-bit ID, swapping the positions of the timestamp and node ID for easier handling of this overflow carry:</p><p>Original Bit Allocation Strategy:
<img loading="lazy" alt="Original Bit Allocation Strategy" src="/assets/images/before-8c52102c116e08f0b37d947b30008b58.png" width="904" height="156" class="img_ev3q"></p><p>Modified Bit Allocation Strategy (swapping timestamp and node ID):
<img loading="lazy" alt="Modified Bit Allocation Strategy" src="/assets/images/after-cad00baeb92d348340136601174c9d8c.png" width="900" height="157" class="img_ev3q"></p><p>This arrangement allows the timestamp and sequence number to be contiguous in memory, making it easy to use an <code>AtomicLong</code> to simultaneously store them.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * timestamp and sequence mix in one Long</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * highest 11 bit: not used</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * middle  41 bit: timestamp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * lowest  12 bit: sequence</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private AtomicLong timestampAndSequence;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The highest 11 bits can be determined during initialization and remain unchanged thereafter:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * business meaning: machine ID (0 ~ 1023)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * actual layout in memory:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * highest 1 bit: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * middle 10 bit: workerId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * lowest 53 bit: all 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private long workerId;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Producing an ID is then straightforward：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public long nextId() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // Obtain the incremented timestamp and sequence number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   long next = timestampAndSequence.incrementAndGet();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // Extract the lowest 53 bits</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   long timestampWithSequence = next &amp; timestampAndSequenceMask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // Perform a bitwise OR operation with the previously saved top 11 bits</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   return workerId | timestampWithSequence;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>At this point, we can observe the following:</p><ol><li><p>The generator no longer has a burst performance limit of 4096/ms. If the sequence number space for a timestamp is exhausted, it will directly advance to the next timestamp, "borrowing" the sequence number space of the next timestamp (there is no need to worry about serious consequences of this "advance consumption," as the reasons will be explained below).</p></li><li><p>The generator has a weak dependency on the operating system clock. During runtime, the generator is not affected by clock backtracking (whether it is manually backtracked or due to machine clock drift) because the generator only fetches the system clock once at startup, and thereafter, they no longer stay synchronized. The only possible scenario for duplicate IDs is a significant clock backtracking during restart (either deliberate human backtracking or modification of the operating system time zone, such as changing Beijing time to London time~ Machine clock drift is typically in the millisecond range and won't have such a large impact).</p></li><li><p>Will continuous "advance consumption" cause the generator's timestamps to be significantly ahead of the system timestamps, resulting in ID duplicates upon restart? In theory, yes, but practically almost impossible. To achieve this effect, it would mean that the generator's QPS received must be consistently stable at over 400w/s~ To be honest, even TC can't handle such high traffic, so, the bottleneck is definitely not in the generator.</p></li></ol><p>In addition, we also adjusted the strategy for generating node IDs. In the original version, when the user did not manually specify a node ID, it would take the low 10 bits of the local IPv4 address as the node ID. In practical production, it was found that there were occasional occurrences of duplicate node IDs (mostly users deploying with k8s). For example, the following IPs would result in duplicates:</p><ul><li>192.168.4.10</li><li>192.168.8.10</li></ul><p>Meaning, as long as the low 2 bits of the fourth byte and the third byte of the IP are the same, duplicates would occur. The new version's strategy is to prioritize taking the low 10 bits from the MAC address of the local network card. If the local machine does not have a valid network card configuration, it randomly picks one from <!-- -->[0, 1023]<!-- --> as the node ID. After this adjustment, it seems that new version users are no longer reporting the same issue (of course, it remains to be tested over time, but in any case, it won't be worse than the IP extraction strategy).</p><p>The above is a brief analysis of Seata's distributed UUID generator. If you find this generator useful, you can directly use it in your project. Its class declaration is <code>public</code>, and the full class name is:
<code>io.seata.common.util.IdWorker</code></p><p>Of course, if you have better ideas, you are also welcome to discuss them with the Seata community.</p>]]></content>
        <author>
            <name>selfishlover</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata New Feature Support -- Undo_Log Compression]]></title>
        <id>https://seata.apache.org/blog/seata-feature-undo-log-compress</id>
        <link href="https://seata.apache.org/blog/seata-feature-undo-log-compress"/>
        <updated>2021-05-07T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Current Situation & Pain Points]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="current-situation--pain-points">Current Situation &amp; Pain Points<a href="#current-situation--pain-points" class="hash-link" aria-label="Direct link to Current Situation &amp; Pain Points" title="Direct link to Current Situation &amp; Pain Points">​</a></h2><p>For Seata, it records the before and after data of DML operations to perform possible rollback operations, and stores this data in a blob field in the database. For batch operations such as insert, update, delete, etc., the number of affected rows may be significant, concatenated into a large field inserted into the database, which may lead to the following issues:</p><ol><li>Exceeding the maximum write limit for a single database operation (such as the <code>max_allowed_package</code> parameter in MySQL).</li><li>Significant network IO and database disk IO overhead due to a large amount of data.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="brainstorming">Brainstorming<a href="#brainstorming" class="hash-link" aria-label="Direct link to Brainstorming" title="Direct link to Brainstorming">​</a></h2><p>For the first issue, the <code>max_allowed_package</code> parameter limit can be increased based on the actual situation of the business to avoid the "query is too large" problem. For the second issue, increasing bandwidth and using high-performance SSD as the database storage medium can help.</p><p>The above solutions involve external or costly measures. Is there a framework-level solution to address the pain points mentioned above?</p><p>Considering the root cause of the pain points mentioned above, the problem lies in the generation of excessively large data fields. Therefore, if the corresponding data can be compressed at the business level before data transmission and storage, theoretically, it can solve the problems mentioned above.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="feasibility-analysis">Feasibility Analysis<a href="#feasibility-analysis" class="hash-link" aria-label="Direct link to Feasibility Analysis" title="Direct link to Feasibility Analysis">​</a></h2><p>Combining the brainstorming above, in practical development, when large batch operations are required, they are often scheduled during periods of relatively low user activity and low concurrency. At such times, CPU and memory resources can be relatively more utilized to quickly complete the corresponding operations. Therefore, by consuming CPU and memory resources to compress rollback data, the size of data transmission and storage can be reduced.</p><p>At this point, two things need to be demonstrated:</p><ol><li>After compression, it can reduce the pressure on network IO and database disk IO. This can be measured by the total time taken for data compression + storage in the database.</li><li>After compression, the efficiency of compression compared to the original data size. This can be measured by the data size before and after compression.</li></ol><p>Testing the time spent on compressing network usage:</p><p><img loading="lazy" src="https://user-images.githubusercontent.com/22959373/95567752-f55ddf80-0a55-11eb-8092-1f1d99855bdd.png" alt="image" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="compression-ratio-test">Compression Ratio Test:<a href="#compression-ratio-test" class="hash-link" aria-label="Direct link to Compression Ratio Test:" title="Direct link to Compression Ratio Test:">​</a></h2><p><img loading="lazy" src="https://user-images.githubusercontent.com/22959373/95567834-0ad30980-0a56-11eb-9d7e-48b74babbea4.png" alt="image" class="img_ev3q"></p><p>The test results clearly indicate that using gzip or zip compression can significantly reduce the pressure on the database and network transmission. At the same time, it can substantially decrease the size of the stored data.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="implementation">Implementation<a href="#implementation" class="hash-link" aria-label="Direct link to Implementation" title="Direct link to Implementation">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="implementation-approach">Implementation Approach<a href="#implementation-approach" class="hash-link" aria-label="Direct link to Implementation Approach" title="Direct link to Implementation Approach">​</a></h4><p><img loading="lazy" src="https://user-images.githubusercontent.com/22959373/116281711-8f039900-a7bc-11eb-91f8-82afdbb9f932.png" alt="Compression" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="partial-code">Partial Code<a href="#partial-code" class="hash-link" aria-label="Direct link to Partial Code" title="Direct link to Partial Code">​</a></h4><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Whether to enable undo_log compression, default is true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">seata.client.undo.compress.enable=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Compressor type, default is zip, generally recommended to be zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">seata.client.undo.compress.type=zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Compression threshold for enabling compression, default is 64k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">seata.client.undo.compress.threshold=64k</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Determining Whether the Undo_Log Compression Feature is Enabled and if the Compression Threshold is Reached</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">protected boolean needCompress(byte[] undoLogContent) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 1. Check whether undo_log compression is enabled (1.4.2 Enabled by Default).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 2. Check whether the compression threshold has been reached (64k by default).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// If both return requirements are met, the corresponding undoLogContent is compressed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ROLLBACK_INFO_COMPRESS_ENABLE </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &amp;&amp; undoLogContent.length &gt; ROLLBACK_INFO_COMPRESS_THRESHOLD;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Initiating Compression for Undo_Log After Determining the Need</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// If you need to compress, compress undo_log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (needCompress(undoLogContent)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Gets the compression type, default zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    compressorType = ROLLBACK_INFO_COMPRESS_TYPE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Get the corresponding compressor and compress it</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    undoLogContent = CompressorFactory.getCompressor(compressorType.getCode()).compress(undoLogContent);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// else does not need to compress and does not need to do anything</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Save the compression type synchronously to the database for use when rolling back:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">protected String buildContext(String serializer, CompressorType compressorType) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;String, String&gt; map = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    map.put(UndoLogConstants.SERIALIZER_KEY, serializer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Save the compression type to the database</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    map.put(UndoLogConstants.COMPRESSOR_TYPE_KEY, compressorType.name());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return CollectionUtils.encodeMap(map);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Decompress the corresponding information when rolling back:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">protected byte[] getRollbackInfo(ResultSet rs) throws SQLException  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Gets a byte array of rollback information saved to the database</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] rollbackInfo = rs.getBytes(ClientTableColumnsName.UNDO_LOG_ROLLBACK_INFO);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Gets the compression type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // getOrDefault uses the default value CompressorType.NONE to directly upgrade 1.4.2+ to compatible versions earlier than 1.4.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String rollbackInfoContext = rs.getString(ClientTableColumnsName.UNDO_LOG_CONTEXT);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;String, String&gt; context = CollectionUtils.decodeMap(rollbackInfoContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CompressorType compressorType = CompressorType.getByName(context.getOrDefault(UndoLogConstants.COMPRESSOR_TYPE_KEY,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CompressorType.NONE.name()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Get the corresponding compressor and uncompress it</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return CompressorFactory.getCompressor(compressorType.getCode())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .decompress(rollbackInfo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="peroration">peroration<a href="#peroration" class="hash-link" aria-label="Direct link to peroration" title="Direct link to peroration">​</a></h3><p>By compressing undo_log, Seata can further improve its performance when processing large amounts of data at the framework level. At the same time, it also provides the corresponding switch and relatively reasonable default value, which is convenient for users to use out of the box, but also convenient for users to adjust according to actual needs, so that the corresponding function is more suitable for the actual use scenario.</p>]]></content>
        <author>
            <name>chd</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata Deadlock Issue Caused by ConcurrentHashMap]]></title>
        <id>https://seata.apache.org/blog/seata-dsproxy-deadlock</id>
        <link href="https://seata.apache.org/blog/seata-dsproxy-deadlock"/>
        <updated>2021-03-13T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This article primarily discusses an online issue, a Seata dynamic data source proxy deadlock caused by a ConcurrentHashMap bug.]]></summary>
        <author>
            <name>xiaoyong.luo</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata Application-Side Startup Process Analysis — Registry and Configuration Module]]></title>
        <id>https://seata.apache.org/blog/seata-client-start-analysis-02</id>
        <link href="https://seata.apache.org/blog/seata-client-start-analysis-02"/>
        <updated>2021-03-04T01:35:01.000Z</updated>
        <author>
            <name>booogu</name>
        </author>
        <category label="Seata" term="Seata"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata Application-Side Startup Process Analysis — How RM & TM Connect with TC]]></title>
        <id>https://seata.apache.org/blog/seata-client-start-analysis-01</id>
        <link href="https://seata.apache.org/blog/seata-client-start-analysis-01"/>
        <updated>2021-02-28T21:08:00.000Z</updated>
        <author>
            <name>booogu</name>
        </author>
        <category label="Seata" term="Seata"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Integration of Spring Cloud with Seata for Distributed Transaction - TCC Mode]]></title>
        <id>https://seata.apache.org/blog/integrate-seata-tcc-mode-with-spring-cloud</id>
        <link href="https://seata.apache.org/blog/integrate-seata-tcc-mode-with-spring-cloud"/>
        <updated>2021-01-23T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This article mainly introduces the integration of Spring Cloud with Seata for distributed transaction using the TCC mode.]]></summary>
        <content type="html"><![CDATA[<p>This article will introduce how to integrate Seata (1.4.0) with Spring Cloud and Feign using the TCC mode. In practice, Seata's AT mode can meet about 80% of our distributed transaction needs. However, when dealing with operations on databases and middleware (such as Redis) that do not support transactions, or when using databases that are not currently supported by the AT mode (currently AT supports MySQL, Oracle, and PostgreSQL), cross-company service invocations, cross-language application invocations, or the need for manual control of the entire two-phase commit process, we need to combine the TCC mode. Moreover, the TCC mode also supports mixed usage with the AT mode.</p><h1>一、The concept of TCC mode</h1><p>In Seata, a distributed global transaction follows a two-phase commit model with a Try-<!-- -->[Confirm/Cancel]<!-- --> pattern. Both the AT (Automatic Transaction) mode and the TCC (Try-Confirm-Cancel) mode in Seata are implementations of the two-phase commit. The main differences between them are as follows:</p><p>AT mode is based on relational databases that support local ACID transactions (currently supporting MySQL, Oracle, and PostgreSQL):</p><p>The first phase, prepare: In the local transaction, it combines the submission of business data updates and the recording of corresponding rollback logs.
The second phase, commit: It immediately completes successfully and automatically asynchronously cleans up the rollback logs.
The second phase, rollback: It automatically generates compensation operations through the rollback logs to complete data rollback.</p><p>On the other hand, TCC mode does not rely on transaction support from underlying data resources:</p><p>The first phase, prepare: It calls a custom-defined prepare logic.
The second phase, commit: It calls a custom-defined commit logic.
The second phase, rollback: It calls a custom-defined rollback logic.</p><p>TCC mode refers to the ability to include custom-defined branch transactions in the management of global transactions.</p><p>In summary, Seata's TCC mode is a manual implementation of the AT mode that allows you to define the processing logic for the two phases without relying on the undo_log used in the AT mode.</p><h1>二、prepare</h1><ul><li>regist center <a href="https://nacos.io/zh-cn/" target="_blank" rel="noopener noreferrer" title="nacos">nacos</a> </li><li><a title="seata服务端(TC）" href="/docs/ops/deploy-guide-beginner/">seata server(TC）</a></li></ul><h1>三、Building TM and TCC-RM</h1><p>This chapter focuses on the implementation of TCC using Spring Cloud + Feign. For the project setup, please refer to the source code (this project provides demos for both AT mode and TCC mode).</p><p><a href="https://github.com/tanzzj/springcloud-seata-feign" target="_blank" rel="noopener noreferrer" title="服务端搭建文档">DEMO</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="31-build-seata-server">3.1 build seata server<a href="#31-build-seata-server" class="hash-link" aria-label="Direct link to 3.1 build seata server" title="Direct link to 3.1 build seata server">​</a></h2><p><a title="服务端搭建文档" href="/docs/ops/deploy-guide-beginner/">build server doc</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="32-build-tm">3.2 build TM<a href="#32-build-tm" class="hash-link" aria-label="Direct link to 3.2 build TM" title="Direct link to 3.2 build TM">​</a></h2><p><a href="https://github.com/tanzzj/springcloud-seata-feign/tree/master/service-tm" target="_blank" rel="noopener noreferrer">service-tm</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="33-build-rm-tcc">3.3 build RM-TCC<a href="#33-build-rm-tcc" class="hash-link" aria-label="Direct link to 3.3 build RM-TCC" title="Direct link to 3.3 build RM-TCC">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="331-defining-tcc-interface">3.3.1 Defining TCC Interface<a href="#331-defining-tcc-interface" class="hash-link" aria-label="Direct link to 3.3.1 Defining TCC Interface" title="Direct link to 3.3.1 Defining TCC Interface">​</a></h3><p>Since we are using Spring Cloud + Feign, which relies on HTTP for communication, we can use @LocalTCC here. It is important to note that @LocalTCC must be annotated on the interface. This interface can be a regular business interface as long as it implements the corresponding methods for the two-phase commit in TCC. The TCC-related annotations are as follows:</p><ul><li>@LocalTCC: Used for TCC in the Spring Cloud + Feign mode.</li><li>@TwoPhaseBusinessAction: Annotates the try method. The name attribute represents the bean name of the current TCC method, which can be the method name (globally unique). The commitMethod attribute points to the commit method, and the rollbackMethod attribute points to the transaction rollback method. After specifying these three methods, Seata will automatically invoke the commit or rollback method based on the success or failure of the global transaction.</li><li>@BusinessActionContextParameter: Annotates the parameters to be passed to the second phase (commitMethod/rollbackMethod) methods.</li><li>BusinessActionContext: Represents the TCC transaction context.</li></ul><p>Here is an example:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Here we define the TCC interface.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * It must be defined on the interface.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * We are using Spring Cloud for remote invocation.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Therefore, we can use LocalTCC here.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@LocalTCC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface TccService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Define the two-phase commit.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * name = The bean name of this TCC, globally unique.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * commitMethod = The method for the second phase confirmation.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * rollbackMethod = The method for the second phase cancellation.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Use the BusinessActionContextParameter annotation to pass parameters to the second phase.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param params  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @TwoPhaseBusinessAction(name = "insert", commitMethod = "commitTcc", rollbackMethod = "cancel")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String insert(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @BusinessActionContextParameter(paramName = "params") Map&lt;String, String&gt; params</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  The confirmation method can be named differently, but it must be consistent with the commitMethod.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  The context can be used to pass the parameters from the try method.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param context </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return boolean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean commitTcc(BusinessActionContext context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * two phase cancel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param context </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return boolean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean cancel(BusinessActionContext context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="332-business-implementation-of-tcc-interface">3.3.2 Business Implementation of TCC Interface<a href="#332-business-implementation-of-tcc-interface" class="hash-link" aria-label="Direct link to 3.3.2 Business Implementation of TCC Interface" title="Direct link to 3.3.2 Business Implementation of TCC Interface">​</a></h3><p>To keep the code concise, we will combine the routing layer with the business layer for explanation here. However, in actual projects, this may not be the case.</p><ul><li>Using @Transactional in the try method allows for direct rollback of operations in relational databases through Spring transactions. The rollback of operations in non-relational databases or other middleware can be handled in the rollbackMethod.</li><li>By using context.getActionContext("params"), you can retrieve the parameters defined in the try phase and perform business rollback operations on these parameters in the second phase.</li><li>Note 1: It is not advisable to catch exceptions here (similarly, handle exceptions with aspects), as doing so would cause TCC to recognize the operation as successful, and the second phase would directly execute the commitMethod.</li><li>Note 2: In TCC mode, it is the responsibility of the developer to ensure idempotence and transaction suspension prevention.</li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TccServiceImpl implements  TccService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TccDAO tccDAO;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * tcc t（try）method</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Choose the actual business execution logic or resource reservation logic based on the actual business scenario.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param params - name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping("/tcc-insert")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional(rollbackFor = Exception.class, propagation = Propagation.REQUIRED)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String insert(@RequestBody Map&lt;String, String&gt; params) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.info("xid = " + RootContext.getXID());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //todo Perform actual operations or operations on MQ, Redis, etc.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tccDAO.insert(params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //Remove the following annotations to throw an exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //throw new RuntimeException("服务tcc测试回滚");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return "success";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * TCC service confirm method</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * If resource reservation is used in the first phase, the reserved resources should be committed during the second phase confirmation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param context </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return boolean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean commitTcc(BusinessActionContext context) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.info("xid = " + context.getXid() + "提交成功");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //todo If resource reservation is used in the first phase, resources should be committed here.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * tcc  cancel method</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param context </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return boolean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean cancel(BusinessActionContext context) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //todo Here, write the rollback operations for middleware or non-relational databases.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println("please manually rollback this data:" + context.getActionContext("params"));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="333-starting-a-global-transaction-in-tm-and-invoking-rm-tcc-interface">3.3.3 Starting a Global Transaction in TM and Invoking RM-TCC Interface<a href="#333-starting-a-global-transaction-in-tm-and-invoking-rm-tcc-interface" class="hash-link" aria-label="Direct link to 3.3.3 Starting a Global Transaction in TM and Invoking RM-TCC Interface" title="Direct link to 3.3.3 Starting a Global Transaction in TM and Invoking RM-TCC Interface">​</a></h3><p>Please refer to the project source code in section 3.2.</p><p>With this, the integration of TCC mode with Spring Cloud is complete.</p>]]></content>
        <author>
            <name>gongxing(zhijian.tan)</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Analysis of Seata Configuration Management Principles]]></title>
        <id>https://seata.apache.org/blog/seata-config-manager</id>
        <link href="https://seata.apache.org/blog/seata-config-manager"/>
        <updated>2021-01-10T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This article primarily introduces the core implementation of Seata configuration management and the interaction process with Spring configuration.]]></summary>
        <author>
            <name>xiaoyong.luo</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Detailed Explanation of seata-golang Communication Model]]></title>
        <id>https://seata.apache.org/blog/seata-golang-communication-mode</id>
        <link href="https://seata.apache.org/blog/seata-golang-communication-mode"/>
        <updated>2021-01-04T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This article provides a detailed explanation of the underlying RPC communication implementation in seata-golang.]]></summary>
        <author>
            <name>xiaomin.liu</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Analysis of Seata Data Source Proxy]]></title>
        <id>https://seata.apache.org/blog/seata-datasource-proxy</id>
        <link href="https://seata.apache.org/blog/seata-datasource-proxy"/>
        <updated>2020-10-16T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This article primarily introduces the implementation principles of Seata data source proxy and potential issues that may arise during usage.]]></summary>
        <author>
            <name>xiaoyong.luo</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata Source Code - Client Startup Process in Distributed Transactions]]></title>
        <id>https://seata.apache.org/blog/seata-sourcecode-client-bootstrap</id>
        <link href="https://seata.apache.org/blog/seata-sourcecode-client-bootstrap"/>
        <updated>2020-08-25T00:00:00.000Z</updated>
        <author>
            <name>xiaobin.yang</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Setting Up Seata Demo Environment on Mac (AT Mode)]]></title>
        <id>https://seata.apache.org/blog/seata-at-demo-in-mac</id>
        <link href="https://seata.apache.org/blog/seata-at-demo-in-mac"/>
        <updated>2020-07-20T00:00:00.000Z</updated>
        <author>
            <name>portman xu</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[The Refactoring Journey of Seata RPC Module]]></title>
        <id>https://seata.apache.org/blog/seata-rpc-refactor</id>
        <link href="https://seata.apache.org/blog/seata-rpc-refactor"/>
        <updated>2020-07-13T00:00:00.000Z</updated>
        <author>
            <name>chenghui.zhang</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata Source Code - Server Startup Process in Distributed Transactions]]></title>
        <id>https://seata.apache.org/blog/seata-sourcecode-server-bootstrap</id>
        <link href="https://seata.apache.org/blog/seata-sourcecode-server-bootstrap"/>
        <updated>2020-07-02T00:00:00.000Z</updated>
        <author>
            <name>xiaobing.yang</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[How is distributed transaction realized? In-depth interpretation of Seata's XA mode]]></title>
        <id>https://seata.apache.org/blog/seata-xa-introduce</id>
        <link href="https://seata.apache.org/blog/seata-xa-introduce"/>
        <updated>2020-04-28T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In-depth interpretation of Seata's XA mode]]></summary>
        <content type="html"><![CDATA[<p>Author profile: Xuan Yi, GitHub ID: sharajava, responsible for the GTS development team of Alibaba Middleware, initiator of the SEATA open source project, worked for many years at Oracle Beijing R&amp;D Center, and was engaged in WebLogic core development. He has long been focused on middleware, especially technical practices in the field of distributed transactions.</p><p>The 1.2.0 version of Seata has released a new transaction mode: XA mode, which supports the XA protocol.</p><p>Here, we will interpret this new feature in depth from three aspects:</p><ul><li>What: What is XA mode?</li><li>Why: Why support XA?</li><li>How: How is XA mode implemented and how to use it?</li></ul><h1>1. What is XA mode?</h1><p>There are two basic preliminary concepts here:</p><ol><li>What is XA?</li><li>What is the so-called transaction mode defined by Seata?</li></ol><p>Based on these two points, understanding XA mode becomes quite natural.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="11-what-is-xa">1.1 What is XA?<a href="#11-what-is-xa" class="hash-link" aria-label="Direct link to 1.1 What is XA?" title="Direct link to 1.1 What is XA?">​</a></h2><p>The XA specification is a standard for distributed transaction processing (DTP) defined by the X/Open organization.</p><p>The XA specification describes the interface between the global transaction manager(TM) and the local resource manager(RM). The purpose of the XA specification is to allow multiple resources (such as databases, application servers, message queues, etc.) to access the same transaction, thus maintaining ACID properties across applications.</p><p>The XA specification uses the Two-Phase Commit (2PC) to ensure that all resources are committed or rolled back at the same time for any specific transaction.</p><p>The XA specification was proposed in the early 1990s. Currently, almost all mainstream databases support the XA specification.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="12-what-is-seatas-transaction-mode">1.2 What is Seata's transaction mode?<a href="#12-what-is-seatas-transaction-mode" class="hash-link" aria-label="Direct link to 1.2 What is Seata's transaction mode?" title="Direct link to 1.2 What is Seata's transaction mode?">​</a></h2><p>Seata defines the framework for global transactions.</p><p>A global transaction is defined as the overall coordination of several branch transactions:</p><ol><li>The Transaction Manager (TM) requests the Transaction Coordinator (TC) to initiate (Begin), commit (Commit), or rollback (Rollback) the global transaction.</li><li>The TM binds the XID representing the global transaction to the branch transaction.</li><li>The Resource Manager (RM) registers with the TC, associating the branch transaction with the global transaction represented by XID.</li><li>The RM reports the execution result of the branch transaction to the TC. (optional)</li><li>The TC sends a branch commit or branch rollback command to the RM.</li></ol><img loading="lazy" src="https://img.alicdn.com/tfs/TB19qmhOrY1gK0jSZTEXXXDQVXa-1330-924.png" alt="seata-mod" style="zoom:50%" class="img_ev3q"><p>Seata's global transaction processing process is divided into two phases:</p><ul><li>Execution phase: Execute branch transactions and ensure that the execution results are <em>rollbackable</em> and <em>durable</em>.</li><li>Completion phase: Based on the resolution of the execution phase, the application sends a request for global commit or rollback to the TC through the TM, and the TC commands the RM to drive the branch transaction to commit or rollback.</li></ul><p>Seata's so-called transaction mode refers to the behavior mode of branch transactions running under the Seata global transaction framework. More precisely, it should be called the branch transaction mode.</p><p>The difference between different transaction modes lies in the different ways branch transactions achieve the goals of the two phases of the global transaction.  That is, answering the following two questions:</p><ul><li>Execution phase: How to execute and ensure that the execution results are <em>rollbackable</em> and <em>durable</em>.</li><li>Completion phase: After receiving the command from the TC, how to submit or rollback the branch transaction?</li></ul><p>Taking our Seata AT mode and TCC mode as examples:</p><p>AT mode</p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1NTuzOBr0gK0jSZFnXXbRRXXa-1330-924.png" alt="at-mod" style="zoom:50%" class="img_ev3q"><ul><li><p>Execution phase:</p><ul><li>Rollbackable: Record rollback logs according to the SQL parsing result</li><li>Durable: Rollback logs and business SQL are committed to the database in the same local transaction</li></ul></li><li><p>Completion phase:</p><ul><li>Branch commit: Asynchronously delete rollback log records</li><li>Branch rollback: Compensate and update according to the rollback log</li></ul></li></ul><p>TCC mode</p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1m59pOEY1gK0jSZFCXXcwqXXa-1330-924.png" alt="tcc-mod" style="zoom:50%" class="img_ev3q"><ul><li><p>Execution Phase:</p><ul><li>Call the Try method defined by the business (guaranteed <em>rollback</em> and <em>persistence</em> entirely by the business layer)</li></ul></li><li><p>Completion Phase:</p><ul><li>Branch Commit: Call the Confirm method defined for each transaction branch</li><li>Branch Rollback: Call the Cancel method defined for each transaction branch</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="13-what-is-xa-mode-in-seata">1.3 What is XA mode in Seata?<a href="#13-what-is-xa-mode-in-seata" class="hash-link" aria-label="Direct link to 1.3 What is XA mode in Seata?" title="Direct link to 1.3 What is XA mode in Seata?">​</a></h2><p>XA mode:</p><p>Within the distributed transaction framework defined by Seata, it is a transaction mode that uses XA protocol mechanisms to manage branch transactions with the support of transaction resources (databases, message services, etc.) for the XA protocol.</p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1hSpccIVl614jSZKPXXaGjpXa-1330-924.png" alt="xa-mod" style="zoom:50%" class="img_ev3q"><ul><li><p>Execution Phase:</p><ul><li>Rollback: Business SQL operations are performed in an XA branch, and the support of resources for the XA protocol ensures <em>rollback</em></li><li>Persistence: After the XA branch is completed, XA prepare is executed, and similarly, the support of resources for the XA protocol ensures <em>persistence</em> (i.e., any unexpected occurrences will not cause situations where rollback is not possible)</li></ul></li><li><p>Completion Phase:</p><ul><li>Branch Commit: Perform commit for XA branch</li><li>Branch Rollback: Perform rollback for XA branch</li></ul></li></ul><h1>2. Why support XA?</h1><p>Why add XA mode in Seata? What is the significance of supporting XA?</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="21-problems-with-compensatory-transaction-mode">2.1 Problems with Compensatory Transaction Mode<a href="#21-problems-with-compensatory-transaction-mode" class="hash-link" aria-label="Direct link to 2.1 Problems with Compensatory Transaction Mode" title="Direct link to 2.1 Problems with Compensatory Transaction Mode">​</a></h2><p>Essentially, the 3 major transaction modes that Seata already supports: AT, TCC, and Saga, are all compensatory in nature.</p><p>Compensatory transaction processing mechanisms are built on top of transaction resources (either in the middleware layer or in the application layer), and the transaction resources themselves are unaware of distributed transactions.</p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1z.qyOET1gK0jSZFrXXcNCXXa-602-460.png" alt="img" style="zoom:50%" class="img_ev3q"><p>The fundamental problem with transaction resources being unaware of distributed transactions is the inability to achieve true <em>global consistency</em>.</p><p>For example, in a compensatory transaction processing process, a stock record is reduced from 100 to 50. At this point, the warehouse administrator connects to the database and sees the current quantity as 50. Later, the transaction is rolled back due to an unexpected occurrence, and the stock is compensated back to 100. Clearly, the warehouse administrator's query finding 50 is <em>dirty data</em>.</p><p>It can be seen that because compensatory distributed transaction mechanisms do not require the mechanism of transaction resources (such as a database), they cannot guarantee data consistency from a global perspective outside the transaction framework.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="22-value-of-xa">2.2 Value of XA<a href="#22-value-of-xa" class="hash-link" aria-label="Direct link to 2.2 Value of XA" title="Direct link to 2.2 Value of XA">​</a></h2><p>Unlike compensatory transaction modes, the XA protocol requires transaction resources to provide support for standards and protocols.</p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1vs9kOvb2gK0jSZK9XXaEgFXa-602-486.png" alt="nct" style="zoom:50%" class="img_ev3q"><p>Because transaction resources are aware of and participate in the distributed transaction processing process, they (such as databases) can guarantee effective isolation of data from any perspective and satisfy global data consistency.</p><p>For example, in the scenario of stock updates mentioned in the previous section, during the XA transaction processing process, the intermediate state of the database holding 50 is guaranteed by the database itself and will not be <em>seen</em> in the warehouse administrator's query statistics. (Of course, the isolation level needs to be READ_COMMITTED or higher.)</p><p>In addition to the fundamental value of <em>global consistency</em>, supporting XA also has the following benefits:</p><ol><li>Non-invasive business: Like AT, XA mode will be non-invasive for businesses, without bringing additional burden to application design and development.</li><li>Wide support for databases: XA protocol is widely supported by mainstream relational databases and can be used without additional adaptation.</li><li>Easy multi-language support: Because it does not involve SQL parsing, the XA mode has lower requirements for Seata's RM, making it easier for different language development SDKs compared to the AT mode.</li><li>Migration of traditional XA-based applications: Traditional applications based on the XA protocol can be smoothly migrated to the Seata platform using the XA mode.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="23-widely-questioned-issues-of-xa">2.3 Widely Questioned Issues of XA<a href="#23-widely-questioned-issues-of-xa" class="hash-link" aria-label="Direct link to 2.3 Widely Questioned Issues of XA" title="Direct link to 2.3 Widely Questioned Issues of XA">​</a></h2><p>There is no distributed transaction mechanism that can perfectly adapt to all scenarios and meet all requirements.</p><p>The XA specification was proposed as early as the early 1990s to solve the problems in the field of distributed transaction processing.</p><p>Now, whether it's the AT mode, TCC mode, or the Saga mode, the essence of these modes' proposals stems from the inability of the XA specification to meet certain scenario requirements.</p><p>The distributed transaction processing mechanism defined by the XA specification has some widely questioned issues. What is our thinking regarding these issues?</p><ol><li><strong>Data Locking</strong>: Data is locked throughout the entire transaction processing until it is finished, and reads and writes are constrained according to the definition of isolation levels.</li></ol><blockquote><p>Thinking:</p><p>Data locking is the cost to obtain higher isolation and global consistency.</p><p>In compensatory transaction processing mechanisms, the completion of branch (local) transactions is done during the execution stage, and data is not locked at the resource level. However, this is done at the cost of sacrificing isolation.</p><p>Additionally, the AT mode uses <em>global locks</em> to ensure basic <em>write isolation</em>, effectively locking data, but the lock is managed centrally on the TC side, with high unlock efficiency and no blocking issues.</p></blockquote><ol start="2"><li><strong>Protocol Blocking</strong>: After XA prepare, the branch transaction enters a blocking stage and must wait for XA commit or XA rollback.</li></ol><blockquote><p>Thinking:</p><p>The blocking mechanism of the protocol itself is not the problem. The key issue is the combination of protocol blocking and data locking.</p><p>If a resource participating in the global transaction is "offline" (does not receive commands to end branch transactions), the data it locks will remain locked. This may even lead to deadlocks.</p><p>This is the core pain point of the XA protocol and is the key problem that Seata aims to solve by introducing the XA mode.</p><p>The basic idea is twofold: avoiding "loss of connection" and adding a "self-release" mechanism. (This involves a lot of technical details, which will not be discussed at the moment. They will be specifically discussed in the subsequent evolution of the XA mode.)</p></blockquote><ol start="3"><li><strong>Poor Performance</strong>: Performance loss mainly comes from two aspects: on one hand, the transaction coordination process increases the RT of individual transactions; on the other hand, concurrent transaction data lock conflicts reduce throughput.</li></ol><blockquote><p>Thinking:</p><p>Compared to running scenarios without distributed transaction support, performance will certainly decline, there is no doubt about that.</p><p>Essentially, the transaction mechanism (whether local or distributed) sacrifices some performance to achieve a simple programming model.</p><p>Compared to the AT mode, which is also <em>non-invasive for businesses</em>:</p><p>Firstly, because XA mode also runs under Seata's defined distributed transaction framework, it does not generate additional transaction coordination communication overhead.</p><p>Secondly, in concurrent transactions, if data has hotspots and lock conflicts occur, this situation also exists in the AT mode (which defaults to using a global lock).</p><p>Therefore, in the two main aspects affecting performance, the XA mode does not have a significantly obvious disadvantage compared to the AT mode.</p><p>The performance advantage of the AT mode mainly lies in: centralized management of global data locks, where the release of locks does not require RM involvement and is very fast; in addition, the asynchronous completion of the global commit stage.</p></blockquote><h1>3. How Does XA Mode Work and How to Use It?</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="31-design-of-xa-mode">3.1 Design of XA Mode<a href="#31-design-of-xa-mode" class="hash-link" aria-label="Direct link to 3.1 Design of XA Mode" title="Direct link to 3.1 Design of XA Mode">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="311-design-objectives">3.1.1 Design Objectives<a href="#311-design-objectives" class="hash-link" aria-label="Direct link to 3.1.1 Design Objectives" title="Direct link to 3.1.1 Design Objectives">​</a></h3><p>The basic design objectives of XA mode mainly focus on two main aspects:</p><ol><li>From the perspective of <em>scenarios</em>, it meets the requirement of <em>global consistency</em>.</li><li>From the perspective of <em>applications</em>, it maintains the non-invasive nature consistent with the AT mode.</li><li>From the perspective of <em>mechanisms</em>, it adapts to the characteristics of distributed microservice architecture.</li></ol><p>Overall idea:</p><ol><li>Same as the AT mode: Construct branch transactions from local transactions in the application program.</li><li>Through data source proxy, wrap the interaction mechanism of the XA protocol at the framework level outside the scope of local transactions in the application program, making the XA programming model transparent.</li><li>Split the 2PC of XA and perform XA prepare at the end of the execution stage of branch transactions, seamlessly integrating the XA protocol into Seata's transaction framework, reducing one round of RPC interaction.</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="312-core-design">3.1.2 Core Design<a href="#312-core-design" class="hash-link" aria-label="Direct link to 3.1.2 Core Design" title="Direct link to 3.1.2 Core Design">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-overall-operating-mechanism">1. Overall Operating Mechanism<a href="#1-overall-operating-mechanism" class="hash-link" aria-label="Direct link to 1. Overall Operating Mechanism" title="Direct link to 1. Overall Operating Mechanism">​</a></h4><p>XA mode runs within the transaction framework defined by Seata:</p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1uM2OaSslXu8jSZFuXXXg7FXa-1330-958.png" alt="xa-fw" style="zoom:50%" class="img_ev3q"><ul><li><p>Execution phase (Execute):</p><ul><li>XA start/XA end/XA prepare + SQL + Branch registration</li></ul></li><li><p>Completion phase (Finish):</p><ul><li>XA commit/XA rollback</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-data-source-proxy">2. Data Source Proxy<a href="#2-data-source-proxy" class="hash-link" aria-label="Direct link to 2. Data Source Proxy" title="Direct link to 2. Data Source Proxy">​</a></h4><p>XA mode requires XAConnection.</p><p>There are two ways to obtain XAConnection:</p><ul><li>Method 1: Requires developers to configure XADataSource</li><li>Method 2: Creation based on the developer's normal DataSource</li></ul><p>The first method adds cognitive burden to developers, as they need to learn and use XA data sources specifically for XA mode, which contradicts the design goal of transparent XA programming model.</p><p>The second method is more user-friendly, similar to the AT mode, where developers do not need to worry about any XA-related issues and can maintain a local programming model.</p><p>We prioritize the implementation of the second method: the data source proxy creates the corresponding XAConnection based on the normal JDBC connection obtained from the normal data source.</p><p>Comparison with the data source proxy mechanism of the AT mode:</p><img loading="lazy" src="/img/xa/pics/ds1.png" alt="img" style="zoom:50%" class="img_ev3q"><p>However, the second method has limitations: it cannot guarantee compatibility correctness.</p><p>In fact, this method is what database drivers should do. Different vendors and different versions of database driver implementation mechanisms are vendor-specific, and we can only guarantee correctness on fully tested driver versions, as differences in the driver versions used by developers can lead to the failure of the mechanism.</p><p>This is particularly evident in Oracle. See Druid issue: <a href="https://github.com/alibaba/druid/issues/3707" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/druid/issues/3707</a></p><p>Taking everything into account, the data source proxy design for XA mode needs to support the first method: proxy based on XA data source.</p><p>Comparison with the data source proxy mechanism of the AT mode:</p><img loading="lazy" src="/img/xa/pics/ds2.png" alt="img" style="zoom:50%" class="img_ev3q"><h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-branch-registration">3. Branch Registration<a href="#3-branch-registration" class="hash-link" aria-label="Direct link to 3. Branch Registration" title="Direct link to 3. Branch Registration">​</a></h4><p>XA start requires the Xid parameter.</p><p>This Xid needs to be associated with the XID and BranchId of the Seata global transaction, so that the TC can drive the XA branch to commit or rollback.</p><p>Currently, the BranchId in Seata is generated uniformly by the TC during the branch registration process, so the timing of the XA mode branch registration needs to be before XA start.</p><p>A possible optimization in the future:</p><p>Delay branch registration as much as possible. Similar to the AT mode, register the branch before the local transaction commit to avoid meaningless branch registration in case of branch execution failure.</p><p>This optimization direction requires a change in the BranchId generation mechanism to cooperate. BranchId will not be generated through the branch registration process, but will be generated and then used to register the branch.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-summary">4. Summary<a href="#4-summary" class="hash-link" aria-label="Direct link to 4. Summary" title="Direct link to 4. Summary">​</a></h4><p>Here, only a few important core designs of the XA mode are explained to illustrate its basic operation mechanism.</p><p>In addition, important aspects such as <em>connection maintenance</em> and <em>exception handling</em> are also important and can be further understood from the project code.</p><p>More information and exchange will be written and shared with everyone in the future.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="313-evolution-plan">3.1.3 Evolution Plan<a href="#313-evolution-plan" class="hash-link" aria-label="Direct link to 3.1.3 Evolution Plan" title="Direct link to 3.1.3 Evolution Plan">​</a></h3><p>The overall evolution plan of the XA mode is as follows:</p><ol><li>Step 1 (already completed): The first version (1.2.0) runs the prototype mechanism of the XA mode. Ensure only addition, no modification, and no new issues introduced to other modes.</li><li>Step 2 (planned to be completed in May): Necessary integration and refactoring with the AT mode.</li><li>Step 3 (planned to be completed in July): Refine the exception handling mechanism and polish for production readiness.</li><li>Step 4 (planned to be completed in August): Performance optimization.</li><li>Step 5 (planned to be completed in 2020): Integrate with Seata project's ongoing design for cloud-native Transaction Mesh to create cloud-native capabilities.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="32-usage-of-xa-mode">3.2 Usage of XA Mode<a href="#32-usage-of-xa-mode" class="hash-link" aria-label="Direct link to 3.2 Usage of XA Mode" title="Direct link to 3.2 Usage of XA Mode">​</a></h2><p>From a programming model perspective, XA mode is exactly the same as the AT mode.</p><p>You can refer to the Seata official website sample: <a href="https://github.com/seata/seata-xa" target="_blank" rel="noopener noreferrer">seata-xa</a></p><p>The example scenario is the classic Seata example, involving the product ordering business of three microservices: inventory, orders, and accounts.</p><p>In the example, the upper programming model is the same as the AT mode. By simply modifying the data source proxy, you can switch between XA mode and AT mode.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean("dataSource")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public DataSource dataSource(DruidDataSource druidDataSource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // DataSourceProxy for AT mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // return new DataSourceProxy(druidDataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // DataSourceProxyXA for XA mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new DataSourceProxyXA(druidDataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>4. Summary</h1><p>At the current stage of technological development, there is no distributed transaction processing mechanism that can perfectly meet all scenarios' requirements.</p><p>Consistency, reliability, ease of use, performance, and many other aspects of system design constraints require different transaction processing mechanisms to meet them.</p><p>The core value of the Seata project is to build a standardized platform that comprehensively addresses the distributed transaction problem.</p><p>Based on Seata, the upper application architecture can flexibly choose the appropriate distributed transaction solution according to the actual scenario's needs.</p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1lTSoOqL7gK0jSZFBXXXZZpXa-1028-528.png" alt="img" style="zoom:50%" class="img_ev3q"><p>The addition of XA mode fills the gap in Seata in the global consistency scenario, forming a landscape of four major transaction modes: AT, TCC, Saga, and XA, which can basically meet all scenarios' demands for distributed transaction processing.</p><p>Of course, both XA mode and the Seata project itself are not yet perfect, and there are many areas that need improvement and enhancement. We warmly welcome everyone to participate in the project's development and contribute to building a standardized distributed transaction platform together.</p>]]></content>
        <author>
            <name>Xuan Yi</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata Quick Start]]></title>
        <id>https://seata.apache.org/blog/seata-quick-start</id>
        <link href="https://seata.apache.org/blog/seata-quick-start"/>
        <updated>2020-04-19T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Getting started with Seata from scratch, setting up Seata services, and integrating distributed transactions into Java projects.]]></summary>
        <author>
            <name>yudaoyuanma</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata High Availability Deployment Practice]]></title>
        <id>https://seata.apache.org/blog/seata-ha-practice</id>
        <link href="https://seata.apache.org/blog/seata-ha-practice"/>
        <updated>2020-04-10T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Seata High Availability Deployment Practice]]></summary>
        <author>
            <name>helloworlde</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata Config Module Source Code Analysis]]></title>
        <id>https://seata.apache.org/blog/seata-analysis-config-modular</id>
        <link href="https://seata.apache.org/blog/seata-analysis-config-modular"/>
        <updated>2020-01-11T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[1. Introduction]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-introduction">1. Introduction<a href="#1-introduction" class="hash-link" aria-label="Direct link to 1. Introduction" title="Direct link to 1. Introduction">​</a></h2><p>According to the classification defined by <a href="https://www.iteye.com/blog/javatar-949527" target="_blank" rel="noopener noreferrer">experts</a>, configurations can be categorized into three types: environment configuration, descriptive configuration, and extension configuration.</p><ul><li>Environment configuration: Typically consists of discrete simple values like parameters for component startup, often in key-value pair format.</li><li>Descriptive configuration: Pertains to business logic, such as transaction initiators and participants, and is usually embedded within the lifecycle management of the business. Descriptive configuration contains more information, sometimes with hierarchical relationships.</li><li>Extension configuration: Products need to discover third-party implementations, requiring high aggregation of configurations. Examples include various configuration centers and registration centers. The common practice is to place the fully qualified class name files under the META-INF/services directory of the JAR file, with each line representing an implementation class name.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-environment-configuration">2. Environment Configuration<a href="#2-environment-configuration" class="hash-link" aria-label="Direct link to 2. Environment Configuration" title="Direct link to 2. Environment Configuration">​</a></h2><p>When the Seata server is loaded, it uses <code>resources/registry.conf</code> to determine the types of configuration centers and registration centers. Starting from version 1.0, Seata client not only loads configurations using the <code>conf</code> file but also allows configuration through YAML files in Spring Boot using <code>seata.config.{type}</code> for choosing the configuration center, similar to selecting the registration center. The source code for loading configurations via YAML is located in the <code>io.seata.spring.boot.autoconfigure.properties.registry</code> package.</p><p>If the user of the Seata client places both a <code>conf</code> configuration file under <code>resources</code> and configures via YAML files, the configuration in the YAML file will take precedence. Code example:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CURRENT_FILE_INSTANCE = null == extConfiguration ? configuration : extConfiguration;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Here, <code>extConfiguration</code> is an instance of external configuration provided by the <code>ExtConfigurationProvider#provide()</code> external configuration provider class, while <code>configuration</code> is provided by another configuration provider class, <code>ConfigurationProvider#provide()</code>. These two configuration provider classes are loaded through SPI in the static block of the <code>ConfigurationFactory</code> in the config module.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">EnhancedServiceLoader.load(ExtConfigurationProvider.class).provide(configuration);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The selection of configuration center types discussed above is related to determining the configuration environment. Once the type of configuration center to be used is determined, the environment configuration is loaded through the corresponding configuration center. File-based configuration, represented by <code>File</code>, is also considered a type of configuration center.</p><p>Both the client and server obtain configuration parameters by using <code>ConfigurationFactory#getInstance()</code> to get an instance of the configuration class, and then retrieve configuration parameters using the instance. The constants defining configuration keys are mainly found in the <code>config</code> file under the <code>core</code> module.</p><p>The meanings of some important environment configuration properties are documented on the <a href="/docs/user/configurations/">official website</a>.</p><p>During instantiation, the configuration parameters obtained through <code>ConfigurationFactory</code> and injected into constructors require a restart to take effect. However, parameters obtained in real-time using <code>ConfigurationFactory</code> become effective immediately when the configuration changes.</p><p>The <code>config</code> module provides the <code>ConfigurationChangeListener#onChangeEvent</code> interface method to modify internal attributes of instances. In this method, dynamic changes to properties are monitored, and if the properties used by the instance are found to have changed from the initial injection, the attributes stored in the instance are modified to align with the configuration center. This enables dynamic configuration updates.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class GlobalTransactionalInterceptor implements ConfigurationChangeListener {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private volatile boolean disable = ConfigurationFactory.getInstance().getBoolean(ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override public Object invoke(Param param) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   if(disable){//Transaction business processing}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override public void onChangeEvent(Param param) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   disable = param;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The code snippet above pertains to the pseudo-code related to the <code>GlobalTransactionalInterceptor</code> and its degradation properties under the Spring module. When the <code>GlobalTransactionalScanner</code> instantiates the interceptor class mentioned above, it registers the interceptor into the list of configuration change listeners. When a configuration change occurs, the listener is invoked:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ConfigurationFactory.getInstance().addConfigListener(ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,(ConfigurationChangeListener)interceptor);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The term "degradation" refers to the scenario where a particular functionality of a service becomes unavailable. By dynamically configuring properties, this functionality can be turned off to avoid continuous attempts and failures. The <code>interceptor#invoke()</code> method executes Seata transaction-related business only when the <code>disable</code> attribute is set to true.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-descriptive-configuration">3. Descriptive Configuration<a href="#3-descriptive-configuration" class="hash-link" aria-label="Direct link to 3. Descriptive Configuration" title="Direct link to 3. Descriptive Configuration">​</a></h2><p>Descriptive configurations in general frameworks often contain abundant information, sometimes with hierarchical relationships. XML configuration is convenient for describing tree structures due to its strong descriptive capabilities. However, the current trend advocates for eliminating cumbersome prescriptive configurations in favor of using conventions.</p><p>In Seata's AT (Automatic Transaction) mode, transaction processing is achieved through proxying data sources, resulting in minimal intrusion on the business logic. Simply identifying which business components need to enable global transactions during Seata startup can be achieved using annotations, thus facilitating descriptive configuration.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@GlobalTransactional(timeoutMills = 300000, name = "busi-doBiz")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public String doBiz(String msg) {}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If using the TCC (Try-Confirm-Cancel) mode, transaction participants also need to annotate their involvement:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@TwoPhaseBusinessAction(name = "tccActionForSpringTest" , commitMethod = "commit", rollbackMethod = "rollback")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public boolean prepare(BusinessActionContext actionContext, int i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public boolean commit(BusinessActionContext actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public boolean rollback(BusinessActionContext actionContext);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-extension-configuration">4. Extension Configuration<a href="#4-extension-configuration" class="hash-link" aria-label="Direct link to 4. Extension Configuration" title="Direct link to 4. Extension Configuration">​</a></h2><p>Extension configurations typically have high requirements for product aggregation because products need to discover third-party implementations and incorporate them into their internals.</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/20200110213751452.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3ODA0NzM3,size_16,color_FFFFFF,t_70" alt="Image Description" class="img_ev3q"></p><p>Here's an example of a custom configuration center provider class. Place a text file with the same name as the interface under META-INF/services, and the content of the file should be the implementation class of the interface. This follows the standard SPI (Service Provider Interface) approach. Then, modify the configuration file <code>registry.conf</code> to set <code>config.type=test</code>.</p><p>However, if you think that by doing so, Seata can recognize it and replace the configuration center, then you are mistaken. When Seata loads the configuration center, it encapsulates the value of the configuration center type specified in the configuration file using the enum <code>ConfigType</code>:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private static Configuration buildConfiguration() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   configTypeName = "test";//The 'config.type' configured in 'registry.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   configType = ConfigType.getType(configTypeName);//An exception will be thrown if ConfigType cannot be retrieved.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If a configuration center type like <code>test</code> is not defined in <code>ConfigType</code>, it will throw an exception. Therefore, merely modifying the configuration file without changing the source code will not enable the use of configuration center provider classes other than those defined in <code>ConfigType</code>.</p><p>Currently, in version 1.0, the configuration center types defined in <code>ConfigType</code> include: File, ZK, Nacos, Apollo, Consul, Etcd3, SpringCloudConfig, and Custom. If a user wishes to use a custom configuration center type, they can use the <code>Custom</code> type.</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/20200110215249152.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3ODA0NzM3,size_16,color_FFFFFF,t_70" alt="Image Description" class="img_ev3q"></p><p>One inelegant approach here is to provide an implementation class with a specified name <code>ZK</code> but with a higher priority level (order=3) than the default <code>ZK</code> implementation (which has order=1). This will make <code>ConfigurationFactory</code> use <code>TestConfigurationProvider</code> as the configuration center provider class.</p><p>Through the above steps, Seata can be configured to use our own provided code. Modules in Seata such as codec, compressor, discovery, integration, etc., all use the SPI mechanism to load functional classes, adhering to the design philosophy of microkernel + plug-in, treating third parties equally.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-seata-source-code-analysis-series">5. Seata Source Code Analysis Series<a href="#5-seata-source-code-analysis-series" class="hash-link" aria-label="Direct link to 5. Seata Source Code Analysis Series" title="Direct link to 5. Seata Source Code Analysis Series">​</a></h2><p>Author: Zhao Runze, <a href="https://blog.csdn.net/qq_37804737/category_9530078.html" target="_blank" rel="noopener noreferrer">Series Address</a>.</p>]]></content>
        <author>
            <name>runze.zhao</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Source Code Analysis of Seata-XID Propagation in Dubbo]]></title>
        <id>https://seata.apache.org/blog/seata-analysis-dubbo-transmit-xid</id>
        <link href="https://seata.apache.org/blog/seata-analysis-dubbo-transmit-xid"/>
        <updated>2020-01-01T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This article explores the propagation of XID in Seata-Dubbo through source code analysis.]]></summary>
        <content type="html"><![CDATA[<p>Author: FUNKYE (Chen Jianbin), Principal Engineer at a certain Internet company in Hangzhou.</p><h1>Preface</h1><ol><li>Let's start by examining the package structure. Under seata-dubbo and seata-dubbo-alibaba, there is a common class named TransactionPropagationFilter, corresponding to Apache Dubbo and Alibaba Dubbo respectively.</li></ol><p><img loading="lazy" alt="20200101203229" src="/assets/images/20200101203229-b1377d653c52962ea621a450291bcf87.png" width="422" height="410" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="source-code-analysis">Source Code Analysis<a href="#source-code-analysis" class="hash-link" aria-label="Direct link to Source Code Analysis" title="Direct link to Source Code Analysis">​</a></h2><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package io.seata.integration.dubbo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.seata.core.context.RootContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.dubbo.common.Constants;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.dubbo.common.extension.Activate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.dubbo.rpc.Filter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.dubbo.rpc.Invocation;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.dubbo.rpc.Invoker;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.dubbo.rpc.Result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.dubbo.rpc.RpcContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.dubbo.rpc.RpcException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.Logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.LoggerFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Activate(group = {Constants.PROVIDER, Constants.CONSUMER}, order = 100)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TransactionPropagationFilter implements Filter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOGGER = LoggerFactory.getLogger(TransactionPropagationFilter.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Result invoke(Invoker&lt;?&gt; invoker, Invocation invocation) throws RpcException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get local XID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String xid = RootContext.getXID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String xidInterceptorType = RootContext.getXIDInterceptorType();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get XID from dubbo param</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String rpcXid = getRpcXid();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String rpcXidInterceptorType = RpcContext.getContext().getAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.debug("xid in RootContext[{}] xid in RpcContext[{}]", xid, rpcXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean bind = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (xid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //transfer xid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            RpcContext.getContext().setAttachment(RootContext.KEY_XID, xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            RpcContext.getContext().setAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE, xidInterceptorType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (rpcXid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //bind XID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RootContext.bind(rpcXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RootContext.bindInterceptorType(rpcXidInterceptorType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                bind = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOGGER.debug("bind[{}] interceptorType[{}] to RootContext", rpcXid, rpcXidInterceptorType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return invoker.invoke(invocation);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (bind) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //remove xid which has finished</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String unbindInterceptorType = RootContext.unbindInterceptorType();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String unbindXid = RootContext.unbind();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (LOGGER.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOGGER.debug("unbind[{}] interceptorType[{}] from RootContext", unbindXid, unbindInterceptorType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // if unbind xid is not current rpc xid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!rpcXid.equalsIgnoreCase(unbindXid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOGGER.warn("xid in change during RPC from {} to {}, xidInterceptorType from {} to {} ", rpcXid, unbindXid, rpcXidInterceptorType, unbindInterceptorType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (unbindXid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // bind xid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        RootContext.bind(unbindXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        RootContext.bindInterceptorType(unbindInterceptorType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        LOGGER.warn("bind [{}] interceptorType[{}] back to RootContext", unbindXid, unbindInterceptorType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * get rpc xid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String getRpcXid() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String rpcXid = RpcContext.getContext().getAttachment(RootContext.KEY_XID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (rpcXid == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            rpcXid = RpcContext.getContext().getAttachment(RootContext.KEY_XID.toLowerCase());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return rpcXid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	1. Based on the source code, we can deduce the corresponding logic processing.</p><p><img loading="lazy" alt="20200101213336" src="/assets/images/20200101213336-dec117cebba3464f980a52714f43ff7d.png" width="775" height="743" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="key-points">Key Points<a href="#key-points" class="hash-link" aria-label="Direct link to Key Points" title="Direct link to Key Points">​</a></h2><ol><li>Dubbo @Activate Annotation:</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ElementType.TYPE, ElementType.METHOD})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface Activate {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String[] group() default {};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String[] value() default {};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String[] before() default {};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String[] after() default {};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int order() default 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It can be analyzed that the @Activate annotation on Seata's Dubbo filter, with parameters @Activate(group = {Constants.PROVIDER, Constants.CONSUMER}, order = 100), indicates that both the Dubbo service provider and consumer will trigger this filter. Therefore, our Seata initiator will initiate an XID transmission. The above flowchart and code have clearly represented this.</p><ol start="2"><li>Dubbo implicit parameter passing can be achieved through setAttachment and getAttachment on RpcContext for implicit parameter transmission between service consumers and providers.</li></ol><p>Fetching: RpcContext.getContext().getAttachment(RootContext.KEY_XID);</p><p>Passing: RpcContext.getContext().setAttachment(RootContext.KEY_XID, xid);</p><h1>Conclusion</h1><p>For further source code reading, please visit the <a href="https://seata.apache.org/" target="_blank" rel="noopener noreferrer">Seata official website</a></p>]]></content>
        <author>
            <name>FUNKYE</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata TCC Module Source Code Analysis]]></title>
        <id>https://seata.apache.org/blog/seata-analysis-tcc-modular</id>
        <link href="https://seata.apache.org/blog/seata-analysis-tcc-modular"/>
        <updated>2019-12-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[一. Introduction]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="一-introduction">一. Introduction<a href="#一-introduction" class="hash-link" aria-label="Direct link to 一. Introduction" title="Direct link to 一. Introduction">​</a></h2><p>In the analysis of the Spring module, it is noted that Seata's Spring module handles beans involved in distributed transactions. Upon project startup, when the <code>GlobalTransactionalScanner</code> detects references to TCC services (i.e., TCC transaction participants), it dynamically proxies them by weaving in the implementation class of <code>MethodInterceptor</code> under the TCC mode. The initiator of the TCC transaction still uses the <code>@GlobalTransactional</code> annotation to initiate it, and a generic implementation class of <code>MethodInterceptor</code> is woven in.</p><p>The implementation class of <code>MethodInterceptor</code> under the TCC mode is referred to as <code>TccActionInterceptor</code> (in the Spring module). This class invokes <code>ActionInterceptorHandler</code> (in the TCC module) to handle the transaction process under the TCC mode.</p><p>The primary functions of TCC dynamic proxy are: generating the TCC runtime context, propagating business parameters, and registering branch transaction records.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二-introduction-to-tcc-mode">二. Introduction to TCC Mode<a href="#二-introduction-to-tcc-mode" class="hash-link" aria-label="Direct link to 二. Introduction to TCC Mode" title="Direct link to 二. Introduction to TCC Mode">​</a></h2><p>In the Two-Phase Commit (2PC) protocol, the transaction manager coordinates resource management in two phases. The resource manager provides three operations: the prepare operation in the first phase, and the commit operation and rollback operation in the second phase.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface TccAction {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @TwoPhaseBusinessAction(name = "tccActionForTest" , commitMethod = "commit", rollbackMethod = "rollback")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean prepare(BusinessActionContext actionContext,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           @BusinessActionContextParameter(paramName = "a") int a,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           @BusinessActionContextParameter(paramName = "b", index = 0) List b,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           @BusinessActionContextParameter(isParamInProperty = true) TccParam tccParam);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean commit(BusinessActionContext actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean rollback(BusinessActionContext actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is a participant instance in TCC. Participants need to implement three methods, where the first parameter must be BusinessActionContext, and the return type of the methods is fixed. These methods are exposed as microservices to be invoked by the transaction manager.</p><ul><li>prepare: Checks and reserves resources. For example, deducting the account balance and increasing the same frozen balance.</li><li>commit: Uses the reserved resources to complete the actual business operation. For example, reducing the frozen balance to complete the fund deduction business.</li><li>cancel: Releases the reserved resources. For example, adding back the frozen balance to the account balance.</li></ul><p>The BusinessActionContext encapsulates the context environment of the current transaction: xid, branchId, actionName, and parameters annotated with @BusinessActionContextParam.</p><p>There are several points to note in participant business:</p><ol><li>Ensure business idempotence, supporting duplicate submission and rollback of the same transaction.</li><li>Prevent hanging, i.e., the rollback of the second phase occurs before the try phase.</li><li>Relax consistency protocols, eventually consistent, so it is read-after-write.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="three-remoting-package-analysis">Three. Remoting package analysis<a href="#three-remoting-package-analysis" class="hash-link" aria-label="Direct link to Three. Remoting package analysis" title="Direct link to Three. Remoting package analysis">​</a></h2><p><img loading="lazy" src="https://img-blog.csdnimg.cn/20191124211806237.png?" alt="Remoting Package Analysis" class="img_ev3q"></p><p>All classes in the package serve DefaultRemotingParser. Dubbo, LocalTCC, and SofaRpc are responsible for parsing classes under their respective RPC protocols.</p><p>Main methods of DefaultRemotingParser:</p><ol><li>Determine if the bean is a remoting bean, code: </li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean isRemoting(Object bean, String beanName) throws FrameworkException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //判断是否是服务调用方或者是否是服务提供方</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return isReference(bean, beanName) || isService(bean, beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>Remote bean parsing, parses rpc classes into RemotingDesc.</li></ol><p>Code:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean isRemoting(Object bean, String beanName) throws FrameworkException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //判断是否是服务调用方或者是否是服务提供方</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return isReference(bean, beanName) || isService(bean, beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Utilize allRemotingParsers to parse remote beans. allRemotingParsers is dynamically loaded in initRemotingParser() by calling EnhancedServiceLoader.loadAll(RemotingParser.class), which implements the SPI loading mechanism for loading subclasses of RemotingParser.</p><p>For extension purposes, such as implementing a parser for feign remote calls, simply write the relevant implementation classes of RemotingParser in the SPI configuration. This approach offers great extensibility.</p><p>RemotingDesc contains specific information about remote beans required for the transaction process, such as targetBean, interfaceClass, interfaceClassName, protocol, isReference, and so on.</p><ol start="3"><li>TCC Resource Registration</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public RemotingDesc parserRemotingServiceInfo(Object bean, String beanName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RemotingDesc remotingBeanDesc = getServiceDesc(bean, beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (remotingBeanDesc == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        remotingServiceMap.put(beanName, remotingBeanDesc);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt; interfaceClass = remotingBeanDesc.getInterfaceClass();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Method[] methods = interfaceClass.getMethods();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (isService(bean, beanName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //service bean, registry resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Object targetBean = remotingBeanDesc.getTargetBean();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (Method m : methods) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    TwoPhaseBusinessAction twoPhaseBusinessAction = m.getAnnotation(TwoPhaseBusinessAction.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (twoPhaseBusinessAction != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        TCCResource tccResource = new TCCResource();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        tccResource.setActionName(twoPhaseBusinessAction.name());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        tccResource.setTargetBean(targetBean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        tccResource.setPrepareMethod(m);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        tccResource.setCommitMethodName(twoPhaseBusinessAction.commitMethod());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        tccResource.setCommitMethod(ReflectionUtil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getMethod(interfaceClass, twoPhaseBusinessAction.commitMethod(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                new Class[] {BusinessActionContext.class}));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        tccResource.setRollbackMethodName(twoPhaseBusinessAction.rollbackMethod());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        tccResource.setRollbackMethod(ReflectionUtil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getMethod(interfaceClass, twoPhaseBusinessAction.rollbackMethod(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                new Class[] {BusinessActionContext.class}));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        //registry tcc resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        DefaultResourceManager.get().registerResource(tccResource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new FrameworkException(t, "parser remoting service error");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (isReference(bean, beanName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //reference bean, TCC proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            remotingBeanDesc.setReference(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return remotingBeanDesc;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Firstly, determine if it is a transaction participant. If so, obtain the interfaceClass from RemotingDesc, iterate through the methods in the interface, and check if there is a @TwoParserBusinessAction annotation on the method. If found, encapsulate the parameters into TCCResource and register the TCC resource through DefaultResourceManager.</p><p>Here, DefaultResourceManager will search for the corresponding resource manager based on the BranchType of the Resource. The resource management class under the TCC mode is in the tcc module.</p><p>This RPC parsing class is mainly provided for use by the spring module. parserRemotingServiceInfo() is encapsulated into the TCCBeanParserUtils utility class in the spring module. During project startup, the GlobalTransactionScanner in the spring module parses TCC beans through the utility class. TCCBeanParserUtils calls TCCResourceManager to register resources. If it is a global transaction service provider, it will weave in the TccActionInterceptor proxy. These processes are functionalities of the spring module, where the tcc module provides functional classes for use by the spring module.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="three-tcc-resource-manager">Three. TCC Resource Manager<a href="#three-tcc-resource-manager" class="hash-link" aria-label="Direct link to Three. TCC Resource Manager" title="Direct link to Three. TCC Resource Manager">​</a></h2><p>TCCResourceManager is responsible for managing the registration, branching, committing, and rolling back of resources under the TCC mode.</p><ol><li>During project startup, when the GlobalTransactionScanner in the spring module detects that a bean is a tcc bean, it caches resources locally and registers them with the server:</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void registerResource(Resource resource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TCCResource tccResource = (TCCResource)resource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tccResourceCache.put(tccResource.getResourceId(), tccResource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super.registerResource(tccResource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The logic for communicating with the server is encapsulated in the parent class AbstractResourceManager. Here, TCCResource is cached based on resourceId. When registering resources in the parent class AbstractResourceManager, resourceGroupId + actionName is used, where actionName is the name specified in the @TwoParseBusinessAction annotation, and resourceGroupId defaults to DEFAULT.</p><ol start="2"><li><p>Transaction branch registration is handled in the rm-datasource package under AbstractResourceManager. During registration, the parameter lockKeys is null, which differs from the transaction branch registration under the AT mode.</p></li><li><p>Committing or rolling back branches:</p></li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public BranchStatus branchCommit(BranchType branchType, String xid, long branchId, String resourceId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     String applicationData) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TCCResource tccResource = (TCCResource)tccResourceCache.get(resourceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (tccResource == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShouldNeverHappenException("TCC resource is not exist, resourceId:" + resourceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object targetTCCBean = tccResource.getTargetBean();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Method commitMethod = tccResource.getCommitMethod();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (targetTCCBean == null || commitMethod == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShouldNeverHappenException("TCC resource is not available, resourceId:" + resourceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boolean result = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //BusinessActionContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            BusinessActionContext businessActionContext = getBusinessActionContext(xid, branchId, resourceId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                applicationData);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object ret = commitMethod.invoke(targetTCCBean, businessActionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ret != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (ret instanceof TwoPhaseResult) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    result = ((TwoPhaseResult)ret).isSuccess();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    result = (boolean)ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result ? BranchStatus.PhaseTwo_Committed : BranchStatus.PhaseTwo_CommitFailed_Retryable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.error(msg, t);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new FrameworkException(t, msg);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Restore the business context using parameters xid, branchId, resourceId, and applicationData.</p><p>Execute the commit method through reflection based on the retrieved context and return the execution result. The rollback method follows a similar approach.</p><p>Here, branchCommit() and branchRollback() are provided for AbstractRMHandler, an abstract class for resource processing in the rm module. This handler is a further implementation class of the template method defined in the core module. Unlike registerResource(), which actively registers resources during spring scanning.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="four-transaction-processing-in-tcc-mode">Four. Transaction Processing in TCC Mode<a href="#four-transaction-processing-in-tcc-mode" class="hash-link" aria-label="Direct link to Four. Transaction Processing in TCC Mode" title="Direct link to Four. Transaction Processing in TCC Mode">​</a></h2><p>The invoke() method of TccActionInterceptor in the spring module is executed when the proxied rpc bean is called. This method first retrieves the global transaction xid passed by the rpc interceptor, and then the transaction process of global transaction participants under TCC mode is still handed over to the ActionInterceptorHandler in the tcc module.</p><p>In other words, transaction participants are proxied during project startup. The actual business methods are executed through callbacks in ActionInterceptorHandler.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    public Map&lt;String, Object&gt; proceed(Method method, Object[] arguments, String xid, TwoPhaseBusinessAction businessAction,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       Callback&lt;Object&gt; targetCallback) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, Object&gt; ret = new HashMap&lt;String, Object&gt;(4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //TCC name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String actionName = businessAction.name();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BusinessActionContext actionContext = new BusinessActionContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        actionContext.setXid(xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //set action anme</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        actionContext.setActionName(actionName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //Creating Branch Record</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String branchId = doTccActionLogStore(method, arguments, businessAction, actionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        actionContext.setBranchId(branchId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //set the parameter whose type is BusinessActionContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt;[] types = method.getParameterTypes();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int argIndex = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Class&lt;?&gt; cls : types) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (cls.getName().equals(BusinessActionContext.class.getName())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                arguments[argIndex] = actionContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            argIndex++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //the final parameters of the try method</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret.put(Constants.TCC_METHOD_ARGUMENTS, arguments);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //the final result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret.put(Constants.TCC_METHOD_RESULT, targetCallback.execute());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Here are two important operations:</p><ol><li>In the doTccActionLogStore() method, two crucial methods are called:</li></ol><ul><li>fetchActionRequestContext(method, arguments): This method retrieves parameters annotated with @BusinessActionContextParam and inserts them into BusinessActionComtext along with transaction-related parameters in the init method below.</li><li>DefaultResourceManager.get().branchRegister(BranchType.TCC, actionName, null, xid, applicationContextStr, null): This method performs the registration of transaction branches for transaction participants under TCC mode.</li></ul><ol start="2"><li>Callback execution of targetCallback.execute(), which executes the specific business logic of the proxied bean, i.e., the prepare() method.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="five-summary">Five. Summary<a href="#five-summary" class="hash-link" aria-label="Direct link to Five. Summary" title="Direct link to Five. Summary">​</a></h2><p>The tcc module primarily provides the following functionalities:</p><ol><li>Defines annotations for two-phase protocols, providing attributes needed for transaction processes under TCC mode.</li><li>Provides implementations of ParserRemoting for parsing remoting beans of different RPC frameworks, to be invoked by the spring module.</li><li>Provides the TCC ResourceManager for resource registration, transaction branch registration, submission, and rollback under TCC mode.</li><li>Provides classes for handling transaction processes under TCC mode, allowing MethodInterceptor proxy classes to delegate the execution of specific mode transaction processes to the tcc module.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="related">Related<a href="#related" class="hash-link" aria-label="Direct link to Related" title="Direct link to Related">​</a></h2><p>Author: Zhao Runze, <a href="https://blog.csdn.net/qq_37804737/category_9530078.html" target="_blank" rel="noopener noreferrer">Series Link</a>.</p>]]></content>
        <author>
            <name>runze.zhao</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata Community Meetup·Hangzhou Station]]></title>
        <id>https://seata.apache.org/blog/seata-community-meetup-hangzhou-ready</id>
        <link href="https://seata.apache.org/blog/seata-community-meetup-hangzhou-ready"/>
        <updated>2019-12-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Seata Community Meetup·Hangzhou Station, officially held on December 21st at Zhejiang Youth Innovation Space in Dream Town, Hangzhou.]]></summary>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata Core Module Source Code Analysis]]></title>
        <id>https://seata.apache.org/blog/seata-analysis-core-modular</id>
        <link href="https://seata.apache.org/blog/seata-analysis-core-modular"/>
        <updated>2019-12-23T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[1. Introduction]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-introduction">1. Introduction<a href="#1-introduction" class="hash-link" aria-label="Direct link to 1. Introduction" title="Direct link to 1. Introduction">​</a></h2><p>The core module defines the types and states of transactions, common behaviors, protocols, and message models for communication between clients and servers, as well as exception handling methods, compilation, compression types, configuration information names, environment context, etc. It also encapsulates RPC based on Netty for use by both clients and servers.</p><p>Let's analyze the main functional classes of the core module according to the package order:</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/20191223162313317.png" alt="Image Description" class="img_ev3q"></p><p>codec: Defines a codec factory class, which provides a method to find the corresponding processing class based on the serialization type. It also provides an interface class Codec with two abstract methods:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;T&gt; byte[] encode(T t);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;T&gt; T decode(byte[] bytes);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-codec-module">1. codec Module<a href="#1-codec-module" class="hash-link" aria-label="Direct link to 1. codec Module" title="Direct link to 1. codec Module">​</a></h2><p>In version 1.0, the codec module has three serialization implementations: SEATA, PROTOBUF, and KRYO.</p><p>compressor: Similar to classes under the codec package, there are three classes here: a compression type class, a factory class, and an abstract class for compression and decompression operations. In version 1.0, there is only one compression method: Gzip.</p><p>constants: Consists of two classes, ClientTableColumnsName and ServerTableColumnsName, representing the models for transaction tables stored on the client and server sides respectively. It also includes classes defining supported database types and prefixes for configuration information attributes.</p><p>context: The environment class RootContext holds a ThreadLocalContextCore to store transaction identification information. For example, TX_XID uniquely identifies a transaction, and TX_LOCK indicates the need for global lock control for local transactions on update/delete/insert/selectForUpdate SQL operations.</p><p>event: Utilizes the Guava EventBus event bus for registration and notification, implementing the listener pattern. In the server module's metrics package, MetricsManager registers monitoring events for changes in GlobalStatus, which represents several states of transaction processing in the server module. When the server processes transactions, the callback methods registered for monitoring events are invoked, primarily for statistical purposes.</p><p>lock: When the server receives a registerBranch message for branch registration, it acquires a lock. In version 1.0, there are two lock implementations: DataBaseLocker and MemoryLocker, representing database locks and in-memory locks respectively. Database locks are acquired based on the rowKey = resourceId + tableName + pk, while memory locks are based directly on the primary key.</p><p>model: BranchStatus, GlobalStatus, and BranchType are used to define transaction types and global/branch states. Additionally, TransactionManager and ResourceManager are abstract classes representing resource managers (RMs) and transaction managers (TMs) respectively. Specific implementations of RMs and TMs are not provided here due to variations in transaction types.</p><p>protocol: Defines entity classes used for transmission in the RPC module, representing models for requests and responses under different transaction status scenarios.</p><p>store: Defines data models for interacting with databases and the SQL statements used for database interactions.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    public void exceptionHandleTemplate(Callback callback, AbstractTransactionRequest request,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AbstractTransactionResponse response) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            callback.execute(request, response); //执行事务业务的方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            callback.onSuccess(request, response); //设置response返回码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (TransactionException tex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.error("Catch TransactionException while do RPC, request: {}", request, tex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            callback.onTransactionException(request, response, tex); //设置response返回码并设置msg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (RuntimeException rex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.error("Catch RuntimeException while do RPC, request: {}", request, rex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            callback.onException(request, response, rex);  //设置response返回码并设置msg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-analysis-of-exception-handling-in-the-exception-package">2. Analysis of Exception Handling in the exception Package<a href="#2-analysis-of-exception-handling-in-the-exception-package" class="hash-link" aria-label="Direct link to 2. Analysis of Exception Handling in the exception Package" title="Direct link to 2. Analysis of Exception Handling in the exception Package">​</a></h2><p>This is the UML diagram of AbstractExceptionHandler. Callback and AbstractCallback are internal interfaces and classes of AbstractExceptionHandler. AbstractCallback implements three methods of the Callback interface but leaves the execute() method unimplemented. AbstractExceptionHandler uses AbstractCallback as a parameter for the template method and utilizes its implemented methods. However, the execute() method is left to be implemented by subclasses.</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/20191211165628768.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM3ODA0NzM3,size_16,color_FFFFFF,t_70" alt="Image Description" class="img_ev3q"></p><p>From an external perspective, AbstractExceptionHandler defines a template method with exception handling. The template includes four behaviors, three of which are already implemented, and the behavior execution is delegated to subclasses.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-analysis-of-the-rpc-package">3. Analysis of the rpc Package<a href="#3-analysis-of-the-rpc-package" class="hash-link" aria-label="Direct link to 3. Analysis of the rpc Package" title="Direct link to 3. Analysis of the rpc Package">​</a></h2><p>When it comes to the encapsulation of RPC by Seata, one need not delve into the details. However, it's worth studying how transaction business is handled.</p><p>The client-side RPC class is AbstractRpcRemotingClient:</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/20191211180129741.png" alt="Image Description" class="img_ev3q"></p><p>The important attributes and methods are depicted in the class diagram. The methods for message sending and initialization are not shown in the diagram. Let's analyze the class diagram in detail:</p><p>clientBootstrap: This is a wrapper class for the netty startup class Bootstrap. It holds an instance of Bootstrap and customizes the properties as desired.</p><p>clientChannelManager: Manages the correspondence between server addresses and channels using a ConcurrentHashMap&lt;serverAddress,channel&gt; container.</p><p>clientMessageListener: Handles messages. Depending on the message type, there are three specific processing methods.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void onMessage(RpcMessage request, String serverAddress, ClientMessageSender sender) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object msg = request.getBody();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (LOGGER.isInfoEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOGGER.info("onMessage:" + msg);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (msg instanceof BranchCommitRequest) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleBranchCommit(request, serverAddress, (BranchCommitRequest)msg, sender);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (msg instanceof BranchRollbackRequest) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleBranchRollback(request, serverAddress, (BranchRollbackRequest)msg, sender);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (msg instanceof UndoLogDeleteRequest) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleUndoLogDelete((UndoLogDeleteRequest)msg);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-analysis-of-the-rpc-package-continued">4. Analysis of the rpc Package (Continued)<a href="#4-analysis-of-the-rpc-package-continued" class="hash-link" aria-label="Direct link to 4. Analysis of the rpc Package (Continued)" title="Direct link to 4. Analysis of the rpc Package (Continued)">​</a></h2><p>Within the message class, the TransactionMessageHandler is responsible for handling messages of different types. Eventually, based on the different transaction types (AT, TCC, SAGE), specific handling classes, as mentioned in the second part, exceptionHandleTemplate(), are invoked.</p><p>mergeSendExecutorService: This is a thread pool with only one thread responsible for merging and sending messages from different addresses. In the sendAsyncRequest() method, messages are offered to the queue LinkedBlockingQueue of the thread pool. The thread is then responsible for polling and processing messages.</p><p>channelRead(): Handles server-side HeartbeatMessage.PONG heartbeat messages. Additionally, it processes MergeResultMessage, which are response messages for asynchronous messages. It retrieves the corresponding MessageFuture based on the msgId and sets the result of the asynchronous message.</p><p>dispatch(): Invokes the clientMessageListener to handle messages sent by the server. Different types of requests have different handling classes.</p><p>In summary, when looking at Netty, one should focus on serialization methods and message handling handler classes. Seata's RPC serialization method is processed by finding the Codec implementation class through the factory class, and the handler is the TransactionMessageHandler mentioned earlier.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-conclusion">5. Conclusion<a href="#5-conclusion" class="hash-link" aria-label="Direct link to 5. Conclusion" title="Direct link to 5. Conclusion">​</a></h2><p>The core module covers a wide range of functionalities, with most classes serving as abstract classes for other modules. Business models are abstracted out, and specific implementations are distributed across different modules. The code in the core module is of high quality, with many classic design patterns such as the template pattern discussed earlier. It is very practical and well-crafted, deserving careful study.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-seata-source-code-analysis-series-links">6. Seata Source Code Analysis Series Links<a href="#6-seata-source-code-analysis-series-links" class="hash-link" aria-label="Direct link to 6. Seata Source Code Analysis Series Links" title="Direct link to 6. Seata Source Code Analysis Series Links">​</a></h2><p><a href="https://blog.csdn.net/qq_37804737/category_9530078.html" target="_blank" rel="noopener noreferrer">Series Links</a></p>]]></content>
        <author>
            <name>runze.zhao</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Dynamically Creating/Closing Seata Distributed Transactions through AOP]]></title>
        <id>https://seata.apache.org/blog/seata-spring-boot-aop-aspectj</id>
        <link href="https://seata.apache.org/blog/seata-spring-boot-aop-aspectj"/>
        <updated>2019-12-23T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This article explains how to dynamically create/close Seata distributed transactions using AOP.]]></summary>
        <author>
            <name>FUNKYE</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata Dynamic Configuration Subscription and Degradation Implementation Principles]]></title>
        <id>https://seata.apache.org/blog/seata-dynamic-config-and-dynamic-disable</id>
        <link href="https://seata.apache.org/blog/seata-dynamic-config-and-dynamic-disable"/>
        <updated>2019-12-17T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This article explains how Seata adapts to different dynamic configuration subscriptions and implements degradation functionality with support for multiple configuration centers.]]></summary>
        <author>
            <name>chenghui.zhang</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata Configuration Center Implementation Principles]]></title>
        <id>https://seata.apache.org/blog/seata-config-center</id>
        <link href="https://seata.apache.org/blog/seata-config-center"/>
        <updated>2019-12-12T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Seata supports multiple third-party configuration centers, but how does Seata simultaneously accommodate so many configuration centers?]]></summary>
        <author>
            <name>chenghui.zhang</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Docker Deployment of Seata Integration with Nacos]]></title>
        <id>https://seata.apache.org/blog/seata-nacos-docker</id>
        <link href="https://seata.apache.org/blog/seata-nacos-docker"/>
        <updated>2019-12-03T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This article explains how to deploy Seata integrated with Nacos configuration using Docker.]]></summary>
        <author>
            <name>FUNKYE</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Configuring Seata Distributed Transaction with Nacos as the Configuration Center]]></title>
        <id>https://seata.apache.org/blog/seata-nacos-analysis</id>
        <link href="https://seata.apache.org/blog/seata-nacos-analysis"/>
        <updated>2019-12-02T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This article explains how to integrate Seata with Nacos for configuration.]]></summary>
        <author>
            <name>FUNKYE</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata Community Meetup·Hangzhou Station]]></title>
        <id>https://seata.apache.org/blog/seata-meetup-hangzhou</id>
        <link href="https://seata.apache.org/blog/seata-meetup-hangzhou"/>
        <updated>2019-12-01T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Seata Community Meetup·Hangzhou Station was successfully held at Zhejiang Youth Innovation Space, Dream Town, Hangzhou on December 21st.]]></summary>
        <content type="html"><![CDATA[<p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1qH2YwVP7gK0jSZFjXXc5aXXa-2002-901.jpg" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="event-introduction">Event Introduction<a href="#event-introduction" class="hash-link" aria-label="Direct link to Event Introduction" title="Direct link to Event Introduction">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="highlight-interpretation">Highlight Interpretation<a href="#highlight-interpretation" class="hash-link" aria-label="Direct link to Highlight Interpretation" title="Direct link to Highlight Interpretation">​</a></h3><ul><li><p>Seata project founder presented "Seata Past, Present, and Future" along with new features of Seata 1.0.</p></li><li><p>Seata core contributors elaborated on Seata AT, TCC, and Saga modes.</p></li><li><p>Implementation analysis of Seata in internet healthcare and Didi Chuxing.</p></li><li><p><a href="https://developer.aliyun.com/live/1760" target="_blank" rel="noopener noreferrer">Replay benefits (Developer Community)</a></p></li><li><p><a href="http://w2wz.com/h2nb" target="_blank" rel="noopener noreferrer">Join Seata thousand-member DingTalk group</a></p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="guest-speakers">Guest Speakers<a href="#guest-speakers" class="hash-link" aria-label="Direct link to Guest Speakers" title="Direct link to Guest Speakers">​</a></h3><ul><li><p>Ji Min (Qing Ming) "Seata Past, Present, and Future" <a href="https://github.com/funky-eyes/awesome-seata/blob/master/slides/meetup/201912%40hangzhou/%E5%AD%A3%E6%95%8F%EF%BC%88%E6%B8%85%E9%93%AD%EF%BC%89%E3%80%8ASeata%20%E7%9A%84%E8%BF%87%E5%8E%BB%E3%80%81%E7%8E%B0%E5%9C%A8%E5%92%8C%E6%9C%AA%E6%9D%A5%E3%80%8B.pdf" target="_blank" rel="noopener noreferrer">slides</a></p><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1BALWw4z1gK0jSZSgXXavwpXa-6720-4480.jpg" class="img_ev3q"></p></li><li><p>Wu Jiangke "My Open Source Journey with SEATA and SEATA's Application in Internet Healthcare Systems" <a href="https://github.com/seata/awesome-seata/blob/master/slides/meetup/201912%40hangzhou/%E5%AD%A3%E6%95%8F%EF%BC%88%E6%B8%85%E9%93%AD%EF%BC%89%E3%80%8ASeata%20%E7%9A%84%E8%BF%87%E5%8E%BB%E3%80%81%E7%8E%B0%E5%9C%A8%E5%92%8C%E6%9C%AA%E6%9D%A5%E3%80%8B.pdf" target="_blank" rel="noopener noreferrer">slides</a></p><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1Xzz1w4v1gK0jSZFFXXb0sXXa-6720-4480.jpg" alt="1577282651" class="img_ev3q"></p></li><li><p>Shen Haiqiang (Xuan Yi) "Essence of Seata AT Mode" <a href="https://github.com/seata/awesome-seata/tree/master/slides/meetup/201912%40hangzhou" target="_blank" rel="noopener noreferrer">slides</a></p><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1UK22w7T2gK0jSZPcXXcKkpXa-6720-4480.jpg" alt="1577282652" class="img_ev3q"></p></li><li><p>Zhang Sen "Detailed Explanation of TCC Mode in Distributed Transaction Seata"</p><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1fCPZw.T1gK0jSZFhXXaAtVXa-6720-4480.jpg" alt="1577282653" class="img_ev3q"></p></li><li><p>Chen Long (Yiyuan) "Seata Long Transaction Solution Saga Mode"</p><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1zLv3wYj1gK0jSZFuXXcrHpXa-6720-4480.jpg" alt="1577282654" class="img_ev3q"></p></li><li><p>Chen Pengzhi "Seata Practice in Didi Chuxing's Motorcycle Business" <a href="https://github.com/seata/awesome-seata/blob/master/slides/meetup/201912%40hangzhou/%E9%99%88%E9%B9%8F%E5%BF%97%E3%80%8ASeata%20%E5%9C%A8%E6%BB%B4%E6%BB%B4%E4%B8%A4%E8%BD%AE%E8%BD%A6%E4%B8%9A%E5%8A%A1%E7%9A%84%E5%AE%9E%E8%B7%B5%E3%80%8B.pdf" target="_blank" rel="noopener noreferrer">slides</a></p><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1phvYw4n1gK0jSZKPXXXvUXXa-6720-4480.jpg" alt="1577282655" class="img_ev3q"></p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="special-awards">Special Awards<a href="#special-awards" class="hash-link" aria-label="Direct link to Special Awards" title="Direct link to Special Awards">​</a></h3><p><img loading="lazy" src="https://img.alicdn.com/tfs/TB1khDVw.z1gK0jSZLeXXb9kVXa-6720-4480.jpg" class="img_ev3q"></p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Resolving the Issue of Losing Mybatis-Plus Features in Seata AT Mode Integration through Source Code]]></title>
        <id>https://seata.apache.org/blog/seata-mybatisplus-analysis</id>
        <link href="https://seata.apache.org/blog/seata-mybatisplus-analysis"/>
        <updated>2019-11-30T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This article explains how to resolve the issue of losing Mybatis-Plus features in Seata integration through source code.]]></summary>
        <author>
            <name>FUNKYE</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Integrating Seata Distributed Transaction with SpringBoot+Dubbo+MybatisPlus]]></title>
        <id>https://seata.apache.org/blog/springboot-dubbo-mybatisplus-seata</id>
        <link href="https://seata.apache.org/blog/springboot-dubbo-mybatisplus-seata"/>
        <updated>2019-11-29T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This article explains how to build the integration of Seata with SpringBoot+Dubbo+MybatisPlus using the direct connection approach.]]></summary>
        <author>
            <name>FUNKYE</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Does Seata Client Need to Start RM and TM Simultaneously?]]></title>
        <id>https://seata.apache.org/blog/seata-at-mode-start-rm-tm</id>
        <link href="https://seata.apache.org/blog/seata-at-mode-start-rm-tm"/>
        <updated>2019-11-28T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[A discussion point regarding future optimizations for Seata]]></summary>
        <author>
            <name>chenghui.zhang</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata AT Mode Startup Source Code Analysis]]></title>
        <id>https://seata.apache.org/blog/seata-at-mode-start</id>
        <link href="https://seata.apache.org/blog/seata-at-mode-start"/>
        <updated>2019-11-27T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Seata Source Code Analysis Series]]></summary>
        <author>
            <name>chenghui.zhang</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Designing More Flexible Financial Applications with Seata Saga]]></title>
        <id>https://seata.apache.org/blog/design-more-flexable-application-by-saga</id>
        <link href="https://seata.apache.org/blog/design-more-flexable-application-by-saga"/>
        <updated>2019-11-04T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This article delves into the pain points of developing distributed financial applications, analyzing solutions from both theoretical and practical perspectives. It explains how to design more flexible financial applications using Seata Saga.]]></summary>
        <content type="html"><![CDATA[<p>Seata, short for Simple Extensible Autonomous Transaction Architecture, is an all-in-one distributed transaction solution. It provides AT, TCC, Saga, and XA transaction modes. This article provides a detailed explanation of the Saga mode within Seata, with the project hosted on <a href="https://github.com/apache/incubator-seata" target="_blank" rel="noopener noreferrer">GitHub</a>.</p><p>Author: Yiyuan (Chen Long), Core Developer of Distributed Transactions at Ant Financial, Seata Committer.</p><a name="uTwja"></a><h1>Pain Points in Financial Distributed Application Development</h1><p>Distributed systems face a prominent challenge where a business process requires a composition of various services. This challenge becomes even more pronounced in a microservices architecture, as it necessitates consistency guarantees at the business level. In other words, if a step fails, it either needs to roll back to the previous service invocation or continuously retry to ensure the success of all steps. - From "Left Ear Wind - Resilient Design: Compensation Transaction"</p><p>In the domain of financial microservices architecture, business processes are often more complex. Processes are lengthy, such as a typical internet microloan business process involving calls to more than ten services. When combined with exception handling processes, the complexity increases further. Developers with experience in financial business development can relate to these challenges.</p><p>During the development of financial distributed applications, we encounter several pain points:</p><ul><li><p><strong>Difficulty Ensuring Business Consistency</strong><br></p><p>  In many of the systems we encounter (e.g., in channel layers, product layers, and integration layers), ensuring eventual business consistency often involves adopting a "compensation" approach. Without a coordinator to support this, the development difficulty is significant. Each step requires handling "rollback" operations in catch blocks, resulting in a code structure resembling an "arrow," with poor readability and maintainability. Alternatively, retrying exceptional operations, if unsuccessful, might lead to asynchronous retries or even manual intervention. These challenges impose a significant burden on developers, reducing development efficiency and increasing the likelihood of errors.</p></li><li><p><strong>Difficulty Managing Business State</strong><br></p><p>  With numerous business entities and their corresponding states, developers often update the entity's state in the database after completing a business activity. Lack of a state machine to manage the entire state transition process results in a lack of intuitiveness, increases the likelihood of errors, and causes the business to enter an incorrect state.</p></li><li><p><strong>Difficulty Ensuring Idempotence</strong><br></p><p>  Idempotence of services is a fundamental requirement in a distributed environment. Ensuring the idempotence of services often requires developers to design each service individually, using unique keys in databases or distributed caches. There is no unified solution, creating a significant burden on developers and increasing the chances of oversight, leading to financial losses.</p></li><li><p><strong>Challenges in Business Monitoring and Operations; Lack of Unified Error Guardian Capability</strong><br></p><p>  Monitoring the execution of business operations is usually done by logging, and monitoring platforms are based on log analysis. While this is generally sufficient, in the case of business errors, these monitors lack immediate access to the business context and require additional database queries. Additionally, the reliance on developers for log printing makes it prone to omissions. For compensatory transactions, there is often a need for "error guardian triggering compensation" and "worker-triggered compensation" operations. The lack of a unified error guardian and processing standard requires developers to implement these individually, resulting in a heavy development burden.</p></li></ul><a name="hvEU6"></a><h1>Theoretical Foundation</h1><p>In certain scenarios where strong consistency is required for data, we may adopt distributed transaction schemes like "Two-Phase Commit" at the business layer. However, in other scenarios, where such strong consistency is not necessary, ensuring eventual consistency is sufficient.</p><p>For example, Ant Financial currently employs the TCC (Try, Confirm, Cancel) pattern in its financial core systems. The characteristics of financial core systems include high consistency requirements (business isolation), short processes, and high concurrency.</p><p>On the other hand, in many business systems above the financial core (e.g., systems in the channel layer, product layer, and integration layer), the emphasis is on achieving eventual consistency. These systems typically have complex processes, long flows, and may need to call services from other companies (such as financial networks). Developing Try, Confirm, Cancel methods for each service in these scenarios incurs high costs. Additionally, when there are services from other companies in the transaction, it is impractical to require those services to follow the TCC development model. Long processes can negatively impact performance if transaction boundaries are too extensive.</p><p>When it comes to transactions, we are familiar with ACID, and we are also acquainted with the CAP theorem, which states that at most two out of three—Consistency (C), Availability (A), and Partition Tolerance (P)—can be achieved simultaneously. To enhance performance, a variant of ACID known as BASE emerged. While ACID emphasizes consistency (C in CAP), BASE emphasizes availability (A in CAP). Achieving strong consistency (ACID) is often challenging, especially when dealing with multiple systems that are not provided by a single company. BASE systems are designed to create more resilient systems. In many situations, particularly when dealing with multiple systems and providers, BASE systems acknowledge the risk of data inconsistency in the short term. This allows new transactions to occur, with potentially problematic transactions addressed later through compensatory means to ensure eventual consistency.</p><p>Therefore, in practical development, we make trade-offs. For many business systems above the financial core, compensatory transactions can be adopted. The concept of compensatory transactions has been proposed for about 30 years, with the Saga theory emerging as a solution for long transactions. With the recent rise of microservices, Saga has gradually gained attention in recent years. Currently, the industry generally recognizes Saga as a solution for handling long transactions.</p><blockquote><p><a href="https://github.com/aphyr/dist-sagas/blob/master/sagas.pdf" target="_blank" rel="noopener noreferrer">https://github.com/aphyr/dist-sagas/blob/master/sagas.pdf</a>[1][http://microservices.io/patterns/data/saga.html]<!-- -->(<a href="http://microservices.io/patterns/data/saga.html)%5B2%5D" target="_blank" rel="noopener noreferrer">http://microservices.io/patterns/data/saga.html)[2]</a></p></blockquote><a name="k8kbY"></a><h1>Community and Industry Solutions</h1><a name="Oc5Er"></a>## Apache Camel Saga<p>Camel is an open-source product that implements Enterprise Integration Patterns (EIP). It is based on an event-driven architecture and offers good performance and throughput. In version 2.21, Camel introduced the Saga EIP.</p><p>The Saga EIP provides a way to define a series of related actions through Camel routes. These actions either all succeed or all roll back. Saga can coordinate distributed services or local services using any communication protocol, achieving global eventual consistency. Saga does not require the entire process to be completed in a short time because it does not occupy any database locks. It can support requests that require long processing times, ranging from seconds to days. Camel's Saga EIP is based on <a href="https://github.com/eclipse/microprofile-sandbox/tree/master/proposals/0009-LRA" target="_blank" rel="noopener noreferrer">MicroProfile's LRA</a>[3]<!-- --> (Long Running Action). It also supports the coordination of distributed services implemented in any language using any communication protocol.</p><p>The implementation of Saga does not lock data. Instead, it defines "compensating operations" for each operation. When an error occurs during the normal process execution, the "compensating operations" for the operations that have already been executed are triggered to roll back the process. "Compensating operations" can be defined on Camel routes using Java or XML DSL (Definition Specific Language).</p><p>Here is an example of Java DSL:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Java DSL example goes here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">```java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// action</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from("direct:reserveCredit")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .bean(idService, "generateCustomId") // generate a custom Id and set it in the body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .to("direct:creditReservation")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// delegate action</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from("direct:creditReservation")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .saga()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .propagation(SagaPropagation.SUPPORTS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .option("CreditId", body()) // mark the current body as needed in the compensating action</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .compensation("direct:creditRefund")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .bean(creditService, "reserveCredit")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .log("Credit ${header.amount} reserved. Custom Id used is ${body}");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// called only if the saga is cancelled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from("direct:creditRefund")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .transform(header("CreditId")) // retrieve the CreditId option from headers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .bean(creditService, "refundCredit")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .log("Credit for Custom Id ${body} refunded");</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>XML DSL sample:</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">route</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">from</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">uri</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">direct:start</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">saga</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">compensation</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">uri</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">direct:compensation</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">completion</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">uri</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">direct:completion</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">option</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">optionName</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">myOptionKey</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">constant</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">myOptionValue</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">constant</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">option</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">option</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">optionName</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">myOptionKey2</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">constant</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">myOptionValue2</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">constant</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">option</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">saga</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">to</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">uri</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">direct:action1</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">to</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">uri</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">direct:action2</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">route</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="pQWuF"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="eventuate-tram-saga">Eventuate Tram Saga<a href="#eventuate-tram-saga" class="hash-link" aria-label="Direct link to Eventuate Tram Saga" title="Direct link to Eventuate Tram Saga">​</a></h2><p><a href="https://github.com/eventuate-tram/eventuate-tram-sagas" target="_blank" rel="noopener noreferrer">Eventuate Tram Saga</a>[4]<!-- -->&nbsp;The framework is a Saga framework for Java microservices using JDBC/JPA. Similar to Camel Saga, it also adopts Java DSL to define compensating operations:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class CreateOrderSaga implements SimpleSaga&lt;CreateOrderSagaData&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private SagaDefinition&lt;CreateOrderSagaData&gt; sagaDefinition =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          step()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .withCompensation(this::reject)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .step()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .invokeParticipant(this::reserveCredit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .step()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .invokeParticipant(this::approve)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public SagaDefinition&lt;CreateOrderSagaData&gt; getSagaDefinition() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return this.sagaDefinition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private CommandWithDestination reserveCredit(CreateOrderSagaData data) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    long orderId = data.getOrderId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Long customerId = data.getOrderDetails().getCustomerId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Money orderTotal = data.getOrderDetails().getOrderTotal();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return send(new ReserveCreditCommand(customerId, orderId, orderTotal))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .to("customerService")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="scN9h"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="apache-servicecomb-saga">Apache ServiceComb Saga<a href="#apache-servicecomb-saga" class="hash-link" aria-label="Direct link to Apache ServiceComb Saga" title="Direct link to Apache ServiceComb Saga">​</a></h2><p><a href="https://github.com/apache/incubator-servicecomb-saga" target="_blank" rel="noopener noreferrer">ServiceComb Saga</a>[5]<!-- --> is also a solution for achieving data eventual consistency in microservices applications. In contrast to <a href="http://design.inf.usi.ch/sites/default/files/biblio/rest-tcc.pdf" target="_blank" rel="noopener noreferrer">TCC</a>, Saga directly commits transactions in the try phase, and the subsequent rollback phase is completed through compensating operations in reverse. What sets it apart is the use of Java annotations and interceptors to define "compensating" services.<br></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="architecture">Architecture:<a href="#architecture" class="hash-link" aria-label="Direct link to Architecture:" title="Direct link to Architecture:">​</a></h4><p>Saga consists of <strong>alpha</strong> and <strong>omega</strong>, where:</p><ul><li>Alpha acts as the coordinator, primarily responsible for managing and coordinating transactions;<br></li><li>Omega is an embedded agent in microservices, responsible for intercepting network requests and reporting transaction events to alpha;<br></li></ul><p>The diagram below illustrates the relationship between alpha, omega, and microservices:<br></p><p><img loading="lazy" alt="ServiceComb Saga" src="/assets/images/service-comb-saga-cb30d341b536a9227801771bc0836ee2.png" width="746" height="261" class="img_ev3q"></p><a name="ggflbq"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="sample">sample：<a href="#sample" class="hash-link" aria-label="Direct link to sample：" title="Direct link to sample：">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class ServiceA extends AbsService implements IServiceA {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static final Logger LOG = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private IServiceB serviceB;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private IServiceC serviceC;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public String getServiceName() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return "servicea";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public String getTableName() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return "testa";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @SagaStart</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Compensable(compensationMethod = "cancelRun")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Transactional(rollbackFor = Exception.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public Object run(InvokeContext invokeContext) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG.info("A.run called");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    doRunBusi();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (invokeContext.isInvokeB(getServiceName())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serviceB.run(invokeContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (invokeContext.isInvokeC(getServiceName())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serviceC.run(invokeContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (invokeContext.isException(getServiceName())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      LOG.info("A.run exception");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      throw new Exception("A.run exception");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void cancelRun(InvokeContext invokeContext) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG.info("A.cancel called");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    doCancelBusi();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="CnD8r"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ant-financials-practice">Ant Financial's Practice<a href="#ant-financials-practice" class="hash-link" aria-label="Direct link to Ant Financial's Practice" title="Direct link to Ant Financial's Practice">​</a></h2><p>Ant Financial extensively uses the TCC mode for distributed transactions, mainly in scenarios where high consistency and performance are required, such as in financial core systems. In upper-level business systems with complex and lengthy processes, developing TCC can be costly. In such cases, most businesses opt for the Saga mode to achieve eventual business consistency. Due to historical reasons, different business units have their own set of "compensating" transaction solutions, basically falling into two categories:</p><ol><li><p>When a service needs to "retry" or "compensate" in case of failure, a record is inserted into the database with the status before executing the service. When an exception occurs, a scheduled task queries the database record and performs "retry" or "compensation." If the business process is successful, the record is deleted.</p></li><li><p>Designing a state machine engine and a simple DSL to orchestrate business processes and record business states. The state machine engine can define "compensating services." In case of an exception, the state machine engine invokes "compensating services" in reverse. There is also an "error guardian" platform that monitors failed or uncompensated business transactions and continuously performs "compensation" or "retry."</p></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="solution-comparison">Solution Comparison<a href="#solution-comparison" class="hash-link" aria-label="Direct link to Solution Comparison" title="Direct link to Solution Comparison">​</a></h2><p>Generally, there are two common solutions in the community and industry: one is based on a state machine or a process engine that orchestrates processes and defines compensation through DSL; the other is based on Java annotations and interceptors to implement compensation. What are the advantages and disadvantages of these two approaches?</p><table><thead><tr><th>Approach</th><th>Pros</th><th>Cons</th></tr></thead><tbody><tr><td>State Machine + DSL</td><td><br>- Business processes can be defined using visual tools, standardized, readable, and can achieve service orchestration functionality<br>- Improves communication efficiency between business analysts and developers<br>- Business state management: Processes are essentially state machines, reflecting the flow of business states<br>- Enhances flexibility in exception handling: Can implement "forward retry" or "backward compensation" after recovery from a crash<br>- Naturally supports asynchronous processing engines such as Actor model or SEDA architecture, improving overall throughput<br></td><td><br>- Business processes are composed of JAVA programs and DSL configurations, making development relatively cumbersome<br>- High intrusiveness into existing business if it is a transformation<br>- High implementation cost of the engine<br></td></tr><tr><td>Interceptor + Java Annotation</td><td><br>- Programs and annotations are integrated, simple development, low learning curve<br>- Easy integration into existing businesses<br>- Low framework implementation cost</td><td><br>- The framework cannot provide asynchronous processing modes such as the Actor model or SEDA architecture to improve system throughput<br>- The framework cannot provide business state management<br>- Difficult to achieve "forward retry" after crash recovery due to the inability to restore thread context<br></td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="seata-saga-approach">Seata Saga Approach<a href="#seata-saga-approach" class="hash-link" aria-label="Direct link to Seata Saga Approach" title="Direct link to Seata Saga Approach">​</a></h2><p>The introduction of Seata Saga can be found in <a href="http://seata.io/zh-cn/docs/user/saga.html" target="_blank" rel="noopener noreferrer">Seata Saga Official Documentation</a>[6]<!-- -->.</p><p>Seata Saga adopts the state machine + DSL approach for the following reasons:</p><ul><li>The state machine + DSL approach is more widely used in practical production scenarios.</li><li>Can use asynchronous processing engines such as the Actor model or SEDA architecture to improve overall throughput.</li><li>Typically, business systems above the core system have "service orchestration" requirements, and service orchestration has transactional eventual consistency requirements. These two are challenging to separate. The state machine + DSL approach can simultaneously meet these two requirements.</li><li>Because Saga mode theoretically does not guarantee isolation, in extreme cases, it may not complete the rollback operation due to dirty writing. For example, in a distributed transaction, if you recharge user A first and then deduct the balance from user B, if A user consumes the balance before the transaction is committed, and the transaction is rolled back, there is no way to compensate. Some business scenarios may allow the business to eventually succeed, and in cases where rollback is impossible, it can continue to retry the subsequent process. The state machine + DSL approach can achieve the ability to "forward" recover context and continue execution, making the business eventually successful and achieving eventual consistency.</li></ul><blockquote><p>In cases where isolation is not guaranteed: When designing business processes, follow the principle of "prefer long款, not short款." Long款 means fewer funds for customers and more funds for institutions. Institutions can refund customers based on their credibility. Conversely, short款 means less funding for institutions, and the funds may not be recovered. Therefore, in business process design, deduction should be done first.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="state-definition-language-seata-state-language">State Definition Language (Seata State Language)<a href="#state-definition-language-seata-state-language" class="hash-link" aria-label="Direct link to State Definition Language (Seata State Language)" title="Direct link to State Definition Language (Seata State Language)">​</a></h3><ol><li><p>Define the service call process through a state diagram and generate a JSON state language definition file.</p></li><li><p>In the state diagram, a node can be a service call, and the node can configure its compensating node.</p></li><li><p>The JSON state diagram is driven by the state machine engine. When an exception occurs, the state engine executes the compensating node corresponding to the successfully executed node to roll back the transaction.</p><blockquote><p>Note: Whether to compensate when an exception occurs can also be user-defined.</p></blockquote></li><li><p>It can meet service orchestration requirements, supporting one-way selection, concurrency, asynchronous, sub-state machine, parameter conversion, parameter mapping, service execution status judgment, exception capture, and other functions.</p></li></ol><p>Assuming a business process calls two services, deducting inventory (InventoryService) and deducting balance (BalanceService), to ensure that in a distributed scenario, either both succeed or both roll back. Both participant services have a <code>reduce</code> method for inventory deduction or balance deduction, and a <code>compensateReduce</code> method for compensating deduction operations. Let's take a look at the interface definition of InventoryService:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface InventoryService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * reduce</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param businessKey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param amount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param params</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean reduce(String businessKey, BigDecimal amount, Map&lt;String, Object&gt; params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * compensateReduce</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param businessKey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param params</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean compensateReduce(String businessKey, Map&lt;String, Object&gt; params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="this-is-the-state-diagram-corresponding-to-the-business-process">This is the state diagram corresponding to the business process:<a href="#this-is-the-state-diagram-corresponding-to-the-business-process" class="hash-link" aria-label="Direct link to This is the state diagram corresponding to the business process:" title="Direct link to This is the state diagram corresponding to the business process:">​</a></h2><p><img loading="lazy" alt="Example State Diagram" src="/assets/images/demo_statelang-90f1fc01bfaf3a795c3b3357e1046f16.png" width="508" height="543" class="img_ev3q"></p><br>Corresponding JSON<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"Name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"reduceInventoryAndBalance"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"Comment"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"reduce inventory then reduce balance in a transaction"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"StartState"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ReduceInventory"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"Version"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0.0.1"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"States"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"ReduceInventory"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ServiceTask"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"ServiceName"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"inventoryAction"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"ServiceMethod"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"reduce"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"CompensateState"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"CompensateReduceInventory"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Next"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ChoiceState"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Input"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">"$.[businessKey]"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">"$.[count]"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Output"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"reduceInventoryResult"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"$.#root"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Status"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"#root == true"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"SU"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"#root == false"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"FA"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"$Exception{java.lang.Throwable}"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"UN"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"ChoiceState"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Choice"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Choices"</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"Expression"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"[reduceInventoryResult] == true"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"Next"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"ReduceBalance"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Default"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"Fail"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"ReduceBalance"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ServiceTask"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"ServiceName"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"balanceAction"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"ServiceMethod"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"reduce"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"CompensateState"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"CompensateReduceBalance"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Input"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">"$.[businessKey]"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">"$.[amount]"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"throwException"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"$.[mockReduceBalanceFail]"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Output"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"compensateReduceBalanceResult"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"$.#root"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Status"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"#root == true"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"SU"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"#root == false"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"FA"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"$Exception{java.lang.Throwable}"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"UN"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Catch"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"Exceptions"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token string" style="color:#e3116c">"java.lang.Throwable"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"Next"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"CompensationTrigger"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Next"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Succeed"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"CompensateReduceInventory"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ServiceTask"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"ServiceName"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"inventoryAction"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"ServiceMethod"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"compensateReduce"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Input"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">"$.[businessKey]"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"CompensateReduceBalance"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ServiceTask"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"ServiceName"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"balanceAction"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"ServiceMethod"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"compensateReduce"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Input"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">"$.[businessKey]"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"CompensationTrigger"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Type"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"CompensationTrigger"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Next"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Fail"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"Succeed"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Type"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"Succeed"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"Fail"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Type"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"Fail"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"ErrorCode"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"PURCHASE_FAILED"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Message"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"purchase failed"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="this-is-the-state-language-to-some-extent-referring-to-aws-step-functions7">This is the state language to some extent referring to <a href="https://docs.aws.amazon.com/zh_cn/step-functions/latest/dg/tutorial-creating-lambda-state-machine.html" target="_blank" rel="noopener noreferrer">AWS Step Functions</a>[7]<!-- -->.<a href="#this-is-the-state-language-to-some-extent-referring-to-aws-step-functions7" class="hash-link" aria-label="Direct link to this-is-the-state-language-to-some-extent-referring-to-aws-step-functions7" title="Direct link to this-is-the-state-language-to-some-extent-referring-to-aws-step-functions7">​</a></h2><a name="2de9b28a"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="introduction-to-state-machine-attributes">Introduction to "State Machine" Attributes:<a href="#introduction-to-state-machine-attributes" class="hash-link" aria-label="Direct link to Introduction to &quot;State Machine&quot; Attributes:" title="Direct link to Introduction to &quot;State Machine&quot; Attributes:">​</a></h4><ul><li>Name: Represents the name of the state machine, must be unique;</li><li>Comment: Description of the state machine;</li><li>Version: Version of the state machine definition;</li><li>StartState: The first "state" to run when starting;</li><li>States: List of states, a map structure, where the key is the name of the "state," which must be unique within the state machine;</li></ul><a name="2b956670"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="introduction-to-state-attributes">Introduction to "State" Attributes:<a href="#introduction-to-state-attributes" class="hash-link" aria-label="Direct link to Introduction to &quot;State&quot; Attributes:" title="Direct link to Introduction to &quot;State&quot; Attributes:">​</a></h4><ul><li>Type: The type of the "state," such as:<ul><li>ServiceTask: Executes the service task;</li><li>Choice: Single conditional choice route;</li><li>CompensationTrigger: Triggers the compensation process;</li><li>Succeed: Normal end of the state machine;</li><li>Fail: Exceptional end of the state machine;</li><li>SubStateMachine: Calls a sub-state machine;</li></ul></li><li>ServiceName: Service name, usually the beanId of the service;</li><li>ServiceMethod: Service method name;</li><li>CompensateState: Compensatory "state" for this state;</li><li>Input: List of input parameters for the service call, an array corresponding to the parameter list of the service method, $. represents using an expression to retrieve parameters from the state machine context. The expression uses <a href="https://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/html/expressions.html" target="_blank" rel="noopener noreferrer">SpringEL</a>[8]<!-- -->, and if it is a constant, write the value directly;</li><li>Output: Assigns the parameters returned by the service to the state machine context, a map structure, where the key is the key when placing it in the state machine context (the state machine context is also a map), and the value uses $. as a SpringEL expression, indicating the value is taken from the return parameters of the service, #root represents the entire return parameters of the service;</li><li>Status: Mapping of the service execution status, the framework defines three statuses, SU success, FA failure, UN unknown. We need to map the execution status of the service into these three statuses, helping the framework judge the overall consistency of the transaction. It is a map structure, where the key is a condition expression, usually based on the return value of the service or the exception thrown for judgment. The default is a SpringEL expression to judge the return parameters of the service. Those starting with $Exception{ indicate judging the exception type, and the value is mapped to this value when this condition expression is true;</li><li>Catch: Route after catching an exception;</li><li>Next: The next "state" to execute after the service is completed;</li><li>Choices: List of optional branches in the Choice type "state," where Expression is a SpringEL expression, and Next is the next "state" to execute when the expression is true;</li><li>ErrorCode: Error code for the Fail type "state";</li><li>Message: Error message for the Fail type "state";</li></ul><p>For more detailed explanations of the state language, please refer to <a href="http://seata.io/zh-cn/docs/user/saga.html" target="_blank" rel="noopener noreferrer">Seata Saga Official Documentation</a>[6<a href="http://seata.io/zh-cn/docs/user/saga.html" target="_blank" rel="noopener noreferrer">http://seata.io/zh-cn/docs/user/saga.html</a>].</p><a name="209f0e37"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="state-machine-engine-principle">State Machine Engine Principle:<a href="#state-machine-engine-principle" class="hash-link" aria-label="Direct link to State Machine Engine Principle:" title="Direct link to State Machine Engine Principle:">​</a></h3><p><img loading="lazy" alt="State Machine Engine Principle" src="/assets/images/saga_engine_mechanism-38f1563ee8316a5dcabeeba27f511f79.png" width="936" height="672" class="img_ev3q"></p><ul><li>The state diagram in the image first executes stateA, then executes stateB, and then executes stateC;</li><li>The execution of "states" is based on an event-driven model. After stateA is executed, a routing message is generated and placed in the EventQueue. The event consumer takes the message from the EventQueue and executes stateB;</li><li>When the entire state machine is started, Seata Server is called to start a distributed transaction, and the xid is generated. Then, the start event of the "state machine instance" is recorded in the local database;</li><li>When a "state" is executed, Seata Server is called to register a branch transaction, and the branchId is generated. Then, the start event of the "state instance" is recorded in the local database;</li><li>After a "state" is executed, the end event of the "state instance" is recorded in the local database, and Seata Server is called to report the status of the branch transaction;</li><li>When the entire state machine is executed, the completion event of the "state machine instance" is recorded in the local database, and Seata Server is called to commit or roll back the distributed transaction;</li></ul><a name="808e95dc"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="design-of-state-machine-engine">Design of State Machine Engine:<a href="#design-of-state-machine-engine" class="hash-link" aria-label="Direct link to Design of State Machine Engine:" title="Direct link to Design of State Machine Engine:">​</a></h3><p><img loading="lazy" alt="Design of State Machine Engine" src="/assets/images/saga_engine-41e75396b108b8e6c157d08766368124.png" width="1044" height="702" class="img_ev3q"></p><p>The design of the state machine engine is mainly divided into three layers, with the upper layer depending on the lower layer. From bottom to top, they are:</p><ul><li><p>Eventing Layer:</p><ul><li>Implements an event-driven architecture that can push events and be consumed by a consumer. This layer does not care about what the event is or what the consumer executes; it is implemented by the upper layer.</li></ul></li><li><p>ProcessController Layer:</p><ul><li>Driven by the above Eventing to execute a "empty" process. The behavior and routing of "states" are not implemented. It is implemented by the upper layer.<blockquote><p>Based on the above two layers, theoretically, any "process" engine can be customly extended. The design of these two layers is based on the internal design of the financial network platform.</p></blockquote></li></ul></li></ul><ul><li>StateMachineEngine Layer:<ul><li>Implements the behavior and routing logic of each type of state in the state machine engine;</li><li>Provides API and state machine language repository;</li></ul></li></ul><a name="73a9fddd"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="practical-experience-in-service-design-under-saga-mode">Practical Experience in Service Design under Saga Mode<a href="#practical-experience-in-service-design-under-saga-mode" class="hash-link" aria-label="Direct link to Practical Experience in Service Design under Saga Mode" title="Direct link to Practical Experience in Service Design under Saga Mode">​</a></h3><p>Below are some practical experiences summarized in the design of microservices under Saga mode. Of course, these are recommended practices, not necessarily to be followed 100%. There are "workaround" solutions even if not followed.</p><blockquote><p>Good news: Seata Saga mode has no specific requirements for the interface parameters of microservices, making Saga mode suitable for integrating legacy systems or services from external institutions.</p></blockquote><a name="d64c5051"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="allow-empty-compensation">Allow Empty Compensation<a href="#allow-empty-compensation" class="hash-link" aria-label="Direct link to Allow Empty Compensation" title="Direct link to Allow Empty Compensation">​</a></h4><ul><li>Empty Compensation: The original service was not executed, but the compensation service was executed;</li><li>Reasons:<ul><li>Timeout (packet loss) of the original service;</li><li>Saga transaction triggers a rollback;</li><li>The request of the original service is not received, but the compensation request is received first;</li></ul></li></ul><p>Therefore, when designing services, it is necessary to allow empty compensation, that is, if the business primary key to be compensated is not found, return compensation success and record the original business primary key.</p><a name="88a92b17"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="hang-prevention-control">Hang Prevention Control<a href="#hang-prevention-control" class="hash-link" aria-label="Direct link to Hang Prevention Control" title="Direct link to Hang Prevention Control">​</a></h4><ul><li>Hang: Compensation service is executed before the original service;</li><li>Reasons:<ul><li>Timeout (congestion) of the original service;</li><li>Saga transaction rollback triggers a rollback;</li><li>Congested original service arrives;</li></ul></li></ul><p>Therefore, check whether the current business primary key already exists in the business primary keys recorded by empty compensation. If it exists, reject the execution of the service.</p><a name="ce766631"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="idempotent-control">Idempotent Control<a href="#idempotent-control" class="hash-link" aria-label="Direct link to Idempotent Control" title="Direct link to Idempotent Control">​</a></h4><ul><li>Both the original service and the compensation service need to ensure idempotence. Due to possible network timeouts, a retry strategy can be set. When a retry occurs, idempotent control should be used to avoid duplicate updates to business data.</li></ul><a name="FO5YS"></a><h1>Summary</h1><p>Many times, we don't need to emphasize strong consistency. We design more resilient systems based on the BASE and Saga theories to achieve better performance and fault tolerance in distributed architecture. There is no silver bullet in distributed architecture, only solutions suitable for specific scenarios. In fact, Seata Saga is a product with the capabilities of "service orchestration" and "Saga distributed transactions." Summarizing, its applicable scenarios are:</p><ul><li>Suitable for handling "long transactions" in a microservices architecture;</li><li>Suitable for "service orchestration" requirements in a microservices architecture;</li><li>Suitable for business systems with a large number of composite services above the financial core system (such as systems in the channel layer, product layer, integration layer);</li><li>Suitable for scenarios where integration with services provided by legacy systems or external institutions is required (these services are immutable and cannot be required to be modified).</li></ul><a name="3X7vO"></a><h2 class="anchor anchorWithStickyNavbar_LWe7" id="related-links-mentioned-in-the-article">Related Links Mentioned in the Article<a href="#related-links-mentioned-in-the-article" class="hash-link" aria-label="Direct link to Related Links Mentioned in the Article" title="Direct link to Related Links Mentioned in the Article">​</a></h2><p>[1][https://github.com/aphyr/dist-sagas/blob/master/sagas.pdf]<!-- -->(<a href="https://github.com/aphyr/dist-sagas/blob/master/sagas.pdf" target="_blank" rel="noopener noreferrer">https://github.com/aphyr/dist-sagas/blob/master/sagas.pdf</a>)<br>[2][http://microservices.io/patterns/data/saga.html]<!-- -->(<a href="http://microservices.io/patterns/data/saga.html" target="_blank" rel="noopener noreferrer">http://microservices.io/patterns/data/saga.html</a>)<br>[3][Microprofile 的 LRA]<!-- -->(<a href="https://github.com/eclipse/microprofile-sandbox/tree/master/proposals/0009-LRA)%EF%BC%9A%5Bhttps://github.com/eclipse/microprofile-sandbox/tree/master/proposals/0009-LRA%5D(https://github.com/eclipse/microprofile-sandbox/tree/master/proposals/0009-LRA" target="_blank" rel="noopener noreferrer">https://github.com/eclipse/microprofile-sandbox/tree/master/proposals/0009-LRA)：[https://github.com/eclipse/microprofile-sandbox/tree/master/proposals/0009-LRA](https://github.com/eclipse/microprofile-sandbox/tree/master/proposals/0009-LRA</a>)<br>[4][Eventuate Tram Saga]<!-- -->(<a href="https://github.com/eventuate-tram/eventuate-tram-sagas)%EF%BC%9A%5Bhttps://github.com/eventuate-tram/eventuate-tram-sagas%5D(https://github.com/eventuate-tram/eventuate-tram-sagas" target="_blank" rel="noopener noreferrer">https://github.com/eventuate-tram/eventuate-tram-sagas)：[https://github.com/eventuate-tram/eventuate-tram-sagas](https://github.com/eventuate-tram/eventuate-tram-sagas</a>)<br>[5][ServiceComb Saga]<!-- -->(<a href="https://github.com/apache/incubator-servicecomb-saga)%EF%BC%9A%5Bhttps://github.com/apache/servicecomb-pack%5D(https://github.com/apache/servicecomb-pack" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-servicecomb-saga)：[https://github.com/apache/servicecomb-pack](https://github.com/apache/servicecomb-pack</a>)<br>[6][Seata Saga 官网文档]<!-- -->(<a href="http://seata.io/zh-cn/docs/user/saga.html)%EF%BC%9A%5Bhttp://seata.io/zh-cn/docs/user/saga.html%5D(http://seata.io/zh-cn/docs/user/saga.html" target="_blank" rel="noopener noreferrer">http://seata.io/zh-cn/docs/user/saga.html)：[http://seata.io/zh-cn/docs/user/saga.html](http://seata.io/zh-cn/docs/user/saga.html</a>)<br>[7][AWS Step Functions]<!-- -->(<a href="https://docs.aws.amazon.com/zh_cn/step-functions/latest/dg/tutorial-creating-lambda-state-machine.html)%EF%BC%9A%5Bhttps://docs.aws.amazon.com/zh_cn/step-functions/latest/dg/tutorial-creating-lambda-state-machine.html%5D(https://docs.aws.amazon.com/zh_cn/step-functions/latest/dg/tutorial-creating-lambda-state-machine.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/zh_cn/step-functions/latest/dg/tutorial-creating-lambda-state-machine.html)：[https://docs.aws.amazon.com/zh_cn/step-functions/latest/dg/tutorial-creating-lambda-state-machine.html](https://docs.aws.amazon.com/zh_cn/step-functions/latest/dg/tutorial-creating-lambda-state-machine.html</a>)<br>[8][SpringEL]<!-- -->(<a href="https://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/html/expressions.html)%EF%BC%9A%5Bhttps://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/html/expressions.html%5D(https://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/html/expressions.html" target="_blank" rel="noopener noreferrer">https://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/html/expressions.html)：[https://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/html/expressions.html](https://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/html/expressions.html</a>)<br></p>]]></content>
        <author>
            <name>long187</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Comprehensive Explanation of Distributed Transaction Seata and Its Three Modes]]></title>
        <id>https://seata.apache.org/blog/seata-at-tcc-saga</id>
        <link href="https://seata.apache.org/blog/seata-at-tcc-saga"/>
        <updated>2019-08-11T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This article focuses on sharing the background and theoretical foundation of distributed transactions, as well as the principles of Seata distributed transactions and the implementation of three modes (AT, TCC, Saga) of distributed transactions.]]></summary>
        <author>
            <name>long187</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Design Principles of Distributed Transaction Middleware Seata]]></title>
        <id>https://seata.apache.org/blog/seata-at-mode-design</id>
        <link href="https://seata.apache.org/blog/seata-at-mode-design"/>
        <updated>2019-07-11T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Design principles of AT mode]]></summary>
        <author>
            <name>chenghui.zhang</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Seata Distributed Go Server Officially Open Source - Introduction to TaaS Design]]></title>
        <id>https://seata.apache.org/blog/seata-analysis-go-server</id>
        <link href="https://seata.apache.org/blog/seata-analysis-go-server"/>
        <updated>2019-04-23T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Preface]]></summary>
        <content type="html"><![CDATA[<h3 class="anchor anchorWithStickyNavbar_LWe7" id="preface">Preface<a href="#preface" class="hash-link" aria-label="Direct link to Preface" title="Direct link to Preface">​</a></h3><p>TaaS is a high-availability implementation of the Seata server (TC, Transaction Coordinator), written in <code>Golang</code>. Taas has been contributed to the Seata open-source community by InfiniVision (<a href="http://infinivision.cn" target="_blank" rel="noopener noreferrer">http://infinivision.cn</a>) and is now officially open source.</p><p>Before Seata was open-sourced, we began to reference GTS and some open-source projects to implement the distributed transaction solution TaaS (Transaction as a Service).</p><p>After we completed the development of the TaaS server, Seata (then called Fescar) was open-sourced and attracted widespread attention from the open-source community. With Alibaba's platform influence and community activity, we believe that Seata will become the standard for open-source distributed transactions in the future. Therefore, we decided to make TaaS compatible with Seata.</p><p>Upon discovering that Seata's server implementation was single-node and lacked high availability, we contacted the Seata community leaders and decided to open-source TaaS to contribute to the open-source community. We will also maintain it in the long term and keep it synchronized with Seata versions.</p><p>Currently, the official Java high-availability version of Seata is also under development. TaaS and this high-availability version have different design philosophies and will coexist in the future.</p><p>TaaS has been open-sourced on GitHub (<a href="https://github.com/apache/incubator-seata-go-server" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata-go-server</a>). We welcome everyone to try it out.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="design-principles">Design Principles<a href="#design-principles" class="hash-link" aria-label="Direct link to Design Principles" title="Direct link to Design Principles">​</a></h3><ol><li>High Performance: Performance scales linearly with the number of machines. Adding new machines to the cluster can improve performance.</li><li>High Availability: If a machine fails, the system can still provide services externally, or the service can be restored externally in a short time (the time it takes to switch leaders).</li><li>Auto-Rebalance: When new machines are added to the cluster or machines are offline, the system can automatically perform load balancing.</li><li>Strong Consistency: The system's metadata is stored consistently in multiple replicas.</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="design">Design<a href="#design" class="hash-link" aria-label="Direct link to Design" title="Direct link to Design">​</a></h3><p><img loading="lazy" alt="TaaS Design" src="/assets/images/taas-7be6d3d8b28495c0c4e06791b334836a.png" width="828" height="1003" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="high-performance">High Performance<a href="#high-performance" class="hash-link" aria-label="Direct link to High Performance" title="Direct link to High Performance">​</a></h4><p>TaaS's performance scales linearly with the number of machines. To support this feature, TaaS handles the smallest unit of global transactions called a <code>Fragment</code>. The system sets the maximum concurrency of active global transactions supported by each Fragment upon startup. The system also samples each Fragment, and when it becomes overloaded, it generates new Fragments to handle more concurrency.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="high-availability">High Availability<a href="#high-availability" class="hash-link" aria-label="Direct link to High Availability" title="Direct link to High Availability">​</a></h4><p>Each <code>Fragment</code> has multiple replicas and one leader to handle requests. When the leader fails, the system generates a new leader to handle requests. During the election process of the new leader, the Fragment does not provide services externally, typically for a few seconds.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="strong-consistency">Strong Consistency<a href="#strong-consistency" class="hash-link" aria-label="Direct link to Strong Consistency" title="Direct link to Strong Consistency">​</a></h4><p>TaaS itself does not store the metadata of global transactions. The metadata is stored in Elasticell (<a href="https://github.com/deepfabric/elasticell" target="_blank" rel="noopener noreferrer">https://github.com/deepfabric/elasticell</a>), a distributed KV storage compatible with the Redis protocol. Elasticell ensures data consistency based on the Raft protocol.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="auto-rebalance">Auto-Rebalance<a href="#auto-rebalance" class="hash-link" aria-label="Direct link to Auto-Rebalance" title="Direct link to Auto-Rebalance">​</a></h4><p>As the system runs, there will be many <code>Fragments</code> and their replicas, resulting in uneven distribution of Fragments on each machine, especially when old machines are offline or new machines come online. When TaaS starts, it selects three nodes as schedulers, responsible for scheduling these <code>Fragments</code> to ensure that the number of Fragments and the number of leaders on each machine are roughly equal. It also ensures that the number of replicas for each Fragment remains at the specified number.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="fragment-replication-creation">Fragment Replication Creation<a href="#fragment-replication-creation" class="hash-link" aria-label="Direct link to Fragment Replication Creation" title="Direct link to Fragment Replication Creation">​</a></h5><p><img loading="lazy" alt="Fragment Replication Creation" src="/assets/images/taas_add-6451cc0e5ab23c96d9d4db5e3c6cb510.png" width="885" height="596" class="img_ev3q"></p><ol><li>At time t0, Fragment1 is created on machine Seata-TC1.</li><li>At time t1, a replica of Fragment1, Fragment1', is created on machine Seata-TC2.</li><li>At time t2, another replica of Fragment1, Fragment1", is created on machine Seata-TC3.</li></ol><p>By time t2, all three replicas of Fragment1 are created.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="fragment-replication-migration">Fragment Replication Migration<a href="#fragment-replication-migration" class="hash-link" aria-label="Direct link to Fragment Replication Migration" title="Direct link to Fragment Replication Migration">​</a></h5><p><img loading="lazy" alt="Fragment Replication Migration" src="/assets/images/taas_move-a147fafaaf5a403fe3b493756aeefdea.png" width="1081" height="1121" class="img_ev3q"></p><ol><li>At time t0, the system has four Fragments, each existing on machines Seata-TC1, Seata-TC2, and Seata-TC3.</li><li>At time t1, a new machine, Seata-TC4, is added.</li><li>At time t2, replicas of three Fragments are migrated to machine Seata-TC4.</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="online-quick-experience">Online Quick Experience<a href="#online-quick-experience" class="hash-link" aria-label="Direct link to Online Quick Experience" title="Direct link to Online Quick Experience">​</a></h3><p>We have set up an experience environment on the public network:</p><ul><li>Seata Server Address: 39.97.115.141:8091</li><li>UI: <a href="http://39.97.115.141:8084/ui/index.html" target="_blank" rel="noopener noreferrer">http://39.97.115.141:8084/ui/index.html</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="local-quick-experience">Local Quick Experience<a href="#local-quick-experience" class="hash-link" aria-label="Direct link to Local Quick Experience" title="Direct link to Local Quick Experience">​</a></h3><p>Quickly experience TaaS functionality using docker-compose.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/seata/taas.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker-compse up -d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Due to the many component dependencies, the docker-compose takes about 30 seconds to start and become available for external services.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="seata-server-address">Seata Server Address<a href="#seata-server-address" class="hash-link" aria-label="Direct link to Seata Server Address" title="Direct link to Seata Server Address">​</a></h4><p>The service listens on the default port 8091. Modify the Seata server address accordingly to experience.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="seata-ui">Seata UI<a href="#seata-ui" class="hash-link" aria-label="Direct link to Seata UI" title="Direct link to Seata UI">​</a></h4><p>Access the WEB UI at <code>http://127.0.0.1:8084/ui/index.html</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="about-infinivision">About InfiniVision<a href="#about-infinivision" class="hash-link" aria-label="Direct link to About InfiniVision" title="Direct link to About InfiniVision">​</a></h3><p>InfiniVision is a technology-driven enterprise service provider dedicated to assisting traditional enterprises in digital transformation and upgrading using technologies such as artificial intelligence, cloud computing, blockchain, big data, and IoT edge computing. InfiniVision actively embraces open source culture and open sources core algorithms and architectures. Notable open-source products include the facial recognition software InsightFace (<a href="https://github.com/deepinsight/insightface" target="_blank" rel="noopener noreferrer">https://github.com/deepinsight/insightface</a>), which has repeatedly won large-scale facial recognition challenges, and the distributed storage engine Elasticell (<a href="https://github.com/deepfabric/elasticell" target="_blank" rel="noopener noreferrer">https://github.com/deepfabric/elasticell</a>).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="about-the-author">About the Author<a href="#about-the-author" class="hash-link" aria-label="Direct link to About the Author" title="Direct link to About the Author">​</a></h3><p>The author, Zhang Xu, is the creator of the open-source Gateway (<a href="https://github.com/fagongzi/gateway" target="_blank" rel="noopener noreferrer">https://github.com/fagongzi/gateway</a>) and currently works at InfiniVision, focusing on infrastructure-related development.</p>]]></content>
        <author>
            <name>fagongzi(zhangxu19830126@gmail.com)</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Fescar Integration with Spring Cloud In-Depth Analysis of Source Code]]></title>
        <id>https://seata.apache.org/blog/how-to-support-spring-cloud</id>
        <link href="https://seata.apache.org/blog/how-to-support-spring-cloud"/>
        <updated>2019-04-15T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Fescar]]></summary>
        <content type="html"><![CDATA[<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fescar">Fescar<a href="#fescar" class="hash-link" aria-label="Direct link to Fescar" title="Direct link to Fescar">​</a></h3><p>Common distributed transaction approaches include XA based on 2PC (e.g., Atomikos), TCC (e.g., ByteTCC) focusing on the business layer, and transactional messaging (e.g., RocketMQ Half Message). XA is a protocol for distributed transactions that requires support from local databases. However, the resource locking at the database level can lead to poor performance. On the other hand, TCC, introduced by Alibaba as a preacher, requires a significant amount of business code to ensure transactional consistency, resulting in higher development and maintenance costs.</p><p>Distributed transactions are a widely discussed topic in the industry, and this is one of the reasons why Fescar has gained 6k stars in a short period of time. The name "Fescar" stands for Fast &amp; Easy Commit And Rollback. In simple terms, Fescar drives global transactions by coordinating local RDBMS branch transactions. It is a middleware that operates at the application layer. The main advantages of Fescar are better performance compared to XA, as it does not occupy connection resources for a long time, and lower development cost and business invasiveness compared to TCC.</p><p>Similar to XA, Fescar divides roles into TC (Transaction Coordinator), RM (Resource Manager), and TM (Transaction Manager). The overall transaction process model of Fescar is as follows:</p><p><img loading="lazy" alt="Fescar事务过程" src="/assets/images/fescar-microservices-88885eb3928c478894342041e066a5ce.png" width="794" height="478" class="img_ev3q"></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1.The TM (Transaction Manager) requests the TC (Transaction Coordinator) to start a global transaction. The global transaction is successfully created, and a globally unique XID (Transaction ID) is generated.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2.The XID is propagated in the context of the microservice invocation chain.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3.The RM (Resource Manager) registers the branch transaction with the TC, bringing it under the jurisdiction of the global transaction corresponding to the XID.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4.The TM initiates a global commit or rollback resolution for the XID with the TC.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5.The TC schedules the completion of commit or rollback requests for all branch transactions under the jurisdiction of the XID.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the current implementation version, the TC (Transaction Coordinator) is deployed as a separate process. It is responsible for maintaining the operation records and global lock records of the global transaction, as well as coordinating and driving the global transaction's commit or rollback. On the other hand, the TM (Transaction Manager) and RM (Resource Manager) work in the same application process as the application.</p><p>The RM manages the underlying database through proxying the JDBC data source. It uses syntax parsing to retain snapshots and generate undo logs during transaction execution. This ensures that the transaction can be rolled back to its previous state if needed.</p><p>This covers the general flow and model division of Fescar. Now, let's proceed with the analysis of Fescar's transaction propagation mechanism.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fescar-transaction-propagation-mechanism">Fescar Transaction Propagation Mechanism<a href="#fescar-transaction-propagation-mechanism" class="hash-link" aria-label="Direct link to Fescar Transaction Propagation Mechanism" title="Direct link to Fescar Transaction Propagation Mechanism">​</a></h3><p>The transaction propagation in Fescar includes both nested transaction calls within an application and transaction propagation across different services. So, how does Fescar propagate transactions in a microservices call chain? Fescar provides a transaction API that allows users to manually bind a transaction's XID and join it to the global transaction. Therefore, depending on the specific service framework mechanism, we can propagate the XID in the call chain to achieve transaction propagation.</p><p>The RPC request process consists of two parts: the caller and the callee. We need to handle the XID during the request and response. The general process is as follows: the caller (or the requester) retrieves the XID from the current transaction context and passes it to the callee through the RPC protocol. The callee extracts the XID from the request and binds it to its own transaction context, thereby participating in the global transaction. Common microservices frameworks usually provide corresponding Filter and Interceptor mechanisms. Now, let's analyze the integration process of Spring Cloud and Fescar in more detail.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="partial-source-code-analysis-of-fescar-integration-with-spring-cloud-alibaba">Partial Source Code Analysis of Fescar Integration with Spring Cloud Alibaba<a href="#partial-source-code-analysis-of-fescar-integration-with-spring-cloud-alibaba" class="hash-link" aria-label="Direct link to Partial Source Code Analysis of Fescar Integration with Spring Cloud Alibaba" title="Direct link to Partial Source Code Analysis of Fescar Integration with Spring Cloud Alibaba">​</a></h3><p>This section of the source code is entirely from spring-cloud-alibaba-fescar. The source code analysis mainly includes three parts: AutoConfiguration, the microservice provider, and the microservice consumer. Regarding the microservice consumer, it can be further divided into two specific approaches: RestTemplate and Feign. For the Feign request approach, it is further categorized into usage patterns that integrate with Hystrix and Sentine.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="fescar-autoconfiguration">Fescar AutoConfiguration<a href="#fescar-autoconfiguration" class="hash-link" aria-label="Direct link to Fescar AutoConfiguration" title="Direct link to Fescar AutoConfiguration">​</a></h4><p>For the AutoConfiguration analysis, this section will only cover the parts related to the startup of Fescar. The analysis of other parts will be interspersed in the 'Microservice Provider' and 'Microservice Consumer' sections.</p><p>The startup of Fescar requires the configuration of GlobalTransactionScanner. The GlobalTransactionScanner is responsible for initializing Fescar's RM client, TM client, and automatically proxying classes annotated with the GlobalTransactional annotation. The startup of the GlobalTransactionScanner bean is loaded and injected through GlobalTransactionAutoConfiguration, which also injects FescarProperties.</p><p>FescarProperties contains important properties of Fescar, such as txServiceGroup. The value of this property can be read from the application.properties file using the key 'spring.cloud.alibaba.fescar.txServiceGroup', with a default value of '${spring.application.name}-fescar-service-group'. txServiceGroup represents the logical transaction group name in Fescar. This group name is obtained from the configuration center (currently supporting file and Apollo) to retrieve the TC cluster name corresponding to the logical transaction group name. The TC cluster's service name is then constructed based on the cluster name. The RM client, TM client, and TC interact through RPC by using the registry center (currently supporting Nacos, Redis, ZooKeeper, and Eureka) and the service name to find available TC service nodes.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="microservice-provider">Microservice Provider<a href="#microservice-provider" class="hash-link" aria-label="Direct link to Microservice Provider" title="Direct link to Microservice Provider">​</a></h4><p>Since the logic of the consumer is a bit more complex, let's first analyze the logic of the provider. For Spring Cloud projects, the default RPC transport protocol is HTTP, so the HandlerInterceptor mechanism is used to intercept HTTP requests.</p><p>HandlerInterceptor is an interface provided by Spring, and it has three methods that can be overridden.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Intercept the execution of a handler. Called after HandlerMapping determined</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * an appropriate handler object, but before HandlerAdapter invokes the handler.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Intercept the execution of a handler. Called after HandlerAdapter actually</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * invoked the handler, but before the DispatcherServlet renders the view.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Can expose additional model objects to the view via the given ModelAndView.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Nullable ModelAndView modelAndView) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Callback after completion of request processing, that is, after rendering</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * the view. Will be called on any outcome of handler execution, thus allows</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * for proper resource cleanup.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Nullable Exception ex) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>According to the comments, we can clearly see the timing and common use cases of each method. For Fescar integration, it overrides the preHandle and afterCompletion methods as needed.</p><p>The purpose of FescarHandlerInterceptor is to bind the XID passed from the service chain to the transaction context of the service node and clean up related resources after the request is completed. FescarHandlerInterceptorConfiguration is responsible for configuring the interception of all URLs. This interceptor will be executed for all incoming requests to perform XID conversion and transaction binding.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author xiaojing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Fescar HandlerInterceptor, Convert Fescar information into</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @see com.alibaba.fescar.core.context.RootContext from http request's header in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * {@link org.springframework.web.servlet.HandlerInterceptor#preHandle(HttpServletRequest , HttpServletResponse , Object )},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * And clean up Fescar information after servlet method invocation in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * {@link org.springframework.web.servlet.HandlerInterceptor#afterCompletion(HttpServletRequest, HttpServletResponse, Object, Exception)}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarHandlerInterceptor implements HandlerInterceptor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger log = LoggerFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .getLogger(FescarHandlerInterceptor.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean preHandle(HttpServletRequest request, HttpServletResponse response,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object handler) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String xid = RootContext.getXID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String rpcXid = request.getHeader(RootContext.KEY_XID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (log.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.debug("xid in RootContext {} xid in RpcContext {}", xid, rpcXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (xid == null &amp;&amp; rpcXid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            RootContext.bind(rpcXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (log.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.debug("bind {} to RootContext", rpcXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void afterCompletion(HttpServletRequest request, HttpServletResponse response,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object handler, Exception e) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String rpcXid = request.getHeader(RootContext.KEY_XID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(rpcXid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String unbindXid = RootContext.unbind();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (log.isDebugEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.debug("unbind {} from RootContext", unbindXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!rpcXid.equalsIgnoreCase(unbindXid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.warn("xid in change during RPC from {} to {}", rpcXid, unbindXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (unbindXid != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RootContext.bind(unbindXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.warn("bind {} back to RootContext", unbindXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The preHandle method is called before the request is executed. The xid parameter represents the unique identifier of the global transaction already bound to the current transaction context, while rpcXid represents the global transaction identifier that needs to be bound to the request and is passed through the HTTP header. In the preHandle method, it checks if there is no XID in the current transaction context and if rpcXid is not empty. If so, it binds rpcXid to the current transaction context.</p><p>The afterCompletion method is called after the request is completed and is used to perform resource cleanup actions. Fescar uses the RootContext.unbind() method to unbind the XID involved in the transaction context. The logic in the if statement is for code robustness. If rpcXid and unbindXid are not equal, it rebinds unbindXid.</p><p>For Spring Cloud, the default RPC method is HTTP. Therefore, for the provider, there is no need to differentiate the request interception method. It only needs to extract the XID from the header and bind it to its own transaction context. However, for the consumer, due to the variety of request components, including circuit breakers and isolation mechanisms, different situations need to be distinguished and handled. We will analyze this in more detail later.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="microservice-consumer">Microservice Consumer<a href="#microservice-consumer" class="hash-link" aria-label="Direct link to Microservice Consumer" title="Direct link to Microservice Consumer">​</a></h4><p>Fescar categorizes the request methods into RestTemplate, Feign, Feign+Hystrix, and Feign+Sentinel. Different components are automatically configured through Spring Boot's Auto Configuration. The specific configuration classes can be found in the spring.factories file, and we will also discuss the relevant configuration classes later in this document.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="resttemplate">RestTemplate<a href="#resttemplate" class="hash-link" aria-label="Direct link to RestTemplate" title="Direct link to RestTemplate">​</a></h5><p>Let's take a look at how Fescar passes XID if the consumer is using RestTemplate for requests.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarRestTemplateInterceptor implements ClientHttpRequestInterceptor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ClientHttpResponse intercept(HttpRequest httpRequest, byte[] bytes,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ClientHttpRequestExecution clientHttpRequestExecution) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HttpRequestWrapper requestWrapper = new HttpRequestWrapper(httpRequest);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String xid = RootContext.getXID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!StringUtils.isEmpty(xid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            requestWrapper.getHeaders().add(RootContext.KEY_XID, xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return clientHttpRequestExecution.execute(requestWrapper, bytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The FescarRestTemplateInterceptor implements the intercept method of the ClientHttpRequestInterceptor interface. It wraps the outgoing request and, if there is an existing Fescar transaction context XID, retrieves it and adds it to the HTTP headers of the request.</p><p>FescarRestTemplateInterceptor is configured in RestTemplate through FescarRestTemplateAutoConfiguration.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarRestTemplateAutoConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public FescarRestTemplateInterceptor fescarRestTemplateInterceptor() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FescarRestTemplateInterceptor();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired(required = false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Collection&lt;RestTemplate&gt; restTemplates;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private FescarRestTemplateInterceptor fescarRestTemplateInterceptor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostConstruct</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.restTemplates != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (RestTemplate restTemplate : restTemplates) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;ClientHttpRequestInterceptor&gt; interceptors = new ArrayList&lt;ClientHttpRequestInterceptor&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        restTemplate.getInterceptors());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                interceptors.add(this.fescarRestTemplateInterceptor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                restTemplate.setInterceptors(interceptors);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The init method iterates through all the RestTemplate instances, retrieves the original interceptors from each RestTemplate, adds the fescarRestTemplateInterceptor, and then reorders the interceptors.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="feign">Feign<a href="#feign" class="hash-link" aria-label="Direct link to Feign" title="Direct link to Feign">​</a></h5><p><img loading="lazy" alt="Feign 类关系图" src="/assets/images/20190305184812-46ab74f3830c4789b6f410150de067d6.png" width="1986" height="788" class="img_ev3q"></p><p>Next, let's take a look at the code related to Feign. There are quite a few classes in this package, so let's start with its AutoConfiguration.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnClass(Client.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@AutoConfigureBefore(FeignAutoConfiguration.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarFeignClientAutoConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Scope("prototype")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnClass(name = "com.netflix.hystrix.HystrixCommand")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(name = "feign.hystrix.enabled", havingValue = "true")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Feign.Builder feignHystrixBuilder(BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return FescarHystrixFeignBuilder.builder(beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Scope("prototype")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnClass(name = "com.alibaba.csp.sentinel.SphU")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(name = "feign.sentinel.enabled", havingValue = "true")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Feign.Builder feignSentinelBuilder(BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return FescarSentinelFeignBuilder.builder(beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnMissingBean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Scope("prototype")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Feign.Builder feignBuilder(BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return FescarFeignBuilder.builder(beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected static class FeignBeanPostProcessorConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FescarBeanPostProcessor fescarBeanPostProcessor(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                FescarFeignObjectWrapper fescarFeignObjectWrapper) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new FescarBeanPostProcessor(fescarFeignObjectWrapper);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FescarContextBeanPostProcessor fescarContextBeanPostProcessor(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new FescarContextBeanPostProcessor(beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FescarFeignObjectWrapper fescarFeignObjectWrapper(BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new FescarFeignObjectWrapper(beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The FescarFeignClientAutoConfiguration is enabled when the Client.class exists and requires it to be applied before FeignAutoConfiguration. Since FeignClientsConfiguration is responsible for generating the FeignContext and is enabled by FeignAutoConfiguration, based on the dependency relationship, FescarFeignClientAutoConfiguration is also applied before FeignClientsConfiguration.</p><p>FescarFeignClientAutoConfiguration customizes the Feign.Builder and adapts it for feign.sentinel, feign.hystrix, and regular feign cases. The purpose is to customize the actual implementation of the Client in Feign to be FescarFeignClient.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HystrixFeign.builder().retryer(Retryer.NEVER_RETRY)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .client(new FescarFeignClient(beanFactory))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SentinelFeign.builder().retryer(Retryer.NEVER_RETRY)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .client(new FescarFeignClient(beanFactory));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Feign.builder().client(new FescarFeignClient(beanFactory));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>FescarFeignClient is an enhancement of the original Feign client proxy.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarFeignClient implements Client {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Client delegate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final BeanFactory beanFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FescarFeignClient(BeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.beanFactory = beanFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.delegate = new Client.Default(null, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FescarFeignClient(BeanFactory beanFactory, Client delegate) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.delegate = delegate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.beanFactory = beanFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Response execute(Request request, Request.Options options) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Request modifiedRequest = getModifyRequest(request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.delegate.execute(modifiedRequest, options);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Request getModifyRequest(Request request) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String xid = RootContext.getXID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(xid)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return request;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, Collection&lt;String&gt;&gt; headers = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        headers.putAll(request.headers());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;String&gt; fescarXid = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fescarXid.add(xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        headers.put(RootContext.KEY_XID, fescarXid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Request.create(request.method(), request.url(), headers, request.body(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                request.charset());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the above process, we can see that FescarFeignClient modifies the original Request. It first retrieves the XID from the current transaction context and, if the XID is not empty, adds it to the request's header.</p><p>FeignBeanPostProcessorConfiguration defines three beans: FescarContextBeanPostProcessor, FescarBeanPostProcessor, and FescarFeignObjectWrapper. FescarContextBeanPostProcessor and FescarBeanPostProcessor both implement the Spring BeanPostProcessor interface.</p><p>Here is the implementation of FescarContextBeanPostProcessor</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object postProcessBeforeInitialization(Object bean, String beanName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throws BeansException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (bean instanceof FeignContext &amp;&amp; !(bean instanceof FescarFeignContext)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new FescarFeignContext(getFescarFeignObjectWrapper(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    (FeignContext) bean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object postProcessAfterInitialization(Object bean, String beanName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throws BeansException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The two methods in BeanPostProcessor allow for pre- and post-processing of beans in the Spring container. The postProcessBeforeInitialization method is called before initialization, while the postProcessAfterInitialization method is called after initialization. The return value of these methods can be the original bean instance or a wrapped instance using a wrapper.</p><p>FescarContextBeanPostProcessor wraps FeignContext into FescarFeignContext. FescarBeanPostProcessor wraps FeignClient into FescarLoadBalancerFeignClient and FescarFeignClient, depending on whether it inherits from LoadBalancerFeignClient.</p><p>In FeignAutoConfiguration, the FeignContext does not have any ConditionalOnXXX conditions. Therefore, Fescar uses a pre-processing approach to wrap FeignContext into FescarFeignContext.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public FeignContext feignContext() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FeignContext context = new FeignContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setConfigurations(this.configurations);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For Feign Clients, the FeignClientFactoryBean retrieves an instance of FeignContext. For custom Feign Client objects configured by developers using the @Configuration annotation, they are configured into the builder, which causes the enhanced FescarFeignClient in FescarFeignBuilder to become ineffective. The key code in FeignClientFactoryBean is as follows</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param &lt;T&gt; the target type of the Feign client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return a {@link Feign} client created with the specified data and the context information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;T&gt; T getTarget() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FeignContext context = applicationContext.getBean(FeignContext.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Feign.Builder builder = feign(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!StringUtils.hasText(this.url)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!this.name.startsWith("http")) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                url = "http://" + this.name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                url = this.name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            url += cleanPath();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return (T) loadBalance(builder, context, new HardCodedTarget&lt;&gt;(this.type,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    this.name, url));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.hasText(this.url) &amp;&amp; !this.url.startsWith("http")) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.url = "http://" + this.url;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String url = this.url + cleanPath();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Client client = getOptional(context, Client.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (client != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (client instanceof LoadBalancerFeignClient) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // not load balancing because we have a url,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // but ribbon is on the classpath, so unwrap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                client = ((LoadBalancerFeignClient)client).getDelegate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            builder.client(client);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Targeter targeter = get(context, Targeter.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (T) targeter.target(this, builder, context, new HardCodedTarget&lt;&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.type, this.name, url));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above code determines whether to make a direct call to the specified URL or use load balancing based on whether the URL parameter is specified in the annotation. The targeter.target method creates the object through dynamic proxy. The general process is as follows: the parsed Feign methods are stored in a map, and then passed as a parameter to generate the InvocationHandler, which in turn generates the dynamic proxy object.</p><p>The presence of FescarContextBeanPostProcessor ensures that even if developers customize operations on FeignClient, the enhancement of global transactions required by Fescar can still be achieved.</p><p>As for FescarFeignObjectWrapper, let's focus on the Wrapper method:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    Object wrap(Object bean) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (bean instanceof Client &amp;&amp; !(bean instanceof FescarFeignClient)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (bean instanceof LoadBalancerFeignClient) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LoadBalancerFeignClient client = ((LoadBalancerFeignClient) bean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return new FescarLoadBalancerFeignClient(client.getDelegate(), factory(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        clientFactory(), this.beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new FescarFeignClient(this.beanFactory, (Client) bean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the wrap method, if the bean is an instance of LoadBalancerFeignClient, it first retrieves the actual Client object that the LoadBalancerFeignClient proxies using the client.getDelegate() method. It then wraps the Client object into FescarFeignClient and generates a subclass of LoadBalancerFeignClient called FescarLoadBalancerFeignClient. If the bean is an instance of Client and not FescarFeignClient or LoadBalancerFeignClient, it is directly wrapped and transformed into FescarFeignClient.</p><p>The above process design is quite clever. It controls the order of configuration based on Spring Boot's Auto Configuration and customizes the Feign Builder bean to ensure that all Clients are enhanced with FescarFeignClient. It also wraps the beans in the Spring container using BeanPostProcessor, ensuring that all beans in the container are enhanced with FescarFeignClient, thus avoiding the replacement action in the getTarget method of FeignClientFactoryBean.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="hystrix-isolation">Hystrix Isolation<a href="#hystrix-isolation" class="hash-link" aria-label="Direct link to Hystrix Isolation" title="Direct link to Hystrix Isolation">​</a></h5><p>Now let's take a look at the Hystrix part. Why do we separate Hystrix and implement a separate strategy class in Fescar? Currently, the default implementation of the transaction context RootContext is based on ThreadLocal, which means the context is bound to the thread. Hystrix itself has two isolation modes: semaphore-based isolation and thread pool-based isolation. Hystrix officially recommends using thread pool isolation for better separation, which is the commonly used mode:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Thread or Semaphore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The default, and the recommended setting, is to run HystrixCommands using thread isolation (THREAD) and HystrixObservableCommands using semaphore isolation (SEMAPHORE).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Commands executed in threads have an extra layer of protection against latencies beyond what network timeouts can offer.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Generally the only time you should use semaphore isolation for HystrixCommands is when the call is so high volume (hundreds per second, per instance) that the overhead of separate threads is too high; this typically only applies to non-network calls.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You are correct that the service layer's business code and the thread that sends the request are not the same. Therefore, the ThreadLocal approach cannot pass the XID to the Hystrix thread and subsequently to the callee. To address this issue, Hystrix provides a mechanism for developers to customize the concurrency strategy. This can be done by extending the HystrixConcurrencyStrategy class and overriding the wrapCallable method:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarHystrixConcurrencyStrategy extends HystrixConcurrencyStrategy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private HystrixConcurrencyStrategy delegate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public FescarHystrixConcurrencyStrategy() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.delegate = HystrixPlugins.getInstance().getConcurrencyStrategy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HystrixPlugins.reset();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HystrixPlugins.getInstance().registerConcurrencyStrategy(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;K&gt; Callable&lt;K&gt; wrapCallable(Callable&lt;K&gt; c) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (c instanceof FescarContextCallable) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return c;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Callable&lt;K&gt; wrappedCallable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.delegate != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            wrappedCallable = this.delegate.wrapCallable(c);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            wrappedCallable = c;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (wrappedCallable instanceof FescarContextCallable) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return wrappedCallable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FescarContextCallable&lt;&gt;(wrappedCallable);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static class FescarContextCallable&lt;K&gt; implements Callable&lt;K&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final Callable&lt;K&gt; actual;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final String xid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FescarContextCallable(Callable&lt;K&gt; actual) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.actual = actual;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.xid = RootContext.getXID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public K call() throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RootContext.bind(xid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return actual.call();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                RootContext.unbind();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Fescar also provides a FescarHystrixAutoConfiguration, which generates the FescarHystrixConcurrencyStrategy when HystrixCommand is present.</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnClass(HystrixCommand.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FescarHystrixAutoConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FescarHystrixConcurrencyStrategy fescarHystrixConcurrencyStrategy() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new FescarHystrixConcurrencyStrategy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="reference">reference<a href="#reference" class="hash-link" aria-label="Direct link to reference" title="Direct link to reference">​</a></h3><ul><li><p>Fescar: <a href="https://github.com/alibaba/fescar" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/fescar</a></p></li><li><p>Spring Cloud Alibaba: <a href="https://github.com/spring-cloud-incubator/spring-cloud-alibaba" target="_blank" rel="noopener noreferrer">https://github.com/spring-cloud-incubator/spring-cloud-alibaba</a></p></li><li><p>spring-cloud-openfeign: <a href="https://github.com/spring-cloud/spring-cloud-openfeign" target="_blank" rel="noopener noreferrer">https://github.com/spring-cloud/spring-cloud-openfeign</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="author">author<a href="#author" class="hash-link" aria-label="Direct link to author" title="Direct link to author">​</a></h3><p> kangshu.guo，Community nickname ywind, formerly employed at Huawei Terminal Cloud, currently a Java engineer at Sohu Intelligent Media Center. Mainly responsible for development related to Sohu accounts. Has a strong interest in distributed transactions, distributed systems, and microservices architecture.
min.ji(qinming)，Community nickname slievrly, Fescar project leader, core developer of Alibaba middleware TXC/GTS. Engaged in core research and development work in distributed middleware for a long time. Has extensive technical expertise in the field of distributed transactions.</p></li></ul>]]></content>
        <author>
            <name>shukang.guo min.ji</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Integrating Seata (formerly Fescar) Distributed Transaction with Spring Cloud]]></title>
        <id>https://seata.apache.org/blog/integrate-seata-with-spring-cloud</id>
        <link href="https://seata.apache.org/blog/integrate-seata-with-spring-cloud"/>
        <updated>2019-04-15T00:00:00.000Z</updated>
        <author>
            <name>dafei.Fei</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[In-Depth Explanation of Seata-Client Principles and Processes in Distributed Transactions]]></title>
        <id>https://seata.apache.org/blog/seata-analysis-java-client</id>
        <link href="https://seata.apache.org/blog/seata-analysis-java-client"/>
        <updated>2019-04-15T00:00:00.000Z</updated>
        <author>
            <name>fangliangsheng</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[In-Depth Analysis of One-Stop Distributed Transaction Solution Seata-Server]]></title>
        <id>https://seata.apache.org/blog/seata-analysis-java-server</id>
        <link href="https://seata.apache.org/blog/seata-analysis-java-server"/>
        <updated>2019-04-08T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Not long ago, I wrote an analysis of the distributed transaction middleware Fescar. Shortly after, the Fescar team rebranded it as Seata (Simple Extensible Autonomous Transaction Architecture), whereas the previous Fescar's English full name was Fast & Easy Commit And Rollback. It can be seen that Fescar was more limited to Commit and Rollback based on its name, while the new brand name Seata aims to create a one-stop distributed transaction solution. With the name change, I am more confident about its future development.]]></summary>
        <content type="html"><![CDATA[<p>Not long ago, I wrote an analysis of the distributed transaction middleware Fescar. Shortly after, the Fescar team rebranded it as Seata (Simple Extensible Autonomous Transaction Architecture), whereas the previous Fescar's English full name was Fast &amp; Easy Commit And Rollback. It can be seen that Fescar was more limited to Commit and Rollback based on its name, while the new brand name Seata aims to create a one-stop distributed transaction solution. With the name change, I am more confident about its future development.</p><p>Here, let's briefly recall the overall process model of Seata:</p><p><img loading="lazy" alt="Seata Process Model" src="/assets/images/20190327000119-20382b15f6fcf95833b54a3b2f735c5d.png" width="1716" height="986" class="img_ev3q"></p><ul><li>TM: Transaction initiator. Used to inform TC about the start, commit, and rollback of global transactions.</li><li>RM: Specific transaction resource. Each RM is registered as a branch transaction in TC.</li><li>TC: Transaction coordinator. Also known as Fescar-server, used to receive registration, commit, and rollback of transactions.</li></ul><p>In previous articles, I provided a general introduction to the roles, and in this article, I will focus on the core role TC, which is the transaction coordinator.</p><h1>2. Transaction Coordinator</h1><p>Why has the emphasis been placed on TC as the core role? Because TC, like God, manages the RM and TM of countless beings in the cloud. If TC fails to function properly, even minor issues with RM and TM will lead to chaos. Therefore, to understand Seata, one must understand its TC.</p><p>So, what capabilities should an excellent transaction coordinator possess? I think it should have the following:</p><ul><li>Correct coordination: It should be able to properly coordinate what RM and TM should do next, what to do if something goes wrong, and what to do if everything goes right.</li><li>High availability: The transaction coordinator is crucial in distributed transactions. If it cannot ensure high availability, it serves no purpose.</li><li>High performance: The performance of the transaction coordinator must be high. If there are performance bottlenecks, it will frequently encounter timeouts, leading to frequent rollbacks.</li><li>High scalability: This characteristic belongs to the code level. If it is an excellent framework, it needs to provide many customizable extensions for users, such as service registration/discovery, reading configuration, etc.</li></ul><p>Next, I will explain how Seata achieves the above four points.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="21-seata-server-design">2.1 Seata-Server Design<a href="#21-seata-server-design" class="hash-link" aria-label="Direct link to 2.1 Seata-Server Design" title="Direct link to 2.1 Seata-Server Design">​</a></h2><p><img loading="lazy" alt="Seata-Server Design" src="/assets/images/design-593e833d29ab54ac77d5a9da7a196a08.png" width="954" height="503" class="img_ev3q"></p><p>The overall module diagram of Seata-Server is shown above:</p><ul><li>Coordinator Core: At the bottom is the core code of the transaction coordinator, mainly used to handle transaction coordination logic, such as whether to commit, rollback, etc.</li><li>Store: Storage module used to persist data to prevent data loss during restarts or crashes.</li><li>Discovery: Service registration/discovery module used to expose server addresses to clients.</li><li>Config: Used to store and retrieve server configurations.</li><li>Lock: Lock module used to provide global locking functionality to Seata.</li><li>RPC: Used for communication with other endpoints.</li><li>HA-Cluster: High availability cluster, currently not open-source, provides reliable high availability services to Seata, expected to be open-sourced in version 0.6.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="22-discovery">2.2 Discovery<a href="#22-discovery" class="hash-link" aria-label="Direct link to 2.2 Discovery" title="Direct link to 2.2 Discovery">​</a></h2><p>First, let's talk about the basic Discovery module, also known as the service registration/discovery module. After starting Seata-Sever, we need to expose our address to other users, which is the responsibility of this module.</p><p><img loading="lazy" alt="Discovery Module" src="/assets/images/discover-123b6b65796c5fac1dbfad5192bde0d2.png" width="583" height="409" class="img_ev3q"></p><p>This module has a core interface <code>RegistryService</code>, as shown in the image above:</p><ul><li>register: Used by the server to register the service.</li><li>unregister: Used by the server, typically called in JVM shutdown hooks.</li><li>subscribe: Used by clients to register event listeners to listen for address changes.</li><li>unsubscribe: Used by clients to cancel event listeners.</li><li>lookup: Used by clients to retrieve service address lists based on keys.</li><li>close: Used to close the Registry resource.</li></ul><p>If you need to add your own service registration/discovery, just implement this interface. So far, with the continuous development and promotion in the community, there are already five service registration/discovery implementations, including redis, zk, nacos, eruka, and consul. Below is a brief introduction to the Nacos implementation:</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="221-register-interface">2.2.1 register Interface:<a href="#221-register-interface" class="hash-link" aria-label="Direct link to 2.2.1 register Interface:" title="Direct link to 2.2.1 register Interface:">​</a></h3><p><img loading="lazy" alt="Register Interface" src="/assets/images/register-9c033585329a607956f4a576c500a0f3.png" width="702" height="117" class="img_ev3q"></p><p>Step 1: Validate the address.
Step 2: Get the Naming instance of Nacos and register the address with the service name <code>serverAddr</code> (fixed service name) on the corresponding cluster group (configured in registry.conf).</p><p>The unregister interface is similar, and I won't go into detail here.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="222-lookup-interface">2.2.2 lookup Interface:<a href="#222-lookup-interface" class="hash-link" aria-label="Direct link to 2.2.2 lookup Interface:" title="Direct link to 2.2.2 lookup Interface:">​</a></h3><p><img loading="lazy" alt="Lookup Interface" src="/assets/images/lookup-a057c9d992510131026a9bd89e2b94e9.png" width="890" height="652" class="img_ev3q"></p><p>Step 1: Get the current cluster name.
Step 2: Check if the service corresponding to the current cluster name has been subscribed. If yes, directly retrieve the subscribed data from the map.</p><p>Step 3: If not subscribed, actively query the service instance list once, then add subscription and store the data returned by subscription in the map. After that, retrieve the latest data directly from the map.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="223-subscribe-interface">2.2.3 subscribe Interface:<a href="#223-subscribe-interface" class="hash-link" aria-label="Direct link to 2.2.3 subscribe Interface:" title="Direct link to 2.2.3 subscribe Interface:">​</a></h3><p><img loading="lazy" alt="Subscribe Interface" src="/assets/images/subscribe-2be2aa5b1bcb8b9bb0a32711b67fc49b.png" width="712" height="143" class="img_ev3q"></p><p>This interface is relatively simple, divided into two steps:
Step 1: Add the <code>cluster -&gt; listener</code> to be subscribed to the map. Since Nacos does not provide a single machine already subscribed list, it needs to be implemented by itself.
Step 2: Subscribe using the Nacos API.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="23-config">2.3 Config<a href="#23-config" class="hash-link" aria-label="Direct link to 2.3 Config" title="Direct link to 2.3 Config">​</a></h2><p>The configuration module is also a relatively basic and simple module. We need to configure some common parameters such as the number of select and work threads for Netty, the maximum allowed session, etc. Of course, these parameters in Seata have their own default settings.</p><p>Similarly, Seata also provides an interface <code>Configuration</code> for customizing where we need to obtain configurations:</p><p><img loading="lazy" alt="Config Interface" src="/assets/images/config-0cb2807fcc90c4dd96e784665c5ee074.png" width="735" height="403" class="img_ev3q"></p><ul><li>getInt/Long/Boolean/getConfig(): Retrieves the corresponding value based on the dataId. If the configuration cannot be read, an exception occurs, or a timeout occurs, it returns the default value specified in the parameters.</li><li>putConfig: Used to add configuration.</li><li>removeConfig: Deletes a configuration.</li><li>add/remove/get ConfigListener: Add/remove/get configuration listeners, usually used to listen for configuration changes.</li></ul><p>Currently, there are four ways to obtain Config: File (file-based), Nacos, Apollo, and ZK (not recommended). In Seata, you first need to configure <code>registry.conf</code> to specify the <code>config.type</code>. Implementing Config is relatively simple, and I won't delve into it here.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="24-store">2.4 Store<a href="#24-store" class="hash-link" aria-label="Direct link to 2.4 Store" title="Direct link to 2.4 Store">​</a></h2><p>The implementation of the storage layer is crucial for Seata's performance and reliability.
If the storage layer is not implemented well, data being processed by TC in distributed transactions may be lost in the event of a crash. Since distributed transactions cannot tolerate data loss, if the storage layer is implemented well but has significant performance issues, RM may experience frequent rollbacks, making it unable to cope with high-concurrency scenarios.</p><p>In Seata, file storage is provided as the default method for storing data. Here, we define the data to be stored as sessions. Sessions created by the TM are referred to as GlobalSessions, while those created by RMs are called BranchSessions. A GlobalSession can have multiple BranchSessions. Our objective is to store all these sessions.</p><p>the code of FileTransactionStoreManager:</p><p><img loading="lazy" src="/assets/images/store-11995c04c2ae5a0b14ce70fe74837dbf.png" width="876" height="258" class="img_ev3q"></p><p>The code snippet above can be broken down into the following steps:</p><ul><li><strong>Step 1</strong>: Generate a TransactionWriteFuture.</li><li><strong>Step 2</strong>: Put this futureRequest into a LinkedBlockingQueue. Why do we need to put all the data into a queue? Well, in fact, we could also use locks for this purpose. In another Alibaba open-source project, RocketMQ, locks are used. Whether it's a queue or a lock, their purpose is to ensure single-threaded writing. But why is that necessary? Some might explain that it's to ensure sequential writing, which would improve speed. However, this understanding is incorrect. The write method of our FileChannel is thread-safe and already ensures sequential writing. Ensuring single-threaded writing is actually to make our write logic single-threaded. This is because there may be logic such as when a file is full or when records are written to specific positions. Of course, this logic could be actively locked, but to achieve simplicity and convenience, it's most appropriate to queue the entire write logic for processing.</li><li><strong>Step 3</strong>: Call future.get to wait for the completion notification of our write logic.</li></ul><p>Once we submit the data to the queue, the next step is to consume it. The code is as follows:</p><p><img loading="lazy" alt="Write Data File" src="/assets/images/storewrite-d7cf58998ec8ae864c12d42bb0af2295.png" width="719" height="101" class="img_ev3q"></p><p>Here, a WriteDataFileRunnable() is submitted to our thread pool, and the run() method of this Runnable is as follows:</p><p><img loading="lazy" alt="Store Run" src="/assets/images/storerun-50f3041c552421e9cdc2666489a4d46a.png" width="855" height="526" class="img_ev3q"></p><p>It can be broken down into the following steps:</p><ul><li><strong>Step 1</strong>: Check if stopping is true. If so, return null.</li><li><strong>Step 2</strong>: Get data from our queue.</li><li><strong>Step 3</strong>: Check if the future has timed out. If so, set the result to false. At this point, our producer's get() method will unblock.</li><li><strong>Step 4</strong>: Write our data to the file. At this point, the data is still in the pageCache layer and has not been flushed to the disk yet. If the write is successful, flush it based on certain conditions.</li><li><strong>Step 5</strong>: When the number of writes reaches a certain threshold, or when the writing time exceeds a certain limit, the current file needs to be saved as a historical file, the old historical files need to be deleted, and a new file needs to be created. This step is to prevent unlimited growth of our files, which would waste disk resources.</li></ul><p>In our writeDataFile method, we have the following code:</p><p><img loading="lazy" alt="Write Data File" src="/assets/images/writedatafile-d999695c1986d60cdd5f2945f81d9882.png" width="748" height="557" class="img_ev3q"></p><ul><li><strong>Step 1</strong>: First, get our ByteBuffer. If it exceeds the maximum loop BufferSize, create a new one directly; otherwise, use our cached Buffer. This step can greatly reduce garbage collection.</li><li><strong>Step 2</strong>: Add the data to the ByteBuffer.</li><li><strong>Step 3</strong>: Finally, write the ByteBuffer to our fileChannel. This will be retried three times. At this point, the data is still in the pageCache layer and is affected by two factors: the OS has its own flushing strategy, but this business program cannot control it. To prevent events such as crashes from causing a large amount of data loss, the business itself needs to control the flush. Below is the flush code:</li></ul><p><img loading="lazy" alt="Flush" src="/assets/images/flush-ba1b0df70804b3501b6ccdf503b01ca8.png" width="868" height="273" class="img_ev3q"></p><p>Here, the flush condition is based on writing a certain number of data or exceeding a certain time. This also presents a small issue: in the event of a power failure, there may still be data in the pageCache that has not been flushed to disk, resulting in a small amount of data loss. Currently, synchronous mode is not supported, which means that each piece of data needs to be flushed, ensuring that each message is written to disk. However, this would greatly affect performance. Of course, there will be continuous evolution and support for this in the future.</p><p>Our store's core process mainly consists of the above methods, but there are also some other processes such as session reconstruction, which are relatively simple and readers can read them on their own.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="25-lock">2.5 Lock<a href="#25-lock" class="hash-link" aria-label="Direct link to 2.5 Lock" title="Direct link to 2.5 Lock">​</a></h2><p>As we know, the isolation level in databases is mainly implemented through locks. Similarly, in the distributed transaction framework Seata, achieving isolation levels also requires locks. Generally, there are four isolation levels in databases: Read Uncommitted, Read Committed, Repeatable Read, and Serializable. In Seata, it can ensure that the isolation level is Read Committed but provides means to achieve Read Committed isolation.</p><p>The Lock module is the core module of Seata for implementing isolation levels. In the Lock module, an interface is provided for managing our locks:
<img loading="lazy" alt="Lock Manager" src="/assets/images/lockManager-ea0f0672144a891b0f4b8c1d79572c23.png" width="759" height="368" class="img_ev3q"></p><p>It has three methods:</p><ul><li>acquireLock: Used to lock our BranchSession. Although a branch transaction Session is passed here, it is actually locking the resources of the branch transaction. Returns true upon successful locking.</li><li>isLockable: Queries whether the transaction ID, resource ID, and locked key are already locked.</li><li>cleanAllLocks: Clears all locks.</li></ul><p>For locks, we can implement them locally or use Redis or MySQL to help us implement them. The official default provides local global lock implementation:
<img loading="lazy" alt="Default Lock" src="/assets/images/defaultLock-1df1bfa4a52ecb7b29a9fdf7f759db8c.png" width="887" height="223" class="img_ev3q"></p><p>In the local lock implementation, there are two constants to pay attention to:</p><ul><li>BUCKET_PER_TABLE: Defines how many buckets each table has, aiming to reduce competition when locking the same table later.</li><li>LOCK_MAP: This map seems very complex from its definition, with many layers of Maps nested inside and outside. Here's a table to explain it specifically:</li></ul><table><thead><tr><th>Layer</th><th>Key</th><th>Value</th></tr></thead><tbody><tr><td>1-LOCK_MAP</td><td>resourceId (jdbcUrl)</td><td>dbLockMap</td></tr><tr><td>2- dbLockMap</td><td>tableName (table name)</td><td>tableLockMap</td></tr><tr><td>3- tableLockMap</td><td>PK.hashcode%Bucket (hashcode%bucket of the primary key value)</td><td>bucketLockMap</td></tr><tr><td>4- bucketLockMap</td><td>PK</td><td>transactionId</td></tr></tbody></table><p>It can be seen that the actual locking occurs in the bucketLockMap. The specific locking method here is relatively simple and will not be detailed. The main process is to gradually find the bucketLockMap and then insert the current transactionId. If this primary key currently has a TransactionId, then it checks if it is itself; if not, the locking fails.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="26-rpc">2.6 RPC<a href="#26-rpc" class="hash-link" aria-label="Direct link to 2.6 RPC" title="Direct link to 2.6 RPC">​</a></h2><p>One of the key factors in ensuring Seata's high performance is the use of Netty as the RPC framework, with the default configuration of the thread model as shown in the diagram below:</p><p><img loading="lazy" alt="Reactor" src="/assets/images/reactor-08b0f8b4eacf85d471715b468a919377.png" width="1019" height="379" class="img_ev3q"></p><p>If the default basic configuration is adopted, there will be one Acceptor thread for handling client connections and a number of NIO-Threads equal to cpu*2. In these threads, heavy business operations are not performed. They only handle relatively fast tasks such as encoding and decoding, heartbeats, and TM registration. Time-consuming business operations are delegated to the business thread pool. By default, the business thread pool is configured with a minimum of 100 threads and a maximum of 500.</p><p>Seata currently allows for configuration of transport layer settings, as shown in the following diagram. Users can optimize Netty transport layer settings according to their needs, and the configuration takes effect when loaded for the first time.</p><p><img loading="lazy" alt="Transport" src="/assets/images/transport-72c1b92a7e58aefcead18accf36697b6.png" width="1052" height="818" class="img_ev3q"></p><p>It's worth mentioning Seata's heartbeat mechanism, which is implemented using Netty's IdleStateHandler, as shown below:</p><p><img loading="lazy" alt="Idle State Handler" src="/assets/images/idleStateHandler-777d7088d0487a1d6cc3aa82c6155b0c.png" width="885" height="53" class="img_ev3q"></p><p>On the server side, there is no maximum idle time set for writing, and for reading, the maximum idle time is set to 15 seconds (the client's default write idle time is 5 seconds, sending ping messages). If it exceeds 15 seconds, the connection will be disconnected, and resources will be closed.</p><p><img loading="lazy" alt="User Event Triggered" src="/assets/images/userEventTriggered-dde1066ce734ef88b3a6acc562e70f9c.png" width="656" height="326" class="img_ev3q"></p><ul><li>Step 1: Check if it is a read idle detection event.</li><li>Step 2: If it is, disconnect the connection and close the resources.</li></ul><p>Additionally, Seata has implemented features such as memory pools, batch merging of small packets by the client for sending, and Netty connection pools (reducing the service unavailable time when creating connections), one of which is batch merging of small packets.</p><p><img loading="lazy" src="/assets/images/send-166e53dadab35ea5272470c6056d27c1.png" width="1472" height="1572" class="img_ev3q"></p><p>The client's message sending process does not directly send messages. Instead, it wraps the message into an RpcMessage through AbstractRpcRemoting#sendAsyncRequest and stores it in the basket, then wakes up the merge sending thread. The merge sending thread, through a while true loop, waits for a maximum of 1ms to retrieve messages from the basket and wraps them into merge messages for actual sending. If an exception occurs in the channel during this process, it will quickly fail and return the result through fail-fast. Before sending the merge message, it is marked in the map. Upon receiving the results, batch confirmation is performed (AbstractRpcRemotingClient#channelRead), and then dispatched to messageListener and handler for processing. Additionally, timerExecutor periodically checks for timeouts in sent messages, marking them as failed if they exceed the timeout. Specific details of the message protocol design will be provided in subsequent articles, so stay tuned.</p><p>Seata's Netty Client consists of TMClient and RMClient, distinguished by their transactional roles. Both inherit from AbstractRpcRemotingClient, which implements RemotingService (service start and stop), RegisterMsgListener (Netty connection pool connection creation callback), and ClientMessageSender (message sending), further inheriting from AbstractRpcRemoting (the top-level message sending and processing template for Client and Server).</p><p>The class diagram for RMClient is depicted below:
<img loading="lazy" alt="RMClient Class Diagram" src="/assets/images/class-e9d7be588754b2b5a08756e05dc79ea1.png" width="1626" height="838" class="img_ev3q"></p><p>TMClient and RMClient interact with channel connections based on their respective poolConfig and NettyPoolableFactory, which implements KeyedPoolableObjectFactory&lt;NettyPoolKey, Channel&gt;. The channel connection pool locates each connection pool based on the role key+IP, and manages channels uniformly. During the sending process, TMClient and RMClient each use only one long-lived connection per IP. However, if a connection becomes unavailable, it is quickly retrieved from the connection pool, reducing service downtime.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="27-ha-cluster">2.7 HA-Cluster<a href="#27-ha-cluster" class="hash-link" aria-label="Direct link to 2.7 HA-Cluster" title="Direct link to 2.7 HA-Cluster">​</a></h2><p>Currently, the official HA-Cluster design has not been publicly disclosed. However, based on some hints from other middleware and the official channels, HA-Cluster could be designed as follows:
<img loading="lazy" alt="HA-Cluster Design" src="/assets/images/hacluster-3b88f79394b7ffe7c02f3b249fae582f.png" width="1085" height="622" class="img_ev3q"></p><p>The specific process is as follows:</p><p><strong>Step 1:</strong> When clients publish information, they ensure that the same transaction with the same transaction ID is handled on the same master. This is achieved by horizontally scaling multiple masters to provide concurrent processing performance.</p><p><strong>Step 2:</strong> On the server side, each master has multiple slaves. Data in the master is nearly real-time synchronized to the slaves, ensuring that when the master crashes, other slaves can take over.</p><p>However, all of the above is speculation, and the actual design and implementation will have to wait until version 0.5. Currently, there is a Go version of Seata-Server donated to Seata (still in progress), which implements replica consistency through Raft. However, other details are not clear.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="28-metrics">2.8 Metrics<a href="#28-metrics" class="hash-link" aria-label="Direct link to 2.8 Metrics" title="Direct link to 2.8 Metrics">​</a></h2><p>This module has not yet disclosed a specific implementation. However, it may provide a plugin interface for integrating with other third-party metrics. Recently, Apache SkyWalking has been discussing how to integrate with the Seata team.</p><h1>3. Coordinator Core</h1><p>We have covered many foundational modules of the Seata server. I believe you now have a general understanding of Seata's implementation. Next, I will explain how the transaction coordinator's specific logic is implemented, providing you with a deeper understanding of Seata's internal workings.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="31-startup-process">3.1 Startup Process<a href="#31-startup-process" class="hash-link" aria-label="Direct link to 3.1 Startup Process" title="Direct link to 3.1 Startup Process">​</a></h2><p>The startup method is defined in the Server class's main method, outlining our startup process:</p><p><img loading="lazy" src="/assets/images/main-616485b1d53577f53bdca2ea7817757b.png" width="651" height="643" class="img_ev3q"></p><p>step1: Create an RpcServer, which encapsulates network operations using Netty to implement the server.</p><p>step2: Parse the port number, local file address (for recovering incomplete transactions if the server crashes), and IP address (optional, useful for obtaining an external VIP registration service when crossing networks).</p><p>step3: Initialize SessionHolder, wherein the crucial step is to recover data from the dataDir folder and rebuild sessions.</p><p>step4: Create a Coordinator, the core logic of the transaction coordinator, and initialize it. The initialization process includes creating four scheduled tasks:</p><ul><li>retryRollbacking: Retry rollback task, used to retry failed rollbacks, executed every 5ms.</li><li>retryCommitting: Retry commit task, used to retry failed commits, executed every 5ms.</li><li>asyncCommitting: Asynchronous commit task, used to perform asynchronous commits, executed every 10ms.</li><li>timeoutCheck: Timeout task check, used to detect timeout tasks and execute timeout logic, executed every 2ms.</li></ul><p>step5: Initialize UUIDGenerator, a basic class used for generating various IDs (transactionId, branchId).</p><p>step6: Set the local IP and listening port in XID, initialize rpcServer, and wait for client connections.</p><p>The startup process is relatively straightforward. Next, I will describe how Seata handles common business logic in distributed transaction frameworks.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="32-begin---start-global-transaction">3.2 Begin - Start Global Transaction<a href="#32-begin---start-global-transaction" class="hash-link" aria-label="Direct link to 3.2 Begin - Start Global Transaction" title="Direct link to 3.2 Begin - Start Global Transaction">​</a></h2><p>The starting point of a distributed transaction is always to start a global transaction. Let's see how Seata implements global transactions:</p><p><img loading="lazy" alt="Begin Global Transaction" src="/assets/images/begin-074ada9f769abc9a5011ce878814e570.png" width="894" height="211" class="img_ev3q"></p><p>step1: Create a GloabSession based on the application ID, transaction group, name, and timeout. As mentioned earlier, GloabSession and BranchSession represent different aspects of the transaction.</p><p>step2: Add a RootSessionManager to it for listening to some events. Currently, Seata has four types of listeners (it's worth noting that all session managers implement SessionLifecycleListener):</p><ul><li>ROOT_SESSION_MANAGER: The largest, containing all sessions.</li><li>ASYNC_COMMITTING_SESSION_MANAGER: Manages sessions that need asynchronous commit.</li><li>RETRY_COMMITTING_SESSION_MANAGER: Manages sessions for retrying commit.</li><li>RETRY_ROLLBACKING_SESSION_MANAGER: Manages sessions for retrying rollback.
Since this is the beginning of a transaction, other SessionManagers are not needed, so only add RootSessionManager.</li></ul><p>step3: Start GloabSession, which changes the state to Begin, records the start time, and calls the onBegin method of RootSessionManager to save the session to the map and write it to the file.</p><p>step4: Finally, return the XID. This XID is composed of ip+port+transactionId, which is crucial. When the TM acquires it, it needs to pass this ID to RM. RM uses XID to determine which server to access.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="33-branchregister---register-branch-transaction">3.3 BranchRegister - Register Branch Transaction<a href="#33-branchregister---register-branch-transaction" class="hash-link" aria-label="Direct link to 3.3 BranchRegister - Register Branch Transaction" title="Direct link to 3.3 BranchRegister - Register Branch Transaction">​</a></h2><p>After the global transaction is initiated by TM, the branch transaction of our RM also needs to be registered on top of our global transaction. Here's how it's handled:</p><p><img loading="lazy" alt="Branch Transaction Registration" src="/assets/images/branchRegister-fb53633441af1f3dab28ea6ad31ef84d.png" width="878" height="376" class="img_ev3q"></p><p>step1: Retrieve and validate the global transaction's state based on the transactionId.</p><p>step2: Create a new branch transaction, which is our BranchSession.</p><p>step3: Lock the branch transaction globally. Here, the logic uses the lock module.</p><p>step4: Add the branchSession, mainly by adding it to the globalSession object and writing it to our file.</p><p>step5: Return the branchId, which is also important. We will need it later to roll back our transaction or update the status of our branch transaction.</p><p>After registering the branch transaction, it is necessary to report whether the local transaction execution of the branch transaction was successful or failed. Currently, the server simply records this information. The purpose of reporting is that even if this branch transaction fails, if the TM insists on committing the global transaction (catches exceptions without throwing), then when traversing to commit the branch transaction, this failed branch transaction does not need to be committed (users can choose to skip it).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="34-globalcommit---global-commit">3.4 GlobalCommit - Global Commit<a href="#34-globalcommit---global-commit" class="hash-link" aria-label="Direct link to 3.4 GlobalCommit - Global Commit" title="Direct link to 3.4 GlobalCommit - Global Commit">​</a></h2><p>When our branch transaction is completed, it's up to our TM - Transaction Manager to decide whether to commit or rollback. If it's a commit, then the following logic will be executed:</p><p><img loading="lazy" alt="Global Commit" src="/assets/images/commit-2583aeb4369e3f50d4deeeef29fa65a0.png" width="890" height="397" class="img_ev3q"></p><p>step1: First, find our globalSession. If it's null, it means it has already been committed, so perform idempotent operation and return success.</p><p>step2: Close our GloabSession to prevent new branches from coming in (rollback due to timeout in cross-service calls, provider continues execution).</p><p>step3: If the status is Begin, it means it hasn't been committed yet, so change its status to Committing, indicating that it's committing.</p><p>step4: Determine if it can be asynchronously committed. Currently, only AT mode can be asynchronously committed. In two-phase global commits, undolog is only deleted without strict order. Here, a timer task is used, and the client merges and deletes in batches after receiving it.</p><p>step5: If it's an asynchronous commit, directly put it into our ASYNC_COMMITTING_SESSION_MANAGER to let it asynchronously execute step6 in the background. If it's synchronous, then execute step6 directly.</p><p>step6: Traverse our BranchSessions for submission. If a branch transaction fails, determine whether to retry based on different conditions. This branchSession can be executed asynchronously, and if it fails, it can continue with the next one because it remains in the manager and won't be deleted until it succeeds. If it's a synchronous commit, it will be put into the retry queue for scheduled retries and will block and submit in sequence.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="35-globalrollback---global-rollback">3.5 GlobalRollback - Global Rollback<a href="#35-globalrollback---global-rollback" class="hash-link" aria-label="Direct link to 3.5 GlobalRollback - Global Rollback" title="Direct link to 3.5 GlobalRollback - Global Rollback">​</a></h2><p>If our TM decides to globally rollback, it will follow the logic below:</p><p><img loading="lazy" alt="Global Rollback" src="/assets/images/rollback-16f69f2b916af5c4cd61f0f194979646.png" width="1738" height="652" class="img_ev3q"></p><p>This logic is basically the same as the commit process but in reverse. I won't delve into it here.</p><h1>4. Conclusion</h1><p>Finally, let's summarize how Seata solves the key points of distributed transactions:</p><ul><li>Correct coordination: Through background scheduled tasks, various retries are performed correctly, and in the future, a monitoring platform may be introduced, possibly allowing manual rollback.</li><li>High availability: Ensured by HA-Cluster.</li><li>High performance: Sequential file writing, RPC implemented through Netty, and Seata can be horizontally scaled in the future to improve processing performance.</li><li>High extensibility: Provides places where users can freely implement, such as configuration, service discovery and registration, global lock, etc.</li></ul><p>In conclusion, I hope you can understand the core design principles of Seata-Server from this article. Of course, you can also imagine how you would design a distributed transaction server if you were to implement one yourself.</p><p>Seata GitHub Repository: <a href="https://github.com/apache/incubator-seata" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata</a></p><p>Article Authors:</p><p>Li Zhao, GitHub ID @CoffeeLatte007, author of the public account "咖啡拿铁", Seata community Committer, Java engineer at Yuanfudao, formerly employed at Meituan. Has a strong interest in distributed middleware and distributed systems.
Ji Min (Qingming), GitHub ID @slievrly, Seata open source project leader, core R&amp;D member of Alibaba middleware TXC/GTS, has long been engaged in core R&amp;D work of distributed middleware, and has rich technical accumulation in the field of distributed transactions.</p>]]></content>
        <author>
            <name>zhao.li,min.ji</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Analysis of Applicable Models and Scenarios for TCC]]></title>
        <id>https://seata.apache.org/blog/tcc-mode-applicable-scenario-analysis</id>
        <link href="https://seata.apache.org/blog/tcc-mode-applicable-scenario-analysis"/>
        <updated>2019-03-27T00:00:00.000Z</updated>
        <author>
            <name>zhangthen</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Introduction to TCC Theory and Design Implementation Guide]]></title>
        <id>https://seata.apache.org/blog/tcc-mode-design-principle</id>
        <link href="https://seata.apache.org/blog/tcc-mode-design-principle"/>
        <updated>2019-03-26T00:00:00.000Z</updated>
        <author>
            <name>zhangthen</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[How to use Seata to ensure consistency between Dubbo Microservices]]></title>
        <id>https://seata.apache.org/blog/quick-start-use-seata-and-dubbo-services</id>
        <link href="https://seata.apache.org/blog/quick-start-use-seata-and-dubbo-services"/>
        <updated>2019-03-07T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This article will introduce you how to use Seata to ensure consistency between Dubbo Microservices.]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="use-case">Use case<a href="#use-case" class="hash-link" aria-label="Direct link to Use case" title="Direct link to Use case">​</a></h2><p>A business logic for user purchasing commodities. The whole business logic is powered by 3 microservices:</p><ul><li>Storage service: deduct storage count on given commodity.</li><li>Order service: create order according to purchase request.</li><li>Account service: debit the balance of user's account.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="architecture">Architecture<a href="#architecture" class="hash-link" aria-label="Direct link to Architecture" title="Direct link to Architecture">​</a></h3><p><img loading="lazy" alt="Architecture" src="/assets/images/seata-1-921f8d579a15d413c12f3542be7f5ffb.png" width="1468" height="868" class="img_ev3q"> </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="storageservice">StorageService<a href="#storageservice" class="hash-link" aria-label="Direct link to StorageService" title="Direct link to StorageService">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface StorageService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * deduct storage count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void deduct(String commodityCode, int count);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="orderservice">OrderService<a href="#orderservice" class="hash-link" aria-label="Direct link to OrderService" title="Direct link to OrderService">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface OrderService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * create order</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Order create(String userId, String commodityCode, int orderCount);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="accountservice">AccountService<a href="#accountservice" class="hash-link" aria-label="Direct link to AccountService" title="Direct link to AccountService">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface AccountService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * debit balance of user's account</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void debit(String userId, int money);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="main-business-logic">Main business logic<a href="#main-business-logic" class="hash-link" aria-label="Direct link to Main business logic" title="Direct link to Main business logic">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class BusinessServiceImpl implements BusinessService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private StorageService storageService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private OrderService orderService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * purchase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void purchase(String userId, String commodityCode, int orderCount) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storageService.deduct(commodityCode, orderCount);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        orderService.create(userId, commodityCode, orderCount);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class StorageServiceImpl implements StorageService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private StorageDAO storageDAO;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void deduct(String commodityCode, int count) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Storage storage = new Storage();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storage.setCount(count);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storage.setCommodityCode(commodityCode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storageDAO.update(storage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class OrderServiceImpl implements OrderService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private OrderDAO orderDAO;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private AccountService accountService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Order create(String userId, String commodityCode, int orderCount) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int orderMoney = calculate(commodityCode, orderCount);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        accountService.debit(userId, orderMoney);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Order order = new Order();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        order.userId = userId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        order.commodityCode = commodityCode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        order.count = orderCount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        order.money = orderMoney;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return orderDAO.insert(order);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="distributed-transaction-solution-with-seata">Distributed Transaction Solution with Seata<a href="#distributed-transaction-solution-with-seata" class="hash-link" aria-label="Direct link to Distributed Transaction Solution with Seata" title="Direct link to Distributed Transaction Solution with Seata">​</a></h2><p><img loading="lazy" alt="undefined" src="/assets/images/seata-2-3e4981c059d8c4d72aec440b06c30a65.png" width="1490" height="852" class="img_ev3q"> </p><p>We just need an annotation <code>@GlobalTransactional</code> on business method: </p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GlobalTransactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void purchase(String userId, String commodityCode, int orderCount) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="example-powered-by-dubbo--seata">Example powered by Dubbo + Seata<a href="#example-powered-by-dubbo--seata" class="hash-link" aria-label="Direct link to Example powered by Dubbo + Seata" title="Direct link to Example powered by Dubbo + Seata">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-setup-database">Step 1: Setup database<a href="#step-1-setup-database" class="hash-link" aria-label="Direct link to Step 1: Setup database" title="Direct link to Step 1: Setup database">​</a></h3><ul><li>Requirement: MySQL with InnoDB engine.</li></ul><p><strong>Note:</strong> In fact, there should be 3 database for the 3 services in the example use case. However, we can just create one database and configure 3 data sources for simple. </p><p>Modify Spring XML with the database URL/username/password you just created.</p><p>dubbo-account-service.xml
dubbo-order-service.xml
dubbo-storage-service.xml</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">url</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">jdbc:mysql://x.x.x.x:3306/xxx</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">username</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">xxx</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">password</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">xxx</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-create-undo_log-table-for-seata">Step 2: Create UNDO_LOG table for Seata<a href="#step-2-create-undo_log-table-for-seata" class="hash-link" aria-label="Direct link to Step 2: Create UNDO_LOG table for Seata" title="Direct link to Step 2: Create UNDO_LOG table for Seata">​</a></h3><p><code>UNDO_LOG</code> table is required by Seata AT mode.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">undo_log</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AUTO_INCREMENT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">branch_id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bigint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">xid</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">rollback_info</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">longblob</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">log_status</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">log_created</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">datetime</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">log_modified</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">datetime</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">ext</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">idx_unionkey</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">xid</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">branch_id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ENGINE</span><span class="token operator" style="color:#393A34">=</span><span class="token keyword" style="color:#00009f">InnoDB</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AUTO_INCREMENT</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">159</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CHARSET</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf8</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-3-create-tables-for-example-business">Step 3: Create tables for example business<a href="#step-3-create-tables-for-example-business" class="hash-link" aria-label="Direct link to Step 3: Create tables for example business" title="Direct link to Step 3: Create tables for example business">​</a></h3><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">storage_tbl</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">storage_tbl</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AUTO_INCREMENT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">commodity_code</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">count</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">UNIQUE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">commodity_code</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ENGINE</span><span class="token operator" style="color:#393A34">=</span><span class="token keyword" style="color:#00009f">InnoDB</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CHARSET</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">order_tbl</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">order_tbl</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AUTO_INCREMENT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">user_id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">commodity_code</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">count</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">money</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ENGINE</span><span class="token operator" style="color:#393A34">=</span><span class="token keyword" style="color:#00009f">InnoDB</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CHARSET</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">account_tbl</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">account_tbl</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AUTO_INCREMENT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">user_id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">money</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ENGINE</span><span class="token operator" style="color:#393A34">=</span><span class="token keyword" style="color:#00009f">InnoDB</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CHARSET</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf8</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-4-start-seata-server">Step 4: Start Seata-Server<a href="#step-4-start-seata-server" class="hash-link" aria-label="Direct link to Step 4: Start Seata-Server" title="Direct link to Step 4: Start Seata-Server">​</a></h3><ul><li>Download server <a href="https://github.com/apache/incubator-seata/releases" target="_blank" rel="noopener noreferrer">package</a>, unzip it.</li><li>Start Seata-Server</li></ul><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sh</span><span class="token plain"> seata-server.sh </span><span class="token variable" style="color:#36acaa">$LISTEN_PORT</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$PATH_FOR_PERSISTENT_DATA</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e.g.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sh</span><span class="token plain"> seata-server.sh </span><span class="token number" style="color:#36acaa">8091</span><span class="token plain"> /home/admin/seata/data/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-5-run-example">Step 5: Run example<a href="#step-5-run-example" class="hash-link" aria-label="Direct link to Step 5: Run example" title="Direct link to Step 5: Run example">​</a></h3><ul><li>Start AccountService (<a href="https://github.com/apache/incubator-seata-samples/blob/master/dubbo/src/main/java/com/seata/seata/samples/dubbo/starter/DubboAccountServiceStarter.java" target="_blank" rel="noopener noreferrer">DubboAccountServiceStarter</a>).</li><li>Start StorageService (<a href="https://github.com/apache/incubator-seata-samples/blob/master/dubbo/src/main/java/com/seata/seata/samples/dubbo/starter/DubboStorageServiceStarter.java" target="_blank" rel="noopener noreferrer">DubboStorageServiceStarter</a>).</li><li>Start OrderService (<a href="https://github.com/apache/incubator-seata-samples/blob/master/dubbo/src/main/java/com/seata/seata/samples/dubbo/starter/DubboOrderServiceStarter.java" target="_blank" rel="noopener noreferrer">DubboOrderServiceStarter</a>).</li><li>Run BusinessService for test (<a href="https://github.com/apache/incubator-seata-samples/blob/master/dubbo/src/main/java/com/seata/seata/samples/dubbo/starter/DubboBusinessTester.java" target="_blank" rel="noopener noreferrer">DubboBusinessTester</a>).</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="related-projects">Related projects<a href="#related-projects" class="hash-link" aria-label="Direct link to Related projects" title="Direct link to Related projects">​</a></h3><ul><li>seata:          <a href="https://github.com/apache/incubator-seata/" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata/</a></li><li>seata-samples : <a href="https://github.com/apache/incubator-seata-samples" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seata-samples</a></li></ul>]]></content>
        <author>
            <name>slievrly</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Unveiling the Principles of Fescar Distributed Transaction]]></title>
        <id>https://seata.apache.org/blog/seata-analysis-simple</id>
        <link href="https://seata.apache.org/blog/seata-analysis-simple"/>
        <updated>2019-02-18T00:00:00.000Z</updated>
        <author>
            <name>kailin.chen</name>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[MT mode]]></title>
        <id>https://seata.apache.org/blog/manual-transaction-mode</id>
        <link href="https://seata.apache.org/blog/manual-transaction-mode"/>
        <updated>2019-02-13T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[introduce MT mode]]></summary>
        <content type="html"><![CDATA[<p>Review the description in the overview: a distributed global transaction, the whole is a model of <strong>the two-phase commit</strong>. A global transaction consists of several branch transactions that meet the model requirements of <strong>the two-phase commit</strong>, which requires each branch transaction to have its own:</p><ul><li>One phase prepare behavior</li><li>Two phase commit or rollback behavior</li></ul><p><img loading="lazy" src="https://upload-images.jianshu.io/upload_images/4420767-e48f0284a037d1df.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Overview of a global transaction" class="img_ev3q"></p><p>According to the two phase behavior pattern，We divide the branch transaction into <strong>Automatic (Branch) Transaction Mode</strong> and <strong>Manual (Branch) Transaction Mode</strong>.</p><p>The AT mode is based on the <strong>Relational Database</strong> that <strong>supports local ACID transactions</strong>：</p><ul><li>One phase prepare behavior: In the local transaction, the business data update and the corresponding rollback log record are submitted together.</li><li>Two phase commit behavior: Immediately ended successfully, <strong>Auto</strong> asynchronous batch cleanup of the rollback log.</li><li>Two phase rollback behavior: By rolling back the log, <strong>automatic</strong> generates a compensation operation to complete the data rollback.</li></ul><p>Accordingly, the MT mode does not rely on transaction support for the underlying data resources:</p><ul><li>One phase prepare behavior: Call the prepare logic of <strong>custom</strong> .</li><li>Two phase commit behavior:Call the commit logic of <strong>custom</strong> .</li><li>Two phase rollback behavior:Call the rollback logic of <strong>custom</strong> .</li></ul><p>The so-called MT mode refers to the support of the branch transaction of <strong>custom</strong> into the management of global transactions.</p>]]></content>
        <author>
            <name>kmmshmily</name>
        </author>
    </entry>
</feed>