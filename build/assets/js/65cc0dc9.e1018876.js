"use strict";(self.webpackChunkseata_website=self.webpackChunkseata_website||[]).push([[93718],{65341:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>l});var r=t(74848),i=t(28453);const o={title:"Integrating Seata (formerly Fescar) Distributed Transaction with Spring Cloud",author:"dafei.Fei",date:"2019/04/15",keywords:["fescar","seata","distributed transaction"]},a="1. Introduction",s={permalink:"/blog/integrate-seata-with-spring-cloud",editUrl:"https://github.com/apache/incubator-seata-website/blob/docusaurus/i18n/en/docusaurus-plugin-content-blog/integrate-seata-with-spring-cloud.md",source:"@site/i18n/en/docusaurus-plugin-content-blog/integrate-seata-with-spring-cloud.md",title:"Integrating Seata (formerly Fescar) Distributed Transaction with Spring Cloud",description:"Many developers are already familiar with Fescar. However, Fescar has now transformed into Seata. If you're not aware of Seata, please check the following link.",date:"2019-04-15T00:00:00.000Z",formattedDate:"April 15, 2019",tags:[],readingTime:5.995,hasTruncateMarker:!1,authors:[{name:"dafei.Fei"}],frontMatter:{title:"Integrating Seata (formerly Fescar) Distributed Transaction with Spring Cloud",author:"dafei.Fei",date:"2019/04/15",keywords:["fescar","seata","distributed transaction"]},unlisted:!1,prevItem:{title:"Fescar Integration with Spring Cloud In-Depth Analysis of Source Code",permalink:"/blog/how-to-support-spring-cloud"},nextItem:{title:"Detailed Explanation of Seata-Client Principles and Processes in Distributed Transactions",permalink:"/blog/seata-analysis-java-client"}},c={authorsImageUrls:[void 0]},l=[];function d(e){const n={a:"a",code:"code",h1:"h1",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"Many developers are already familiar with Fescar. However, Fescar has now transformed into Seata. If you're not aware of Seata, please check the following link."}),"\n",(0,r.jsxs)(n.p,{children:["SEATA GITHUB: [",(0,r.jsx)(n.a,{href:"https://github.com/apache/incubator-seata",children:"https://github.com/apache/incubator-seata"}),"]"]}),"\n",(0,r.jsx)(n.p,{children:"We extend our sincere thanks and greetings to the Alibaba team for their contributions in bringing numerous open-source software to developers."}),"\n",(0,r.jsx)(n.p,{children:"Today, I will share my insights on integrating Seata with Spring Cloud, aiming to help more developers avoid common pitfalls and streamline their setup process."}),"\n",(0,r.jsx)(n.h1,{id:"2-project-overview",children:"2. Project Overview"}),"\n",(0,r.jsx)(n.p,{children:"The setup process is as follows: client -> gateway -> service consumer -> service provider."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Technical Framework: spring cloud gateway\nspring cloud fegin\nnacos1.0.RC2\nfescar-server0.4.1 (Seata)\n"})}),"\n",(0,r.jsxs)(n.p,{children:["For instructions on starting Nacos, please refer to: ",(0,r.jsx)(n.a,{href:"https://nacos.io/zh-cn/docs/quick-start.html",children:"Nacos Startup Guide"})]}),"\n",(0,r.jsxs)(n.p,{children:["Seata supports various service registration methods. In the ",(0,r.jsx)(n.code,{children:"fescar-server-0.4.1\\conf"})," directory, you will find:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"file.conf\nlogback.xml\nnacos-config.sh\nnacos-config.text\nregistry.conf\n"})}),"\n",(0,r.jsxs)(n.p,{children:["There are a total of five files. Among them, ",(0,r.jsx)(n.code,{children:"file.conf"})," and ",(0,r.jsx)(n.code,{children:"registry.conf"})," are needed in the code segments for both service consumers and providers. Note: ",(0,r.jsx)(n.code,{children:"file.conf"})," and ",(0,r.jsx)(n.code,{children:"registry.conf"})," must be included in the current applications in use, i.e., both service consumer and provider applications must include them. If you are using a configuration center like Nacos or ZK, ",(0,r.jsx)(n.code,{children:"file.cnf"})," can be ignored. However, if ",(0,r.jsx)(n.code,{children:'type="file"'})," is specified, then ",(0,r.jsx)(n.code,{children:"file.cnf"})," must be used."]}),"\n",(0,r.jsxs)(n.p,{children:["Below is the configuration information in the ",(0,r.jsx)(n.code,{children:"registry.conf"})," file. The ",(0,r.jsx)(n.code,{children:"registry"})," section is for the service registration center configuration, and the ",(0,r.jsx)(n.code,{children:"config"})," section is for the configuration center."]}),"\n",(0,r.jsxs)(n.p,{children:["As shown below, Seata currently supports nacos, file, eureka, redis, zookeeper, etc., for registration and configuration. The default downloaded configuration type is ",(0,r.jsx)(n.code,{children:"file"}),". The choice of method depends on your project\u2019s actual requirements. Here, I chose nacos, but eureka can also be used. Both versions have been tested and work fine."]}),"\n",(0,r.jsx)(n.p,{children:"Note: If you are integrating with eureka, please use the latest official version."}),"\n",(0,r.jsx)(n.h1,{id:"3-core-configuration",children:"3. Core Configuration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'registry {\n  # file, nacos, eureka, redis, zk\n  type = "nacos"\n\n  nacos {\n    serverAddr = "localhost"\n    namespace = "public"\n    cluster = "default"\n  }\n  eureka {\n    serviceUrl = "http://localhost:1001/eureka"\n    application = "default"\n    weight = "1"\n  }\n  redis {\n    serverAddr = "localhost:6379"\n    db = "0"\n  }\n  zk {\n    cluster = "default"\n    serverAddr = "127.0.0.1:2181"\n    session.timeout = 6000\n    connect.timeout = 2000\n  }\n  file {\n    name = "file.conf"\n  }\n}\n\nconfig {\n  # file, nacos, apollo, zk\n  type = "nacos"\n\n  nacos {\n    serverAddr = "localhost"\n    namespace = "public"\n    cluster = "default"\n  }\n  apollo {\n    app.id = "fescar-server"\n    apollo.meta = "http://192.168.1.204:8801"\n  }\n  zk {\n    serverAddr = "127.0.0.1:2181"\n    session.timeout = 6000\n    connect.timeout = 2000\n  }\n  file {\n    name = "file.conf"\n  }\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Note that ",(0,r.jsx)(n.code,{children:"nacos-config.sh"})," is a script that needs to be executed if using Nacos as the configuration center. It initializes some default settings for Nacos."]}),"\n",(0,r.jsx)(n.p,{children:"Refer to the official guide for SEATA startup: Note that the official startup command separates parameters with spaces, so be careful. The IP is an optional parameter. Due to DNS resolution, sometimes when registering with Nacos, Fescar might obtain the address using the computer name, requiring you to specify the IP or configure the host to point to the IP. This issue has been fixed in the latest SEATA version."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"sh fescar-server.sh 8091 /home/admin/fescar/data/ IP (optional)\n"})}),"\n",(0,r.jsxs)(n.p,{children:["As mentioned earlier, ",(0,r.jsx)(n.code,{children:"file.conf"})," and ",(0,r.jsx)(n.code,{children:"registry.conf"})," are needed in our code. The focus here is on ",(0,r.jsx)(n.code,{children:"file.conf"}),". It is only loaded if ",(0,r.jsx)(n.code,{children:"registry"})," is configured with ",(0,r.jsx)(n.code,{children:"file"}),". If using ZK, Nacos, or other configuration centers, it can be ignored. However, ",(0,r.jsx)(n.code,{children:"service.localRgroup.grouplist"})," and ",(0,r.jsx)(n.code,{children:"service.vgroupMapping"})," need to be specified in the configuration center so that your client can automatically obtain the corresponding SEATA service and address from the configuration center upon startup. Failure to configure this will result in an error due to the inability to connect to the server. If using eureka, the config section should specify ",(0,r.jsx)(n.code,{children:'type="file"'}),". SEATA config currently does not support eureka."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'transport {\n  # tcp, udt, unix-domain-socket\n  type = "TCP"\n  # NIO, NATIVE\n  server = "NIO"\n  # enable heartbeat\n  heartbeat = true\n  # thread factory for netty\n  thread-factory {\n    boss-thread-prefix = "NettyBoss"\n    worker-thread-prefix = "NettyServerNIOWorker"\n    server-executor-thread-prefix = "NettyServerBizHandler"\n    share-boss-worker = false\n    client-selector-thread-prefix = "NettyClientSelector"\n    client-selector-thread-size = 1\n    client-worker-thread-prefix = "NettyClientWorkerThread"\n    # netty boss thread size, will not be used for UDT\n    boss-thread-size = 1\n    # auto default pin or 8\n    worker-thread-size = 8\n  }\n}\nservice {\n  # vgroup -> rgroup\n  vgroup_mapping.service-provider-fescar-service-group = "default"\n  # only support single node\n  localRgroup.grouplist = "127.0.0.1:8091"\n  # degrade current not support\n  enableDegrade = false\n  # disable\n  disable = false\n}\n\nclient {\n  async.commit.buffer.limit = 10000\n  lock {\n    retry.internal = 10\n    retry.times = 30\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h1,{id:"4-service-details",children:"4. Service Details"}),"\n",(0,r.jsx)(n.p,{children:"Two key points need attention:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"grouplist IP: This is the IP and port of the current Fescar server.\nvgroup_mapping configuration.\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"vgroup_mapping.service-provider-fescar-service-group"}),": The service name here is actually the application name configured in the ",(0,r.jsx)(n.code,{children:"application.properties"})," of your consumer or provider, e.g., ",(0,r.jsx)(n.code,{children:"spring.application.name=service-provider"}),". In the source code, the application name is concatenated with ",(0,r.jsx)(n.code,{children:"fescar-service-group"})," to form the key. Similarly, the value is the name of the current Fescar service. ",(0,r.jsx)(n.code,{children:'cluster = "default" / application = "default"'})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'vgroup_mapping.service-provider-fescar-service-group = "default"\n# only support single node\nlocalRgroup.grouplist = "127.0.0.1:8091"\n'})}),"\n",(0,r.jsx)(n.p,{children:"Both provider and consumer need to configure these two files."}),"\n",(0,r.jsx)(n.p,{children:"If you use Nacos as the configuration center, you need to add the configuration in Nacos by adding the configuration manually."}),"\n",(0,r.jsx)(n.h1,{id:"5-transaction-usage",children:"5. Transaction Usage"}),"\n",(0,r.jsx)(n.p,{children:"In my code, the request is load-balanced through the gateway to the consumer. The consumer then requests the provider through Feign. The official example uses Feign, but here, the request is forwarded directly through the gateway, so the global transaction is handled in the controller layer, similar to the official demo."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'@RestController\npublic class DemoController {\n\t@Autowired\n\tprivate DemoFeignClient demoFeignClient;\n\n\t@Autowired\n\tprivate DemoFeignClient2 demoFeignClient2;\n\t@GlobalTransactional(timeoutMills = 300000, name = "spring-cloud-demo-tx")\n\t@GetMapping("/getdemo")\n\tpublic String demo() {\n\n\t\t// Call service A and simply save\n\t\tResponseData<Integer> result = demoFeignClient.insertService("test", 1);\n\t\tif(result.getStatus() == 400) {\n\t\t\tSystem.out.println(result + "+++++++++++++++++++++++++++++++++++++++");\n\t\t\tthrow new RuntimeException("this is error1");\n\t\t}\n\n\t\t// Call service B and test rollback of service A upon error\n\t\tResponseData<Integer> result2 = demoFeignClient2.saveService();\n\n\t\tif(result2.getStatus() == 400) {\n\t\t\tSystem.out.println(result2 + "+++++++++++++++++++++++++++++++++++++++");\n\t\t\tthrow new RuntimeException("this is error2");\n\t\t}\n\n\t\treturn "SUCCESS";\n\t}\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"This concludes the core integration of transactions. Here, service A and B are both providers. When service B encounters an error, the global transaction rolls back. Each transaction can handle its local transactions independently."}),"\n",(0,r.jsxs)(n.p,{children:["SEATA uses a global XID to uniformly identify transactions. I will not list the database tables needed for SEATA here. For details, refer to: ",(0,r.jsx)(n.a,{href:"https://github.com/spring-cloud-incubator/spring-cloud-alibaba/tree/master/spring-cloud-alibaba-examples/fescar-example",children:"spring-cloud-fescar official DEMO"})]}),"\n",(0,r.jsx)(n.h1,{id:"5data-proxy",children:"5.Data Proxy"}),"\n",(0,r.jsxs)(n.p,{children:["Another important point is that in a distributed database service, each database needs an ",(0,r.jsx)(n.code,{children:"undo_log"})," table to handle XID storage."]}),"\n",(0,r.jsx)(n.p,{children:"Additionally, each service project needs a database connection pool proxy. Currently, only Druid connection pool is supported. More will be supported in the future."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'@Configuration\npublic class DatabaseConfiguration {\n\n\t@Bean(destroyMethod = "close", initMethod = "init")\n\t@ConfigurationProperties(prefix="spring.datasource")\n\tpublic DruidDataSource druidDataSource() {\n\t\treturn new DruidDataSource();\n\t}\n\n\t@Bean\n\tpublic DataSourceProxy dataSourceProxy(DruidDataSource druidDataSource) {\n\t\treturn new DataSourceProxy(druidDataSource);\n\t}\n\n    @Bean\n    public SqlSessionFactory sqlSessionFactory(DataSourceProxy dataSourceProxy) throws Exception {\n        SqlSessionFactoryBean factoryBean = new SqlSessionFactoryBean();\n        factoryBean.setDataSource(dataSourceProxy);\n        return factoryBean.getObject();\n    }\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Pay attention to the configuration file and data proxy. Without a data source proxy, ",(0,r.jsx)(n.code,{children:"undo_log"})," will have no data, making XID management impossible."]}),"\n",(0,r.jsx)(n.p,{children:"Author: Da Fei"})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>s});var r=t(96540);const i={},o=r.createContext(i);function a(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);