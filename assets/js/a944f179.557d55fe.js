"use strict";(self.webpackChunkseata_website=self.webpackChunkseata_website||[]).push([[19778],{32414:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>l});var a=t(74848),r=t(28453);const o={title:"Detailed Explanation of Seata-Client Principles and Processes in Distributed Transactions",author:"fangliangsheng",date:"2019/04/15",keywords:["fescar","seata","distributed transaction"]},i=void 0,s={permalink:"/blog/seata-analysis-java-client",editUrl:"https://github.com/apache/incubator-seata-website/blob/docusaurus/i18n/en/docusaurus-plugin-content-blog/seata-analysis-java-client.md",source:"@site/i18n/en/docusaurus-plugin-content-blog/seata-analysis-java-client.md",title:"Detailed Explanation of Seata-Client Principles and Processes in Distributed Transactions",description:"Preface",date:"2019-04-15T00:00:00.000Z",formattedDate:"April 15, 2019",tags:[],readingTime:21.72,hasTruncateMarker:!1,authors:[{name:"fangliangsheng"}],frontMatter:{title:"Detailed Explanation of Seata-Client Principles and Processes in Distributed Transactions",author:"fangliangsheng",date:"2019/04/15",keywords:["fescar","seata","distributed transaction"]},unlisted:!1,prevItem:{title:"Integrating Seata (formerly Fescar) Distributed Transaction with Spring Cloud",permalink:"/blog/integrate-seata-with-spring-cloud"},nextItem:{title:"In-Depth Analysis of One-Stop Distributed Transaction Solution Seata-Server",permalink:"/blog/seata-analysis-java-server"}},c={authorsImageUrls:[void 0]},l=[{value:"Preface",id:"preface",level:2},{value:"Related Concepts",id:"related-concepts",level:2},{value:"Distributed Framework Support",id:"distributed-framework-support",level:2},{value:"Business Logic",id:"business-logic",level:2},{value:"Configuration Files",id:"configuration-files",level:2},{value:"Data Source Proxy",id:"data-source-proxy",level:2},{value:"Start Server",id:"start-server",level:2},{value:"Start Client",id:"start-client",level:2},{value:"TM Process Flow",id:"tm-process-flow",level:2},{value:"RM Processing Flow",id:"rm-processing-flow",level:2},{value:"Transaction Commit",id:"transaction-commit",level:2},{value:"Transaction Rollback",id:"transaction-rollback",level:2},{value:"Summary",id:"summary",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h2,{id:"preface",children:"Preface"}),"\n",(0,a.jsxs)(n.p,{children:["In distributed systems, distributed transactions are a problem that must be solved. Currently, the most commonly used solution is eventual consistency. Since Alibaba open-sourced Fescar (renamed Seata in early April) earlier this year, the project has received great attention, currently nearing 8000 stars. ",(0,a.jsx)(n.a,{href:"https://github.com/apache/incubator-seata",children:"Seata"})," aims to solve the problem of distributed transactions in the microservices field with high performance and zero intrusion. It is currently undergoing rapid iteration, with a near-term goal of producing a production-ready MySQL version. For a comprehensive introduction to Seata, you can check the ",(0,a.jsx)(n.a,{href:"https://github.com/apache/incubator-seata/wiki/%E6%A6%82%E8%A7%88",children:"official WIKI"})," for more detailed information."]}),"\n",(0,a.jsxs)(n.p,{children:["This article is mainly based on the structure of spring cloud+spring jpa+spring cloud alibaba fescar+mysql+seata, building a distributed system demo, and analyzing and explaining its working process and principles from the perspective of the client (RM, TM) through seata's debug logs and source code.\nThe code in the article is based on fescar-0.4.1. Since the project was just renamed to seata not long ago, some package names, class names, and jar package names are still named fescar, so the term fescar is still used in the following text. Sample project: ",(0,a.jsx)(n.a,{href:"https://github.com/fescar-group/fescar-samples/tree/master/springcloud-jpa-seata",children:"https://github.com/fescar-group/fescar-samples/tree/master/springcloud-jpa-seata"})]}),"\n",(0,a.jsx)(n.h2,{id:"related-concepts",children:"Related Concepts"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"XID"}),": The unique identifier of a global transaction, composed of ip:port",":sequence"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Transaction Coordinator (TC)"}),": Maintains the running state of global transactions, responsible for coordinating and driving the commit or rollback of global transactions"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Transaction Manager (TM)"}),": Controls the boundary of global transactions, responsible for starting a global transaction and finally initiating the decision of global commit or rollback"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Resource Manager (RM)"}),": Controls branch transactions, responsible for branch registration, status reporting, and receiving instructions from the transaction coordinator to drive the commit and rollback of branch (local) transactions"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"distributed-framework-support",children:"Distributed Framework Support"}),"\n",(0,a.jsx)(n.p,{children:"Fescar uses XID to represent a distributed transaction. XID needs to be transmitted in the systems involved in a distributed transaction request, to send the processing status of branch transactions to the feacar-server, and to receive commit and rollback instructions from the feacar-server. Fescar officially supports all versions of the dubbo protocol, and the community also provides corresponding implementations for spring cloud (spring-boot) distributed projects."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-alibaba-fescar</artifactId>\n    <version>2.1.0.BUILD-SNAPSHOT</version>\n</dependency>\n"})}),"\n",(0,a.jsx)(n.p,{children:"This component implements the XID transmission function based on RestTemplate and Feign communication."}),"\n",(0,a.jsx)(n.h2,{id:"business-logic",children:"Business Logic"}),"\n",(0,a.jsx)(n.p,{children:"The business logic is the classic process of placing an order, deducting the balance, and reducing inventory. According to the module division, it is divided into three independent services, each connected to the corresponding database:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Order: order-server"}),"\n",(0,a.jsx)(n.li,{children:"Account: account-server"}),"\n",(0,a.jsx)(n.li,{children:"Inventory: storage-server"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"There is also a business system that initiates distributed transactions:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Business: business-server"}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["The project structure is as shown in the figure below:\n",(0,a.jsx)(n.img,{alt:"Insert image description here",src:t(45910).A+"",width:"1034",height:"658"})]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Normal Business"})}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"The business initiates a purchase request"}),"\n",(0,a.jsx)(n.li,{children:"Storage deducts inventory"}),"\n",(0,a.jsx)(n.li,{children:"Order creates an order"}),"\n",(0,a.jsx)(n.li,{children:"Account deducts balance"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Abnormal Business"})}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"The business initiates a purchase request"}),"\n",(0,a.jsx)(n.li,{children:"Storage deducts inventory"}),"\n",(0,a.jsx)(n.li,{children:"Order creates an order"}),"\n",(0,a.jsxs)(n.li,{children:["Account ",(0,a.jsx)(n.code,{children:"deduct balance exception"})]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"In the normal process, the data of steps 2, 3, and 4 is normally updated globally commit. In the abnormal process, the data is globally rolled back due to the exception error in step 4."}),"\n",(0,a.jsx)(n.h2,{id:"configuration-files",children:"Configuration Files"}),"\n",(0,a.jsxs)(n.p,{children:["The configuration entry file for fescar is ",(0,a.jsx)(n.a,{href:"https://github.com/apache/incubator-seata/blob/develop/config/src/main/resources/registry.conf",children:"registry.conf"}),". Check the code ",(0,a.jsx)(n.a,{href:"https://github.com/apache/incubator-seata/blob/develop/config/src/main/java/com/alibaba/fescar/config/ConfigurationFactory.java",children:"ConfigurationFactory"})," to find that currently, the configuration file name can only be registry.conf and cannot be specified otherwise."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'private static final String REGISTRY_CONF = "registry.conf";\npublic static final Configuration FILE_INSTANCE = new FileConfiguration(REGISTRY_CONF);\n'})}),"\n",(0,a.jsxs)(n.p,{children:["In ",(0,a.jsx)(n.code,{children:"registry"}),", you can specify the specific configuration form, the default is to use the file type. In file.conf, there are 3 parts of the configuration content:"]}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"transport"}),"\nThe transport part configuration corresponds to the ",(0,a.jsx)(n.a,{href:"https://github.com/apache/incubator-seata/blob/develop/core/src/main/java/com/alibaba/fescar/core/rpc/netty/NettyServerConfig.java",children:"NettyServerConfig"})," class, used to define Netty-related parameters. TM and RM communicate with fescar-server using Netty."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"service"})}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:'service {\n    #vgroup->rgroup\n    vgroup_mapping.my_test_tx_group = "default"\n    #Configure the address for the Client to connect to TC\n    default.grouplist = "127.0.0.1:8091"\n    #degrade current not support\n    enableDegrade = false\n    #disable\n    Whether to enable seata distributed transaction\n    disableGlobalTransaction = false\n}\n'})}),"\n",(0,a.jsxs)(n.ol,{start:"3",children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.strong,{children:"client"})}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",children:"client {\n    #RM receives the upper limit of buffer after TC's commit notification\n    async.commit.buffer.limit = 10000\n    lock {\n      retry.internal = 10\n      retry.times = 30\n    }\n}\n"})}),"\n",(0,a.jsx)(n.h2,{id:"data-source-proxy",children:"Data Source Proxy"}),"\n",(0,a.jsxs)(n.p,{children:["In addition to the previous configuration files, fescar in AT mode has a bit of code volume, which is for the proxy of the data source, and currently can only be based on the proxy of ",(0,a.jsx)(n.code,{children:"DruidDataSource"}),". Note: In the latest release of version 0.4.2, it has supported any data source type."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'@Bean\n@ConfigurationProperties(prefix = "spring.datasource")\npublic DruidDataSource druidDataSource() {\n    DruidDataSource druidDataSource = new DruidDataSource();\n    return druidDataSource;\n}\n@Primary\n@Bean("dataSource")\npublic DataSourceProxy dataSource(DruidDataSource druidDataSource) {\n    return new DataSourceProxy(druidDataSource);\n}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["The purpose of using ",(0,a.jsx)(n.code,{children:"DataSourceProxy"})," is to introduce ",(0,a.jsx)(n.code,{children:"ConnectionProxy"}),". One aspect of fescar's non-intrusiveness is reflected in the implementation of ",(0,a.jsx)(n.code,{children:"ConnectionProxy"}),". The cut-in point for branch transactions to join global transactions is at the local transaction's ",(0,a.jsx)(n.code,{children:"commit"})," stage. This design ensures that business data and ",(0,a.jsx)(n.code,{children:"undo_log"})," are in a local transaction. The ",(0,a.jsx)(n.code,{children:"undo_log"})," table needs to be created in the business library, and fescar depends on this table to record the status of each branch transaction and the rollback data of the second stage. There is no need to worry about the table's data volume becoming a single point problem. In the case of a global transaction commit, the transaction's corresponding ",(0,a.jsx)(n.code,{children:"undo_log"})," will be asynchronously deleted."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE `undo_log` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `branch_id` bigint(20) NOT NULL,\n  `xid` varchar(100) NOT NULL,\n  `rollback_info` longblob NOT NULL,\n  `log_status` int(11) NOT NULL,\n  `log_created` datetime NOT NULL,\n  `log_modified` datetime NOT NULL,\n  `ext` varchar(100) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `ux_undo_log` (`xid`, `branch_id`)\n) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;\n"})}),"\n",(0,a.jsx)(n.h2,{id:"start-server",children:"Start Server"}),"\n",(0,a.jsxs)(n.p,{children:["Go to ",(0,a.jsx)(n.a,{href:"https://github.com/apache/incubator-seata/releases",children:"https://github.com/apache/incubator-seata/releases"})," to download the fescar-server version corresponding to the Client version to avoid protocol inconsistencies caused by different versions. Enter the bin directory after decompression and execute"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"./fescar-server.sh 8091 ../data\n"})}),"\n",(0,a.jsx)(n.p,{children:"If the startup is successful, the following output will be shown"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"2019-04-09 20:27:24.637 INFO [main] c.a.fescar.core.rpc.netty.AbstractRpcRemotingServer.start:152 -Server started ...\n"})}),"\n",(0,a.jsx)(n.h2,{id:"start-client",children:"Start Client"}),"\n",(0,a.jsxs)(n.p,{children:["The loading entry class of fescar is located in ",(0,a.jsx)(n.a,{href:"https://github.com/spring-cloud-incubator/spring-cloud-alibaba/blob/finchley/spring-cloud-alibaba-fescar/src/main/java/org/springframework/cloud/alibaba/fescar/GlobalTransactionAutoConfiguration.java",children:"GlobalTransactionAutoConfiguration"}),", which can be automatically loaded for spring boot-based projects, and of course, it can also be instantiated by other means."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'@Configuration\n@EnableConfigurationProperties({FescarProperties.class})\npublic class GlobalTransactionAutoConfiguration {\n    private final ApplicationContext applicationContext;\n    private final FescarProperties fescarProperties;\n    public GlobalTransactionAutoConfiguration(ApplicationContext applicationContext, FescarProperties fescarProperties) {\n\n\n        this.applicationContext = applicationContext;\n        this.fescarProperties = fescarProperties;\n    }\n    /**\n     * Instantiate GlobalTransactionScanner\n     * scanner is the initialization initiator for the client\n     */\n    @Bean\n    public GlobalTransactionScanner globalTransactionScanner() {\n        String applicationName = this.applicationContext.getEnvironment().getProperty("spring.application.name");\n        String txServiceGroup = this.fescarProperties.getTxServiceGroup();\n        if (StringUtils.isEmpty(txServiceGroup)) {\n            txServiceGroup = applicationName + "-fescar-service-group";\n            this.fescarProperties.setTxServiceGroup(txServiceGroup);\n        }\n        return new GlobalTransactionScanner(applicationName, txServiceGroup);\n    }\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"You can see that it supports a configuration item FescarProperties, used to configure the transaction group name"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:"spring.cloud.alibaba.fescar.tx-service-group=my_test_tx_group\n"})}),"\n",(0,a.jsx)(n.p,{children:'If the service group is not specified, the default name generated is spring.application.name + "-fescar-service-group". Therefore, if spring.application.name is not specified, it will report an error when starting.'}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'@ConfigurationProperties("spring.cloud.alibaba.fescar")\npublic class FescarProperties {\n    private String txServiceGroup;\n    public FescarProperties() {}\n    public String getTxServiceGroup() {\n        return this.txServiceGroup;\n    }\n    public void setTxServiceGroup(String txServiceGroup) {\n        this.txServiceGroup = txServiceGroup;\n    }\n}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["After obtaining the applicationId and txServiceGroup, create a ",(0,a.jsx)(n.a,{href:"https://github.com/apache/incubator-seata/blob/develop/spring/src/main/java/com/alibaba/fescar/spring/annotation/GlobalTransactionScanner.java",children:"GlobalTransactionScanner"})," object, mainly seeing the initClient method in the class."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'private void initClient() {\n    if (StringUtils.isNullOrEmpty(applicationId) || StringUtils.isNullOrEmpty(txServiceGroup)) {\n        throw new IllegalArgumentException("applicationId: " + applicationId + " txServiceGroup: " + txServiceGroup);\n    }\n    // init TM\n    TMClient.init(applicationId, txServiceGroup);\n    // init RM\n    RMClient.init(applicationId, txServiceGroup);\n}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["In the method, you can see that ",(0,a.jsx)(n.code,{children:"TMClient"})," and ",(0,a.jsx)(n.code,{children:"RMClient"})," are initialized. For a service, it can be both TM and RM roles. When it is TM or RM depends on whether the ",(0,a.jsx)(n.code,{children:"@GlobalTransactional"})," annotation is marked in a global transaction. The result of the Client creation is a Netty connection with TC, so you can see two Netty Channels in the startup log, indicating that the transactionRole is ",(0,a.jsx)(n.code,{children:"TMROLE"})," and ",(0,a.jsx)(n.code,{children:"RMROLE"}),"."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'2019-04-09 13:42:57.417 INFO 93715 --- [imeoutChecker_1] c.a.f.c.rpc.netty.NettyPoolableFactory : NettyPool create channel to {"address":"127.0.0.1:8091", "message":{"applicationId":"business-service", "byteBuffer":{"char":"\\u0000","direct":false,"double":0.0,"float":0.0,"int":0,"long":0,"readOnly":false,"short":0},"transactionServiceGroup":"my_test_tx_group","typeCode":101,"version":"0.4.1"},"transactionRole":"TMROLE"}\n2019-04-09 13:42:57.505 INFO 93715 --- [imeoutChecker_1] c.a.f.c.rpc.netty.NettyPoolableFactory : NettyPool create channel to {"address":"127.0.0.1:8091", "message":{"applicationId":"business-service", "byteBuffer":{"char":"\\u0000","direct":false,"double":0.0,"float":0.0,"int":0,"long":0,"readOnly":false,"short":0},"transactionServiceGroup":"my_test_tx_group","typeCode":103,"version":"0.4.1"},"transactionRole":"RMROLE"}\n2019-04-09 13:42:57.629 DEBUG 93715 --- [lector_TMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler : Send:RegisterTMRequest{applicationId=\'business-service\', transactionServiceGroup=\'my_test_tx_group\'}\n2019-04-09 13:42:57.629 DEBUG 93715 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler : Send:RegisterRMRequest{resourceIds=\'null\', applicationId=\'business-service\', transactionServiceGroup=\'my_test_tx_group\'}\n2019-04-09 13:42:57.699 DEBUG 93715 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler : Receive:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null,messageId:1\n2019-04-09 13:42:57.699 DEBUG 93715 --- [lector_TMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler : Receive:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null,messageId:2\n2019-04-09 13:42:57.701 DEBUG 93715 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting : com.alibaba.fescar.core.rpc.netty.RmRpcClient@3b06d101 msgId:1 future :com.alibaba.fescar.core.protocol.MessageFuture@28bb1abd body:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null\n2019-04-09 13:42:57.701 DEBUG 93715 --- [lector_TMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting : com.alibaba.fescar.core.rpc.netty.TmRpcClient@65fc3fb7 msgId:2 future :com.alibaba.fescar.core.protocol.MessageFuture@9a1e3df body:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null\n2019-04-09 13:42:57.710 INFO 93715 --- [imeoutChecker_1] c.a.fescar.core.rpc.netty.RmRpcClient : register RM success. server version:0.4.1 channel:[id: 0xe6468995 L:/127.0.0.1:57397 - R:/127.0.0.1:8091]\n2019-04-09 13:42:57.710 INFO 93715 --- [imeoutChecker_1] c.a.f.c.rpc.netty.NettyPoolableFactory : register success cost 114 ms version:0.4.1 role:TMROLE channel:[id: 0xd22fe0c5 L:/127.0.0.1:57398 - R:/127.0.0.1:8091]\n2019-04-09 13:42:57.711 INFO 93715 --- [imeoutChecker_1] c.a.f.c.rpc.netty.NettyPoolableFactory : register success cost 125 ms version:0.4.1 role:RMROLE channel:[id: 0xe6468995 L:/127.0.0.1:57397 - R:/127.0.0.1:8091]\n'})}),"\n",(0,a.jsx)(n.p,{children:"The log shows"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"Create Netty connection"}),"\n",(0,a.jsx)(n.li,{children:"Send registration request"}),"\n",(0,a.jsx)(n.li,{children:"Receive response result"}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"RmRpcClient"}),", ",(0,a.jsx)(n.code,{children:"TmRpcClient"})," successfully instantiated"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"tm-process-flow",children:"TM Process Flow"}),"\n",(0,a.jsxs)(n.p,{children:["In this example, the TM role is business-service. The purchase method of BusinessService is marked with the ",(0,a.jsx)(n.code,{children:"@GlobalTransactional"})," annotation."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"@Service\npublic class BusinessService {\n    @Autowired\n    private StorageFeignClient storageFeignClient;\n    @Autowired\n    private OrderFeignClient orderFeignClient;\n    @GlobalTransactional\n    public void purchase(String userId, String commodityCode, int orderCount) {\n        storageFeignClient.deduct(commodityCode, orderCount);\n        orderFeignClient.create(userId, commodityCode, orderCount);\n    }\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["After the method is called, a global transaction will be created. First, pay attention to the function of the ",(0,a.jsx)(n.code,{children:"@GlobalTransactional"})," annotation, which is intercepted and processed in the ",(0,a.jsx)(n.a,{href:"https://github.com/apache/incubator-seata/blob/develop/spring/src/main/java/com/alibaba/fescar/spring/annotation/GlobalTransactionalInterceptor.java",children:"GlobalTransactionalInterceptor"}),"."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"/**\n * AOP intercepts method calls\n */\n@Override\npublic Object invoke(final MethodInvocation methodInvocation) throws Throwable {\n    Class<?> targetClass = (methodInvocation.getThis() != null ? AopUtils.getTargetClass(methodInvocation.getThis()) : null);\n    Method specificMethod = ClassUtils.getMostSpecificMethod(methodInvocation.getMethod(), targetClass);\n    final Method method = BridgeMethodResolver.findBridgedMethod(specificMethod);\n    // Get the GlobalTransactional annotation of the method\n    final GlobalTransactional globalTransactionalAnnotation = getAnnotation(method, GlobalTransactional.class);\n    final GlobalLock globalLockAnnotation = getAnnotation(method, GlobalLock.class);\n    // If the method has the GlobalTransactional annotation, intercept the corresponding method processing\n    if (globalTransactionalAnnotation != null) {\n        return handleGlobalTransaction(methodInvocation, globalTransactionalAnnotation);\n    } else if (globalLockAnnotation != null) {\n        return handleGlobalLock(methodInvocation);\n    } else {\n        return methodInvocation.proceed();\n    }\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"handleGlobalTransaction"})," method calls the execute method of the [TransactionalTemplate](",(0,a.jsx)(n.a,{href:"https://github.com/apache/incubator-seata/blob/develop/tm/src/main/java",children:"https://github.com/apache/incubator-seata/blob/develop/tm/src/main/java"})]}),"\n",(0,a.jsx)(n.p,{children:"/com/alibaba/fescar/tm/api/TransactionalTemplate.java). As the class name suggests, this is a standard template method that defines the standard steps for TM to handle global transactions. The comments are already quite clear."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"public Object execute(TransactionalExecutor business) throws TransactionalExecutor.ExecutionException {\n    // 1. get or create a transaction\n    GlobalTransaction tx = GlobalTransactionContext.getCurrentOrCreate();\n    try {\n        // 2. begin transaction\n        try {\n            triggerBeforeBegin();\n            tx.begin(business.timeout(), business.name());\n            triggerAfterBegin();\n        } catch (TransactionException txe) {\n            throw new TransactionalExecutor.ExecutionException(tx, txe, TransactionalExecutor.Code.BeginFailure);\n        }\n        Object rs = null;\n        try {\n            // Do Your Business\n            rs = business.execute();\n        } catch (Throwable ex) {\n            // 3. any business exception rollback.\n            try {\n                triggerBeforeRollback();\n                tx.rollback();\n                triggerAfterRollback();\n                // 3.1 Successfully rolled back\n                throw new TransactionalExecutor.ExecutionException(tx, TransactionalExecutor.Code.RollbackDone, ex);\n            } catch (TransactionException txe) {\n                // 3.2 Failed to rollback\n                throw new TransactionalExecutor.ExecutionException(tx, txe, TransactionalExecutor.Code.RollbackFailure, ex);\n            }\n        }\n        // 4. everything is fine commit.\n        try {\n            triggerBeforeCommit();\n            tx.commit();\n            triggerAfterCommit();\n        } catch (TransactionException txe) {\n            // 4.1 Failed to commit\n            throw new TransactionalExecutor.ExecutionException(tx, txe, TransactionalExecutor.Code.CommitFailure);\n        }\n        return rs;\n    } finally {\n        // 5. clear\n        triggerAfterCompletion();\n        cleanUp();\n    }\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["The begin method of ",(0,a.jsx)(n.a,{href:"https://github.com/apache/incubator-seata/blob/develop/tm/src/main/java/com/alibaba/fescar/tm/api/DefaultGlobalTransaction.java",children:"DefaultGlobalTransaction"})," is called to start a global transaction."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'public void begin(int timeout, String name) throws TransactionException {\n    if (role != GlobalTransactionRole.Launcher) {\n        check();\n        if (LOGGER.isDebugEnabled()) {\n            LOGGER.debug("Ignore Begin(): just involved in global transaction [" + xid + "]");\n        }\n        return;\n    }\n    if (xid != null) {\n        throw new IllegalStateException();\n    }\n    if (RootContext.getXID() != null) {\n        throw new IllegalStateException();\n    }\n    // Specific method to start the transaction, get the XID returned by TC\n    xid = transactionManager.begin(null, null, name, timeout);\n    status = GlobalStatus.Begin;\n    RootContext.bind(xid);\n    if (LOGGER.isDebugEnabled()) {\n        LOGGER.debug("Begin a NEW global transaction [" + xid + "]");\n    }\n}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["At the beginning of the method, ",(0,a.jsx)(n.code,{children:"if (role != GlobalTransactionRole.Launcher)"})," checks the role to determine whether the current role is the initiator (Launcher) or the participant (Participant) of the global transaction. If the ",(0,a.jsx)(n.code,{children:"@GlobalTransactional"})," annotation is also added to the downstream system methods in a distributed transaction, its role is Participant, and the subsequent begin will be ignored and directly returned. The determination of whether it is a Launcher or Participant is based on whether the current context already has an XID. The one without an XID is the Launcher, and the one with an XID is the Participant. Therefore, the creation of a global transaction can only be executed by the Launcher, and only one Launcher exists in a distributed transaction."]}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.a,{href:"https://github.com/apache/incubator-seata/blob/develop/tm/src/main/java/com/alibaba/fescar/tm/DefaultTransactionManager.java",children:"DefaultTransactionManager"})," is responsible for TM and TC communication, sending begin, commit, rollback instructions."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"@Override\npublic String begin(String applicationId, String transactionServiceGroup, String name, int timeout) throws TransactionException {\n    GlobalBeginRequest request = new GlobalBeginRequest();\n    request.setTransactionName(name);\n    request.setTimeout(timeout);\n    GlobalBeginResponse response = (GlobalBeginResponse) syncCall(request);\n    return response.getXid();\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"At this point, the XID returned by fescar-server indicates that a global transaction has been successfully created. The log also reflects the above process."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"2019-04-09 13:46:57.417 DEBUG 31326 --- [nio-8084-exec-1] c.a.f.c.rpc.netty.AbstractRpcRemoting : offer message: timeout=60000, transactionName=purchase(java.lang.String, java.lang.String, int)\n2019-04-09 13:46:57.417 DEBUG 31326 --- [geSend_TMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting : write message:FescarMergeMessage, timeout=60000, transactionName=purchase(java.lang.String, java.lang.String, int) channel:[id: 0xa148545e L:/127.0.0.1:56120 - R:/127.0.0.1:8091] active?true, writable?true, isopen?true\n2019-04-09 13:46:57.418 DEBUG 31326 --- [lector_TMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler : Send:FescarMergeMessage, timeout=60000, transactionName=purchase(java.lang.String, java.lang.String, int)\n2019-04-09 13:46:57.421 DEBUG 31326 --- [lector_TMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler : Receive:MergeResultMessage, com.alibaba.fescar.core.protocol.transaction.GlobalBeginResponse@2dc480dc, messageId:1\n2019-04-09 13:46:57.421 DEBUG 31326 --- [nio-8084-exec-1] c.a.fescar.core.context.RootContext : bind 192.168.224.93:8091:2008502699\n2019-04-09 13:46:57.421 DEBUG 31326 --- [nio-8084-exec-1] c.a.f.tm.api.DefaultGlobalTransaction : Begin a NEW global transaction [192.168.224.93:8091:2008502699]\n"})}),"\n",(0,a.jsxs)(n.p,{children:["After the global transaction is created, business.execute() is executed, which is the business code ",(0,a.jsx)(n.code,{children:"storageFeignClient.deduct(commodityCode, orderCount)"})," that enters the RM processing flow. The business logic here is to call the inventory service's deduct inventory interface."]}),"\n",(0,a.jsx)(n.h2,{id:"rm-processing-flow",children:"RM Processing Flow"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'@GetMapping(path = "/deduct")\npublic Boolean deduct(String commodityCode, Integer count) {\n    storageService.deduct(commodityCode, count);\n    return true;\n}\n@Transactional\npublic void deduct(String commodityCode, int count) {\n    Storage storage = storageDAO.findByCommodityCode(commodityCode);\n    storage.setCount(storage.getCount() - count);\n    storageDAO.save(storage);\n}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["The interface and service method of storage do not appear to have fescar-related code and annotations, reflecting fescar's non-intrusiveness. How does it join this global transaction? The answer is in the ",(0,a.jsx)(n.a,{href:"https://github.com/apache/incubator-seata/blob/develop/rm-datasource/src/main/java/com/alibaba/fescar/rm/datasource/ConnectionProxy.java",children:"ConnectionProxy"}),", which is why the ",(0,a.jsx)(n.code,{children:"DataSourceProxy"})," must be used. Through DataSourceProxy, fescar can register branch transactions and send RM's processing results to TC at the cut-in point of local transaction submission in business code. Since the local transaction submission of business code is implemented by the proxy of ",(0,a.jsx)(n.code,{children:"ConnectionProxy"}),", the commit method of ConnectionProxy is actually executed during local transaction submission."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"public void commit() throws SQLException {\n    // If it is a global transaction, perform global transaction submission\n    // Determine if it is a global transaction, just check if there is an XID in the current context\n    if (context.inGlobalTransaction()) {\n        processGlobalTransactionCommit();\n    } else if (context.isGlobalLockRequire()) {\n        processLocalCommitWithGlobalLocks();\n    } else {\n        targetConnection.commit();\n    }\n}\n\nprivate void processGlobalTransactionCommit() throws SQLException {\n    try {\n        // First register RM with TC and get the branchId assigned by TC\n        register();\n    } catch (TransactionException e) {\n        recognizeLockKeyConflictException(e);\n    }\n    try {\n        if (context.hasUndoLog()) {\n            // Write undo log\n            UndoLogManager.flushUndoLogs(this);\n        }\n        // Commit local transaction, write undo_log and business data in a local transaction\n        targetConnection.commit();\n    } catch (Throwable ex) {\n        // Notify TC that RM's transaction processing failed\n        report(false);\n        if (ex instanceof SQLException) {\n            throw new SQLException(ex);\n        }\n    }\n    // Notify TC that RM's transaction processing succeeded\n    report(true);\n    context.reset();\n}\n\nprivate void register() throws TransactionException {\n    // Register RM, build request to send registration instructions to TC via netty\n    Long branchId = DefaultResourceManager.get().branchRegister(BranchType.AT, getDataSourceProxy().getResourceId(), null, context.getXid(), null, context.buildLockKeys());\n    // Save the returned branchId in the context\n    context.setBranchId(branchId);\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"Verify the above process through logs."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'2019-04-09 21:57:48.341 DEBUG 38933 --- [nio-8081-exec-1] o.s.c.a.f.web.FescarHandlerInterceptor : xid in Root\n\nContext null xid in RpcContext 192.168.0.2:8091:2008546211\n2019-04-09 21:57:48.341 DEBUG 38933 --- [nio-8081-exec-1] c.a.fescar.core.context.RootContext : bind 192.168.0.2:8091:2008546211\n2019-04-09 21:57:48.341 DEBUG 38933 --- [nio-8081-exec-1] o.s.c.a.f.web.FescarHandlerInterceptor : bind 192.168.0.2:8091:2008546211 to RootContext\n2019-04-09 21:57:48.386 INFO 38933 --- [nio-8081-exec-1] o.h.h.i.QueryTranslatorFactoryInitiator : HHH000397: Using ASTQueryTranslatorFactory\nHibernate: select storage0_.id as id1_0_, storage0_.commodity_code as commodit2_0_, storage0_.count as count3_0_ from storage_tbl storage0_ where storage0_.commodity_code=?\nHibernate: update storage_tbl set count=? where id=?\n2019-04-09 21:57:48.673 INFO 38933 --- [nio-8081-exec-1] c.a.fescar.core.rpc.netty.RmRpcClient : will connect to 192.168.0.2:8091\n2019-04-09 21:57:48.673 INFO 38933 --- [nio-8081-exec-1] c.a.fescar.core.rpc.netty.RmRpcClient : RM will register :jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false\n2019-04-09 21:57:48.673 INFO 38933 --- [nio-8081-exec-1] c.a.f.c.rpc.netty.NettyPoolableFactory : NettyPool create channel to {"address":"192.168.0.2:8091", "message":{"applicationId":"storage-service", "byteBuffer":{"char":"\\u0000","direct":false,"double":0.0,"float":0.0,"int":0,"long":0,"readOnly":false,"short":0},"resourceIds":"jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false","transactionServiceGroup":"hello-service-fescar-service-group","typeCode":103,"version":"0.4.0"},"transactionRole":"RMROLE"}\n2019-04-09 21:57:48.677 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler : Send:RegisterRMRequest{resourceIds=\'jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false\', applicationId=\'storage-service\', transactionServiceGroup=\'hello-service-fescar-service-group\'}\n2019-04-09 21:57:48.680 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler : Receive:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null,messageId:9\n2019-04-09 21:57:48.680 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting : com.alibaba.fescar.core.rpc.netty.RmRpcClient@7d61f5d4 msgId:9 future :com.alibaba.fescar.core.protocol.MessageFuture@186cd3e0 body:version=0.4.1,extraData=null,identified=true,resultCode=null,msg=null\n2019-04-09 21:57:48.680 INFO 38933 --- [nio-8081-exec-1] c.a.fescar.core.rpc.netty.RmRpcClient : register RM success. server version:0.4.1 channel:[id: 0xd40718e3 L:/192.168.0.2:62607 - R:/192.168.0.2:8091]\n2019-04-09 21:57:48.680 INFO 38933 --- [nio-8081-exec-1] c.a.f.c.rpc.netty.NettyPoolableFactory : register success cost 3 ms version:0.4.1 role:RMROLE channel:[id: 0xd40718e3 L:/192.168.0.2:62607 - R:/192.168.0.2:8091]\n2019-04-09 21:57:48.680 DEBUG 38933 --- [nio-8081-exec-1] c.a.f.c.rpc.netty.AbstractRpcRemoting : offer message: transactionId=2008546211, branchType=AT, resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false, lockKey=storage_tbl:1\n2019-04-09 21:57:48.681 DEBUG 38933 --- [geSend_RMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting : write message:FescarMergeMessage, transactionId=2008546211, branchType=AT, resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false, lockKey=storage_tbl:1 channel:[id: 0xd40718e3 L:/192.168.0.2:62607 - R:/192.168.0.2:8091] active?true, writable?true, isopen?true\n2019-04-09 21:57:48.681 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler : Send:FescarMergeMessage, transactionId=2008546211, branchType=AT, resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false, lockKey=storage_tbl:1\n2019-04-09 21:57:48.687 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler : Receive:MergeResultMessage, BranchRegisterResponse: transactionId=2008546211, branchId=2008546212, result code=Success, getMsg=null, messageId:11\n2019-04-09 21:57:48.702 DEBUG 38933 --- [nio-8081-exec-1] c.a.f.rm.datasource.undo.UndoLogManager : Flushing UNDO LOG: {"branchId":2008546212, "sqlUndoLogs":[{"afterImage":{"rows":[{"fields":[{"keyType":"PrimaryKey","name":"id","type":4,"value":1},{"keyType":"NULL","name":"count","type":4,"value":993}]}],"tableName":"storage_tbl"},"beforeImage":{"rows":[{"fields":[{"keyType":"PrimaryKey","name":"id","type":4,"value":1},{"keyType":"NULL","name":"count","type":4,"value":994}]}],"tableName":"storage_tbl"},"sqlType":"UPDATE","tableName":"storage_tbl"}],"xid":"192.168.0.2:8091:2008546211"}\n2019-04-09 21:57:48.755 DEBUG 38933 --- [nio-8081-exec-1] c.a.f.c.rpc.netty.AbstractRpcRemoting : offer message: transactionId=2008546211, branchId=2008546212, resourceId=null, status=PhaseOne_Done, applicationData=null\n2019-04-09 21:57:48.755 DEBUG 38933 --- [geSend_RMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting : write message:FescarMergeMessage, transactionId=2008546211, branchId=2008546212, resourceId=null, status=PhaseOne_Done, applicationData=null channel:[id: 0xd40718e3 L:/192.168.0.2:62607 - R:/192.168.0.2:8091] active?true, writable?true, isopen?true\n2019-04-09 21:57:48.756 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler : Send:FescarMergeMessage, transactionId=2008546211, branchId=2008546212, resourceId=null, status=PhaseOne_Done, applicationData=null\n2019-04-09 21:57:48.758 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler : Receive:MergeResultMessage, com.alibaba.fescar.core.protocol.transaction.BranchReportResponse@582a08cf, messageId:13\n2019-04-09 21:57:48.799 DEBUG 38933 --- [nio-8081-exec-1] c.a.fescar.core.context.RootContext : unbind 192.168.0.2:8091:2008546211\n2019-04-09 21:57:48.799 DEBUG 38933 --- [nio-8081-exec-1] o.s.c.a.f.web.FescarHandlerInterceptor : unbind 192.168.0.2:8091:2008546211 from RootContext\n'})}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"Get the XID passed from business-service"}),"\n",(0,a.jsx)(n.li,{children:"Bind X"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"ID to the current context\n3. Execute business logic SQL\n4. Create a Netty connection to TC\n5. Send branch transaction information to TC\n6. Get the branchId returned by TC\n7. Record Undo Log data\n8. Send the processing result of PhaseOne stage to TC\n9. Unbind XID from the current context"}),"\n",(0,a.jsxs)(n.p,{children:["Steps 1 and 9 are completed in the ",(0,a.jsx)(n.a,{href:"https://github.com/dongsheep/spring-cloud-alibaba/blob/master/spring-cloud-alibaba-fescar/src/main/java/org/springframework/cloud/alibaba/fescar/web/FescarHandlerInterceptor.java",children:"FescarHandlerInterceptor"}),", which is not part of fescar, but implemented in spring-cloud-alibaba-fescar. It realizes the bind and unbind of xid to the current request context during feign and rest communication."]}),"\n",(0,a.jsx)(n.p,{children:"Here, RM completes the work of the PhaseOne stage, then look at the processing logic of the PhaseTwo stage."}),"\n",(0,a.jsx)(n.h2,{id:"transaction-commit",children:"Transaction Commit"}),"\n",(0,a.jsx)(n.p,{children:"After each branch transaction is completed, TC summarizes the reported results of each RM and sends commit or rollback instructions to each RM."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"2019-04-09 21:57:49.813 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler : Receive:xid=192.168.0.2:8091:2008546211, branchId=2008546212, branchType=AT, resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false, applicationData=null, messageId:1\n2019-04-09 21:57:49.813 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.AbstractRpcRemoting : com.alibaba.fescar.core.rpc.netty.RmRpcClient@7d61f5d4 msgId:1 body:xid=192.168.0.2:8091:2008546211, branchId=2008546212, branchType=AT, resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false, applicationData=null\n2019-04-09 21:57:49.814 INFO 38933 --- [atch_RMROLE_1_8] c.a.f.core.rpc.netty.RmMessageListener : onMessage:xid=192.168.0.2:8091:2008546211, branchId=2008546212, branchType=AT, resourceId=jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false, applicationData=null\n2019-04-09 21:57:49.816 INFO 38933 --- [atch_RMROLE_1_8] com.alibaba.fescar.rm.AbstractRMHandler : Branch committing: 192.168.0.2:8091:2008546211, 2008546212, jdbc:mysql://127.0.0.1:3306/db_storage?useSSL=false, null\n2019-04-09 21:57:49.816 INFO 38933 --- [atch_RMROLE_1_8] com.alibaba.fescar.rm.AbstractRMHandler : Branch commit result: PhaseTwo_Committed\n2019-04-09 21:57:49.817 INFO 38933 --- [atch_RMROLE_1_8] c.a.fescar.core.rpc.netty.RmRpcClient : RmRpcClient sendResponse branchStatus=PhaseTwo_Committed, result code=Success, getMsg=null\n2019-04-09 21:57:49.817 DEBUG 38933 --- [atch_RMROLE_1_8] c.a.f.c.rpc.netty.AbstractRpcRemoting : send response:branchStatus=PhaseTwo_Committed, result code=Success, getMsg=null channel:[id: 0xd40718e3 L:/192.168.0.2:62607 - R:/192.168.0.2:8091]\n2019-04-09 21:57:49.817 DEBUG 38933 --- [lector_RMROLE_1] c.a.f.c.rpc.netty.MessageCodecHandler : Send:branchStatus=PhaseTwo_Committed, result code=Success, getMsg=null\n"})}),"\n",(0,a.jsx)(n.p,{children:"The log shows"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"RM receives the commit notice of XID=192.168.0.2:8091:2008546211, branchId=2008546212"}),"\n",(0,a.jsx)(n.li,{children:"Execute the commit action"}),"\n",(0,a.jsx)(n.li,{children:"Send the commit result to TC, branchStatus is PhaseTwo_Committed"}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["Specifically, see the execution process of the second stage commit in the doBranchCommit method of the ",(0,a.jsx)(n.a,{href:"https://github.com/apache/incubator-seata/blob/develop/rm/src/main/java/com/alibaba/fescar/rm/AbstractRMHandler.java",children:"AbstractRMHandler"})," class."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'/**\n * Get the key parameters such as xid and branchId notified\n * Then call the RM\'s branchCommit\n */\nprotected void doBranchCommit(BranchCommitRequest request, BranchCommitResponse response) throws TransactionException {\n    String xid = request.getXid();\n    long branchId = request.getBranchId();\n    String resourceId = request.getResourceId();\n    String applicationData = request.getApplicationData();\n    LOGGER.info("Branch committing: " + xid + " " + branchId + " " + resourceId + " " + applicationData);\n    BranchStatus status = getResourceManager().branchCommit(request.getBranchType(), xid, branchId, resourceId, applicationData);\n    response.setBranchStatus(status);\n    LOGGER.info("Branch commit result: " + status);\n}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Eventually, the branchCommit request will be called to the branchCommit method of ",(0,a.jsx)(n.a,{href:"https://github.com/apache/incubator-seata/blob/develop/rm-datasource/src/main/java/com/alibaba/fescar/rm/datasource/AsyncWorker.java",children:"AsyncWorker"}),". AsyncWorker's processing method is a key part of fescar's architecture. Since most transactions will be committed normally, they end in the PhaseOne stage. This way, locks can be released as quickly as possible. After receiving the commit instruction in the PhaseTwo stage, the asynchronous processing can be done. This excludes the time consumption of the PhaseTwo stage from a distributed transaction."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'private static final List<Phase2Context> ASYNC_COMMIT_BUFFER = Collections.synchronizedList(new ArrayList<Phase2Context>());\n\n/**\n * Add the XID to be committed to the list\n */\n@Override\npublic BranchStatus branchCommit(BranchType branchType, String xid, long branchId, String resourceId, String applicationData) throws TransactionException {\n    if (ASYNC_COMMIT_BUFFER.size() < ASYNC_COMMIT_BUFFER_LIMIT) {\n        ASYNC_COMMIT_BUFFER.add(new Phase2Context(branchType, xid, branchId, resourceId, applicationData));\n    } else {\n        LOGGER.warn("Async commit buffer is FULL. Rejected branch [" + branchId + "/" + xid + "] will be handled by housekeeping later.");\n    }\n    return BranchStatus.PhaseTwo_Committed;\n}\n\n/**\n * Consume the XIDs in ASYNC_COMMIT_BUFFER through scheduled tasks\n */\npublic synchronized void init() {\n    LOGGER.info("Async Commit Buffer Limit: " + ASYNC_COMMIT_BUFFER_LIMIT);\n    timerExecutor = new ScheduledThreadPoolExecutor(1, new NamedThreadFactory("AsyncWorker", 1, true));\n    timerExecutor.scheduleAtFixedRate(new Runnable() {\n        @Override\n        public void run() {\n            try {\n                doBranchCommits();\n            } catch (Throwable e) {\n                LOGGER.info("Failed at async committing ... " + e.getMessage());\n            }\n        }\n    }, 10, 1000 * 1, TimeUnit.MILLISECONDS);\n}\n\nprivate void doBranchCommits() {\n    if (ASYNC_COMMIT_BUFFER.size() == 0) {\n        return;\n    }\n    Map<String, List<Phase2Context>> mappedContexts = new HashMap<>();\n    Iterator<Phase2Context> iterator = ASYNC_COMMIT_BUFFER.iterator();\n    // In a timed loop, take out all pending data in ASYNC_COMMIT_BUFFER\n    // Group the data to be committed with resourceId as the key. The resourceId is the database connection URL\n    // This can be seen in the previous log, the purpose is to cover the multiple data sources created by the application\n    while (iterator.hasNext()) {\n        Phase2Context commitContext = iterator.next();\n        List<Phase2Context> contextsGroupedByResourceId = mappedContexts.get(commitContext.resourceId);\n        if (contextsGroupedByResourceId == null) {\n            contextsGroupedByResourceId = new ArrayList<>();\n            mappedContexts.put(commitContext.resourceId, contextsGroupedByResourceId);\n        }\n        contextsGroupedByResourceId.add(commitContext);\n        iterator.remove();\n    }\n    for (Map.Entry<String, List<Phase2Context>> entry : mappedContexts.entrySet()) {\n        Connection conn = null;\n        try {\n            try {\n                // Get the data source and connection based on resourceId\n                DataSourceProxy dataSourceProxy = DataSourceManager.get().get(entry.getKey());\n                conn = dataSourceProxy.getPlainConnection();\n            } catch (SQLException sqle) {\n                LOGGER.warn("Failed to get connection for async committing on " + entry.getKey(), sqle);\n                continue;\n            }\n            List<Phase2Context> contextsGroupedByResourceId = entry.getValue();\n            for (Phase2Context commitContext : contextsGroupedByResourceId) {\n                try {\n                    // Perform undolog processing, that is, delete the records corresponding to xid and branchId\n                    UndoLogManager.deleteUndoLog(commitContext.xid, commitContext.branchId, conn);\n                } catch\n\n (Exception ex) {\n                    LOGGER.warn("Failed to delete undo log [" + commitContext.branchId + "/" + commitContext.xid + "]", ex);\n                }\n            }\n        } finally {\n            if (conn != null) {\n                try {\n                    conn.close();\n                } catch (SQLException closeEx) {\n                    LOGGER.warn("Failed to close JDBC resource while deleting undo_log ", closeEx);\n                }\n            }\n        }\n    }\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"So for the commit action, RM only needs to delete the undo_log corresponding to xid and branchId."}),"\n",(0,a.jsx)(n.h2,{id:"transaction-rollback",children:"Transaction Rollback"}),"\n",(0,a.jsx)(n.p,{children:"There are two scenarios for triggering rollback:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["Branch transaction processing exception, that is the case of ",(0,a.jsx)(n.code,{children:"report(false)"})," in the ",(0,a.jsx)(n.a,{href:"https://github.com/apache/incubator-seata/blob/develop/rm-datasource/src/main/java/com/alibaba/fescar/rm/datasource/ConnectionProxy.java",children:"ConnectionProxy"})]}),"\n",(0,a.jsxs)(n.li,{children:["TM catches the exceptions thrown from the downstream system, that is the exception caught by the method marked with the ",(0,a.jsx)(n.code,{children:"@GlobalTransactional"})," annotation in the initiated global transaction. In the previous template method execute of the ",(0,a.jsx)(n.a,{href:"https://github.com/apache/incubator-seata/blob/develop/tm/src/main/java/com/alibaba/fescar/tm/api/TransactionalTemplate.java",children:"TransactionalTemplate"}),", the call to business.execute() was caught. After the catch, it will call rollback, and TM will notify TC that the corresponding XID needs to roll back the transaction."]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'public void rollback() throws TransactionException {\n    // Only the Launcher can initiate this rollback\n    if (role == GlobalTransactionRole.Participant) {\n        // Participant has no responsibility of committing\n        if (LOGGER.isDebugEnabled()) {\n            LOGGER.debug("Ignore Rollback(): just involved in global transaction [" + xid + "]");\n        }\n        return;\n    }\n    if (xid == null) {\n        throw new IllegalStateException();\n    }\n    status = transactionManager.rollback(xid);\n    if (RootContext.getXID() != null) {\n        if (xid.equals(RootContext.getXID())) {\n            RootContext.unbind();\n        }\n    }\n}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["TC summarizes and sends rollback instructions to the participants. RM receives the rollback notice in the doBranchRollback method of the ",(0,a.jsx)(n.a,{href:"https://github.com/apache/incubator-seata/blob/develop/rm/src/main/java/com/alibaba/fescar/rm/AbstractRMHandler.java",children:"AbstractRMHandler"})," class."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'protected void doBranchRollback(BranchRollbackRequest request, BranchRollbackResponse response) throws TransactionException {\n    String xid = request.getXid();\n    long branchId = request.getBranchId();\n    String resourceId = request.getResourceId();\n    String applicationData = request.getApplicationData();\n    LOGGER.info("Branch rolling back: " + xid + " " + branchId + " " + resourceId);\n    BranchStatus status = getResourceManager().branchRollback(request.getBranchType(), xid, branchId, resourceId, applicationData);\n    response.setBranchStatus(status);\n    LOGGER.info("Branch rollback result: " + status);\n}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Then the rollback request is passed to the branchRollback method of the ",(0,a.jsx)(n.a,{href:"https://github.com/apache/incubator-seata/blob/develop/rm-datasource/src/main/java/com/alibaba/fescar/rm/datasource/DataSourceManager.java",children:"DataSourceManager"})," class."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"public BranchStatus branchRollback(BranchType branchType, String xid, long branchId, String resourceId, String applicationData) throws TransactionException {\n    // Get the corresponding data source based on resourceId\n    DataSourceProxy dataSourceProxy = get(resourceId);\n    if (dataSourceProxy == null) {\n        throw new ShouldNeverHappenException();\n    }\n    try {\n        UndoLogManager.undo(dataSourceProxy, xid, branchId);\n    } catch (TransactionException te) {\n        if (te.getCode() == TransactionExceptionCode.BranchRollbackFailed_Unretriable) {\n            return BranchStatus.PhaseTwo_RollbackFailed_Unretryable;\n        } else {\n            return BranchStatus.PhaseTwo_RollbackFailed_Retryable;\n        }\n    }\n    return BranchStatus.PhaseTwo_Rollbacked;\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Ultimately, the undo method of the ",(0,a.jsx)(n.a,{href:"https://github.com/apache/incubator-seata/blob/develop/rm-datasource/src/main/java/com/alibaba/fescar/rm/datasource/undo/UndoLogManager.java",children:"UndoLogManager"})," is executed. Since it is pure JDBC operation, the code is relatively long and will not be posted here. You can view the source code on GitHub via the link. Briefly describe the undo process:"]}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"Find the undo_log submitted in the PhaseOne stage based on xid and branchId."}),"\n",(0,a.jsx)(n.li,{children:"If found, generate the playback SQL based on the data recorded in the undo_log and execute it, that is, restore the data modified in the PhaseOne stage."}),"\n",(0,a.jsx)(n.li,{children:"After step 2 is completed, delete the corresponding undo_log data."}),"\n",(0,a.jsxs)(n.li,{children:["If no corresponding undo_log is found in step 1, insert a new undo_log with the status ",(0,a.jsx)(n.code,{children:"GlobalFinished"}),". The reason it is not found may be that the local transaction in the PhaseOne stage encountered an exception, resulting in no normal write-in. Because xid and branchId are unique indexes, the insertion in step 4 can prevent successful write-in after recovery in the PhaseOne stage. In this way, the business data will not be successfully submitted, achieving the effect of final rollback."]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,a.jsx)(n.p,{children:"Combining distributed business scenarios with local, this article analyzes the main processing flow of the fescar client side and analyzes the main source code for the TM and RM roles, hoping to help you understand the working principles of fescar. With the rapid iteration of fescar and the planning of future Roadmaps, it is believed that fescar can become a benchmark solution for open-source distributed transactions in time."})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},45910:(e,n,t)=>{t.d(n,{A:()=>a});const a=t.p+"assets/images/20190410114411366-32c3a0b5d1265bbd65911d6d46d284ef.png"},28453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>s});var a=t(96540);const r={},o=a.createContext(r);function i(e){const n=a.useContext(o);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),a.createElement(o.Provider,{value:n},e.children)}}}]);