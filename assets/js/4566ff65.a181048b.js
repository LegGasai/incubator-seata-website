"use strict";(self.webpackChunkseata_website=self.webpackChunkseata_website||[]).push([[59833],{49657:(e,r,t)=>{t.r(r),t.d(r,{assets:()=>c,contentTitle:()=>i,default:()=>l,frontMatter:()=>n,metadata:()=>s,toc:()=>u});var o=t(74848),a=t(28453);const n={title:"Resolving the Issue of Losing Mybatis-Plus Features in Seata AT Mode Integration through Source Code",keywords:["Seata","Mybatis-Plus","distributed transaction"],description:"This article explains how to resolve the issue of losing Mybatis-Plus features in Seata integration through source code.",author:"FUNKYE",date:"2019/11/30"},i="Solve the problem of losing MP features in SeataAT schema integration with Mybatis-Plus through source code",s={permalink:"/blog/seata-mybatisplus-analysis",editUrl:"https://github.com/apache/incubator-seata-website/blob/docusaurus/i18n/en/docusaurus-plugin-content-blog/seata-mybatisplus-analysis.md",source:"@site/i18n/en/docusaurus-plugin-content-blog/seata-mybatisplus-analysis.md",title:"Resolving the Issue of Losing Mybatis-Plus Features in Seata AT Mode Integration through Source Code",description:"This article explains how to resolve the issue of losing Mybatis-Plus features in Seata integration through source code.",date:"2019-11-30T00:00:00.000Z",formattedDate:"November 30, 2019",tags:[],readingTime:10.58,hasTruncateMarker:!1,authors:[{name:"FUNKYE"}],frontMatter:{title:"Resolving the Issue of Losing Mybatis-Plus Features in Seata AT Mode Integration through Source Code",keywords:["Seata","Mybatis-Plus","distributed transaction"],description:"This article explains how to resolve the issue of losing Mybatis-Plus features in Seata integration through source code.",author:"FUNKYE",date:"2019/11/30"},unlisted:!1,prevItem:{title:"Seata Community Meetup\xb7Hangzhou Station",permalink:"/blog/seata-meetup-hangzhou"},nextItem:{title:"Integrating Seata Distributed Transaction with SpringBoot+Dubbo+MybatisPlus",permalink:"/blog/springboot-dubbo-mybatisplus-seata"}},c={authorsImageUrls:[void 0]},u=[{value:"Analyse the causes",id:"analyse-the-causes",level:2}];function p(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(r.p,{children:["Project address: ",(0,o.jsx)(r.a,{href:"https://gitee.com/itCjb/springboot-dubbo-mybatisplus-seata",children:"https://gitee.com/itCjb/springboot-dubbo-mybatisplus-seata"})]}),"\n",(0,o.jsx)(r.p,{children:"Author: FUNKYE (Chen Jianbin), Hangzhou, an Internet company programmer."}),"\n",(0,o.jsx)(r.h1,{id:"introduction",children:"Introduction"}),"\n",(0,o.jsxs)(r.p,{children:["Mybatis-Plus: ",(0,o.jsx)(r.a,{href:"https://github.com/baomidou/mybatis-plus",children:"MyBatis-Plus"})," (MP for short) is an ",(0,o.jsx)(r.a,{href:"http://www.mybatis.org/mybatis-3/",children:"MyBatis"})," enhancement tool in the MyBatis on the basis of only enhancements do not change , in order to simplify the development , improve efficiency and born ."]}),"\n",(0,o.jsx)(r.p,{children:"MP configuration:"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-xml",children:'<bean id="sqlSessionFactory" class="com.baomidou.mybatisplus.extension.spring.MybatisSqlSessionFactoryBean">\n<property name="dataSource" ref="dataSource"/>\n</bean\n'})}),"\n",(0,o.jsx)(r.p,{children:"Seata: Seata is an open source distributed transaction solution , is committed to providing high-performance and easy to use distributed transaction services . Seata will provide users with AT, TCC, SAGA and XA transaction patterns , to create a one-stop distributed solution for users ."}),"\n",(0,o.jsx)(r.p,{children:"AT mode mechanism:"}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsx)(r.li,{children:"Phase I: Business data and rollback log records are committed in the same local transaction, releasing local locks and connection resources."}),"\n",(0,o.jsx)(r.li,{children:"Phase II:"}),"\n",(0,o.jsx)(r.li,{children:"Commit asynchronised and completed very quickly."}),"\n",(0,o.jsx)(r.li,{children:"Rollbacks are back-compensated by the phase 1 rollback log."}),"\n"]}),"\n",(0,o.jsx)(r.h2,{id:"analyse-the-causes",children:"Analyse the causes"}),"\n",(0,o.jsxs)(r.ol,{children:["\n",(0,o.jsxs)(r.li,{children:["\n",(0,o.jsx)(r.p,{children:"First of all, through the introduction, we can see that mp is required to register the sqlSessionFactory and inject the data source, while Seata is to ensure the normal rollback and commit of the transaction through the proxy data source."}),"\n"]}),"\n",(0,o.jsxs)(r.li,{children:["\n",(0,o.jsx)(r.p,{children:"Let's look at the SeataAutoConfig code based on the official Seata demo."}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-java",children:'package org.test.config;\n\nimport javax.sql.DataSource;\n\nimport org.apache.ibatis.session.\nimport org.slf4j.Logger; import org.slf4j.\nimport org.slf4j.LoggerFactory; import org.springframework.\nimport org.springframework.beans.factory.annotation.Autowired; import org.springframework.beans.factory.annotation.\nimport org.springframework.boot.autoconfigure.jdbc.DataSourceProperties; import org.springframework.boot.autoconfigure.jdbc.\nimport org.springframework.context.annotation.\nimport org.springframework.context.annotation.Configuration; import org.springframework.context.annotation.\nimport org.springframework.context.annotation.\n\nimport com.alibaba.druid.pool.DruidDataSource; import com.baomidou.pool.\nimport com.alibaba.druid.pool.DruidDataSource; import com.baomidou.mybatisplus.extension.spring.\n\nimport io.seata.rm.datasource.DataSourceProxy; import io.seata.rm.datasource.\nimport io.seata.rm.datasource.DataSourceProxy; import io.seata.spring.annotation.\n\n@Configuration\npublic class SeataAutoConfig {\n @Autowired(required = true)\n private DataSourceProperties dataSourceProperties; private final static Logger logger; @Autowired(required = true)\n private final static Logger logger = LoggerFactory.getLogger(SeataAutoConfig.class);\n\n @Bean(name = "dataSource") // Declare it as a bean instance.\n @Primary // In the same DataSource, first use the labelled DataSource\n public DataSource druidDataSource() {\n  DruidDataSource druidDataSource = new DruidDataSource();\n  logger.info("dataSourceProperties.getUrl():{}",dataSourceProperties.getUrl());\n  druidDataSource.setUrl(dataSourceProperties.getUrl());\n  druidDataSource.setUsername(dataSourceProperties.getUsername());\n  druidDataSource.setPassword(dataSourceProperties.getPassword());\n  druidDataSource.setDriverClassName(dataSourceProperties.getDriverClassName()); druidDataSource.setDriverClassName(dataSourceProperties.getDriverClassName());\n  druidDataSource.setInitialSize(0);\n  druidDataSource.setMaxActive(180);\n  druidDataSource.setMaxWait(60000);\n  druidDataSource.setMinIdle(0); druidDataSource.setMinIdle(0);\n  druidDataSource.setValidationQuery("Select 1 from DUAL");\n  druidDataSource.setTestOnBorrow(false); druidDataSource.setTestOnBorrow(false);\n  druidDataSource.setTestOnReturn(false); druidDataSource.\n  druidDataSource.setTestWhileIdle(true); druidDataSource.\n  druidDataSource.setTimeBetweenEvictionRunsMillis(60000); druidDataSource.\n  druidDataSource.setMinEvictableIdleTimeMillis(25200000); druidDataSource.\n  druidDataSource.setRemoveAbandoned(true);\n  druidDataSource.setRemoveAbandonedTimeout(1800); druidDataSource.setRemoveAbandonedTimeout(1800);\n  druidDataSource.setLogAbandoned(true);\n  logger.info("Loading dataSource ........") ;\n  return druidDataSource;\n }\n\n /**\n  * init datasource proxy\n  * @Param: druidDataSource datasource bean instance\n  * @Param: druidDataSource datasource bean instance\n  * @Return: DataSourceProxy datasource proxy\n  */\n @Bean\n public DataSourceProxy dataSourceProxy(DataSource dataSource) {\n  logger.info("Proxy dataSource ........") ;\n  return new DataSourceProxy(dataSource);\n }\n\n @Bean\n public SqlSessionFactory sqlSessionFactory(DataSourceProxy dataSourceProxy) throws Exception {\n  MybatisSqlSessionFactoryBean factory = new MybatisSqlSessionFactoryBean();\n  MybatisSqlSessionFactoryBean = new MybatisSqlSessionFactoryBean(); factory.setDataSource(dataSourceProxy);\n       factory.setMapperLocations(new PathMatchingResourcePatternResolver()); factory.setMapperLocations(new PathMatchingResourcePatternResolver())\n           .getResources("classpath*:/mapper/*.xml")); factory.setMapperLocations(new PathMatchingResourcePatternResolver())\n  return factory.getObject();\n }\n\n /**\n  * init global transaction scanner\n  * @Return: GlobalTransactionScanner\n  * @Return: GlobalTransactionScanner\n  */\n @Bean\n public GlobalTransactionScanner globalTransactionScanner() {\n  logger.info("Configuring seata........") ;\n  return new GlobalTransactionScanner("test-service", "test-group");\n }\n}\n\n'})}),"\n",(0,o.jsx)(r.p,{children:"First of all, we see that in our seata configuration datasource class, we have configured a datasource, and then we have configured a seata proxy datasource bean, and this time."}),"\n",(0,o.jsx)(r.p,{children:"Then we if we directly start the mp integration seata project will find that paging and other plug-ins will be directly invalid , even scanning mapper have to write from the code , this is why?"}),"\n",(0,o.jsx)(r.p,{children:"By reading the above code, because we have another configuration of a sqlSessionFactory, resulting in mp's sqlSessionFactory failure, this time we found the problem, even if we do not configure sqlSessionFactoryl, but also because of the mp data source used is not seata proxy After the data source used by mp is not proxied by seata, resulting in distributed transaction failure. But how to solve this problem?"}),"\n",(0,o.jsx)(r.p,{children:"We need to read the source code of mp and find its startup class."}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-java",children:'/* /* /* /* /* /* /* /*\n* Copyright (c) 2011-2020, baomidou (jobob@qq.com).\n* <p>\n* Licensed under the Apache License, Version 2.0 (the "License"); you may not\n* use this file except in compliance with the Licence. You may obtain a copy of * the Licence at\n* the License at\n* <p>\n* https://www.apache.org/licenses/LICENSE-2.0\n* <p>\n* Unless required by applicable law or agreed to in writing, software * distributed under the Licence is distributed on an "AS IS" BASIS.\n* distributed under the Licence is distributed on an "AS IS" BASIS, WITHOUT\n* WARRANTIES OR CONDITIONS OF ANY KIND, either expressed or implied.\n* Licence for the specific language governing permissions and limitations under\n* the Licence.\n*/\npackage com.baomidou.mybatisplus.autoconfigure;\n\n\nimport com.baomidou.mybatisplus.core.MybatisConfiguration; import com.baomidou.mybatisplus.core.config.\nimport com.baomidou.mybatisplus.core.config.GlobalConfig; import com.baomidou.mybatisplus.core.\nimport com.baomidou.mybatisplus.core.handlers.\nimport com.baomidou.mybatisplus.core.incrementer.IKeyGenerator; import com.baomidou.mybatisplus.core.\nimport com.baomidou.mybatisplus.core.injector.ISqlInjector; import com.baomidou.mybatisplus.core.injector.\nimport com.baomidou.mybatisplus.extension.spring.MybatisSqlSessionFactoryBean; import org.apache.ibache.\nimport org.apache.ibatis.annotations.\nimport org.apache.ibatis.mapping.DatabaseIdProvider; import org.apache.ibatis.mapping.\nimport org.apache.ibatis.mapping.DatabaseIdProvider; import org.apache.ibatis.plugin.\nimport org.apache.ibatis.scripting.LanguageDriver; import org.apache.ibatis.scripting.\nimport org.apache.ibatis.scripting.LanguageDriver; import org.apache.ibatis.session.\nimport org.apache.ibatis.session.SqlSessionFactory; import org.apache.ibatis.session.\nimport org.apache.ibatis.session.SqlSessionFactory; import org.apache.ibatis.type.\nimport org.mybatis.spring.SqlSessionFactoryBean; import org.mybatis.spring.\nimport org.mybatis.spring.SqlSessionTemplate; import org.mybatis.spring.\nimport org.mybatis.spring.mapper.MapperFactoryBean; import org.mybatis.spring.mapper.\nimport org.mybatis.spring.mapper.MapperScannerConfigurer; import org.mybatis.spring.mapper.\nimport org.slf4j.Logger; import org.slf4j.\nimport org.slf4j.LoggerFactory; import org.springframework.\nimport org.springframework.beans.BeanWrapper; import org.springframework.beans.\nimport org.springframework.beans.BeanWrapperImpl; import org.springframework.beans.\nimport org.springframework.beans.factory.BeanFactory; import org.springframework.beans.\nimport org.springframework.beans.factory.BeanFactoryAware; import org.springframework.beans.factory.\nimport org.springframework.beans.factory.InitialisingBean; import org.springframework.beans.factory.\nimport org.springframework.beans.factory.ObjectProvider; import org.springframework.beans.factory.\nimport org.springframework.beans.factory.support.BeanDefinitionBuilder; import org.springframework.beans.factory.support.\nimport org.springframework.beans.factory.support.BeanDefinitionRegistry; import org.springframework.beans.factory.support.\nimport org.springframework.boot.autoconfigure.AutoConfigurationPackages; import org.springframework.boot.autoconfigure.\nimport org.springframework.boot.autoconfigure.AutoConfigureAfter; import org.springframework.boot.autoconfigure.\nimport org.springframework.boot.autoconfigure.EnableAutoConfiguration; import org.springframework.boot.autoconfigure.\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnClass; import org.springframework.boot.autoconfigure.\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean; import org.springframework.boot.autoconfigure.condition.\nimport org.springframework.boot.autoconfigure.condition.ConditionalOnSingleCandidate; import org.springframework.boot.autoconfigure.condition.\nimport org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration; import org.springframework.boot.autoconfigure.jdbc.\nimport org.springframework.boot.context.properties.EnableConfigurationProperties; import org.springframework.boot.context.properties.\nimport org.springframework.context.ApplicationContext; import org.springframework.context.\nimport org.springframework.context.annotation.\nimport org.springframework.context.annotation.\nimport org.springframework.context.annotation.Import; import org.springframework.context.annotation.\nimport org.springframework.context.annotation.ImportBeanDefinitionRegistrar; import org.springframework.context.annotation.\nimport org.springframework.context.annotation.ImportBeanDefinitionRegistrar; import org.springframework.core.io.\nimport org.springframework.core.io.ResourceLoader; import org.springframework.core.io.\nimport org.springframework.core.type.AnnotationMetadata; import org.springframework.core.io.\nimport org.springframework.core.type.AnnotationMetadata; import org.springframework.util.\nimport org.springframework.util.CollectionUtils; import org.springframework.util.\nimport org.springframework.util.ObjectUtils; import org.springframework.util.\nimport org.springframework.util.StringUtils; import org.springframework.util.\n\nimport javax.sql.DataSource; import java.util.\nimport java.util.List; import java.util.\nimport java.util.Optional; import java.util.\nimport java.util.stream.\n\n/**\n* {@link EnableAutoConfiguration Auto-Configuration} for Mybatis. Contributes a\n* {@link SqlSessionFactory} and a {@link SqlSessionTemplate}.\n* <p>\n* If {@link org.mybatis.spring.annotation.MapperScan} is used, or a\n* configuration file is specified as a property, those will be considered, * otherwise this auto-configuration will be considered.\n* otherwise this auto-configuration will attempt to register mappers based on\n* the interface definitions in or under the root auto-configuration package.\n* </p\n* <p> copy from {@link org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration}</p>\n* @author Edd\xfa Mel\xe9n\n* @author Edd\xfa Mel\xe9ndez\n* @author Josh Long\n* @author Kazuki Shimizu\n* @author Eduardo Macarr\xf3n\n*/\n@Configuration\n@ConditionalOnClass({SqlSessionFactory.class, SqlSessionFactoryBean.class})\n@ConditionalOnSingleCandidate(DataSource.class)\n@EnableConfigurationProperties(MybatisPlusProperties.class)\n@AutoConfigureAfter(DataSourceAutoConfiguration.class)\npublic class MybatisPlusAutoConfiguration implements InitialisingBean {\n\n   private static final Logger logger = LoggerFactory.getLogger(MybatisPlusAutoConfiguration.class);\n\n   private final MybatisPlusProperties properties.\n\n   private final Interceptor[] interceptors; private final\n\n   private final TypeHandler[] typeHandlers; private final MybatisPlusProperties properties; private final\n\n   private final LanguageDriver[] languageDrivers.\n\n   private final ResourceLoader resourceLoader;\n\n   private final DatabaseIdProvider databaseIdProvider; private final\n\n   private final List<ConfigurationCustomizer> configurationCustomizers; private final List<ConfigurationCustomizer> configurationCustomizers.\n\n   private final List<MybatisPlusPropertiesCustomizer> mybatisPlusPropertiesCustomizers;\n\n   private final ApplicationContext applicationContext;\n\n\n   public MybatisPlusAutoConfiguration(MybatisPlusProperties properties, MybatisPlusPropertiesCustomizers)\n                                       ObjectProvider<Interceptor[]> interceptorsProvider, ObjectProvider<TypeHandler[]> interceptorsProvider, MybatisPlusAutoConfiguration(MybatisPlusProperties)\n                                       ObjectProvider<TypeHandler[]> typeHandlersProvider, ObjectProvider<LanguageProvider\n                                       ObjectProvider<LanguageDriver[]> languageDriversProvider,\n                                       ResourceLoader resourceLoader,\n                                       ObjectProvider<DatabaseIdProvider> databaseIdProvider,\n                                       ObjectProvider<List<ConfigurationCustomizer>> configurationCustomizersProvider,\n                                       ObjectProvider<List<MybatisPlusPropertiesCustomizer>> mybatisPlusPropertiesCustomizerProvider,\n                                       ApplicationContext applicationContext) {\n       this.properties = properties; this.interceptors = interceptors\n       this.interceptors = interceptorsProvider.getIfAvailable();\n       this.typeHandlers = typeHandlersProvider.getIfAvailable(); this.\n       this.languageDrivers = languageDriversProvider.getIfAvailable(); this.\n       this.resourceLoader = resourceLoader; this.databaseIdProvider.getIfAvailable()\n       this.databaseIdProvider = databaseIdProvider.getIfAvailable(); this.\n       this.configurationCustomizers = configurationCustomizersProvider.getIfAvailable(); this.\n       this.mybatisPlusPropertiesCustomizers = mybatisPlusPropertiesCustomizerProvider.getIfAvailable(); this.\n       this.applicationContext = applicationContext;\n   }\n\n   @Override\n   public void afterPropertiesSet() {\n       if (!CollectionUtils.isEmpty(mybatisPlusPropertiesCustomizers)) {\n           mybatisPlusPropertiesCustomizers.forEach(i -> i.customise(properties));\n       }\n       checkConfigFileExists();\n   }\n\n   private void checkConfigFileExists() {\n       if (this.properties.isCheckConfigLocation() && StringUtils.hasText(this.properties.getConfigLocation())) {\n           Resource resource = this.resourceLoader.getResource(this.properties.getConfigLocation());\n           Assert.state(resource.exists(),\n               "Cannot find config location: " + resource + " (please add config file or check your Mybatis configuration)");\n       }\n   }\n\n   @SuppressWarnings("SpringJavaInjectionPointsAutowiringInspection")\n   @Bean\n   @ConditionalOnMissingBean\n   public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception {\n       // TODO uses MybatisSqlSessionFactoryBean instead of SqlSessionFactoryBean.\n       MybatisSqlSessionFactoryBean factory = new MybatisSqlSessionFactoryBean();\n       factory.setDataSource(dataSource); factory.setVfs(SpringBean); factory.setVfs(SpringBean)\n       factory.setVfs(SpringBootVFS.class);\n       if (StringUtils.hasText(this.properties.getConfigLocation())) {\n           factory.setConfigLocation(this.resourceLoader.getResource(this.properties.getConfigLocation())); }\n       }\n       applyConfiguration(factory).\n       if (this.properties.getConfigurationProperties() ! = null) {\n           factory.setConfigurationProperties(this.properties.getConfigurationProperties());\n       }\n       if (!ObjectUtils.isEmpty(this.interceptors)) {\n           factory.setPlugins(this.interceptors); }\n       }\n       if (this.databaseIdProvider ! = null) {\n           factory.setDatabaseIdProvider(this.databaseIdProvider); }\n       }\n       if (StringUtils.hasLength(this.properties.getTypeAliasesPackage())) {\n           factory.setTypeAliasesPackage(this.properties.getTypeAliasesPackage()); }\n       }\n       if (this.properties.getTypeAliasesSuperType() ! = null) {\n           factory.setTypeAliasesSuperType(this.properties.getTypeAliasesSuperType()); }\n       }\n       if (StringUtils.hasLength(this.properties.getTypeHandlersPackage())) {\n           factory.setTypeHandlersPackage(this.properties.getTypeHandlersPackage()); }\n       }\n       if (!ObjectUtils.isEmpty(this.typeHandlers)) {\n           factory.setTypeHandlers(this.typeHandlers); }\n       }\n       if (!ObjectUtils.isEmpty(this.properties.resolveMapperLocations())) {\n           factory.setMapperLocations(this.properties.resolveMapperLocations()); }\n       }\n\n       // TODO makes some changes to the source code (because it adapts to an older version of mybatis, but we don\'t need to).\n       Class<? extends LanguageDriver> defaultLanguageDriver = this.properties.getDefaultScriptingLanguageDriver(); if (!\n       if (!ObjectUtils.isEmpty(this.languageDrivers)) {\n           factory.setScriptingLanguageDrivers(this.languageDrivers); }\n       }\n       Optional.ofNullable(defaultLanguageDriver).ifPresent(factory::setDefaultScriptingLanguageDriver);\n\n       // TODO custom enum package\n       if (StringUtils.hasLength(this.properties.getTypeEnumsPackage())) {\n           factory.setTypeEnumsPackage(this.properties.getTypeEnumsPackage());\n       }\n       // TODO This must be non-NULL.\n       GlobalConfig globalConfig = this.properties.getGlobalConfig(); // TODO inject the filler.\n       // TODO inject the filler\n       if (this.applicationContext.getBeanNamesForType(MetaObjectHandler.class,\n           false, false).length > 0) {\n           MetaObjectHandler metaObjectHandler = this.applicationContext.getBean(MetaObjectHandler.class);\n           globalConfig.setMetaObjectHandler(metaObjectHandler);\n       }\n       // TODO inject the primary key generator\n       if (this.applicationContext.getBeanNamesForType(IKeyGenerator.class, false\n           false).length > 0) {\n           IKeyGenerator keyGenerator = this.applicationContext.getBean(IKeyGenerator.class);\n           globalConfig.getDbConfig().setKeyGenerator(keyGenerator);\n       }\n       // TODO injecting the sql injector\n       if (this.applicationContext.getBeanNamesForType(ISqlInjector.class, false,\n           false).length > 0) {\n           ISqlInjector iSqlInjector = this.applicationContext.getBean(ISqlInjector.class);\n           globalConfig.setSqlInjector(iSqlInjector);\n       }\n       // TODO set GlobalConfig to MybatisSqlSessionFactoryBean\n       factory.setGlobalConfig(globalConfig); return factory.getObject(MybatisSqlSessionFactoryBean); }\n       factory.setGlobalConfig(globalConfig); return factory.getObject();\n   }\n\n   // TODO entry using MybatisSqlSessionFactoryBean.\n   private void applyConfiguration(MybatisSqlSessionFactoryBean factory) {\n       // TODO using MybatisConfiguration\n       MybatisConfiguration configuration = this.properties.getConfiguration(); if (configuration == null & null); }\n       if (configuration == null && !StringUtils.hasText(this.properties.getConfigLocation()) {\n           configuration = new MybatisConfiguration();\n       }\n       if (configuration ! = null && !CollectionUtils.isEmpty(this.configurationCustomizers)) {\n           for (ConfigurationCustomizer customizer : this.configurationCustomizers) {\n               customizer.customize(configuration);\n           }\n       }\n       factory.setConfiguration(configuration); }\n   }\n\n   @Bean\n   @ConditionalOnMissingBean\n   public SqlSessionTemplate sqlSessionTemplate(SqlSessionFactory sqlSessionFactory) {\n       ExecutorType executorType = this.properties.getExecutorType(); if (executorType !\n       if (executorType ! = null) {\n           return new SqlSessionTemplate(sqlSessionFactory, executorType); if (executorType !\n       } else {\n           return new SqlSessionTemplate(sqlSessionFactory); } else { new SqlSessionTemplate(sqlSessionFactory); }\n       }\n   }\n\n   /**} }\n    * This will just scan the same base package as Spring Boot does. If you want more power, you can explicitly use\n    * {@link org.mybatis.spring.annotation.MapperScan} but this will get typed mappers working correctly, out-of-the-box, * similar to using Spring Data JPA repositories.\n    * similar to using Spring Data JPA repositories.\n    */\n   public static class AutoConfiguredMapperScannerRegistrar implements BeanFactoryAware, ImportBeanDefinitionRegistrar {\n\n       private BeanFactory beanFactory;\n\n       private BeanFactory beanFactory; @Override\n       public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {\n\n           if (!AutoConfigurationPackages.has(this.beanFactory)) {\n               logger.debug("Could not determine auto-configuration package, automatic mapper scanning disabled."); return; { if (!AutoConfigurationPackages.has(this.beanFactory)) { if (!\n               return;\n           }\n\n           logger.debug("Searching for mappers annotated with @Mapper");\n\n           List<String> packages = AutoConfigurationPackages.get(this.beanFactory);\n           if (logger.isDebugEnabled()) {\n               packages.forEach(pkg -> logger.debug("Using auto-configuration base package \'{}\'", pkg));\n           }\n\n           BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition(MapperScannerConfigurer.class);\n           builder.addPropertyValue("ProcessPropertyPlaceHolders", true);\n           builder.addPropertyValue("annotationClass", Mapper.class); builder.addPropertyValue("processPropertyPlaceHolders", true);\n           builder.addPropertyValue("basePackage", StringUtils.collectionToCommaDelimitedString(packages));\n           BeanWrapper beanWrapper = new BeanWrapperImpl(MapperScannerConfigurer.class);\n           Stream.of(beanWrapper.getPropertyDescriptors())\n               // Need to mybatis-spring 2.0.2+\n               .filter(x -> x.getName().equals("lazyInitialisation")).findAny()\n               .ifPresent(x -> builder.addPropertyValue("lazyInitialization", "${mybatis.lazy-initialization:false}"));\n           registry.registerBeanDefinition(MapperScannerConfigurer.class.getName(), builder.getBeanDefinition());\n       }\n\n       @Override\n       public void setBeanFactory(BeanFactory beanFactory) {\n           this.beanFactory = beanFactory; } @Override public void setBeanFactory(beanFactory) { this.\n       }\n   }\n\n   /**\n    * If mapper registering configuration or mapper scanning configuration not present, this configuration allow to scan\n    * mappers based on the same component-scanning path as Spring Boot itself.\n    */\n   @Configuration\n   @Import(AutoConfiguredMapperScannerRegistrar.class)\n   @ConditionalOnMissingBean({MapperFactoryBean.class, MapperScannerConfigurer.class})\n   public static class MapperScannerRegistrarNotFoundConfiguration implements InitialisingBean {\n\n       public void afterPropertiesSet\n       public void afterPropertiesSet() {\n           logger.debug(\n               "Not found configuration for registering mapper bean using @MapperScan, MapperFactoryBean and MapperScannerConfigurer.");\n       }\n   }\n}\n\n'})}),"\n",(0,o.jsx)(r.p,{children:"See the sqlSessionFactory method in the mp startup class, it injects a data source in the same way, at this point you should know the solution, right?"}),"\n",(0,o.jsx)(r.p,{children:"That's right, is to be proxied to the data source to the mp sqlSessionFactory."}),"\n",(0,o.jsx)(r.p,{children:"It's very simple, we need to slightly change our seata configuration class on the line"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-java",children:'package org.test.config; import javax.sql.\n\nimport javax.sql.DataSource; import org.mybatis.\n\nimport org.mybatis.spring.annotation.\nimport org.slf4j.Logger; import org.slf4j.\nimport org.slf4j.LoggerFactory; import org.springframework.\nimport org.springframework.beans.factory.annotation.Autowired; import org.springframework.beans.factory.annotation.\nimport org.springframework.boot.autoconfigure.jdbc.DataSourceProperties; import org.springframework.boot.autoconfigure.jdbc.\nimport org.springframework.context.annotation.\nimport org.springframework.context.annotation.Configuration; import org.springframework.context.annotation.\nimport org.springframework.context.annotation.\n\nimport com.alibaba.druid.pool.DruidDataSource; import com.alibaba.druid.pool.\n\nimport io.seata.rm.datasource.DataSourceProxy; import io.seata.rm.datasource.\nimport io.seata.spring.annotation.GlobalTransactionScanner; import io.seata.rm.datasource.\n\n@Configuration\n@MapperScan("com.baomidou.springboot.mapper*")\npublic class SeataAutoConfig {\n@Autowired(required = true)\nprivate DataSourceProperties dataSourceProperties; private final static Logger logger; @Autowired(required = true)\nprivate final static Logger logger = LoggerFactory.getLogger(SeataAutoConfig.class);\nprivate DataSourceProxy dataSourceProxy;\n\n    @Bean(name = "dataSource") // Declare it as a bean instance.\n    @Primary // In the same DataSource, the labelled DataSource is used first\n    public DataSource druidDataSource() {\n        DruidDataSource druidDataSource = new DruidDataSource();\n        logger.info("dataSourceProperties.getUrl():{}", dataSourceProperties.getUrl());\n        druidDataSource.setUrl(dataSourceProperties.getUrl());\n        druidDataSource.setUsername(dataSourceProperties.getUsername());\n        druidDataSource.setPassword(dataSourceProperties.getPassword());\n        druidDataSource.setDriverClassName(dataSourceProperties.getDriverClassName()); druidDataSource.setDriverClassName(dataSourceProperties.getDriverClassName());\n        druidDataSource.setInitialSize(0);\n        druidDataSource.setMaxActive(180);\n        druidDataSource.setMaxWait(60000);\n        druidDataSource.setMinIdle(0); druidDataSource.setMinIdle(0);\n        druidDataSource.setValidationQuery("Select 1 from DUAL");\n        druidDataSource.setTestOnBorrow(false); druidDataSource.setTestOnBorrow(false);\n        druidDataSource.setTestOnReturn(false); druidDataSource.\n        druidDataSource.setTestWhileIdle(true); druidDataSource.\n        druidDataSource.setTimeBetweenEvictionRunsMillis(60000); druidDataSource.\n        druidDataSource.setMinEvictableIdleTimeMillis(25200000); druidDataSource.\n        druidDataSource.setRemoveAbandoned(true);\n        druidDataSource.setRemoveAbandonedTimeout(1800); druidDataSource.setRemoveAbandonedTimeout(1800);\n        druidDataSource.setLogAbandoned(true);\n        logger.info("Loading dataSource ........") ;\n        dataSourceProxy = new DataSourceProxy(druidDataSource);\n        return dataSourceProxy;\n    }\n\n    /**\n     * init datasource proxy\n     } /** * init datasource proxy\n     * @Param: druidDataSource datasource bean instance\n     * @Return: DataSourceProxy datasource proxy\n     */\n    @Bean\n    public DataSourceProxy dataSourceProxy() {\n        logger.info("Proxy dataSource ........") ;\n        return dataSourceProxy;\n    }\n\n    /**\n     * init global transaction scanner\n     * @Return: GlobalTransactionScanner\n     * @Return: GlobalTransactionScanner\n     */\n    @Bean\n    public GlobalTransactionScanner globalTransactionScanner() {\n        logger.info("Configuring seata........") ;\n        return new GlobalTransactionScanner("test-service", "test-group");\n    }\n}\n\n'})}),"\n",(0,o.jsx)(r.p,{children:"Look at the code, we removed their own configuration of the sqlSessionFactory, directly let the DataSource bean return is a proxied bean, and we added @Primary, resulting in mp priority to use our configuration of the data source, which solves the problem of mp because of seata proxy data source with the creation of a new sqlSessionFactory, resulting in mp's plug-ins and components fail the bug!"}),"\n",(0,o.jsx)(r.h1,{id:"summary",children:"Summary"}),"\n",(0,o.jsx)(r.p,{children:"stepping into the pit is not terrible, the main and patience along the principle of each component implementation, and then go to think, look for the corresponding conflict of the code block, you will be able to find a compatible method of the two."})]})}function l(e={}){const{wrapper:r}={...(0,a.R)(),...e.components};return r?(0,o.jsx)(r,{...e,children:(0,o.jsx)(p,{...e})}):p(e)}},28453:(e,r,t)=>{t.d(r,{R:()=>i,x:()=>s});var o=t(96540);const a={},n=o.createContext(a);function i(e){const r=o.useContext(n);return o.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function s(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),o.createElement(n.Provider,{value:r},e.children)}}}]);