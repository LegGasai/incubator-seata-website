"use strict";(self.webpackChunkseata_website=self.webpackChunkseata_website||[]).push([[659],{19910:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>d,frontMatter:()=>i,metadata:()=>r,toc:()=>l});var s=n(74848),o=n(28453);const i={title:"Introduction to TCC Theory and Design Implementation Guide",author:"zhangthen",date:"2019/03/26",keywords:["fescar","distributed transaction","TCC","roadmap"]},a="Introduction to TCC Theory and Design Implementation Guidelines",r={permalink:"/blog/tcc-mode-design-principle",editUrl:"https://github.com/apache/incubator-seata-website/blob/docusaurus/i18n/en/docusaurus-plugin-content-blog/tcc-mode-design-principle.md",source:"@site/i18n/en/docusaurus-plugin-content-blog/tcc-mode-design-principle.md",title:"Introduction to TCC Theory and Design Implementation Guide",description:"Fescar 0.4.0 version released the TCC schema, contributed by the Anthem team, you are welcome to try it out,Sample address//github.com/fescar-group/fescar-samples/tree/master/tcc,At the end of this article, we also provide the roadmap of the project, welcome to follow.",date:"2019-03-26T00:00:00.000Z",formattedDate:"March 26, 2019",tags:[],readingTime:6.18,hasTruncateMarker:!1,authors:[{name:"zhangthen"}],frontMatter:{title:"Introduction to TCC Theory and Design Implementation Guide",author:"zhangthen",date:"2019/03/26",keywords:["fescar","distributed transaction","TCC","roadmap"]},unlisted:!1,prevItem:{title:"Analysis of Applicable Models and Scenarios for TCC",permalink:"/blog/tcc-mode-applicable-scenario-analysis"},nextItem:{title:"How to use Seata to ensure consistency between Dubbo Microservices",permalink:"/blog/quick-start-use-seata-and-dubbo-services"}},c={authorsImageUrls:[void 0]},l=[{value:"I. Introduction to TCC",id:"i-introduction-to-tcc",level:3},{value:"II. TCC Design",id:"ii-tcc-design",level:3},{value:"1, <strong>Business operation is completed in two stages</strong>",id:"1-business-operation-is-completed-in-two-stages",level:4},{value:"2, <strong>Concurrency Control</strong>",id:"2-concurrency-control",level:4},{value:"3, <strong>Allow empty rollback</strong>",id:"3-allow-empty-rollback",level:4},{value:"4. Anti-suspension control",id:"4-anti-suspension-control",level:4},{value:"5. Idempotent control",id:"5-idempotent-control",level:4},{value:"Roadmap",id:"roadmap",level:3}];function h(e){const t={a:"a",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(t.p,{children:["Fescar 0.4.0 version released the TCC schema, contributed by the Anthem team, you are welcome to try it out,",(0,s.jsx)("br",{}),"Sample address:[",(0,s.jsx)(t.a,{href:"https://github.com/fescar-group/fescar-samples/tree/master/tcc%5D(https",children:"https://github.com/fescar-group/fescar-samples/tree/master/tcc](https"}),"."," //github.com/fescar-group/fescar-samples/tree/master/tcc),",(0,s.jsx)("br",{}),"At the end of this article, we also provide the roadmap of the project, welcome to follow."]}),"\n",(0,s.jsx)("a",{name:"f1d2fc6a"}),"\n",(0,s.jsx)(t.h3,{id:"i-introduction-to-tcc",children:"I. Introduction to TCC"}),"\n",(0,s.jsx)(t.p,{children:'In the Two Phase Commitment Protocol (2PC), the resource manager (RM, resource manager) needs to provide three functions: "prepare", "commit" and "rollback". "Rollback" 3 operations; while the transaction manager (TM, transaction manager) coordinates all resource managers in 2 phases, in the first phase asks all resource managers whether the "preparation" is successful, if all resources are If all resources are "ready" successfully, then perform "commit" operation of all resources in the second phase, otherwise perform "rollback" operation of all resources in the second phase to ensure that the final state of all resources is the same, either all commits or all commits, or the final state of all resources is the same. to ensure that the final state of all resources is the same, either all commit or all rollback.'}),"\n",(0,s.jsx)(t.p,{children:"Resource Manager has many implementations, among which TCC (Try-Confirm-Cancel) is a service-based implementation of Resource Manager; TCC is a relatively mature distributed transaction solution that can be used to solve the data consistency problem of cross-database and cross-service business operations; TCC's Try, Confirm and Cancel methods are implemented by business code. TCC's Try, Confirm, and Cancel methods are all implemented by business code, so TCC can be called a service-based resource manager."}),"\n",(0,s.jsx)(t.p,{children:"The Try operation of TCC is the first stage, which is responsible for checking and reserving resources; Confirm operation is the second stage, which is the submit operation to execute the real business; Cancel is the second stage, which is the rollback operation, which is the cancellation of the reserved resources to return the resources to the initial state."}),"\n",(0,s.jsx)(t.p,{children:"As shown in the figure below, after the user implements a TCC service, the TCC service will be one of the resources of the distributed transaction, participating in the whole distributed transaction; the transaction manager coordinates the TCC services in two stages, calling the Try method of all TCC services in the first stage, and executing the Confirm or Cancel method of all TCC services in the second stage; eventually all TCC services are either committed or cancelled; all TCC services are either committed or cancelled. services are either all committed or all rolled back."}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"image.png",src:n(58150).A+"",width:"1110",height:"668"})}),"\n",(0,s.jsx)("a",{name:"48153343"}),"\n",(0,s.jsx)(t.h3,{id:"ii-tcc-design",children:"II. TCC Design"}),"\n",(0,s.jsx)(t.p,{children:"When users access TCC, most of the work is focused on how to implement TCC service, after years of TCC application by Anthem, the following main TCC design and implementation of the main matters are summarised below:"}),"\n",(0,s.jsx)("a",{name:"4226dc7c"}),"\n",(0,s.jsxs)(t.h4,{id:"1-business-operation-is-completed-in-two-stages",children:["1, ",(0,s.jsx)(t.strong,{children:"Business operation is completed in two stages"})]}),"\n",(0,s.jsx)(t.p,{children:"Before connecting to TCC, business operation can be completed in one step only, but after connecting to TCC, we need to consider how to divide it into 2 phases to complete, put the resource checking and reserving in Try operation in the first phase, and put the execution of real business operation in Confirm operation in the second phase."}),"\n",(0,s.jsx)(t.p,{children:'Below is an example of how the business model can be designed in two phases. Example scenario: "Account A has a balance of $100, of which $30 needs to be deducted";'}),"\n",(0,s.jsx)(t.p,{children:'Before accessing TCC, the user could write SQL: "update account table set balance = balance - 30 where account = A" to complete the deduction operation in one step.'}),"\n",(0,s.jsx)(t.p,{children:"After connecting to TCC, you need to consider how to split the debit operation into 2 steps:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Try operation: checking and reserving resources;"}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"In the deduction scenario, what Try operation has to do is to check whether the balance of A account is enough, and then freeze the $30 to be deducted (reserved resources); no real deduction will happen at this stage."}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Confirm operation: performs the submission of the real operation;"}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"In the deduction scenario, the Confirm phase takes place when the real deduction occurs, deducting the $30 already frozen in A's account."}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Cancel operation: whether or not the reserved resource is released;"}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"In a debit scenario, the debit is cancelled and the Cancel operation performs the task of releasing the $30 that was frozen by the Try operation, returning Account A to its initial state."}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"image.png",src:n(9733).A+"",width:"744",height:"302"})}),"\n",(0,s.jsx)("a",{name:"bce861f1"}),"\n",(0,s.jsxs)(t.h4,{id:"2-concurrency-control",children:["2, ",(0,s.jsx)(t.strong,{children:"Concurrency Control"})]}),"\n",(0,s.jsx)(t.p,{children:"Users should consider concurrency issues when implementing TCC and minimise lock granularity to maximise concurrency in distributed transactions."}),"\n",(0,s.jsx)(t.p,{children:'The following is still an example of deducting money from account A. "There is $100 on account A. Transaction T1 has to deduct $30 of it, and transaction T2 also has to deduct $30, and there is concurrency".'}),"\n",(0,s.jsx)(t.p,{children:"In the first phase of the Try operation, distributed transaction T1 and distributed transaction T2 are freezing that part of the funds without interfering with each other; so that in the second phase of the distributed transaction, no matter whether T1 is a commit or a rollback, there will be no impact on T2, so that T1 and T2 are executing in parallel on the same piece of business data."}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.img,{alt:"image.png",src:n(93381).A+"",width:"738",height:"302"})," ",(0,s.jsx)("br",{})]}),"\n",(0,s.jsx)("a",{name:"e945e352"}),"\n",(0,s.jsxs)(t.h4,{id:"3-allow-empty-rollback",children:["3, ",(0,s.jsx)(t.strong,{children:"Allow empty rollback"})]}),"\n",(0,s.jsx)(t.p,{children:"As shown in the following figure, when the transaction coordinator invokes the first-phase Try operation of the TCC service, there may be a network timeout due to packet loss, and at this time the transaction manager triggers a two-phase rollback to invoke the Cancel operation of the TCC service, which is invoked without a timeout."}),"\n",(0,s.jsx)(t.p,{children:"The TCC service receives a Cancel request without receiving a Try request, this scenario is called a null rollback; null rollbacks often occur in production environments, and users should allow for null rollbacks when implementing TCC services, i.e., return success when receiving a null rollback."}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"image.png",src:n(50432).A+"",width:"1404",height:"858"})}),"\n",(0,s.jsx)("a",{name:"e02f3ee9"}),"\n",(0,s.jsx)(t.h4,{id:"4-anti-suspension-control",children:"4. Anti-suspension control"}),"\n",(0,s.jsx)(t.p,{children:"As shown in the figure below, when the transaction coordinator calls the TCC service's one-phase Try operation, there may be a timeout due to network congestion, at this time, the transaction manager will trigger a two-phase rollback and call the TCC service's Cancel operation, and the Cancel call is not timed out; after this, the one-phase Try packet that is congested in the network is received by the TCC service, and there is a two-phase After this, the first-phase Try packet on the congested network is received by the TCC service, and the second-phase Cancel request is executed before the first-phase Try request, and the TCC service will never receive the second-phase Confirm or Cancel after executing the late Try, resulting in the suspension of the TCC service."}),"\n",(0,s.jsx)(t.p,{children:"When you implement TCC service, you should allow empty rollback, but refuse to execute Try request after empty rollback to avoid hanging."}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"image.png",src:n(19515).A+"",width:"1438",height:"842"})}),"\n",(0,s.jsx)("a",{name:"5322a3d5"}),"\n",(0,s.jsx)(t.h4,{id:"5-idempotent-control",children:"5. Idempotent control"}),"\n",(0,s.jsxs)(t.p,{children:["Whether it is network packet retransmission or compensation execution of abnormal transaction, it will lead to the Try, Confirm or Cancel operation of TCC service to be executed repeatedly; users need to consider idempotent control when implementing TCC service, i.e., the business result of Try, Confirm, Cancel executed once and executed many times is the same. ",(0,s.jsx)("br",{}),(0,s.jsx)(t.img,{alt:"image.png",src:n(43063).A+"",width:"469",height:"275"}),(0,s.jsx)("br",{}),(0,s.jsx)("br",{})]}),"\n",(0,s.jsx)("a",{name:"Roadmap"}),"\n",(0,s.jsx)(t.h3,{id:"roadmap",children:"Roadmap"}),"\n",(0,s.jsx)(t.p,{children:"Currently we have released version 0.4.0, we will release version 0.5 ~ 1.0, continue to improve and enrich the functions of AT, TCC mode, and solve the problem of high availability of the server side, after version 1.0, this open source product will reach the standard of production environment."}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"image1.png",src:n(26904).A+"",width:"1680",height:"652"})})]})}function d(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},93381:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/conc-3fbb097a571ca78f9e463786b01dca57.png"},50432:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/empty_rollback-e06a0b70a6ab6a896c0bb67ace87b751.png"},43063:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/miden-c277a00ed0d40b3eed4f6648bcc27a75.png"},26904:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/roadmap-30821aa2e9d0cc93e4697af4cd6a2393.png"},19515:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/susp-3a5ed6577950c1034caca1d822a7aa80.png"},58150:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/tcc-2324b37c207fcf8b371402eb4bc5df43.png"},9733:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/tow_step-cfda16e094be75a90cd5a366f1f731a9.png"},28453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>r});var s=n(96540);const o={},i=s.createContext(o);function a(e){const t=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),s.createElement(i.Provider,{value:t},e.children)}}}]);